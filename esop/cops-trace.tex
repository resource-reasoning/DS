\begin{figure*}[!t]
\captionsetup[subfigure]{aboveskip=0pt, belowskip=5pt}

\[
\displaymathfont
\begin{multlined}
\ToCOPSProg{\copsconf_0 |  \cl,\repl_1:(\opW,\key_1,(\txid_1,\repl_1)) 
            -> \copsconf_1 | \cl,\repl_1:\mathtt{s}
            -> \copsconf_2 | \cl,\repl_1:(\opR,\key_1,(\txid_1,\repl_1))
            -> \copsconf_3 | \repl_1:\mathtt{sync}
            -> \copsconf_4 | \cl,\repl_1:(\opR,\key_2,(\txid_2,\repl_2)) 
            -> \!
}
\\[-3pt] \ToCOPSProg{ \copsconf_5 | \cl,\repl_1:\mathtt{p}
            -> \copsconf_6 | \lb
            -> \copsconf_7 | \cl,\repl_1:(\opR,\key_1,(\txid_1,\repl_2))
            -> \copsconf_8 | \lb'
            -> \copsconf_9 | \cl,\repl_1:(\opR,\key_2,(\txid_2,\repl_2))
            -> \copsconf_{10} | \cl,\repl_1:\mathtt{e}
            -> \cdots
            }
\end{multlined}
\normalsize
\]

\vspace*{-10pt}

\hrulefill

\vspace*{-20pt}

\[
\displaymathfont
\begin{multlined}
\ToCOPSProg{ \copsconf'_5 | \lb 
            -> \copsconf'_6 | \lb'  
            -> \copsconf'_7 | \cl,\repl_1:\mathtt{p}
            -> \copsconf'_8 | \cl,\repl_1:(\opR,\key_1,(\txid_1,\repl_2))
            -> \copsconf'_9 | \cl,\repl_1:(\opR,\key_2,(\txid_2,\repl_2))
            -> \copsconf'_{10} | \cl,\repl_1:\mathtt{e}
            -> \cdots
            }
\end{multlined}
\normalsize
\]

\vspace*{-10pt}

\hrulefill

\vspace*{-10pt}

\noindent%
\begin{multline*}
\hspace*{-10pt}%
\scalebox{.65}{%
\begin{tikzpicture}[font=\large]%
%Location x
\node(locx) {$\key_1 \mapsto$};
\draw pic at ([xshift=\tikzkvspace]locx.east) {vlist={versionx}{%
    fillbg/\val_0/{(\txid_0,\repl_0)}/\stub
    , fillbg/\val_1/{(\txid_1,\repl_1)}/\stub
    , /\val'_1/{(\txid_1,\repl_2)}/\stub
}};
%Location y
\path (versionx.east) + (0.55,0) node (locy) {$\key_2 \mapsto$};
\draw pic at ([xshift=\tikzkvspace]locy.east) {vlist={versiony}{%
    fillbg/\val_0/{(\txid_0,\repl_0)}/\stub
    , /\val_2/{(\txid_2,\repl_2)}/\stub
}};
\end{tikzpicture}%
}
\xrightarrow[\ ]{\scriptsize\begin{array}{@{}l@{}}\cl,\vi:\{ \key_1 \mapsto \{ 0,1,2 \},\key_2 \mapsto \{ 0,1 \} \}, \\ \fp: \Set{\opR(\key_1,\val'_1),\opR(\key_2,\val_2)} \end{array} }
\\[-3pt]
\scalebox{.65}{%
\begin{tikzpicture}[font=\large]%
%Location x
\node(locx) {$\key_1 \mapsto$};
\draw pic at ([xshift=\tikzkvspace]locx.east) {vlist={versionx}{%
    fillbg/\val_0/{(\txid_0,\repl_0)}/\stub
    , fillbg/\val_1/{(\txid_1,\repl_1)}/\stub
    , fillbg/\val'_1/{(\txid_1,\repl_2)}/\stub \cup \{ \txidrd \}
}};
%Location y
\path (versionx.east) + (0.55,0) node (locy) {$\key_2 \mapsto$};
\draw pic at ([xshift=\tikzkvspace]locy.east) {vlist={versiony}{%
    fillbg/\val_0/{(\txid_0,\repl_0)}/\stub
    , fillbg/\val_2/{(\txid_2,\repl_2)}/\stub \cup \{ \txidrd \}
}};
\end{tikzpicture}%
}
\end{multline*}

\vspace*{-15pt}

\hrulefill

\caption{Top: the COPS trace that produces \cref{fig:cops-request-values,fig:cops-re-read-values}; 
Middle: the normalised COPS trace; 
Bottom: the step encoding the multi-read transaction depicted above, with the kv-store encoding of \cref{fig:initial-cops} (left), and the views (highlighted) encoding of the client contexts before and after the transaction.}
\label{fig:cops-trace}
\label{fig:cops-encode}
\label{fig:encode-mkvs}
\label{fig:encode-view}
%\spaceshrink{-5pt}
\end{figure*}

