\section{Auxiliary Lemmata}

\thm \label{thm:eSound} (Elementary command soundness). For all $\hat{\mathds{C}} \in \mathsf{ECmd}$, their corresponding axiom $(M_1, \hat{\mathds{C}}, M_2) \in \mathsf{Ax}_{\hat{\mathsf{C}}}$ and any given machine state $m = (h, s) \in \mathsf{Storage} \times \mathsf{Stack}$, the following must hold.
\[
	\tsem{\hat{\mathds{C}}}_{\hat{\mathsf{C}}} \left( \lfloor M_1 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M_2 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
\]
{\parindent0pt
\begin{proof}
By induction on the structure of $\hat{\mathds{C}}$. \\

\textit{Case}: $\passign{\pvar{x}}{\mathds{E}}$

\textit{To show}: $\tsem{\passign{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}} \left( \lfloor M_1 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M_2 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}$

Let's pick an arbitrary $m_1 \in M_1$, now by definition of $\lfloor - \rfloor_\mathbb{M}$, it is now sufficient to show that the following holds for some $m_2 \in M_2$:
\begin{gather}
	\label{thm:CH1} \tsem{\passign{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}} \left(m_1 \bullet_\mathbb{M} m \right) = m_2 \bullet_\mathbb{M} m
\end{gather}

From the definition of the \textsc{Assign} axiom, we know that $m_1 = (h_1, s_1)$ can be any machine state and $m_2 = (h_1, s_1[\pvar{x} \mapsto v])$ where $v = \tsem{\mathds{E}}^\textsc{e}_{s_1}$. Then by definition of $\tsem{\passign{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}}$, the first projection of the return value is $m_1 \bullet_\mathbb{M} m$. We can conclude that (\ref{thm:CH1}) holds.  \\

\textit{Case}: $\palloc{\pvar{x}}{\mathds{E}}$

\textit{To show}: $\tsem{\palloc{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}} \left( \lfloor M_1 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M_2 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}$

Let's pick an arbitrary $m_1 \in M_1$, now by definition of $\lfloor - \rfloor_\mathbb{M}$, it is now sufficient to show that the following holds for some $m_2 \in M_2$:
\begin{gather}
	\label{thm:CH3} \tsem{\palloc{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}} \left(m_1 \bullet_\mathbb{M} m, s \right) = m_2 \bullet_\mathbb{M} m
\end{gather}

From the definition of the \textsc{Alloc} axiom, we know that $m_1 \in \{ (\emptyset, \emptyset) \}$ meaning that $m_1 = (\emptyset, \emptyset)$ and $m_2 = \left([l \mapsto 0]\ldots[l + n - 1 \mapsto 0], [\pvar{x} \mapsto l] \right)$ for $n = \tsem{\mathds{E}}_s^\textsc{e}$, $n > 0$ and some arbitrary $l \in \mathsf{Key}$. Then by definition of $\tsem{\palloc{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}}$, the return value is:
\begin{align*}
	m' &= ((h \uplus \emptyset)[l \mapsto 0]\ldots[l + n - 1 \mapsto 0], (s \uplus \emptyset)[\pvar{x} \mapsto l]) \\
	&= (h[l \mapsto 0]\ldots[l + n - 1 \mapsto 0], s[\pvar{x} \mapsto l])
\end{align*}
We can pick $l$ such that $\{ l, \ldots, l + n -1 \} \cap \pred{dom}{h} \equiv \emptyset$ and as a consequence express $m' = m_2 \bullet_\mathbb{M} m$. We can conclude that (\ref{thm:CH3}) holds. \\

\textit{Case}: $\pderef{\pvar{x}}{\mathds{E}}$

\textit{To show}: $\tsem{\pderef{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}} \left( \lfloor M_1 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M_2 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}$

Let's pick an arbitrary $m_1 \in M_1$, it is now sufficient to show that the following holds for some $m_2 \in M_2$:
\begin{gather}
	\label{thm:CH4} \tsem{\pderef{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}} \left( m_1 \bullet_\mathbb{M} m\right) = m_2 \bullet_\mathbb{M} m
\end{gather}

From the definition of the \textsc{Read} axiom, we know that $m_1 = ([k \mapsto v], [\pvar{x} \mapsto -])$ for $k = \tsem{\mathds{E}}_s^\textsc{e}$ and some $v \in \mathsf{Val}$, therefore we know that $k \in \pred{dom}{m_1\downarrow_1} \land \pvar{x} \in \pred{dom}{m_1 \downarrow_2}$ and it follows that $k \not\in \pred{dom}{h} \land \pvar{x} \not\in \pred{dom}{s}$ since $m_1 \bullet_\mathbb{M} m$ is defined. The resulting $m_2 = ([k \mapsto v], [\pvar{x} \mapsto v])$. Then by definition of $\tsem{\pderef{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}}$, the return value is $m' = ([k \mapsto v] \uplus h, ([\pvar{x} \mapsto -] \uplus s)[\pvar{x} \mapsto v])$ which can be rewritten as $m_2 \bullet_\mathbb{M} m$. We can conclude that (\ref{thm:CH4}) holds. \\

\textit{Case}: $\pmutate{\mathds{E}_1}{\mathds{E}_2}$

\textit{To show}: $\tsem{\pmutate{\mathds{E}_1}{\mathds{E}_2}}_{\hat{\mathsf{C}}} \left( \lfloor M_1 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M_2 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}$

Let's pick an arbitrary $m_1 \in M_1$, now by definition of $\lfloor - \rfloor_\mathbb{M}$, it is sufficient to show that the following holds for some $m_2 \in M_2$:
\begin{gather}
	\label{thm:CH5} \tsem{\pmutate{\mathds{E}_1}{\mathds{E}_2}}_{\hat{\mathsf{C}}} \left( m_1 \bullet_\mathbb{M} m \right) = m_2 \bullet_\mathbb{M} m
\end{gather}

From the definition of the \textsc{Write} axiom, we know that $m_1 = ([k \mapsto -], s_1)$ for $k = \tsem{\mathds{E}_1}_s^\textsc{e}$ and $m_2 = ([k \mapsto v], s_1)$ for $v = \tsem{\mathds{E}_2}_s^\textsc{e}$, therefore we know that $k \in \pred{dom}{[k \mapsto -]}$ which implies that $k \not\in \pred{dom}{h}$ given that $m_1 \bullet_\mathbb{M} m$ is defined. Then, by definition of $\tsem{\pmutate{\mathds{E}_1}{\mathds{E}_2}}_{\hat{\mathsf{C}}}$, the return value is $(m_1 \bullet_\mathbb{M} m)[k \mapsto v] = (([k \mapsto -] \uplus h)[k \mapsto v], s_1 \uplus s_2)$. This implies that $m$ is not modified since $k \not\in \pred{dom}{h}$, and $m_2 = [k \mapsto v]$. We can conclude that (\ref{thm:CH5}) holds.
\end{proof}
}

\thm \label{thm:cSound} (Command soundness). For all $\mathds{C} \in \mathsf{Cmd}$, their corresponding axiom $(M_1, \mathds{C}, M_2) \in \mathsf{Ax}_\mathsf{C}$, some $s \in \mathsf{Stack}$ and any given machine state $m \in \mathbb{M}$ the following must hold.
\[
	\tsem{\mathds{C}}_\mathsf{C} \left( \lfloor M_1 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M_2 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
\]

{\parindent0pt
\begin{proof}
By induction on the structure of $\mathds{C}$. \\

\textit{Base case}: $\mathds{\hat{C}}$

\textit{To show}: $\tsem{\hat{\mathds{C}}}_\mathsf{C} \left( \lfloor M_1 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \downarrow_1 \subseteq \lfloor M_2 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}$

The result follows directly from Parameter \ref{param:ecmdSound}. \\

\textit{Base case}: $\pskip$

\textit{To show}: $\tsem{\pskip}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \downarrow_1 \subseteq \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}$

By definition of $\tsem{\pskip}_\mathsf{C}$ we have the following.
\begin{align*}
	\tsem{\pskip}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \downarrow_1
	&=
	\lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
	\\
	&\subseteq \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
\end{align*} 

\textit{Inductive case}: $\mathds{C}_1 ; \mathds{C}_2$

\textit{To show}:
\begin{gather*}
	\tsem{\mathds{C}_1 ; \mathds{C}_2}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \downarrow_1 \subseteq \lfloor M' \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
	\\
	\text{where } (M, \mathds{C}_1, M''), (M'', \mathds{C}_2, M') \in \textsc{Ax}_\mathsf{C}
\end{gather*}

\textit{Inductive hypothesis}: Assume the property holds for $\mathds{C}_1$ and for $\mathds{C}_2$.

By definition of $\tsem{\mathds{C}_1 ; \mathds{C}_2}_\mathsf{C}$ we have the following.
\begin{align*}
	\tsem{\mathds{C}_1 ; \mathds{C}_2}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \downarrow_1
	&=
	\tsem{\mathds{C}_2}\left( \tsem{\mathds{C}_1}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\}\rfloor_\mathbb{M}, s \right) \right) \downarrow_1 \\
	\text{by I.H. on } \mathds{C}_1 &\subseteq
	\tsem{\mathds{C}_1}_\mathsf{C} \left( \lfloor M'' \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \downarrow_1 \\
	\text{by I.H. on } \mathds{C}_2 &\subseteq
	\lfloor M' \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
\end{align*}

\textit{Inductive case}: $\pif{\mathds{B}}{\mathds{C}_1}{\mathds{C}_2}$

\textit{To show}:
\begin{gather*}
	\tsem{\pif{\mathds{B}}{\mathds{C}_1}{\mathds{C}_2}}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \downarrow_1 \subseteq \lfloor M' \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
	\\
	\text{where } (M, \mathds{C}_1, M'), (M, \mathds{C}_2, M') \in \textsc{Ax}_\mathsf{C}
\end{gather*}

\textit{Inductive hypothesis}: Assume the property holds for $\mathds{C}_1$ and for $\mathds{C}_2$.

By definition of $\tsem{\pif{\mathds{B}}{\mathds{C}_1}{\mathds{C}_2}}_\mathsf{C}$ we have the following.
\begin{gather*}
	\tsem{\pif{\mathds{B}}{\mathds{C}_1}{\mathds{C}_2}}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \downarrow_1
	\\
	=
	\\
	\left( \mathbf{if}\ \tsem{\mathds{B}}^\textsc{b}_s\ \mathbf{then}\ \tsem{\mathds{C}_1}_\mathsf{C}\left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right)\ \mathbf{else}\ \tsem{\mathds{C}_2}_\mathsf{C}\left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \right) \downarrow_1
\end{gather*}

Now we have two scenarios to consider, based on how $\tsem{\mathds{B}}_s^\textsc{b}$ evaluates.
\begin{itemize}
	\item If $\tsem{\mathds{B}}_s^\textsc{b} = \top$, then we can proceed as follows.
		\begin{align*}			
			&\left( \mathbf{if}\ \top\ \mathbf{then}\ \tsem{\mathds{C}_1}_\mathsf{C}\left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right)\ \mathbf{else}\ \tsem{\mathds{C}_2}_\mathsf{C}\left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \right) \downarrow_1 \\
			&=
			\tsem{\mathds{C}_1}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \downarrow_1
			\\
			& \subseteq \lfloor M' \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \text{ by I.H. on } \mathds{C}_1
		\end{align*}
	\item If $\tsem{\mathds{B}}_s^\textsc{b} = \bot$, then we can proceed as follows.
		\begin{align*}			
			&\left( \mathbf{if}\ \bot\ \mathbf{then}\ \tsem{\mathds{C}_1}_\mathsf{C}\left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right)\ \mathbf{else}\ \tsem{\mathds{C}_2}_\mathsf{C}\left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \right) \downarrow_1 \\
			&=
			\tsem{\mathds{C}_2}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \downarrow_1
			\\
			& \subseteq \lfloor M' \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \text{ by I.H. on } \mathds{C}_2
		\end{align*}
\end{itemize}

\textit{Inductive case}: $\ploop{\mathds{B}}{\mathds{C}}$

\textit{To show}:
\begin{gather*}
	\tsem{\ploop{\mathds{B}}{\mathds{C}}}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \downarrow_1 \subseteq \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
	\\
	\text{where } (M, \mathds{C}, M) \in \textsc{Ax}_\mathsf{C}
\end{gather*}

\textit{Inductive hypothesis}: Assume the property holds for $\mathds{C}$.

By definition of $\tsem{\ploop{\mathds{B}}{\mathds{C}}}_\mathsf{C}$ we have the following.
\begin{align*}
	&\tsem{\ploop{\mathds{B}}{\mathds{C}}}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \downarrow_1
	\\
	&=
	\tsem{\pif{\mathds{B}}{\left(\mathds{C};\ploop{\mathds{B}}{\mathds{C}}\right)}{\pskip}}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \downarrow_1 \\
	&=
	\left( \mathbf{if}\ \tsem{\mathds{B}}^\textsc{b}_s\ \mathbf{then}\ \tsem{\mathds{C};\ploop{\mathds{B}}{\mathds{C}}}_\mathsf{C}\left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right)\ \mathbf{else}\ \tsem{\pskip}_\mathsf{C}\left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \right) \downarrow_1
\end{align*}

As before, we have two cases to consider, based on how $\tsem{\mathds{B}}_s^\textsc{b}$ evaluates.
\begin{itemize}
	\item If $\tsem{\mathds{B}}_s^\textsc{b} = \top$, then we can proceed as follows.
		\begin{align*}
			&\left( \mathbf{if}\ \top\ \mathbf{then}\ \tsem{\mathds{C};\ploop{\mathds{B}}{\mathds{C}}}_\mathsf{C}\left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right)\ \mathbf{else}\ \tsem{\pskip}_\mathsf{C}\left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \right) \downarrow_1
			\\
			&= \tsem{\mathds{C};\ploop{\mathds{B}}{\mathds{C}}}_\mathsf{C}\left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \downarrow_1
			\\
			& \subseteq \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \text{ by I.H. on } \mathds{C}
		\end{align*}
	\item If $\tsem{\mathds{B}}_s^\textsc{b} = \bot$, then we can proceed as follows.
		\begin{align*}
			&\left( \mathbf{if}\ \bot\ \mathbf{then}\ \tsem{\mathds{C};\ploop{\mathds{B}}{\mathds{C}}}_\mathsf{C}\left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right)\ \mathbf{else}\ \tsem{\pskip}_\mathsf{C}\left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \right) \downarrow_1
			\\
			&= \tsem{\pskip}_\mathsf{C}\left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}, s \right) \downarrow_1
			\\
			& \subseteq \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \text{ by the } \pskip \text{ case of this proof}.
		\end{align*}
\end{itemize}
\end{proof}
}

\lem \label{lem:R} For all $w_1, w_2, w, w' = (l', g', \mathcal{J}') \in \mathsf{World}$,
\[
	w_1 \bullet w_2 = w \land (l', g', \mathcal{J}') \in G(w_1) \implies ((w_2)_\mathsf{L}, g', \mathcal{J}') \in R(w_2)
\]

{\parindent0pt
\begin{proof}
Let's pick arbitrary $w_1, w_2, w, w' = (l', g', \mathcal{J}') \in \mathsf{World}$ such that:
\begin{gather}
	\label{lem:R1} w_1 \bullet w_2 = w \land
	\\
	\label{lem:R2} (l', g', \mathcal{J}') \in G(w_1)
\end{gather}

\textit{To show}: $((w_2)_\mathsf{L}, g', \mathcal{J}') \in R(w_2)$

From (\ref{lem:R2}) and the definition of $G$ we know that:
\begin{gather}
	\label{lem:R3} (l', g', \mathcal{J}') \in (G^c \cup G^u)^*(w_1)
\end{gather}

From (\ref{lem:R1}), (\ref{lem:R3}) and by Lemma \ref{lem:Ru}, Lemma \ref{lem:Rc} we get:
\[
	((w_2)_\mathsf{L}, g', \mathcal{J}') \in (R^c \cup R^u)^*(w_2)
\]
Therefore we can conclude the following.
\[
	((w_2)_\mathsf{L}, g', \mathcal{J}') \in R(w_2)
\]
\end{proof}
}

\lem \label{lem:Ru} For all $w_1, w_2, w, w' = (l', g', \mathcal{J}') \in \mathsf{World}$,
\[
	w_1 \bullet w_2 = w \land (l', g', \mathcal{J}') \in G^u(w_1) \implies ((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^u(w_2)
\]

{\parindent0pt
\begin{proof}
Let's pick arbitrary $w_1 = (l_1, g_1, \mathcal{J}_1), w_2 = (l_2, g_2, \mathcal{J}_2), w$ and $(l', g', \mathcal{J}') \in \mathsf{World}$, such that:
\begin{gather}
	\label{lem:Ru1} w_1 \bullet w_2 = w \land \\
	\label{lem:Ru2} (l', g', \mathcal{J}') \in G^u(w_1)
\end{gather}

\textit{To show}: $((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^u(w_2)$

From (\ref{lem:Ru1}) we know that
\begin{gather}
	\label{lem:Ru3} g_1 = g_2 \\
	\label{lem:Ru4} \mathcal{J}_1 = \mathcal{J}_2
\end{gather}

From the definition of $G^u$ and from (\ref{lem:Ru2}) and (\ref{lem:Ru4}) we know that:
\begin{gather}
	\label{lem:Ru5} \mathcal{J}' = \mathcal{J}_1 = \mathcal{J}_2 \land \\
	\label{lem:Ru6} ((l_1 \oplus g_1)_\mathsf{K})_\mathbb{K}^\bot = ((l' \oplus g')_\mathsf{K})_\mathbb{K}^\bot \land \\
		\label{lem:Ru7} (g_1 = g' \lor (\exists r, \kappa \leq (l_1)_\mathsf{K}(r) \ldotp (g_1, g') \in \lceil \mathcal{J}_1(r) \rceil(\kappa)
		\\ \land ((l_1 \oplus g_1)_\mathsf{M})_\mathbb{M}^\bot = ((l' \oplus g')_\mathsf{M})_\mathbb{M}^\bot )
\end{gather}

Given the disjunction in (\ref{lem:Ru7}), we need to consider two cases. \\

\textit{Case 1}: $g_1 = g'$

From (\ref{lem:Ru3}) and our assumption, we get that $g_2 = g'$. Now, from (\ref{lem:Ru5}), it follows that:
\begin{gather}
	\label{lem:Ru8} ((w_2)_\mathsf{L}, g', \mathcal{J}') = ((l_2, g_2, \mathcal{J}_2))
\end{gather}

From (\ref{lem:Ru8}) and the definition of $R^u$ we can conclude that:
\[
	((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^u((l_2, g_2, \mathcal{J}_2))
\]

\textit{Case 2}:
\begin{gather}
	\label{lem:Ru9} \exists r, \kappa \leq (l_1)_\mathsf{K}(r) \ldotp (g_1, g') \in \lceil \mathcal{J}_1(r) \rceil(\kappa)
	\\
	\label{lem:Ru10} \land ((l_1 \oplus g_1)_\mathsf{M})_\mathbb{M}^\bot = ((l' \oplus g')_\mathsf{M})_\mathbb{M}^\bot
\end{gather}

From (\ref{lem:Ru1}), (\ref{lem:Ru3}) and (\ref{lem:Ru4}) we know that:
\begin{gather}
	\label{lem:Ru11} w = (l_1 \circ l_2, g_2, \mathcal{J}_2)
\end{gather}

From the definition of $\mathsf{World}$ we know that $\pred{wf}{w}$ holds, and together with (\ref{lem:Ru3}) we have:
\begin{gather}
	\label{lem:Ru12} ((l_1 \circ l_2) \oplus g_2)_\mathsf{K} = (l_1)_\mathsf{K} \bullet_\mathbb{K} (l_2)_\mathsf{K} \bullet_\mathbb{K} \llfloor g_2 \rrfloor_\mathsf{K} = (l_1 \oplus g_1)_\mathsf{K} \bullet_\mathbb{K} (l_2)_\mathsf{K} \text{ defined}
	\\
	\label{lem:Ru13} \text{and } ((l_1 \circ l_2) \oplus g_1)_\mathsf{M} = (l_1 \oplus g_1)_\mathsf{M} \bullet_\mathbb{M} (l_2)_\mathsf{M} \text{ defined}
\end{gather}

From (\ref{lem:Ru9}) we obtain $\kappa \leq (l_1)_\mathsf{K}(r)$, from (\ref{lem:Ru12}) and Lemma \ref{lem:SepF}, we know:
\begin{gather}
	\label{lem:Ru14} \kappa\ \sharp \left( (l_2)_\mathsf{K} \bullet_\mathbb{K} \llfloor g_2 \rrfloor_\mathsf{K} \right)
\end{gather}

From (\ref{lem:Ru3}), (\ref{lem:Ru10}) and (\ref{lem:Ru13}) we know:
\begin{gather}
	\label{lem:Ru15} (l' \oplus g')_\mathsf{M} \bullet_\mathbb{M} (l_2)_\mathsf{M} = ((l' \circ l_2) \oplus g')_\mathsf{M} \text{ defined}
\end{gather}

From (\ref{lem:Ru6}) and (\ref{lem:Ru12}) we know:
\begin{gather}
	\label{lem:Ru16} (l' \oplus g')_\mathsf{K} \bullet_\mathbb{K} (l_2)_\mathsf{K} = ((l' \circ l_2) \oplus g')_\mathsf{K} \text{ defined}
\end{gather}

From (\ref{lem:Ru15}), (\ref{lem:Ru16}) we get that $(l_1' \circ l_2) \oplus g'$ is defined and as a consequence we obtain:
\begin{gather}
	\label{lem:Ru17} l_2 \oplus g' \text{ defined}
\end{gather}

From (\ref{lem:Ru5}), (\ref{lem:Ru9}), (\ref{lem:Ru14}), (\ref{lem:Ru17}) and the definition of $R^u$ we can conclude that:
\[
	((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^u((l_2, g_2, \mathcal{J}_2))
\]
\end{proof}
}

\lem \label{lem:Rc}  For all $w_1, w_2, w, w' = (l', g', \mathcal{J}') \in \mathsf{World}$,
\[
	w_1 \bullet w_2 = w \land (l', g', \mathcal{J}') \in G^c(w_1) \implies ((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^c(w_2)
\]

{\parindent0pt
\begin{proof}
Let's pick arbitrary $w_1 = (l_1, g_1, \mathcal{J}_1), w_2 = (l_2, g_2, \mathcal{J}_2), w$ and $w' = (l', g', \mathcal{J}') \in \mathsf{World}$, such that:
\begin{gather}
	\label{lem:Rc1} w_1 \bullet w_2 = w \land \\
	\label{lem:Rc2} (l', g', \mathcal{J}') \in G^c(w_1)
\end{gather}

\textit{To show}: $((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^c(w_2)$

From (\ref{lem:Ru1}) we know that
\begin{gather}
	\label{lem:Rc3} g_1 = g_2 \\
	\label{lem:Rc4} \mathcal{J}_1 = \mathcal{J}_2
\end{gather}

From the definition of $G^c$ and from (\ref{lem:Rc2}), (\ref{lem:Rc3}) and (\ref{lem:Rc4}) we know that:
\begin{gather}
	\label{lem:Rc5} \exists r, m, l, l_r, a, \rho \ldotp \pred{fresh}{r, w} \land \pred{dom}{\rho} = \{r\} \land
	\\
	\label{lem:Rc6} l_1 = l \circ l_r \land l' = l \circ (m, \rho) \land m \in \mathbf{0}_\mathbb{M} \land
	\\
	\label{lem:Rc10} g' = g_2[r \mapsto l_r] \land \mathcal{J}' = \mathcal{J}_2[r \mapsto a]
\end{gather}

From (\ref{lem:Rc1}) and (\ref{lem:Rc6}) we know that $(l_1 \circ l_2) \oplus g$ and that $l_1 = l \circ l_r$ are defined which implies that:
\begin{gather}
	\label{lem:Rc7} l_r \circ l_2 \text{ defined}
	\\
	\label{lem:Rc8} l_2 \oplus g_2 \text{ defined}
\end{gather}

Now, from (\ref{lem:Rc10}) we know that $g' = g_2[r \mapsto l_r]$ and together with (\ref{lem:Rc7}) and (\ref{lem:Rc8}) we obtain that:
\begin{gather}
	\label{lem:Rc9} l_2 \oplus g' \text{ defined}
\end{gather}

From (\ref{lem:Rc1}) and (\ref{lem:Rc5}) we obtain that:
\begin{gather}
	\label{lem:Rc11} \pred{fresh}{r, w_2}
\end{gather}

From (\ref{lem:Rc10}), (\ref{lem:Rc9}) and (\ref{lem:Rc11}) we can conclude that:
\[
	((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^c(w_2)
\]
\end{proof}
}

\lem \label{lem:SepF} Given any separation algebra $(\mathcal{M}, \bullet_\mathcal{M}, \mathbf{0}_\mathcal{M})$
\[
	\forall a, b, c, d \in \mathcal{M} \ldotp a \bullet_\mathcal{M} b = d \land c \leq b \implies \exists f \ldotp a \bullet_\mathcal{M} c = f
\]

{\parindent0pt
\begin{proof}
Let's pick arbitrary $a, b, c, d \in \mathcal{M}$ such that:
\begin{gather}
	\label{lem:SepF1} a \bullet_\mathcal{M} b = d
	\\
	\label{lem:SepF2} c \leq b
\end{gather}

From (\ref{lem:SepF2}) we obtain:
\begin{gather}
	\label{lem:SepF3} \exists e \in \mathcal{M} \ldotp c \bullet_\mathcal{M} e = b
\end{gather}

Now, as a consequence, from (\ref{lem:SepF1}) we have:
\begin{gather}
	\label{lem:SepF4} a \bullet_\mathcal{M} c \bullet_\mathcal{M} e = d
\end{gather}

Since $e \leq d$ from (\ref{lem:SepF4}) we have:
\begin{gather}
	\label{lem:SepF5} \exists f \in \mathcal{M} \ldotp e \bullet_\mathcal{M} f = d
\end{gather}

From (\ref{lem:SepF4}), (\ref{lem:SepF5}) and cancellativity of separation algebras we have $a \bullet_\mathcal{M} c = f$ and therefore $\exists f \in \mathcal{M} \ldotp a \bullet_\mathcal{M} c = f$ holds.
\end{proof}
}