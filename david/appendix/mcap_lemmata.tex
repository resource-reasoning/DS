\section{Auxiliary Lemmata for mCAP}

\thm \label{thm:eSound} (Elementary command soundness). For all $\hat{\mathds{C}} \in \mathsf{ECmd}$, their corresponding axiom $(M_1, \hat{\mathds{C}}, M_2) \in \mathsf{Ax}_{\hat{\mathsf{C}}}$ and any given machine state $m = (h, s) \in \mathsf{Storage} \times \mathsf{Stack}$, the following must hold.
\[
	\tsem{\hat{\mathds{C}}}_{\hat{\mathsf{C}}} \left( \lfloor M_1 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M_2 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
\]
{\parindent0pt
\begin{proof}
By induction on the structure of $\hat{\mathds{C}}$. \\

\textit{Case}: $\passign{\pvar{x}}{\mathds{E}}$

\textit{To show}: $\tsem{\passign{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}} \left( \lfloor M_1 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M_2 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}$

Let's pick an arbitrary $m_1 \in M_1$, now by definition of $\lfloor - \rfloor_\mathbb{M}$, it is now sufficient to show that the following holds for some $m_2 \in M_2$:
\begin{gather}
	\label{thm:CH1} \tsem{\passign{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}} \left(m_1 \bullet_\mathbb{M} m \right) = \{ m_2 \bullet_\mathbb{M} m \}
\end{gather}

From the definition of the \textsc{Assign} axiom, we know that $m_1 = (h_1, s_1)$ can be any machine state and $m_2 = (h_1, s_1[\pvar{x} \mapsto v])$ where $v = \tsem{\mathds{E}}^\textsc{e}_{s_1}$. Then by definition of $\tsem{\passign{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}}$, the first projection of the return value is $m_1 \bullet_\mathbb{M} m$. We can conclude that (\ref{thm:CH1}) holds.  \\

\textit{Case}: $\palloc{\pvar{x}}{\mathds{E}}$

\textit{To show}: $\tsem{\palloc{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}} \left( \lfloor M_1 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M_2 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}$

Let's pick an arbitrary $m_1 \in M_1$, now by definition of $\lfloor - \rfloor_\mathbb{M}$, it is now sufficient to show that the following holds for some $m_2 \in M_2$:
\begin{gather}
	\label{thm:CH3} \tsem{\palloc{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}} \left(m_1 \bullet_\mathbb{M} m, s \right) = \{ m_2 \bullet_\mathbb{M} m \}
\end{gather}

From the definition of the \textsc{Alloc} axiom, we know that $m_1 \in \{ (\emptyset, \emptyset) \}$ meaning that $m_1 = (\emptyset, \emptyset)$ and $m_2 = \left([l \mapsto 0]\ldots[l + n - 1 \mapsto 0], [\pvar{x} \mapsto l] \right)$ for $n = \tsem{\mathds{E}}_s^\textsc{e}$, $n > 0$ and some arbitrary $l \in \mathsf{Key}$. Then by definition of $\tsem{\palloc{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}}$, the return value is:
\begin{align*}
	m' &= ((h \uplus \emptyset)[l \mapsto 0]\ldots[l + n - 1 \mapsto 0], (s \uplus \emptyset)[\pvar{x} \mapsto l]) \\
	&= (h[l \mapsto 0]\ldots[l + n - 1 \mapsto 0], s[\pvar{x} \mapsto l])
\end{align*}
We can pick $l$ such that $\{ l, \ldots, l + n -1 \} \cap \pred{dom}{h} \equiv \emptyset$ and as a consequence express $m' = m_2 \bullet_\mathbb{M} m$. We can conclude that (\ref{thm:CH3}) holds. \\

\textit{Case}: $\pderef{\pvar{x}}{\mathds{E}}$

\textit{To show}: $\tsem{\pderef{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}} \left( \lfloor M_1 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M_2 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}$

Let's pick an arbitrary $m_1 \in M_1$, it is now sufficient to show that the following holds for some $m_2 \in M_2$:
\begin{gather}
	\label{thm:CH4} \tsem{\pderef{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}} \left( m_1 \bullet_\mathbb{M} m\right) = \{m_2 \bullet_\mathbb{M} m\}
\end{gather}

From the definition of the \textsc{Read} axiom, we know that for $k = \tsem{\mathds{E}}_s^\textsc{e}$ and some $v \in \mathsf{Val}$:
\begin{gather}
	\label{thm:CH7}
	m_1 = (h_1, s_1) = ([k \mapsto v], [\pvar{x} \mapsto -]) \land m_2 = ([k \mapsto v], [\pvar{x} \mapsto v])
\end{gather}
therefore we know that $k \in \pred{dom}{h_1} \land \pvar{x} \in \pred{dom}{m_1 \downarrow_2}$ and it follows that $k \not\in \pred{dom}{h} \land \pvar{x} \not\in \pred{dom}{s}$ since $m_1 \bullet_\mathbb{M} m$ is defined. Then from the definition of $\tsem{\pderef{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}}$ and \ref{thm:CH7} we have:
\begin{align*}
	\tsem{\pderef{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}}
		&=
	\{ (h_1 \uplus h, (s_1 \uplus s)[\pvar{x} \mapsto v]) \} \\
		&=
	\{ ([k \mapsto v] \uplus h, ([\pvar{x} \mapsto -] \uplus s)[\pvar{x} \mapsto v]) \} \\
		&=
	\{ ([k \mapsto v] \uplus h, [\pvar{x} \mapsto v] \uplus s) \} \\
		&=
	\{ ([k \mapsto v], [\pvar{x} \mapsto v]) \uplus_2 (h, s) \} \\
		&=
	\{ m_2 \uplus m \} = \{ m_2 \bullet_\mathbb{M} m \}
\end{align*}

\textit{Case}: $\pmutate{\mathds{E}_1}{\mathds{E}_2}$

\textit{To show}: $\tsem{\pmutate{\mathds{E}_1}{\mathds{E}_2}}_{\hat{\mathsf{C}}} \left( \lfloor M_1 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M_2 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}$

Let's pick an arbitrary $m_1 \in M_1$, now by definition of $\lfloor - \rfloor_\mathbb{M}$, it is sufficient to show that the following holds for some $m_2 \in M_2$:
\begin{gather}
	\label{thm:CH5} \tsem{\pmutate{\mathds{E}_1}{\mathds{E}_2}}_{\hat{\mathsf{C}}} \left( m_1 \bullet_\mathbb{M} m \right) = \{ m_2 \bullet_\mathbb{M} m \}
\end{gather}

From the definition of the \textsc{Write} axiom, we know that for $k = \tsem{\mathds{E}_1}_s^\textsc{e}$ and $v = \tsem{\mathds{E}_2}_s^\textsc{e}$,
\begin{gather}
	\label{thm:CH6}
	m_1 = (h_1, s_1) = ([k \mapsto -], s_1) \land m_2 = ([k \mapsto v], s_1)
\end{gather}
This implies that $k \in \pred{dom}{h_1}$ which requires that $k \not\in \pred{dom}{h}$ given that $m_1 \bullet_\mathbb{M} m$ is defined by assumption. Then, from the definition of $\tsem{\pmutate{\mathds{E}_1}{\mathds{E}_2}}_{\hat{\mathsf{C}}}$ and (\ref{thm:CH6}), we have:
\begin{align*}
	\tsem{\pmutate{\mathds{E}_1}{\mathds{E}_2}}_{\hat{\mathsf{C}}} \left( m_1 \bullet_\mathbb{M} m \right)
		&=
	\{((h_1 \uplus h)[k \mapsto v], s_1 \uplus s)\} \\
		&=
	\{(([k \mapsto -] \uplus h)[k \mapsto v], s_1 \uplus s)\} \\
		&=
	\{([k \mapsto v] \uplus h, s_1 \uplus s)\} \\
		&=
	\{ ([k \mapsto v], s_1) \uplus_2 (h, s) \} \\
		&=
	\{ m_2 \uplus_2 m \} = \{ m_2 \bullet_\mathbb{M} m \}
\end{align*}
\end{proof}
}

\thm \label{thm:cSound} (Command soundness). For all $\mathds{C} \in \mathsf{Cmd}$, their corresponding axiom $(M_1, \mathds{C}, M_2) \in \mathsf{Ax}_\mathsf{C}$ and any given machine state $m \in \mathbb{M}$ the following must hold.
\[
	\tsem{\mathds{C}}_\mathsf{C} \left( \lfloor M_1 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M_2 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
\]

{\parindent0pt
\begin{proof}
By induction on the structure of $\mathds{C}$. \\

\textit{Base case}: $\mathds{\hat{C}}$

\textit{To show}: $\tsem{\hat{\mathds{C}}}_\mathsf{C} \left( \lfloor M_1 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M_2 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}$

The result follows directly from Parameter \ref{param:ecmdSound}. \\

\textit{Base case}: $\pskip$

\textit{To show}: $\tsem{\pskip}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}\right) \subseteq \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}$

By definition of $\tsem{\pskip}_\mathsf{C}$ we have the following.
\begin{align*}
	\tsem{\pskip}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right)
	&=
	\lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
	\\
	&\subseteq \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
\end{align*} 

\textit{Inductive case}: $\mathds{C}_1 ; \mathds{C}_2$

\textit{To show}:
\begin{gather*}
	\tsem{\mathds{C}_1 ; \mathds{C}_2}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M' \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
	\\
	\text{where } (M, \mathds{C}_1, M''), (M'', \mathds{C}_2, M') \in \textsc{Ax}_\mathsf{C}
\end{gather*}

\textit{Inductive hypothesis}: Assume the property holds for $\mathds{C}_1$ and for $\mathds{C}_2$.

By definition of $\tsem{\mathds{C}_1 ; \mathds{C}_2}_\mathsf{C}$ we have the following.
\begin{align*}
	\tsem{\mathds{C}_1 ; \mathds{C}_2}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right)
	&=
	\tsem{\mathds{C}_2}\left( \tsem{\mathds{C}_1}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\}\rfloor_\mathbb{M}\right) \right) \\
	\text{by I.H. on } \mathds{C}_1 &\subseteq
	\tsem{\mathds{C}_1}_\mathsf{C} \left( \lfloor M'' \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \\
	\text{by I.H. on } \mathds{C}_2 &\subseteq
	\lfloor M' \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
\end{align*}

\textit{Inductive case}: $\pif{\mathds{B}}{\mathds{C}_1}{\mathds{C}_2}$

\textit{To show}:
\begin{gather*}
	\tsem{\pif{\mathds{B}}{\mathds{C}_1}{\mathds{C}_2}}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M' \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
	\\
	\text{where } (M, \mathds{C}_1, M_1), (M, \mathds{C}_2, M_2) \in \textsc{Ax}_\mathsf{C} \text{ and } M' \equiv M_1 \cup M_2
\end{gather*}

\textit{Inductive hypothesis}: Assume the property holds for $\mathds{C}_1$ and for $\mathds{C}_2$.

Let $S_{in} = \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}$ and $S_{out} = \lfloor M' \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}$. Let's pick an arbitrary $\sigma \in S_{in}$. It is now sufficient to show that the following holds:
\begin{gather*}
	\tsem{\pif{\mathds{B}}{\mathds{C}_1}{\mathds{C}_2}}_\mathsf{C} \left( \sigma \right) \subseteq S_{out}
\end{gather*}

From the definition of $\tsem{\pif{\mathds{B}}{\mathds{C}_1}{\mathds{C}_2}}_\mathsf{C}$ we have the following.
\[
	\tsem{\pif{\mathds{B}}{\mathds{C}_1}{\mathds{C}_2}}_\mathsf{C} \left( \sigma \right)
		= 
	\mathbf{if}\ \tsem{\mathds{B}}_\sigma^\textsc{b}\ \mathbf{then}\ \tsem{\mathds{C}_1}_\mathsf{C}\left( \sigma \right) \mathbf{else}\ \tsem{\mathds{C}_2}_\mathsf{C}\left( \sigma \right)
\]

We now have two scenarios to consider, based on how $\tsem{\mathds{B}}_\sigma^\textsc{b}$ evaluates.
\begin{itemize}
	\item If $\tsem{\mathds{B}}_\sigma^\textsc{b} = \top$, then we can proceed as follows.
		\begin{align*}			
			& \mathbf{if}\ \top\ \mathbf{then}\ \tsem{\mathds{C}_1}_\mathsf{C}\left( \sigma \right) \mathbf{else}\ \tsem{\mathds{C}_2}_\mathsf{C}\left( \sigma \right) \\
				&=
			\tsem{\mathds{C}_1}_\mathsf{C} \left( \sigma \right) \\
				&
			\subseteq \lfloor M_1 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \text{ by I.H. on } \mathds{C}_1 \\
				&
			\subseteq \lfloor M' \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \text{ as } M_1 \subseteq M'
		\end{align*}
	\item If $\tsem{\mathds{B}}_\sigma^\textsc{b} = \bot$, then we can proceed as follows.
		\begin{align*}			
			& \mathbf{if}\ \bot\ \mathbf{then}\ \tsem{\mathds{C}_1}_\mathsf{C}\left( \sigma \right) \mathbf{else}\ \tsem{\mathds{C}_2}_\mathsf{C}\left( \sigma \right) \\
			&=
			\tsem{\mathds{C}_2}_\mathsf{C} \left( \sigma \right) \\
			&
			\subseteq \lfloor M_2 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \text{ by I.H. on } \mathds{C}_2 \\
			&
			\subseteq \lfloor M' \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \text{ as } M_2 \subseteq M'
		\end{align*}
\end{itemize}

\textit{Inductive case}: $\ploop{\mathds{B}}{\mathds{C}}$

\textit{To show}:
\begin{gather*}
	\tsem{\ploop{\mathds{B}}{\mathds{C}}}_\mathsf{C} \left( \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M' \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
	\\
	\text{where } (M, \mathds{C}, M'') \in \textsc{Ax}_\mathsf{C} \text{ and } M' \equiv M \cup M''
\end{gather*}

\textit{Inductive hypothesis}: Assume the property holds for $\mathds{C}$.

Let $S_{in} = \lfloor M \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}$ and $S_{out} = \lfloor M' \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}$. Let's pick an arbitrary $\sigma \in S_{in}$. It is now sufficient to show that the following holds:
\begin{gather}
	\tsem{\ploop{\mathds{B}}{\mathds{C}}}_\mathsf{C} \left( \sigma \right) \subseteq S_{out}
\end{gather}
By definition of $\tsem{\ploop{\mathds{B}}{\mathds{C}}}_\mathsf{C}$ we have the following.
\begin{align*}
	\tsem{\ploop{\mathds{B}}{\mathds{C}}}_\mathsf{C} \left( \sigma \right)
	&=
	\tsem{\pif{\mathds{B}}{\left(\mathds{C};\ploop{\mathds{B}}{\mathds{C}}\right)}{\pskip}}_\mathsf{C} \left( \sigma \right) \\
	&=
	\mathbf{if}\ \tsem{\mathds{B}}^\textsc{b}_\sigma\ \mathbf{then}\ \tsem{\mathds{C};\ploop{\mathds{B}}{\mathds{C}}}_\mathsf{C}\left( \sigma \right)\ \mathbf{else}\ \tsem{\pskip}_\mathsf{C}\left( \sigma \right)
\end{align*}

As before, we have two cases to consider, based on how $\tsem{\mathds{B}}_\sigma^\textsc{b}$ evaluates.
\begin{itemize}
	\item If $\tsem{\mathds{B}}_\sigma^\textsc{b} = \top$, then we can proceed as follows.
		\begin{align*}
			&\mathbf{if}\ \top\ \mathbf{then}\ \tsem{\mathds{C};\ploop{\mathds{B}}{\mathds{C}}}_\mathsf{C}\left( \sigma \right)\ \mathbf{else}\ \tsem{\pskip}_\mathsf{C}\left( \sigma \right)
			\\
			&= \tsem{\mathds{C};\ploop{\mathds{B}}{\mathds{C}}}_\mathsf{C}\left( \sigma \right)
			\\
			&= \tsem{\ploop{\mathds{B}}{\mathds{C}}}_\mathsf{C} \left( \tsem{\mathds{C}}_\mathsf{C}\left( \sigma \right) \right)
			\\
			& ??
		\end{align*}
	\item If $\tsem{\mathds{B}}_\sigma^\textsc{b} = \bot$, then we can proceed as follows.
		\begin{align*}
			&\mathbf{if}\ \bot\ \mathbf{then}\ \tsem{\mathds{C};\ploop{\mathds{B}}{\mathds{C}}}_\mathsf{C}\left( \sigma \right)\ \mathbf{else}\ \tsem{\pskip}_\mathsf{C}\left( \sigma \right)
			\\
			&= \tsem{\pskip}_\mathsf{C}\left( \sigma \right)
			\\
			&\subseteq S_{in} \text{ by original assumption}
			\\
			&\subseteq S_{out} \text{ as } M \subseteq M'.
		\end{align*}
\end{itemize}
\end{proof}
}

\lem \label{lem:R} For all $w_1, w_2, w, w' = (l', g', \mathcal{J}') \in \mathsf{World}$,
\[
	w_1 \bullet w_2 = w \land (l', g', \mathcal{J}') \in G(w_1) \implies ((w_2)_\mathsf{L}, g', \mathcal{J}') \in R(w_2)
\]

{\parindent0pt
\begin{proof}
Let's pick arbitrary $w_1, w_2, w, w' = (l', g', \mathcal{J}') \in \mathsf{World}$ such that:
\begin{gather}
	\label{lem:R1} w_1 \bullet w_2 = w \land
	\\
	\label{lem:R2} (l', g', \mathcal{J}') \in G(w_1)
\end{gather}

\textit{To show}: $((w_2)_\mathsf{L}, g', \mathcal{J}') \in R(w_2)$

From (\ref{lem:R2}) and the definition of $G$ we know that:
\begin{gather}
	\label{lem:R3} (l', g', \mathcal{J}') \in (G^c \cup G^u)^*(w_1)
\end{gather}

From (\ref{lem:R1}), (\ref{lem:R3}) and by Lemma \ref{lem:Ru}, Lemma \ref{lem:Rc} we get:
\[
	((w_2)_\mathsf{L}, g', \mathcal{J}') \in (R^c \cup R^u)^*(w_2)
\]
Therefore we can conclude the following.
\[
	((w_2)_\mathsf{L}, g', \mathcal{J}') \in R(w_2)
\]
\end{proof}
}

\lem \label{lem:Ru} For all $w_1, w_2, w, w' = (l', g', \mathcal{J}') \in \mathsf{World}$,
\[
	w_1 \bullet w_2 = w \land (l', g', \mathcal{J}') \in G^u(w_1) \implies ((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^u(w_2)
\]

{\parindent0pt
\begin{proof}
Let's pick arbitrary $w_1 = (l_1, g_1, \mathcal{J}_1), w_2 = (l_2, g_2, \mathcal{J}_2), w$ and $(l', g', \mathcal{J}') \in \mathsf{World}$, such that:
\begin{gather}
	\label{lem:Ru1} w_1 \bullet w_2 = w \land \\
	\label{lem:Ru2} (l', g', \mathcal{J}') \in G^u(w_1)
\end{gather}

\textit{To show}: $((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^u(w_2)$

From (\ref{lem:Ru1}) we know that
\begin{gather}
	\label{lem:Ru3} g_1 = g_2 \\
	\label{lem:Ru4} \mathcal{J}_1 = \mathcal{J}_2
\end{gather}

From the definition of $G^u$ and from (\ref{lem:Ru2}) and (\ref{lem:Ru4}) we know that:
\begin{gather}
	\label{lem:Ru5} \mathcal{J}' = \mathcal{J}_1 = \mathcal{J}_2 \land \\
	\label{lem:Ru6} ((l_1 \oplus g_1)_\mathsf{K})_\mathbb{K}^\bot = ((l' \oplus g')_\mathsf{K})_\mathbb{K}^\bot \land \\
		\label{lem:Ru7} (g_1 = g' \lor (\exists r, \kappa \leq (l_1)_\mathsf{K}(r) \ldotp (g_1, g') \in \lceil \mathcal{J}_1(r) \rceil(\kappa)
		\\ \land ((l_1 \oplus g_1)_\mathsf{M})_\mathbb{M}^\bot = ((l' \oplus g')_\mathsf{M})_\mathbb{M}^\bot )
\end{gather}

Given the disjunction in (\ref{lem:Ru7}), we need to consider two cases. \\

\textit{Case 1}: $g_1 = g'$

From (\ref{lem:Ru3}) and our assumption, we get that $g_2 = g'$. Now, from (\ref{lem:Ru5}), it follows that:
\begin{gather}
	\label{lem:Ru8} ((w_2)_\mathsf{L}, g', \mathcal{J}') = ((l_2, g_2, \mathcal{J}_2))
\end{gather}

From (\ref{lem:Ru8}) and the definition of $R^u$ we can conclude that:
\[
	((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^u((l_2, g_2, \mathcal{J}_2))
\]

\textit{Case 2}:
\begin{gather}
	\label{lem:Ru9} \exists r, \kappa \leq (l_1)_\mathsf{K}(r) \ldotp (g_1, g') \in \lceil \mathcal{J}_1(r) \rceil(\kappa)
	\\
	\label{lem:Ru10} \land ((l_1 \oplus g_1)_\mathsf{M})_\mathbb{M}^\bot = ((l' \oplus g')_\mathsf{M})_\mathbb{M}^\bot
\end{gather}

From (\ref{lem:Ru1}), (\ref{lem:Ru3}) and (\ref{lem:Ru4}) we know that:
\begin{gather}
	\label{lem:Ru11} w = (l_1 \circ l_2, g_2, \mathcal{J}_2)
\end{gather}

From the definition of $\mathsf{World}$ we know that $\pred{wf}{w}$ holds, and together with (\ref{lem:Ru3}) we have:
\begin{gather}
	\label{lem:Ru12} ((l_1 \circ l_2) \oplus g_2)_\mathsf{K} = (l_1)_\mathsf{K} \bullet_\mathbb{K} (l_2)_\mathsf{K} \bullet_\mathbb{K} \llfloor g_2 \rrfloor_\mathsf{K} = (l_1 \oplus g_1)_\mathsf{K} \bullet_\mathbb{K} (l_2)_\mathsf{K} \text{ defined}
	\\
	\label{lem:Ru13} \text{and } ((l_1 \circ l_2) \oplus g_1)_\mathsf{M} = (l_1 \oplus g_1)_\mathsf{M} \bullet_\mathbb{M} (l_2)_\mathsf{M} \text{ defined}
\end{gather}

From (\ref{lem:Ru9}) we obtain $\kappa \leq (l_1)_\mathsf{K}(r)$, from (\ref{lem:Ru12}) and Lemma \ref{lem:SepF}, we know:
\begin{gather}
	\label{lem:Ru14} \kappa\ \sharp \left( (l_2)_\mathsf{K} \bullet_\mathbb{K} \llfloor g_2 \rrfloor_\mathsf{K} \right)
\end{gather}

From (\ref{lem:Ru3}), (\ref{lem:Ru10}) and (\ref{lem:Ru13}) we know:
\begin{gather}
	\label{lem:Ru15} (l' \oplus g')_\mathsf{M} \bullet_\mathbb{M} (l_2)_\mathsf{M} = ((l' \circ l_2) \oplus g')_\mathsf{M} \text{ defined}
\end{gather}

From (\ref{lem:Ru6}) and (\ref{lem:Ru12}) we know:
\begin{gather}
	\label{lem:Ru16} (l' \oplus g')_\mathsf{K} \bullet_\mathbb{K} (l_2)_\mathsf{K} = ((l' \circ l_2) \oplus g')_\mathsf{K} \text{ defined}
\end{gather}

From (\ref{lem:Ru15}), (\ref{lem:Ru16}) we get that $(l_1' \circ l_2) \oplus g'$ is defined and as a consequence we obtain:
\begin{gather}
	\label{lem:Ru17} l_2 \oplus g' \text{ defined}
\end{gather}

From (\ref{lem:Ru5}), (\ref{lem:Ru9}), (\ref{lem:Ru14}), (\ref{lem:Ru17}) and the definition of $R^u$ we can conclude that:
\[
	((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^u((l_2, g_2, \mathcal{J}_2))
\]
\end{proof}
}

\lem \label{lem:Rc}  For all $w_1, w_2, w, w' = (l', g', \mathcal{J}') \in \mathsf{World}$,
\[
	w_1 \bullet w_2 = w \land (l', g', \mathcal{J}') \in G^c(w_1) \implies ((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^c(w_2)
\]

{\parindent0pt
\begin{proof}
Let's pick arbitrary $w_1 = (l_1, g_1, \mathcal{J}_1), w_2 = (l_2, g_2, \mathcal{J}_2), w$ and $w' = (l', g', \mathcal{J}') \in \mathsf{World}$, such that:
\begin{gather}
	\label{lem:Rc1} w_1 \bullet w_2 = w \land \\
	\label{lem:Rc2} (l', g', \mathcal{J}') \in G^c(w_1)
\end{gather}

\textit{To show}: $((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^c(w_2)$

From (\ref{lem:Ru1}) we know that
\begin{gather}
	\label{lem:Rc3} g_1 = g_2 \\
	\label{lem:Rc4} \mathcal{J}_1 = \mathcal{J}_2
\end{gather}

From the definition of $G^c$ and from (\ref{lem:Rc2}), (\ref{lem:Rc3}) and (\ref{lem:Rc4}) we know that:
\begin{gather}
	\label{lem:Rc5} \exists r, m, l, l_r, a, \rho \ldotp \pred{fresh}{r, w} \land \pred{dom}{\rho} = \{r\} \land
	\\
	\label{lem:Rc6} l_1 = l \circ l_r \land l' = l \circ (m, \rho) \land m \in \mathbf{0}_\mathbb{M} \land
	\\
	\label{lem:Rc10} g' = g_2[r \mapsto l_r] \land \mathcal{J}' = \mathcal{J}_2[r \mapsto a]
\end{gather}

From (\ref{lem:Rc1}) and (\ref{lem:Rc6}) we know that $(l_1 \circ l_2) \oplus g$ and that $l_1 = l \circ l_r$ are defined which implies that:
\begin{gather}
	\label{lem:Rc7} l_r \circ l_2 \text{ defined}
	\\
	\label{lem:Rc8} l_2 \oplus g_2 \text{ defined}
\end{gather}

Now, from (\ref{lem:Rc10}) we know that $g' = g_2[r \mapsto l_r]$ and together with (\ref{lem:Rc7}) and (\ref{lem:Rc8}) we obtain that:
\begin{gather}
	\label{lem:Rc9} l_2 \oplus g' \text{ defined}
\end{gather}

From (\ref{lem:Rc1}) and (\ref{lem:Rc5}) we obtain that:
\begin{gather}
	\label{lem:Rc11} \pred{fresh}{r, w_2}
\end{gather}

From (\ref{lem:Rc10}), (\ref{lem:Rc9}) and (\ref{lem:Rc11}) we can conclude that:
\[
	((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^c(w_2)
\]
\end{proof}
}

\lem \label{lem:SepF} Given any separation algebra $(\mathcal{M}, \bullet_\mathcal{M}, \mathbf{0}_\mathcal{M})$
\[
	\forall a, b, c, d \in \mathcal{M} \ldotp a \bullet_\mathcal{M} b = d \land c \leq b \implies \exists f \ldotp a \bullet_\mathcal{M} c = f
\]

{\parindent0pt
\begin{proof}
Let's pick arbitrary $a, b, c, d \in \mathcal{M}$ such that:
\begin{gather}
	\label{lem:SepF1} a \bullet_\mathcal{M} b = d
	\\
	\label{lem:SepF2} c \leq b
\end{gather}

From (\ref{lem:SepF2}) we obtain:
\begin{gather}
	\label{lem:SepF3} \exists e \in \mathcal{M} \ldotp c \bullet_\mathcal{M} e = b
\end{gather}

Now, as a consequence, from (\ref{lem:SepF1}) and (\ref{lem:SepF3}) we have:
\begin{gather}
	\label{lem:SepF4} a \bullet_\mathcal{M} \left( c \bullet_\mathcal{M} e \right) = d
\end{gather}

From (\ref{lem:SepF4}) and the associativity of a pcm we obtain:
\begin{gather}
	\label{lem:SepF5} \left( a \bullet_\mathcal{M} c \right) \bullet_\mathcal{M} e = d
\end{gather}

From (\ref{lem:SepF5}) we know that $a \bullet_\mathcal{M} c$ is defined which implies that $\exists f \in \mathcal{M} \ldotp a \bullet_\mathcal{M} c = f$ holds.
\end{proof}
}

\begin{lem}
	\label{lem:pred-i}
	(Predicate introduction).
	If $\tsem{\Delta}^\textsc{p} \subseteq \tsem{\Delta'}^\textsc{p}$ and $\Delta' \vdash \triple{P}{\mathds{P}}{Q}$ then $\Delta \vdash \triple{P}{\mathds{P}}{Q}$.
	\begin{proof}
		Let's pick arbitrary $\Delta, \Delta' \in \mathsf{Ax}, \mathds{P} \in \mathsf{Prog}, P, Q \in \mathsf{Assn}$ and assume that the following holds:
		\begin{gather}
			\label{lem:pred-i1} \tsem{\Delta}^\textsc{p} \subseteq \tsem{\Delta'}^\textsc{p} \\
			\label{lem:pred-i2} \land\ \Delta' \vDash \triple{P}{\mathds{P}}{Q}
		\end{gather}
		From (\ref{lem:pred-i1}) we obtain that:
		\begin{gather}
			\label{lem:pred-i3} \forall \delta \ldotp \delta \in \tsem{\Delta'}^\textsc{p} \implies \delta \in \tsem{\Delta}^\textsc{p}
		\end{gather}
		While from (\ref{lem:pred-i2}) and from the definition of $\vdash$ we know that:
		\begin{gather}
			\label{lem:pred-i4} \forall e, \delta \in \tsem{\Delta'}^\textsc{p} \ldotp
			\vDash \triple{\tsem{P}_{e, \delta}}{\mathds{P}}{\tsem{Q}_{e, \delta}}
		\end{gather}
		From (\ref{lem:pred-i3}) and (\ref{lem:pred-i4}) we conclude that:
		\[
			\forall e, \delta \in \tsem{\Delta}^\textsc{p} \ldotp
			\vDash \triple{\tsem{P}_{e, \delta}}{\mathds{P}}{\tsem{Q}_{e, \delta}}
		\]
		which from the definition of $\vdash$ means that $\Delta \vdash \triple{P}{\mathds{P}}{Q}$ as needed.
	\end{proof}
\end{lem}

\begin{defn}
	(Predicate environment similarity).
	We say that two predicate environments $\delta$ and $\delta'$ are \emph{similar up to predicate} $\alpha$, written $\delta \approx^\alpha \delta'$, if and only if:
	\[
		\forall \beta \ldotp \beta \neq \alpha \implies \delta(\beta) = \delta'(\beta)
	\]
\end{defn}

\begin{lem}
	\label{lem:simSat}
	(Similarity satisfaction).
	\[
		\forall e, \delta, \delta', \alpha, P \ldotp \delta \approx^\alpha \delta' \land \alpha \not\in P \implies \tsem{P}_{e, \delta} = \tsem{P}_{e, \delta'}
	\]
	{\parindent0pt
	\begin{proof}
		Let's pick arbitrary $e \in \mathsf{LEnv}, \delta, \delta' \in \mathsf{PEnv}, \alpha \in \mathsf{PName}, P \in \mathsf{Assn}$ and assume that $\delta \approx^\alpha \delta' \land \alpha \not\in P$ holds. We will now proceed with the proof using induction on the structure of assertion $P$. \\
		
		\textit{Base case 1}: $p \in \mathsf{Assn}$
		
		It trivially follows that $\tsem{p}_{e, \delta} = \tsem{p}_{e, \delta'}$ since the satisfaction of logic assertion $p$ does not depend on predicate environments $\delta$ and $\delta'$. In fact, we check for satisfaction of $p$ through $l, e \vDash_\mathsf{SL} p$. \\
		
		\textit{Base case 2}: $\beta(\mathds{E}_1, \ldots, \mathds{E}_n) \in \mathsf{Assn}$
		
		There are two cases to consider based on the predicate name $\beta$:
		\begin{itemize}
			\item If $\beta \neq \alpha$ then from our original assumption and the defition of $\approx^\alpha$ we obtain that $\tsem{\beta(\mathds{E}_1, \ldots, \mathds{E}_n)}_{e, \delta} = \tsem{\beta(\mathds{E}_1, \ldots, \mathds{E}_n)}_{e, \delta'}$ holds.
			
			\item It can never be the case that $\beta = \alpha$ since we initially assumed that $\alpha \not\in P$.
		\end{itemize}
		
		\textit{Inductive case}: $Q \lor R \in \mathsf{Assn}$
		
		\textit{Inductive hypothesis}: Assume that $\tsem{Q}_{e, \delta} = \tsem{Q}_{e, \delta'}$ and $\tsem{R}_{e, \delta} = \tsem{R}_{e, \delta'}$ holds.
		
		By the assertions satisfaction definition on the $\lor$ case, we are required to show that, for any world $w \in \mathsf{World}$:
		\begin{gather}
			w, e, \delta \vDash Q \lor w, e, \delta \vDash R \\
			\iff \\
			w, e, \delta' \vDash Q \lor w, e, \delta' \vDash R
		\end{gather}
		Both the \textit{if} and the \textit{only if} parts of the proof are directly satisfied by the I.H. on assertions $Q$ and $R$. All other inductive cases are similar to the presented one and follow straight from their I.H.
	\end{proof}
	}
\end{lem}

\begin{lem}
	\label{lem:pred-e}
	(Predicate elimination).
	If $\forall \delta \in \tsem{\Delta}^\textsc{p} \ldotp \mathsf{stable}_\delta(R)$ and $\alpha \not\in \Delta, P, Q$ and $\Delta, (\forall \vec{x} \ldotp \alpha(\vec{x}) \equiv R) \vdash \triple{P}{\mathds{P}}{Q}$ then $\Delta \vdash \triple{P}{\mathds{P}}{Q}$.
	\begin{proof}
		Let's pick arbitrary $\Delta \in \mathsf{Ax}, \mathds{P} \in \mathsf{Prog}, \alpha \in \mathsf{PName}, P, Q, R \in \mathsf{Assn}$ and assume that the following holds:
		\begin{gather}
			\label{lem:pred-e1} \forall \delta \in \tsem{\Delta}^\textsc{p} \ldotp \mathsf{stable}_\delta(R) \\
			\label{lem:pred-e2} \land\ \alpha \not\in \Delta, P, Q \\
			\label{lem:pred-e4} \land\ \Delta, (\forall \vec{x} \ldotp \alpha(\vec{x}) \equiv R) \vDash \triple{P}{\mathds{P}}{Q}
		\end{gather}
		We now pick arbitrary $\delta \in \tsem{\Delta}^\textsc{p}$ and $\delta' \in \tsem{\Delta, (\forall \vec{x} \ldotp \alpha(\vec{x}) \equiv R)}^\textsc{p}$. From (\ref{lem:pred-e1}), (\ref{lem:pred-e2}) and the definition of $\tsem{-}^\textsc{p}$ we obtain that:
		\begin{gather}
			\label{lem:pred-e3} \delta \approx^\alpha \delta'
		\end{gather}
		From (\ref{lem:pred-e2}), (\ref{lem:pred-e4}), (\ref{lem:pred-e3}) and Lemma \ref{lem:simSat} we conclude that $\Delta \vdash \triple{P}{\mathds{P}}{Q}$.
	\end{proof}
\end{lem}