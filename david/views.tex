\section{Program Logic}

\subsection{Model}

\defn (Separation algebra). A separation agebra $(\mathcal{M}, \bullet, I)$ is a partial, commutative monoid, with multiple units where $\mathcal{M}$ is a set equipped with a partial operator $\bullet : \mathcal{M} \times \mathcal{M} \rightharpoonup \mathcal{M}$ and a unit set $I \subseteq \mathcal{M}$ satisfying:
\begin{itemize}
\item Commutativity: $m_1 \bullet m_2 = m_2 \bullet m_1$ when either is defined.
\item Associativity: $m_1 \bullet (m_2 \bullet m_3) = (m_1 \bullet m_2) \bullet m_3$ when either is defined.
\item Existence of unit: for all $m \in \mathcal{M}$ there exists $i \in I$ such that $i \bullet m = m$.
\item Minimality of unit: for all $m \in \mathcal{M}$ and $i \in I$, if $i \bullet m$ is defined then $i \bullet m = m$.
\item Cancellativity: for all $m_1, m_2, y, z \in \mathcal{M}$ if $m_1 \bullet y = z$ and $m_2 \bullet y = z$ then $m_1 = m_2$.
\end{itemize}

\defn (Ordering). Given a separation algebra $(\mathcal{M}, \bullet, \mathbf{0})$, the ordering relation $\leq : \mathcal{M} \times \mathcal{M}$ is defined as:
\[
	\leq \triangleq \{ (m_1, m_2)\ |\ \exists m \ldotp m_1 \bullet m = m_2 \}
\]
We write $m_1 \leq m_2$ for $(m_1, m_2) \in \leq$.

\defn (Compatibility). Given a separation algebra $(\mathcal{M}, \bullet, \mathbf{0})$, the compatibility property $\sharp : \mathcal{M} \times \mathcal{M}$ is defined as:
\[
	\sharp \triangleq \{ (m_1, m_2)\ |\ \exists m \ldotp m_1 \bullet m_2 = m \}
\]

\defn (Orthogonal). Given a separation algebra $(\mathcal{M}, \bullet, \mathbf{0})$ and an element $m \in \mathcal{M}$, its orthogonal $(-)^\bot_\mathcal{M} : \mathcal{M} \rightarrow \mathcal{P}(\mathcal{M})$ is the set of all elements in $\mathcal{M}$ which are compatible with it.
\[
	(m)^\bot_\mathcal{M} \triangleq \{m'\ |\ m\ \sharp\ m' \}
\]

\defn (Cross-split property) A separation agebra $(\mathcal{M}, \bullet, I)$ complies with the cross-split property iff:
\begin{gather*}
	\forall a, b, c, d, z \ldotp a \bullet b = z \land c \bullet d = z \implies \\ \exists ac, ad, bc, bd \ldotp ac \bullet ad = a \land ac \bullet bc = c \land bc \bullet bd = b \land ad \bullet bd = d
\end{gather*}

\defn (Region identifiers). We define the set of region identifiers $\mathsf{Rid}$, ranged over by $r, r_1, \ldots, r_n$, to be equivalent to the set $\mathsf{Val}$.

\param (Machine states separation algebra). Let $(\mathbb{M}, \bullet_\mathbb{M}, \mathbf{0}_\mathbb{M})$ be any separation algebra satisfying the cross-split property, which represents machine states where elements of $\mathbb{M}$ are ranged over by $m, m_1, \ldots, m_n$. In the scenario of transactions reasoning, we instantiate the separation algebra to $(\mathsf{State}, \uplus, \emptyset)$, where $\uplus$ is the union of partial functions with disjoint domains.

\param (Capability separation algebra). Let $(\mathbb{K}, \bullet_\mathbb{K}, \mathbf{0}_\mathbb{K})$ be any separation algebra satisfying the cross-split property which represents capability resources where elements of $\mathbb{K}$ are ranged over by $\kappa, \kappa_1, \ldots, \kappa_n$.

\defn (Region capabilities). Given a separation algebra for capabilities, $(\mathbb{K}, \bullet_\mathbb{K}, \mathbf{0}_\mathbb{K})$, we define the set $\mathsf{RKap}$ to contain all mappings from region identifiers to such capabilities as:
\[
	\mathsf{RKap} \triangleq \mathsf{Rid} \overset{\text{fin}}{\rightharpoonup} \mathbb{K}
\]
We range over elements of the $\mathsf{RKap}$ set using $\rho, \rho_1, \ldots, \rho_n$. Composition on region capabilities, formally $\circ : \mathsf{RKap} \times \mathsf{RKap} \rightharpoonup \mathsf{RKap}$, is defined as follows:
\begin{align*}
	\rho \circ \rho' &\triangleq \pred{comp}{\pred{dom}{\rho} \cup \pred{dom}{\rho'}, \rho, \rho'}
	\\
	\pred{comp}{\emptyset, -, -} &\triangleq \emptyset
	\\
	\pred{comp}{\{r\} \cup R, \rho, \rho'} &\triangleq \rho''[r \mapsto (\hat{\rho}(r) \bullet_\mathbb{K} \hat{\rho}'(r))]
	\\ &\text{where } \rho'' = \pred{comp}{R, \rho, \rho'}
\end{align*}
Where $\mathsf{comp} : \left( \mathcal{P}(\mathsf{Rid}) \times \mathsf{RKap} \times \mathsf{RKap} \right) \rightarrow \mathsf{RKap}$ and $\hat{-} : \mathsf{RKap} \rightarrow \mathsf{Rid} \rightarrow \mathbb{K}$ is defined in the following way.
\[
	\hat{\rho}(r) \triangleq
		\begin{cases}
			\rho(r), & \text{if } r \in \pred{dom}{\rho}
			\\
			\mathbf{0}_\mathbb{K}, & \text{otherwise}
		\end{cases}
\]

\defn (Logical states). Given a separation algebra for machine states $(\mathbb{M}, \bullet_\mathbb{M}, \mathbf{0}_\mathbb{M})$, and one for capabilities $(\mathbb{K}, \bullet_\mathbb{K}, \mathbf{0}_\mathbb{K})$, a logical state is a pair $(m, \rho)$ where $m \in \mathbb{M}$ is a machine state and $\rho \in \mathsf{RKap}$ is a region capability.
\[
	\mathsf{LState} \triangleq \mathbb{M} \times \mathsf{RKap}
\]
When referring to an arbitrary logical state or a local state we use $l, l_1, \ldots, l_n$. We define the unit logical state as $\mathbf{0}_\mathsf{L} \triangleq (\mathbf{0}_\mathbb{M}, \emptyset)$ and given a logical state $l$ we use $l_\mathsf{M}$ and $l_\mathsf{K}$ to refer to its first and second projections respectively. The composition of logical states, formally $\circ : \mathsf{LState} \times \mathsf{LState} \rightharpoonup \mathsf{LState}$, is defined as:
\[
	(m, \rho) \circ (m', \rho') \triangleq (m \bullet_\mathbb{M} m', \rho \circ \rho')
\]
The separation algebra of logical states is thus $(\mathsf{LState}, \circ, \mathbf{0}_\mathsf{L})$.

\defn (Shared states). We define the set of shared states $\mathsf{GState}$, ranged over by $g, g_1, \ldots g_n$, as a finite partial function mapping region identifiers to logical states.
\[
	\mathsf{GState} \triangleq \mathsf{Rid} \overset{\text{fin}}{\rightharpoonup} \mathsf{LState}
\]
The $\llfloor - \rrfloor : \mathsf{GState} \rightarrow \mathsf{LState}$ operator, which extracts all logical states from shared regions, is defined as:
\[
	\llfloor g \rrfloor \triangleq \prod^{\circ}_{r \in \pred{dom}{g}} g(r)
\]

We also define the \textit{cross-composition} between logical states and shared states, $\circ : \mathsf{LState} \times \mathsf{GState} \rightharpoonup \mathsf{LState}$, as:
\[
	l \circ g \triangleq l \circ \llfloor g \rrfloor
\]

\defn (Action models). The set of actions $\mathsf{Actions}$, is defined as:
\[
	\mathsf{Action} \triangleq \mathsf{LState} \times \mathsf{LState}
\]
The set of action models, $\mathsf{AMod}$, is defined as follows.
\[
	\mathsf{AMod} \triangleq \mathsf{Rid} \overset{\text{fin}}{\rightharpoonup} \mathbb{K} \overset{\text{fin}}{\rightharpoonup} \mathcal{P}(\mathsf{Action})
\]
We use $\mathcal{J}, \mathcal{J}_1, \ldots, \mathcal{J}_n$ to range over action models and we write $\emptyset$ for an action model with an empty domain.

\defn (Capability containment). A region capability $\rho \in \mathsf{RKap}$ is defined to be contained in an action model $\mathcal{J} \in \mathsf{AMod}$ as follows.
\[
	\rho \prec \mathcal{J} \iff \forall r \in \pred{dom}{\rho} \ldotp \exists \kappa \in \pred{dom}{\mathcal{J}(r)} \ldotp \rho(r) \leq \kappa
\]
The above describes that any capability associated to any region in $\rho$ must be accounted for in the domain of the mapping associated to the same region in $\mathcal{J}$.

\defn (Well-formedness). We define for a tuple $(l, g, \mathcal{J})$ to be well-formed in the following way.
\[
	\pred{wf}{l, g, \mathcal{J}} \iff \exists m, \rho \ldotp l \circ g = (m, \rho) \land \rho \prec \mathcal{J}
\]

\defn (World). The set of all worlds $\mathsf{World}$ is ranged over by $w, w_1, \ldots w_n$ and defined as the set of tuples containing a local state, a global one and an action model:
\[
	\mathsf{World} \triangleq \{ w \in \mathsf{LState} \times \mathsf{GState} \times \mathsf{AMod}\ |\ \pred{wf}{w} \}
\]
We write $w_\mathsf{L}, w_\mathsf{S}$ and $w_\mathsf{A}$ for the first, second and third projections of a world $w$. Composition on worlds, $\bullet : \mathsf{World} \rightarrow \mathsf{World} \rightharpoonup \mathsf{World}$, is defined by composing local states and requiring that shared states and action models be identical.
\[
	(l, g, \mathcal{J}) \bullet (l', g', \mathcal{J}') \triangleq
	\begin{cases}
		(l \circ l', g, \mathcal{J}), & \text{if } g = g' \text{ and } \mathcal{J} = \mathcal{J}' \\ & \text{and } \pred{wf}{(l \circ l', g, \mathcal{J})}
		\\
		\mathsf{undef} & \text{otherwise}
	\end{cases}
\]

\subsection{Assertions}

We assume the presence of an infinite set of logical variables, $x \in \mathsf{LVar}$, logical expressions, $E \in \mathsf{LExpr}$, and logical environments, $\mathsf{LEnv}$, such that $e \in \mathsf{LEnv} : \mathsf{LVar} \rightarrow \mathsf{Val}$. Logical environments associate logical variables with their values.

\param (Machine state assertions). We define the set of machine state assertions $\mathsf{MAssn}$, ranged over by $\mathcal{M}, \mathcal{M}_1, \ldots, \mathcal{M}_n$ as:
\[
	\mathcal{M} \in \mathsf{MAssn} ::= x = E\ |\ E_1 \mapsto E_2
\]
We also provide an associated semantics function that maps such assertions to elements of the machine state separation algebra, $\tsem{-}_-^\textsc{m} : \mathsf{MAssn} \rightarrow \mathsf{LEnv} \rightarrow \mathcal{P}(\mathbb{M})$.
\begin{align*}
	\tsem{x = E}^\textsc{m}_e &\triangleq \{ h \in \mathbb{M}\ |\ e(x) = \tsem{E}^\textsc{e}_e \}
	\\
	\tsem{E_1 \mapsto E_2}_e^\textsc{m} &\triangleq \{ h\ |\ \pred{dom}{h} = \{\tsem{E_1}_e^\textsc{e}\} \land h(\tsem{E_1}_e^\textsc{e}) = \tsem{E_2}_e^\textsc{e} \}
\end{align*}
It is assumed that the operator for logical expressions semantics, $\tsem{-}_-^\textsc{e} : \mathsf{LExpr} \rightarrow \mathsf{LEnv} \rightarrow \mathsf{Val}$, is appropriately defined.

\param (Capability assertions). Assume a set of capability assertions $\mathsf{KAssn}$ ranged over by $\mathcal{K}, \mathcal{K}_1, \ldots, \mathcal{K}_n$ and an associated semantics function that maps such assertions to elements of the capability separation algebra given as $(\mathbb{K}, \bullet_\mathbb{K}, \mathbf{0}_\mathbb{K})$:
\[
	\tsem{-}_-^\textsc{k} : \mathsf{KAssn} \rightarrow \mathsf{LEnv} \rightarrow \mathcal{P}(\mathbb{K})
\]

\defn (Assertion syntax). Assertions are elements of the $\mathsf{Assn}$ set defined by the following grammar, where $x \in \mathsf{LVar}$ and $r \in \mathsf{LExpr}$.
\begin{align*}
A &::= \mathtt{false}\ |\ \mathtt{emp}\ |\ \mathcal{M}\ |\ \mathcal{K} \\
p, q \in \mathsf{LAssn} &::= A\ |\ \lnot p\ |\ \exists x \ldotp p\ |\ p \lor q\ |\ p \sep q\ |\ p \sepimp q \\
P, Q \in \mathsf{Assn} &::= p\ |\ \exists x \ldotp P\ |\ P \lor Q\ |\ P \sep Q\ |\ \boxed{P}_I^r \\
I \in \mathsf{IAssn} &::= \emptyset\ |\ \{ \mathcal{K} : \exists \vec{y} \ldotp P \leadsto Q \} \cup I
\end{align*}

\defn (Assertion semantics). Assertion semantics are given with respect to a world $w \in \mathsf{World}$ and a logical environment $e \in \mathsf{LEnv}$.
\begingroup
\renewcommand*{\arraystretch}{1.5}
\[
\begin{array}{r c l}
	(l, g, \mathcal{J}), e \vDash p
	&
	\iff
	&
	l, e \vDash_\mathsf{SL} p
\\
	(l, g, \mathcal{J}), e \vDash \boxed{P}_I^r
	&
	\iff
	&
	l = \mathbf{0}_\mathbb{M} \text{ and } \exists l' \ldotp (l', g, \mathcal{J}) \vDash P
	\\ && \text{and } g(\tsem{r}_e^\textsc{e}) = l' \text{ and } \mathcal{J}(\tsem{r}_e^\textsc{e}), e \vDash_\mathcal{J} I
\\
	w, e \vDash \exists x \ldotp P
	&
	\iff
	&
	\exists v \ldotp w, e[x \mapsto v] \vDash P
\\
	w, e \vDash P \lor Q
	&
	\iff
	&
	w, e \vDash P \text{ or } w, e \vDash Q
\\
	w, e \vDash P \sep Q
	&
	\iff
	&
	\exists w_1, w_2 \ldotp w = w_1 \bullet w_2 \text{ and } \\ && w_1, e \vDash P \text{ and } w_2, e \vDash Q
\\
	a, e \vDash_\mathcal{J} \emptyset
	&
	\iff	
	&
	a = \emptyset
\\
	a, e \vDash_\mathcal{J} \{ \mathcal{K} : \exists \vec{y} \ldotp P \leadsto Q \} \cup I
	&
	\iff
	&
	a \setminus \tsem{\mathcal{K}}_e^\textsc{k}, e \vDash_\mathcal{J} I \text{ and } \\ && \forall \kappa \in \tsem{\mathcal{K}}_e^\textsc{k}, l_P, l_Q \ldotp (l_P, l_Q) \in a(\kappa) \\ && \text{implies } \exists \vec{v} \text{ such that } (l_P, \emptyset, \mathcal{J}), e[\vec{y} \mapsto \vec{v}] \vDash P \\ && \text{and } (l_Q, \emptyset, \mathcal{J}), e[\vec{y} \mapsto \vec{v}] \vDash Q
\\
	l, e \vDash_\mathsf{SL} \mathtt{false}
	&&
	\text{never}
\\
	l, e \vDash_\mathsf{SL}  \mathtt{emp}
	&
	\iff
	&
	l = \mathbf{0}_\mathsf{L}
\\
	l, e \vDash_\mathsf{SL} \mathcal{M}
	&
	\iff
	&
	\exists m \ldotp l = (m, \emptyset) \text{ and } m \in \tsem{\mathcal{M}}_e^\textsc{m}
\\
	l, e \vDash_\mathsf{SL} \mathcal{K}
	&
	\iff
	&
	\exists r, \kappa \ldotp l = (\mathbf{0}_\mathbb{M}, \emptyset[r \mapsto \kappa]) \text{ and } \kappa \in \tsem{\mathcal{K}}_e^\textsc{k}
\\
	l, e \vDash_\mathsf{SL} \lnot p
	&
	\iff
	&
	l, e \not\vDash_\mathsf{SL} p
\\
	l, e \vDash_\mathsf{SL} p \sepimp q
	&
	\iff
	&
	\exists l' \ldotp l', e \vDash_\mathsf{SL} p \text{ and } l \sharp l' \text{ implies } \\
	&& l \circ l', e \vDash_\mathsf{SL} q
\\
	l, e \vDash_\mathsf{SL} p \sep q
	&
	\iff
	&
	\exists l_1, l_2 \ldotp l = l_1 \circ l_2 \text{ and } \\
	&& l_1, e \vDash_\mathsf{SL} p \text{ and } l_2, e \vDash_\mathsf{SL} q
\\
	 l, e \vDash_\mathsf{SL} p \lor q
	 &
	 \iff
	 &
	 l, e \vDash_\mathsf{SL} p \text{ or } l, e \vDash_\mathsf{SL} q
\\
	l, e \vDash_\mathsf{SL} \exists x \ldotp p
	&
	\iff
	&
	\exists v \ldotp l, e[x \mapsto v] \vDash_\mathsf{SL} p
\end{array}
\]
\endgroup

Given a logical environment $e \in \mathsf{LEnv}$, we write $\tsem{P}_e$ for the set of all worlds satisfying assertion $P$.
\[
	\tsem{P}_e \triangleq \{ w\ |\ w, e \vDash P \}
\]

\subsection{Environment semantics}

\defn (Rely region construction). The rely construction relation $R^c$ between worlds, models how the environment can create a new region.
\[
\begin{array}{r | l}
	R^c \triangleq \bigg\{ (w, w')
	&
	\begin{array}{r}
		\exists r, l, a \ldotp \pred{fresh}{r, w} \land w'_\mathsf{L} = w_\mathsf{L} \land w'_\mathsf{S} = w_\mathsf{S}[r \mapsto l] \land
		\\
		w'_\mathsf{L} \circ w'_\mathsf{S} \text{ defined} \land w'_\mathsf{A} = w_\mathsf{A}[r \mapsto a] \land (w'_\mathsf{L})_\mathsf{K}(r) = \mathbf{0}_\mathbb{K}
	\end{array}
	\bigg\}
\end{array}
\]

\defn (Rely region update).
\[
	R^u \triangleq \{ \left( (l, g, \mathcal{J}), (l, g', \mathcal{J}) \right)\ |\ \exists r, \kappa \ldotp  \kappa\ \sharp\ (l \circ g)_\mathsf{K}(r) \land (g, g') \in \lceil \mathcal{J}(r) \rceil (\kappa) \}
\]
Where the $\lceil - \rceil : \left( \mathbb{K} \rightarrow \mathcal{P}(\mathsf{Action}) \right) \times \mathbb{K} \rightarrow \mathcal{P}(\mathsf{Action})$ operator is defined as:
\[
	\lceil a \rceil (\kappa) \triangleq \{ (p \circ f, q \circ f)\ |\ (p, q) \in a(\kappa) \land f \in \mathsf{LState} \}
\]

\param (Rely relation).
\[
	R \triangleq (R^c \cup R^u)^*
\]
%\[
%\begin{array}{r | l}
%	R^u \triangleq \bigg\{ (w, w')
%	&
%	\begin{array}{r}
%	
%	\end{array}
%	\bigg\}
%\end{array}
%\]

\defn (Stability). An assertion $P$ is said to be stable, $\pred{stable}{P}$, if, for all $e \in \mathsf{LEnv}$ and $w, w' \in \mathsf{World}$, if $w, e \vDash P$ and $(w, w') \in R$, then $w', e \vDash P$.

\defn (Guarantee region construction). The guarantee construction relation $R^c$ between worlds, models how a thread can create a new region. We leave region destruction as implicit, i.e. the user can encode it as a special action in the action model associated to the region, which gets rid of everything inside of it.
\[
\begin{array}{r | l}
	G^c \triangleq \Bigg\{ (w, w')
	&
	\begin{array}{c}
		\exists r, m, l, a, \rho, \rho' \ldotp \pred{fresh}{r, w} \land \pred{dom}{\rho'} = \{r\} \land
		\\
		w_\mathsf{L} = (m, \rho) \circ l \land w'_\mathsf{L} = l \circ (\mathbf{0}_\mathbb{M}, \rho') \land
		\\
		w'_\mathsf{S} = w_\mathsf{S}[r \mapsto (m, \rho) ] \land w'_\mathsf{A} = w_\mathsf{A}[r \mapsto a]
	\end{array}
	\Bigg\}
\end{array}
\]

Where we define a region identifier to be \textit{fresh}, with respect to a given world, as follows:
\[
\begin{array}{r l}
	\pred{fresh}{r, (l, g, \mathcal{J})} \iff
	&
	r \not\in \pred{dom}{g} \cup \pred{dom}{\mathcal{J}} \cup \pred{dom}{l_\mathsf{K}} \cup \left( \bigcup_{r' \in \pred{dom}{g}} \pred{dom}{g(r')_\mathsf{K}} \right)
	\\
	& \cup \left( \bigcup_{r \in \pred{dom}{\mathcal{J}}} \bigcup_{(l_1, l_2) \in \pred{ran}{\mathcal{J}(r)}} \pred{dom}{(l_1)_\mathsf{K}} \cup \pred{dom}{(l_2)_\mathsf{K}} \right)
\end{array}	
\]

\defn (Guarantee region update).
\[
\begin{array}{r | l}
	G^u \triangleq \Bigg\{ ((l, g, \mathcal{J}), (l', g', \mathcal{J}))
	&
	\begin{array}{c}
		((l \circ g)_\mathsf{K})_\mathbb{K}^\bot = ((l' \circ g')_\mathsf{K})_\mathbb{K}^\bot \land \\
		(g = g' \lor \exists r, \kappa \leq l_\mathsf{K}(r) \ldotp (g, g') \in \lceil \mathcal{J}(r) \rceil(\kappa)  \\ \land ((l \circ g)_\mathsf{M})_\mathbb{M}^\bot = ((l' \circ g')_\mathsf{M})_\mathbb{M}^\bot )
	\end{array}
	\Bigg\}
\end{array}
\]

\defn (Guarantee relation).
\[
	G \triangleq (G^c \cup G^u)^*
\]

\defn (Repartitioning). $P \Rrightarrow^{\{p\}\{q\}} Q$ holds iff, for every logical environment $e \in \mathsf{LEnv}$, and world $w_1 = (l_1, g_1, \mathcal{J}_1) \in \mathsf{World}$ such that $w_1, e \vDash P$, there exists a states $m_1, m' \in \mathbb{M}$, such that:
\begin{itemize}
\item $(m_1, \emptyset), e \vDash_\mathsf{SL} p$ and
\item $m_1 \bullet_\mathbb{M} m' = (l_1 \circ g_1)_\mathsf{M}$ and
\item for every $m_2 \in \mathbb{M}$ where $(m_2, \emptyset), e \vDash_\mathsf{SL} q$, there exists a world $w_2 = (l_2, g_2, \mathcal{J}_2) \in \mathsf{World}$ such that $w_2, e \vDash Q$ and
	\begin{itemize}
		\item $m_2 \bullet_\mathbb{M} m' = (l_2 \circ g_2)_\mathsf{M}$
		\item $(w_1, w_2) \in G$
	\end{itemize}
\end{itemize}

We write $P \Rrightarrow Q$ in order to express $P \Rrightarrow^{\{\mathtt{emp}\}\{\mathtt{emp}\}}Q$. The latter allows the shared state to be reorganized around but not mutated.

\subsection{Soundness}

\param (Elementary command axioms). Given the separation algebra of machine states $(\mathbb{M}, \bullet_\mathbb{M}, \mathbf{0}_\mathbb{M})$ we define the set of axioms $\textsc{Ax}_{\hat{\mathsf{C}}} : \mathcal{P}(\mathbb{M}) \times \mathsf{Cmd} \times \mathcal{P}(\mathbb{M})$ as follows.
\begin{gather*}
	\infer[\textsc{Write}]
	{
		\vdash
		\triple
			{E_1 \mapsto -}
			{\pmutate{E_1}{E_2}}
			{E_1 \mapsto E_2}
	}
	{}
	\\
	\infer[\textsc{Read}]
	{
		\vdash
		\triple
			{\pvar{x} \doteq E_1 \sep \cell{E}{E_2}}
			{\pderef{\pvar{x}}{E}}
			{\pvar{x} \doteq E_2[E_1/\pvar{x}] \sep \cell{E[E_1/\pvar{x}]}{E_2[E_1/\pvar{x}]}}
	}
	{}
	\\
	\infer[\textsc{Assign}]
	{
		\vdash
		\triple
			{P}
			{\passign{\pvar{x}}{E}}
			{\exists x \ldotp \pvar{x} \doteq E[x/\pvar{x}] \sep P[x/\pvar{x}]}	
	}
	{}
	\\
	\infer[\textsc{Alloc}]
	{
		\vdash
		\triple
			{\mathtt{emp}}
			{\palloc{\pvar{x}}{E}}
			{\exists y \ldotp \pvar{x} \doteq y \sep \circledast_{0 \leq i < E} \left(\cell{y + i}{0}\right)}
	}
	{}
\end{gather*}

\param (Sequential command axioms). Given the axiomatisation of elementary commands $\textsc{Ax}_{\hat{\mathsf{C}}}$, we now define the axioms of sequential commands, formally $\textsc{Ax}_\mathsf{C} : \mathcal{P}(\mathbb{M}) \times \mathsf{Cmd} \times \mathcal{P}(\mathbb{M})$.
\begin{align*}
	\textsc{Ax}_\mathsf{C} &\triangleq \textsc{Ax}_{\hat{\mathsf{C}}} \cup \textsc{Ax}_{\textsc{skip}} \cup \textsc{Ax}_{\textsc{seq}} \cup \textsc{Ax}_{\textsc{cond}} \cup \textsc{Ax}_{\textsc{loop}}
	\\
	\textsc{Ax}_{\textsc{skip}} &\triangleq \{ (M, \pskip, M)\ |\ M \in \mathcal{P}(\mathbb{M}) \}
	\\
	\textsc{Ax}_{\textsc{seq}} &\triangleq \{ (M, \mathds{C}_1 ; \mathds{C}_2, M')\ |\ (M, \mathds{C}_1, M'') \in \textsc{Ax}_\mathsf{C} \land (M'', \mathds{C}_2, M') \in \textsc{Ax}_\mathsf{C} \}
	\\
	\textsc{Ax}_{\textsc{cond}} &\triangleq \{ (M, \pif{\mathds{B}}{\mathds{C}_1}{\mathds{C}_2}, M')\ |\ (M, \mathds{C}_1, M') \in \textsc{Ax}_\mathsf{C} \land (M, \mathds{C}_2, M') \in \textsc{Ax}_\mathsf{C} \}
	\\
	\textsc{Ax}_{\textsc{loop}} &\triangleq \{ (M, \ploop{\mathds{B}}{\mathds{C}}, M)\ |\ (M, \mathds{C}, M) \in \textsc{Ax}_\mathsf{C}) \}
\end{align*}
Where $M, M'$ and $M''$ are used to quantify over elements of $\mathcal{P}(\mathbb{M})$.

\param (Transaction axioms). Given the axiomatisation of sequential commands $\textsc{Ax}_\mathsf{C}$ we define the set of transactions axioms, $\textsc{Ax}_\mathsf{T} : \mathcal{P}(\mathsf{World}) \times \mathsf{Trans} \times \mathcal{P}(\mathsf{World})$ as:
\[
	\textsc{Ax}_\mathsf{T} \triangleq \{ (W, \ptdef{\mathds{C}}_\iota, W')\ |\ (M_1, \mathds{C}, M_2) \in \textsc{Ax}_\mathsf{C} \land W \Rrightarrow^{\{M_1\}\{M_2\}} W' \}
\]
Where $W$ and $W'$ are used to quantify over elements of $\mathcal{P}(\mathsf{World})$.

\defn (Proof rules). All proof rules that follow carry the implicit assumption that the preconditions and postcondition of their judgements are stable.
\begin{gather*}
\begin{array}{c c}
	\infer[\textsc{Skip}]
	{
		\vdash \triple{P}{\pskip}{P}
	}
	{}
&
	\infer[\textsc{Trans}]
	{
		\vdash \triple{P}{\mathds{T}}{Q}
	}
	{
		\forall e \ldotp (\tsem{P}_e, \mathds{T}, \tsem{Q}_e) \in \textsc{Ax}_\mathsf{T}
	}
\end{array}
\\ \\
\begin{array}{c c}
	\infer[\textsc{Seq}]
	{
		\vdash \triple{P}{\mathds{P}_1 ; \mathds{P}_2}{Q}
	}
	{
		\vdash \triple{P}{\mathds{P}_1}{R}
		&
		\vdash \triple{R}{\mathds{P}_2}{Q}	
	}
&
	\infer[\textsc{Par}]
	{
		\vdash \triple{P_1 \sep P_2}{\mathds{P}_1 \| \mathds{P}_2}{Q_1 \sep Q_2}	
	}
	{
		\vdash \triple{P_1}{\mathds{P}_1}{Q_1}
		&
		\vdash \triple{P_2}{\mathds{P}_2}{Q_2}	
	}
\end{array}
\\ \\
\begin{array}{c c}
	\infer[\textsc{Frame}]
	{
		\vdash \triple{P \sep R}{\mathds{P}}{Q \sep R}	
	}
	{
		\vdash \triple{P}{\mathds{P}}{Q}
	}
&
	\infer[\textsc{Conseq}]
	{
		\vdash \triple{P}{\mathds{P}}{Q}	
	}
	{
		P \Rrightarrow P'
		&
		\vdash \triple{P'}{\mathds{P}}{Q'}
		&
		Q' \Rrightarrow Q	
	}
\end{array}
\\ \\
\begin{array}{c c}
	\infer[\textsc{Choice}]
	{
		\vdash \triple{P}{\mathds{P}_1 + \mathds{P}_2}{Q}	
	}
	{
		\vdash \triple{P}{\mathds{P}_1}{Q}
		&
		\vdash \triple{P}{\mathds{P}_2}{Q}
	}
&
	\infer[\textsc{Loop}]
	{
		\vdash \triple{P}{\mathds{P}^*}{P}	
	}
	{
		\vdash \triple{P}{\mathds{P}}{P}
	}
\end{array}
\end{gather*}

\param (Concrete states). The set of concrete states $\mathcal{S}$ is defined to be equivalent to the $\mathsf{State}$ one. Thus we range over it using $h, h_1, \ldots, h_n$.

%\param (Elementary command interpretation). The elementary command interpretation function, formally $\tsem{-}_{\hat{\mathsf{C}}}^s : \mathsf{ECmd} \rightarrow \mathcal{S} \rightarrow \mathcal{P}(\mathcal{S})$ is defined in the following way.
%\[
%	\tsem{\hat{\mathds{C}}}_{\hat{\mathsf{C}}}^s \triangleq \{ h'\ |\ (h, s, \hat{\mathds{C}}) \rightarrow_\textsc{c} (h', s', \pskip) \}
%\]

%\defn (Sequential command interpretation). The sequential command interpretation function, formally $\tsem{-}_\mathsf{C}^s : \mathsf{Cmd} \rightarrow \mathcal{S} \rightarrow \mathcal{P}(\mathcal{S})$ is defined in the following way.

\param (Elementary commands interpretation). The interpretation function for elementary commands, formally $\tsem{-}_{\hat{\mathsf{C}}} : \mathsf{ECmd} \times \mathsf{Stack} \rightarrow \mathcal{S} \rightarrow \mathcal{P}(\mathcal{S} \times \mathsf{Stack})$, is defined as:
\begin{align*}
	\tsem{\passign{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}}(h, s) &\triangleq \{ (h, s[\pvar{x} \mapsto \tsem{\mathds{E}}_s]) \}
	\\
	\tsem{\palloc{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}}(h, s) &\triangleq
		\begin{cases}
			\{ (h[\vec{a} \mapsto \vec{z}], s)
			&
			\text{if } n = \tsem{\mathds{E}}_s \text{ and } n > 0 \text{ and } l \in \mathsf{Key} \\
			|\ \forall 0 \leq i < n \ldotp \vec{z}_i = 0 \}, & \text{and } \vec{a} = (l, \ldots, l + n - 1) \text{ and } \\
			& \{ l, \ldots, l + n - 1 \} \cap \pred{dom}{h} \equiv \emptyset \\
			\{(\emptyset, s)\}, & \text{if } n = \tsem{\mathds{E}}_s \text{ and } n > 0 \text{ and } l \in \mathsf{Key} \\ & \text{and } \{ l, \ldots, l + n - 1 \} \cap \pred{dom}{h} \not\equiv \emptyset \\
			& \text{or } n > 0 \text{ and } l \not\in \mathsf{Key} \\
			\{ (\lightning, s) \}, & \text{otherwise}
		\end{cases}
	\\
	\tsem{\pderef{\pvar{x}}{\mathds{E}}}_{\hat{\mathsf{C}}}(h, s) &\triangleq
		\begin{cases}
			\{ (h, s[\pvar{x} \mapsto v]) \}, & \text{if } k = \tsem{\mathds{E}}_s \text{ and } k \in \pred{dom}{h} \text{ and } h(k) = v \\
			\{ (\emptyset, s) \}, & \text{if } k = \tsem{\mathds{E}}_s \text{ and } k \in \pred{dom}{h} \text{ and } h(k) \neq v \\
			\{ (\lightning, s) \}, & \text{otherwise}
		\end{cases}
	\\
	\tsem{\pmutate{\mathds{E}_1}{\mathds{E}_2}}_{\hat{\mathsf{C}}}(h, s) &\triangleq
	\begin{cases}
		\{ (h[k \mapsto v] \}, s) \}, & \text{if } k = \tsem{\mathds{E}_1}_s \text{ and } v = \tsem{\mathds{E}_2}_s \text{ and } k \in \pred{dom}{h} \\
		\{ (\lightning, s) \}, & \text{otherwise}
	\end{cases}
\end{align*}

\param (Commands interpretation). The interpretation function for elementary commands, formally $\tsem{-}^s_{\mathsf{C}} : \mathsf{Cmd} \times \mathsf{Stack} \rightarrow \mathcal{S} \rightarrow \mathcal{P}(\mathcal{S} \times \mathsf{Stack})$, is defined as:
\begin{align*}
	\tsem{\hat{\mathds{C}}}_{\mathsf{C}}(h, s) &\triangleq \tsem{\hat{\mathds{C}}}_{\hat{\mathsf{C}}}(h, s)
	\\
	\tsem{\pskip}_{\mathsf{C}}(h, s) &\triangleq \{(h, s)\}
	\\
	\tsem{\mathds{C}_1 ; \mathds{C}_2}_{\mathsf{C}}(h, s) &\triangleq \{ (h', s')\ |\ S = \tsem{\mathds{C}_1}_\mathsf{C}(h, s) \land (h', s') \in \tsem{\mathds{C}_2}_\mathsf{C}(S) \}
	\\
	\tsem{\pif{\mathds{B}}{\mathds{C}_1}{\mathds{C}_2}}^s_\mathsf{C}(h, s) &\triangleq \mathbf{if}\ \tsem{\mathds{B}}^\textsc{b}_s\ \mathbf{then}\ \tsem{\mathds{C}_1}_\mathsf{C}(h, s)\ \mathbf{else}\ \tsem{\mathds{C}_2}_\mathsf{C}(h, s)
	\\
	\tsem{\ploop{\mathds{B}}{\mathds{C}}}^s_\mathsf{C}(h, s) &\triangleq \mathbf{if}\ \tsem{\mathds{B}}^\textsc{b}_s\ \mathbf{then}\ \tsem{\mathds{C} ; \ploop{\mathds{B}}{\mathds{C}}}^s_\mathsf{C}(h, s)\ \mathbf{else}\ \tsem{\pskip}_\mathsf{C}(h, s)
\end{align*}

\param (Transactions interpretation). We assume interpretation function for transactions, formally $\tsem{-}_\mathsf{T} : \mathsf{Atom} \rightarrow \mathcal{S} \rightarrow \mathcal{P}(\mathcal{S})$, is defined as:
\[
	\tsem{\ptdef{\mathds{C}}_\iota}_\mathsf{T}(h) \triangleq \{ h'\ |\ \exists s' \ldotp (h', s') = \tsem{\mathds{C}}_\mathsf{C}(h, \emptyset) \}
\]
We also lift the interpretation function to a set of concrete state such that for $S \in \mathcal{P}(\mathcal{S})$:
\[
	\tsem{\mathds{T}}_\mathsf{T}(H) \triangleq \bigcup_{h \in H}  \tsem{\mathds{T}}_\mathsf{T}(h)
\]	

\param (Machine state reification). Given that we defined the set $\mathcal{S}$ to be $\mathsf{State}$, and instantiated $\mathbb{M}$ to also be $\mathsf{State}$, the machine state reification function $\lfloor - \rfloor_\mathbb{M} : \mathbb{M} \rightarrow \mathcal{P}(\mathcal{S})$ will be defined as:
\[
	\lfloor m \rfloor_\mathbb{M} \triangleq \{ m \}
\]

\defn (Reification). The reification of worlds, $\lfloor - \rfloor_W : \mathsf{World} \rightarrow \mathcal{P}(\mathcal{S})$, is defined as follows.
\[
	\lfloor (l, g, \mathcal{J}) \rfloor_W \triangleq \lfloor (l \circ g)_\mathsf{M} \rfloor_\mathbb{M}
\]

\thm (Elementary command soundness). For all $\hat{\mathds{C}} \in \mathsf{ECmd}$, their corresponding axiom $(M_1, \hat{\mathds{C}}, M_2) \in \mathsf{Ax}_{\hat{\mathsf{C}}}$ and any given machine state $m \in \mathbb{M}$ the following must hold.
\[
	\tsem{\hat{\mathds{C}}}_{\hat{\mathsf{C}}} \left( \lfloor M_1 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M_2 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
\]

\thm \label{thm:cSound} (Command soundness). For all $\mathds{C} \in \mathsf{Cmd}$, their corresponding axiom $(M_1, \mathds{C}, M_2) \in \mathsf{Ax}_\mathsf{C}$ and any given machine state $m \in \mathbb{M}$ the following must hold.
\[
	\tsem{\mathds{C}}_\mathsf{C} \left( \lfloor M_1 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M} \right) \subseteq \lfloor M_2 \bullet_\mathbb{M} \{m\} \rfloor_\mathbb{M}
\]

\thm (Transaction soundness). For all $\mathds{T} \in \mathsf{Trans}, (W_1, \mathds{T}, W_2) \in \textsc{Ax}_\mathsf{T}$ and $w \in \mathsf{World}$:
\[
	\tsem{\mathds{T}}_\mathsf{T}(\lfloor W_1 \bullet_\mathbb{M} \{ w \} \rfloor_W) \subseteq \lfloor W_2 \bullet_\mathbb{M} R(\{ w \}) \rfloor_W
\]

{\parindent0pt
\begin{proof}
By induction on the structure of $\mathds{T}$. \\	

\textit{Case}: $\ptdef{\mathds{C}}_\iota$

Let's pick an arbitrary $\mathds{C} \in \mathsf{Cmd}, \iota \in \mathsf{Tid}, w \in \mathsf{World}$ and $W_1, W_2 \in \mathcal{P}(\mathsf{World})$ such that $(W_1, \ptdef{\mathds{C}}_\iota, W_2) \in \textsc{Ax}_\mathsf{T}$ holds. From the definition of $\textsc{Ax}_\mathsf{T}$ we know that there exists $M_1, M_2 \in \mathcal{P}(\mathbb{M})$ such that:
\begin{gather}\label{tsound:1}
	(M_1, \mathds{C}, M_2) \in \textsc{Ax}_\mathsf{S} \land W_1 \Rrightarrow^{\{M_1\}\{M_2\}} W_2
\end{gather}

\textit{To show}:
\[
	\tsem{\ptdef{\mathds{C}}_\iota}_\mathsf{T}(\lfloor W_1 \bullet \{w\} \rfloor_W) \subseteq \lfloor W_2 \bullet R(\{w\}) \rfloor_W
\]

Let's pick an arbitrary $w_1 = (l_1, g_1, \mathcal{J}_1) \in W_1$. We are now left to show that there exists a $w_2 \in \mathsf{World}$ and $w' \in R(w)$ such that:
\[
	\tsem{\ptdef{\mathds{C}}_\iota}_\mathsf{T}(\lfloor w_1 \bullet w \rfloor_W) = \lfloor w_2 \bullet w' \rfloor_W
\]

From the definition of $\tsem{-}_\mathsf{T}, \lfloor - \rfloor_W$, and the properties of $\bullet$ and $\bullet_\mathbb{M}$ we have:
\begin{align}\label{tsound:2}
\tsem{\ptdef{\mathds{C}}_\iota}_\mathsf{T}(\lfloor w_1 \bullet w \rfloor_W) =\
&\tsem{\mathds{C}}_\mathsf{C}(\lfloor w_1 \bullet w \rfloor_W) \\
&\tsem{\mathds{C}}_\mathsf{C}\left( \lfloor (l_1 \circ g_1)_\mathsf{M} \bullet_\mathbb{M} (w_\mathsf{L})_\mathsf{M} \rfloor_\mathbb{M} \right)
\end{align}

From (\ref{tsound:1}) and the definition of $\Rrightarrow$ we know there exists $m_1 \in M_1$ and $m' \in \mathbb{M}$ such that:
\begin{gather}
\label{tsound:3} m_1 \circ m' = (l_1 \circ g_1)_\mathsf{M} \land \\
\label{tsound:4} \forall m_2 \in M_2 \ldotp \exists w_2 = (l_2, g_2, \mathcal{J}_2) \in W_2 \ldotp m_2 \circ m' = (l_2 \circ g_2)_\mathsf{M} \land (w_1, w_2) \in G
\end{gather}

From (\ref{tsound:2}) and (\ref{tsound:4}) we get:
\begin{gather}\label{tsound:5}
\tsem{\ptdef{\mathds{C}}_\iota}_\mathsf{T}(\lfloor w_1 \bullet w \rfloor_W) =
\tsem{\mathds{C}}_\mathsf{C}(\lfloor m_1 \bullet_\mathbb{M} m' \bullet_\mathbb{M} (w_\mathsf{L})_\mathsf{M} \rfloor_\mathbb{M})
\end{gather}

From (\ref{tsound:1}) and Theorem \ref{thm:cSound} we can rewrite (\ref{tsound:5}) as:
\[
	\tsem{\ptdef{\mathds{C}}_\iota}_\mathsf{T}(\lfloor w_1 \bullet w \rfloor_W)
	\subseteq
	\lfloor M_2 \bullet_\mathbb{M} \{m' \bullet_\mathbb{M} (w_\mathsf{L})_\mathsf{M}\} \rfloor_\mathbb{M}
\]

Which means that there exists a $m_2 \in M_2$ such that:
\begin{gather}\label{tsound:6}
	\tsem{\ptdef{\mathds{C}}_\iota}_\mathsf{T}(\lfloor w_1 \bullet w \rfloor_W)
	=
	\lfloor m_2 \bullet_\mathbb{M} m' \bullet_\mathbb{M} (w_\mathsf{L})_\mathsf{M} \rfloor_\mathbb{M}
\end{gather}

From (\ref{tsound:4}) we know that there exists $w_2 \in \mathsf{World}$ such that:
\begin{gather}
\label{tsound:8} w_2 = (l_2, g_2, \mathcal{J}_2) \in W_2 \land m_2 \circ m' = (l_2 \circ g_2)_\mathsf{M} \\
\label{tsound:7} (w_1, w_2) \in G
\end{gather}

From the definition of $\lfloor - \rfloor_W$ and the properties of $\bullet_\mathbb{M}$ and $\bullet$ we can rewrite (\ref{tsound:6}) as:
\begin{gather}\label{tsound:9}
	\tsem{\ptdef{\mathds{C}}_\iota}_\mathsf{T}(\lfloor w_1 \bullet w \rfloor_W)
	=
	\lfloor (l_2 \circ w_\mathsf{L}, g_2, \mathcal{J}_2) \rfloor_W
\end{gather}

From (\ref{tsound:7}) and Lemma \ref{lem:R} we know that there exists a $w' \in \mathsf{World}$ such that:
\begin{gather}\label{tsound:10}
	w' = (w_\mathsf{L}, g_2, \mathcal{J}_2) \land w' \in R(w)
\end{gather}

From (\ref{tsound:8}), (\ref{tsound:9}) and (\ref{tsound:10}) we know that there exists a $w_2 \in W_2$ and $w' \in R(w)$ such that:
\[
	\tsem{\ptdef{\mathds{C}}_\iota}_\mathsf{T}(\lfloor w_1 \bullet w \rfloor_W) = \lfloor w_2 \bullet R(w) \rfloor_W
\]
\end{proof}
}

\lem \label{lem:R} For all $w_1, w_2, w, w' = (l', g', \mathcal{J}') \in \mathsf{World}$,
\[
	w_1 \bullet w_2 = w \land (l', g', \mathcal{J}') \in G(w_1) \implies ((w_2)_\mathsf{L}, g', \mathcal{J}') \in R(w_2)
\]

{\parindent0pt
\begin{proof}
Let's pick arbitrary $w_1, w_2, w, w' = (l', g', \mathcal{J}') \in \mathsf{World}$ such that:
\begin{gather}
	\label{lem:R1} w_1 \bullet w_2 = w \land
	\\
	\label{lem:R2} (l', g', \mathcal{J}') \in G(w_1)
\end{gather}

\textit{To show}: $((w_2)_\mathsf{L}, g', \mathcal{J}') \in R(w_2)$

From (\ref{lem:R2}) and the definition of $G$ we know that:
\begin{gather}
	\label{lem:R3} (l', g', \mathcal{J}') \in (G^c \cup G^u \cup G^d)^*(w_1)
\end{gather}

From (\ref{lem:R1}), (\ref{lem:R3}) and by Lemma \ref{lem:Ru}, Lemma \ref{lem:Rc} and Lemma \ref{lem:Rd} we get:
\[
	((w_2)_\mathsf{L}, g', \mathcal{J}') \in (R^c \cup R^u \cup R^d)^*(w_2)
\]
Therefore we can conclude the following.
\[
	((w_2)_\mathsf{L}, g', \mathcal{J}') \in R(w_2)
\]
\end{proof}
}

\lem \label{lem:Ru} For all $w_1, w_2, w, w' = (l', g', \mathcal{J}') \in \mathsf{World}$,
\[
	w_1 \bullet w_2 = w \land (l', g', \mathcal{J}') \in G^u(w_1) \implies ((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^u(w_2)
\]

{\parindent0pt
\begin{proof}
Let's pick arbitrary $w_1 = (l_1, g_1, \mathcal{J}_1), w_2 = (l_2, g_2, \mathcal{J}_2), w$ and $(l', g', \mathcal{J}') \in \mathsf{World}$, such that:
\begin{gather}
	\label{lem:Ru1} w_1 \bullet w_2 = w \land \\
	\label{lem:Ru2} (l', g', \mathcal{J}') \in G^u(w_1)
\end{gather}

\textit{To show}: $((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^u(w_2)$

From (\ref{lem:Ru1}) we know that
\begin{gather}
	\label{lem:Ru3} g_1 = g_2 \\
	\label{lem:Ru4} \mathcal{J}_1 = \mathcal{J}_2
\end{gather}

From the definition of $G^u$ and from (\ref{lem:Ru2}) and (\ref{lem:Ru4}) we know that:
\begin{gather}
	\label{lem:Ru5} \mathcal{J}' = \mathcal{J}_1 = \mathcal{J}_2 \land \\
	\label{lem:Ru6} ((l_1 \circ g_1)_\mathsf{K})_\mathbb{K}^\bot = ((l' \circ g')_\mathsf{K})_\mathbb{K}^\bot \land \\
		\label{lem:Ru7} (g_1 = g' \lor \exists r, \kappa \leq (l_1)_\mathsf{K} \ldotp \imath(\kappa) = r \land (g_1, g') \in \lceil \mathcal{J}_1(r) \rceil(\kappa)
		\\ \land ((l_1 \circ g_1)_\mathsf{M})_\mathbb{M}^\bot = ((l' \circ g')_\mathsf{M})_\mathbb{M}^\bot )
\end{gather}

Given the disjunction in (\ref{lem:Ru7}), we need to consider two cases. \\

\textit{Case 1}: $g_1 = g'$

From (\ref{lem:Ru3}) and our assumption, we get that $g_2 = g'$. Now, from (\ref{lem:Ru5}), it follows that:
\begin{gather}
	\label{lem:Ru8} ((w_2)_\mathsf{L}, g', \mathcal{J}') = (l_2, g_2, \mathcal{J}_2)
\end{gather}

From (\ref{lem:Ru8}) and the definition of $R^u$ we can conclude that:
\[
	((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^u(l_2, g_2, \mathcal{J}_2)
\]

\textit{Case 2}:
\begin{gather}
	\label{lem:Ru9} \exists r, \kappa \leq (l_1)_\mathsf{K} \ldotp \imath(\kappa) = r \land (g_1, g') \in \lceil \mathcal{J}_1(r) \rceil(\kappa)
	\\
	\label{lem:Ru10} \land ((l_1 \circ g_1)_\mathsf{M})_\mathbb{M}^\bot = ((l' \circ g')_\mathsf{M})_\mathbb{M}^\bot
\end{gather}

From (\ref{lem:Ru1}), (\ref{lem:Ru3}) and (\ref{lem:Ru4}) we know that:
\begin{gather}
	\label{lem:Ru11} w = (l_1 \circ l_2, g_2, \mathcal{J}_2)
\end{gather}

From the definition of $\mathsf{World}$ we know that $\pred{wf}{w}$ holds, and together with (\ref{lem:Ru3}) we have:
\begin{gather}
	\label{lem:Ru12} (l_1 \circ l_2 \circ g_2)_\mathsf{K} = (l_1)_\mathsf{K} \bullet_\mathbb{K} (l_2)_\mathsf{K} \bullet_\mathbb{K} \llfloor g_2 \rrfloor_\mathsf{K} = (l_1 \circ g_1)_\mathsf{K} \bullet_\mathbb{K} (l_2)_\mathsf{K} \text{ defined}
	\\
	\label{lem:Ru13} (l_1 \circ l_2 \circ g_1)_\mathsf{M} = (l_1 \circ g_1)_\mathsf{M} \bullet_\mathbb{M} (l_2)_\mathsf{M} \text{ defined}
\end{gather}

From (\ref{lem:Ru9}) we obtain $\kappa \leq (l_1)_\mathsf{K}$, from (\ref{lem:Ru12}) and Lemma \ref{lem:SepF}, we know:
\begin{gather}
	\label{lem:Ru14} \kappa\ \sharp \left( (l_2)_\mathsf{K} \bullet_\mathbb{K} \llfloor g_2 \rrfloor_\mathsf{K} \right)
\end{gather}

From (\ref{lem:Ru3}), (\ref{lem:Ru10}) and (\ref{lem:Ru13}) we know:
\begin{gather}
	\label{lem:Ru15} (l' \circ g')_\mathsf{M} \bullet_\mathbb{M} (l_2)_\mathsf{M} = (l' \circ l_2 \circ g')_\mathsf{M} \text{ defined}
\end{gather}

From (\ref{lem:Ru6}) and (\ref{lem:Ru12}) we know:
\begin{gather}
	\label{lem:Ru16} (l' \circ g')_\mathsf{K} \bullet_\mathbb{K} (l_2)_\mathsf{K} = (l' \circ l_2 \circ g')_\mathsf{K} \text{ defined}
\end{gather}

From (\ref{lem:Ru15}), (\ref{lem:Ru16}) we get that $l_1' \circ l_2 \circ g'$ is defined and as a consequence we obtain:
\begin{gather}
	\label{lem:Ru17} l_2 \circ g' \text{ defined}
\end{gather}

From (\ref{lem:Ru5}), (\ref{lem:Ru9}), (\ref{lem:Ru14}), (\ref{lem:Ru17}) and the definition of $R^u$ we can conclude that:
\[
	((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^u(l_2, g_2, \mathcal{J}_2)
\]
\end{proof}
}

\lem \label{lem:Rc}  For all $w_1, w_2, w, w' = (l', g', \mathcal{J}') \in \mathsf{World}$,
\[
	w_1 \bullet w_2 = w \land (l', g', \mathcal{J}') \in G^c(w_1) \implies ((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^c(w_2)
\]

{\parindent0pt
\begin{proof}
Let's pick arbitrary $w_1 = (l_1, g_1, \mathcal{J}_1), w_2 = (l_2, g_2, \mathcal{J}_2), w$ and $w' = (l', g', \mathcal{J}') \in \mathsf{World}$, such that:
\begin{gather}
	\label{lem:Rc1} w_1 \bullet w_2 = w \land \\
	\label{lem:Rc2} (l', g', \mathcal{J}') \in G^c(w_1)
\end{gather}

\textit{To show}: $((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^c(w_2)$

From (\ref{lem:Ru1}) we know that
\begin{gather}
	\label{lem:Rc3} g_1 = g_2 \\
	\label{lem:Rc4} \mathcal{J}_1 = \mathcal{J}_2
\end{gather}

From the definition of $G^c$ and from (\ref{lem:Rc2}), (\ref{lem:Rc3}) and (\ref{lem:Rc4}) we know that:
\begin{gather}
	\label{lem:Rc5} \exists r, m, l, a \ldotp r \not\in \pred{dom}{g_2} \land l_1 = (m, \mathbf{0}_\mathbb{K}) \circ l \land g' = g_2[r \mapsto (m, \mathbf{0}_\mathbb{K})] \land
	\\
	\label{lem:Rc6} r \not\in \pred{dom}{\mathcal{J}_2} \land \mathcal{J}' = \mathcal{J}_2[r \mapsto a] \land l' = l \circ \left( \mathbf{0}_\mathbb{M}, \prod^{\bullet_\mathbb{K}}_{\kappa' \in \pred{dom}{a}} \kappa' \right)
\end{gather}

From (\ref{lem:Rc1}) and (\ref{lem:Rc5}) we know that $(l_1 \circ l_2) \circ g$ and that $l_1 = (m, \mathbf{0}_\mathbb{K}) \circ l$ are defined which implies that:
\begin{gather}
	\label{lem:Rc7} (m, \mathbf{0}_\mathbb{K}) \circ l_2 \text{ defined}
	\\
	\label{lem:Rc8} l_2 \circ g_2 \text{ defined}
\end{gather}

Now, from (\ref{lem:Rc5}) we know that $g' = g_2[r \mapsto (m, \mathbf{0}_\mathbb{K})]$ and together with (\ref{lem:Rc7}) and (\ref{lem:Rc8}) we obtain that:
\begin{gather}
	\label{lem:Rc9} l_2 \circ g' \text{ defined}
\end{gather}

From (\ref{lem:Rc6}) we get that $r \not\asymp w'$ since all permissions for the action mapping $a = \mathcal{J}'(r)$ are in the logical state $l'$. From this observation together with (\ref{lem:Rc5}), (\ref{lem:Rc6}) and (\ref{lem:Rc9}) we can conclude that:
\[
	((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^c(w_2)
\]
\end{proof}
}

\lem \label{lem:Rd}  For all $w_1, w_2, w, w' = (l', g', \mathcal{J}') \in \mathsf{World}$,
\[
	w_1 \bullet w_2 = w \land (l', g', \mathcal{J}') \in G^d(w_1) \implies ((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^d(w_2)
\]

{\parindent0pt
\begin{proof}
Let's pick arbitrary $w_1 = (l_1, g_1, \mathcal{J}_1), w_2 = (l_2, g_2, \mathcal{J}_2), w$ and $w' = (l', g', \mathcal{J}') \in \mathsf{World}$, such that:
\begin{gather}
	\label{lem:Rd1} w_1 \bullet w_2 = w \land \\
	\label{lem:Rd2} (l', g', \mathcal{J}') \in G^d(w_1)
\end{gather}

\textit{To show}: $((w_2)_\mathsf{L}, g', \mathcal{J}') \in R^d(w_2)$

From (\ref{lem:Rd2}) and the definition of the $G^d$ relation we know that:
\begin{gather}
	\label{lem:Rd3} w_1 \in G^c(w')
\end{gather}

From (\ref{lem:Rd1}), (\ref{lem:Rd3}) and Lemma \ref{lem:Rc} we obtain:
\begin{gather}
	\label{lem:Rd4} ((w_2)_L, g_1, \mathcal{J}_1) \in R^c(w_2)
\end{gather}
\end{proof}
}

\lem \label{lem:SepF} Given any separation algebra $(\mathcal{M}, \bullet_\mathcal{M}, \mathbf{0}_\mathcal{M})$
\[
	\forall a, b, c, d \in \mathcal{M} \ldotp a \bullet_\mathcal{M} b = d \land c \leq b \implies \exists f \ldotp a \bullet_\mathcal{M} c = f
\]

{\parindent0pt
\begin{proof}
Let's pick arbitrary $a, b, c, d \in \mathcal{M}$ such that:
\begin{gather}
	\label{lem:SepF1} a \bullet_\mathcal{M} b = d
	\\
	\label{lem:SepF2} c \leq b
\end{gather}

From (\ref{lem:SepF2}) we obtain:
\begin{gather}
	\label{lem:SepF3} \exists e \in \mathcal{M} \ldotp c \bullet_\mathcal{M} e = b
\end{gather}

Now, as a consequence, from (\ref{lem:SepF1}) we have:
\begin{gather}
	\label{lem:SepF4} a \bullet_\mathcal{M} c \bullet_\mathcal{M} e = d
\end{gather}

Since $e \leq d$ from (\ref{lem:SepF4}) we have:
\begin{gather}
	\label{lem:SepF5} \exists f \in \mathcal{M} \ldotp e \bullet_\mathcal{M} f = d
\end{gather}

From (\ref{lem:SepF4}), (\ref{lem:SepF5}) and cancellativity of separation algebras we have $a \bullet_\mathcal{M} c = f$ and therefore $\exists f \in \mathcal{M} \ldotp a \bullet_\mathcal{M} c = f$ holds.
\end{proof}
}