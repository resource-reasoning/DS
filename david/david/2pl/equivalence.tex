\section{Semantics Equivalence}

\label{sec:semEquiv}

Serializability gives us an important consistency property on the \tpl\ operational semantics that we defined. In abstract terms, it allows us to think about program executions in some sequential order, without having to consider all possible interleavings that may arise. At this point, we want to show an even stronger result which is the semantics equivalence between the semantics defined in Section \ref{sec:2plSemantics} and some \textit{atomic} operational semantics, defined in Section \ref{sec:atomicSem}, that reduce transactions in one go, as if the system stops when they begin execution and starts again when they are done. In database terms, this is referred to as \textit{strict serializability}, a property which enforces that, on top of some order between parallel transactions, the internal program order is also preserved. The equivalence not only allows us to forget about the peculiar locking details of \tpl\ and thus only to focus on \textit{atomic} reductions, but also provides us with the key element in proving soundness with respect to the mCAP program logic defined in Section \ref{sec:mcapModel}. This empowers us to build mCAP proofs of programs running under the \tpl\ semantics.

The final outcome of this section will be a proof of the following statement, which says that any program that terminates, i.e. reduces to $\pskip$, under the \tpl\ operational semantics will have the same overall effect on the global storage as the same terminating program running under the \textsc{Atom} semantics and starting with the same state.
\[
	\forall h, h', S, S', \mathds{P} \ldotp
	(h, \emptyset, S, \mathds{P}) \rightarrow^* (h', \emptyset, S', \pskip) \implies 
	(h, \mathds{P}) \tred^* (h', \pskip)
\]

In order for the semantics equivalence claim to be complete, the inverse implication also needs to be established. This states that the final storage of any terminating program reduction in \textsc{Atom}, will be reachable by reducing the same program starting from the same initial state in \textsc{2pl}, where the transactions' state components are existentially quantified.
\[
	\forall h, h' \ldotp
	(h, \mathds{P}) \tred^* (h', \pskip)
	\implies
	\exists S, S' \ldotp
	(h, \emptyset, S, \mathds{P}) \rightarrow^* (h', \emptyset, S', \pskip)
\]
We do not formally prove this result given that it is trivial to understand that the \textsc{Atom} semantics can be replicated by the \tpl\ ones, simply by always chosing to reduce the same transaction until it reaches $\pskip$, without allowing concurrent interleaving. Given that we start with an empty lock manager component $\emptyset$, run transactions one after the other and each of those needs to remove its footprint from locks before terminating, no transaction will get \textit{stuck} as part of the overall reduction.

\input{./david/2pl/atomic_semantics.tex}

\input{./david/2pl/swaps.tex}

\input{./david/2pl/order.tex}

\input{./david/2pl/atom.tex}

\section{Soundness}

All the ingredients necessary to show the soundness of the mCAP logic with respect to the \tpl\ semantics have been illustrated and proven. We are now left to combine all of the results into a proof of soundness, which follows from the fact that mCAP is sound with respect to the \textsc{Atom} semantics, as determined in Theorem \ref{thm:mcapSound}, and every terminating reduction in \tpl\ can be replicated in \textsc{Atom}, by Theorem \ref{thm:atom}.

We first define the meaning of a \tpl\ semantic judgement, and later prove that any syntactic program judgement in mCAP is sound with respect to the \tpl\ semantics.
\begin{defn}
	(\tpl\ Semantic Judgement).
	\begin{gather*}
		\vDash_\textsc{2pl} \triple{P}{\mathds{P}}{Q} \\
		\iff \\
		\left(
		\begin{array}{c}
			\forall e, \delta, w, \sigma, h \ldotp
			w \in \tsem{P}_{e, \delta} \land \sigma \in \lfloor w \rfloor_W \land h = \sigma \downarrow_1 \land (h, \emptyset, \emptyset, \mathds{P}) \rightarrow^* (h', \emptyset, -, \pskip) \\[0.4em]
			\implies \exists w', \sigma' \ldotp w' \in \tsem{Q}_{e, \delta} \land \sigma' \in \lfloor w' \rfloor_W \land \sigma' \downarrow_1 = h'
		\end{array}
		\right)
	\end{gather*}
\end{defn}

The meaning of such judgement is that for any world that satisfies $P$, we take the heap component from its reification, and run it through the \tpl\ semantics until termination. The final storage, $h'$, will then need to be one of the possible reifications of a terminating world $w'$ which satisfies assertion $Q$.

\begin{thm}
	\label{thm:2plSound}
	(\tpl\ Soundness).
	For all $\mathds{P}, P, Q$ if $\vdash \triple{P}{\mathds{P}}{Q}$ then $\vDash_\textsc{2pl} \triple{P}{\mathds{P}}{Q}$.
	\begin{proof}
		Let's pick arbitrary $\mathds{P} \in \mathsf{Prog}$ and $P, Q \in \mathsf{Assn}$. We now assume that $\vdash \triple{P}{\mathds{P}}{Q}$ holds. It is required to show that:
		\begin{gather}
			\forall e, \delta, w, \sigma, h \ldotp \\
			w \in \tsem{P}_{e, \delta} \land \sigma \in \lfloor w \rfloor_W \land h = \sigma \downarrow_1 \land (h, \emptyset, \emptyset, \mathds{P}) \rightarrow^* (h', \emptyset, -, \pskip) \\[0.4em]
			\implies \exists w', \sigma' \ldotp w' \in \tsem{Q}_{e, \delta} \land \sigma' \in \lfloor w' \rfloor_W \land \sigma' \downarrow_1 = h'
		\end{gather}
		We pick an arbitrary $w \in \mathsf{World}, e \in \mathsf{LEnv}, \delta \in \mathsf{PEnv}, \sigma \in \mathcal{S}, h \in \mathsf{Storage}$ and assume that:
		\begin{gather}
			\label{thm:2plSound2} w \in \tsem{P}_{e, \delta} \land \sigma \in \lfloor w \rfloor_W \\
			\label{thm:2plSound1} \land\ h = \sigma \downarrow_1 \land (h, \emptyset, \emptyset, \mathds{P}) \rightarrow^* (h', \emptyset, -, \pskip)
		\end{gather}
		From (\ref{thm:2plSound1}) and Theorem \ref{thm:atom} we know that the following holds:
		\begin{gather}
			\label{thm:2plSound3}
			(h, \mathds{P}) \tred^* (h', \pskip)
		\end{gather}
		From (\ref{thm:2plSound3}) and Theorem \ref{thm:atomViewsProg}, i.e. the one-way equivalence between \textsc{Atom} and the Views operational semantics, we obtain:
		\begin{gather}
			\label{thm:2plSound4}
			\exists \sigma' \ldotp h' = \sigma' \downarrow_1 \land\ \mathds{P}, \sigma \rightarrow^*_{\mathsf{Views}} \pskip, \sigma'
		\end{gather}
		From (\ref{thm:2plSound2}), Theorem \ref{thm:mcapSound}, i.e. soundness of mCAP's transactions instantiation, and (\ref{thm:2plSound4}) we can conclude that, for some $w' \in \mathsf{World}$:
		\[
			w' \in \tsem{Q}_{e, \delta} \land \sigma' \in \lfloor w' \rfloor_W \land \sigma' \downarrow_1 = h'
		\]
	\end{proof}
\end{thm}