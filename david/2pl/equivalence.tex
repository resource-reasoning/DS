\subsection{Semantics Equivalence}

Serializability gives us an important consistency property on the \tpl\ operational semantics that we defined. In abstract terms, it allows us to think about program executions in some sequential order, without having to consider all possible interleavings that may arise. At this point, we want to show an even stronger result which is the semantics equivalence between the semantics defined in Section \ref{sec:2plSemantics} and some \textit{atomic} operational semantics, defined in Section \ref{sec:atomicSem}, that reduce transactions in one go, as if the system stops when they begin execution and starts again when they are done. The equivalence not only allows us to forget about the peculiar locking details of \tpl\ and thus only to focus on \textit{atomic} reductions, but also provides us with soundness with respect to the mCAP program logic defined in Section \ref{sec:mcapModel}. This empowers us to build mCAP proofs of programs running under the \tpl\ semantics.

The final outcome of this section will be a proof of the following statement, which says that any program that terminates, i.e. reduces to $\pskip$, under the \tpl\ operational semantics will have the same overall effect on the global storage as the same terminating program running under the \textsc{Atom} semantics and starting with the same state.
\[
	\forall h, h', S, S', \mathds{P} \ldotp
	(h, \emptyset, S, \mathds{P}) \rightarrow^* (h', \emptyset, S', \pskip) \implies 
	(h, \mathds{P}) \tred^* (h', \pskip)
\]

\input{./david/2pl/atomic_semantics.tex}

\input{./david/2pl/swaps.tex}

\input{./david/2pl/order.tex}

\input{./david/2pl/atom.tex}

\subsection{Soundness}

All the ingredients necessary to show the soundness of the mCAP logic with respect to the \tpl\ semantics have been illustrated and proven. We are now left to combine all of the results into a proof of soundness, which follows from the fact that mCAP is sound with respect to the \textsc{Atom} semantics, as determined in Theorem \ref{thm:mcapSound}, and every terminating reduction in \tpl\ can be replicated in \textsc{Atom}, by Theorem \ref{thm:atom}.

\begin{thm}
	\label{thm:2plSound}
	(\tpl\ soundness).
	For all $\mathds{P}, P, Q$ if $\vdash \triple{P}{\mathds{P}}{Q}$ then $\vDash_\textsc{2pl} \triple{P}{\mathds{P}}{Q}$.
	\begin{proof}
		Let's pick arbitrary $\mathds{P} \in \mathsf{Prog}$ and $P, Q \in \mathsf{Assn}$. We now assume that $\vdash \triple{P}{\mathds{P}}{Q}$ holds. It is required to show that:
		\begin{gather}
			\forall e, \delta, w, \sigma, h \ldotp \\
			w \in \tsem{P}_{e, \delta} \land \sigma \in \lfloor w \rfloor_W \land h = \sigma \downarrow_1 \land (h, \emptyset, \emptyset, \mathds{P}) \rightarrow^* (h', \emptyset, -, \pskip) \\
			\implies \exists w', \sigma' \ldotp w' \in \tsem{Q}_{e, \delta} \land \sigma' \in \lfloor w' \rfloor_W \land \sigma' \downarrow_1 = h'
		\end{gather}
		We pick an arbitrary $w \in \mathsf{World}, e \in \mathsf{LEnv}, \delta \in \mathsf{PEnv}, \sigma \in \mathcal{S}, h \in \mathsf{Storage}$ and assume that:
		\begin{gather}
			\label{thm:2plSound2} w \in \tsem{P}_{e, \delta} \land \sigma \in \lfloor w \rfloor_W \\
			\label{thm:2plSound1} \land\ h = \sigma \downarrow_1 \land (h, \emptyset, \emptyset, \mathds{P}) \rightarrow^* (h', \emptyset, -, \pskip)
		\end{gather}
		From (\ref{thm:2plSound1}) and Theorem \ref{thm:atom} we know that the following holds:
		\begin{gather}
			\label{thm:2plSound3}
			(h, \mathds{P}) \tred^* (h', \pskip)
		\end{gather}
		From (\ref{thm:2plSound2}), Theorem \ref{thm:mcapSound}, i.e. soundness of mCAP's transactions instantiation, and (\ref{thm:2plSound3}) we can conclude that, for some $w' \in \mathsf{World}, \sigma' \in \mathcal{S}$:
		\[
			w' \in \tsem{Q}_{e, \delta} \land \sigma' \in \lfloor w' \rfloor_W \land \sigma' \downarrow_1 = h'
		\]
	\end{proof}
\end{thm}