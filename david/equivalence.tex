\section{Trace equivalence}

\begin{gather*}
	\pred{clean}{\tau, \tau'} \iff \\
	(\forall i, k, x, n, n', l \ldotp x \in \{op(i, k), (\actalloc{i}{n}{l}, n')\} \implies (x \in \tau \iff x \in \tau')) \\
	\land \\
	(\forall i, k, x, n, \kappa \ldotp x \in \{ (\actlock{i}{k}{\kappa}, n), (\actunlock{i}{k}, n) \} \land x \in \tau \land op(i, k) \not\in \tau \implies x \not\in \tau')
\end{gather*}

\[
	\alpha(\iota, k) \triangleq \alpha \text{ s. t. }
	\alpha \in 
		\{
			\actread{\iota}{k}{v},
			\actwrite{\iota}{k}{v},
			\actlock{\iota}{k}{\kappa},
			\actunlock{\iota}{k}\
			|\ v \in \mathsf{Val}, \kappa \in \mathsf{Lock}
		\}
\]

\lem
\begin{gather*}
	\forall h, h', \Phi, \Phi', S, S', \mathds{P}, \mathds{P}', i, j, k, k', v, v' \ldotp \\
	 i \neq j \implies
	 \\
	(\exists h_0, \Phi_0, S_0, \mathds{P}_0 \ldotp 
	(h, \Phi, S, \mathds{P}) \xrightarrow{\actread{i}{k}{v}} (h_0, \Phi_0, S_0, \mathds{P}_0)  \xrightarrow{\actread{j}{k'}{v'}} (h', \Phi', S', \mathds{P}') \\
	\iff \\
	\exists h_1, \Phi_1, S_1, \mathds{P}_1 \ldotp
	(h, \Phi, S, \mathds{P}) \xrightarrow{\actread{j}{k'}{v'}} (h_1, \Phi_1, S_1, \mathds{P}_1) \xrightarrow{\actread{i}{k}{v}} (h', \Phi', S', \mathds{P}'))
\end{gather*}

\lem
\begin{gather*}
	\forall h, h', \Phi, \Phi', S, S', \mathds{P}, \mathds{P}', i, j, k, k', x, y \ldotp \\
	x = \alpha(i, k) \land y = \alpha(j, k') \land i \neq j \land k \neq k' \implies \\
	(\exists h_0, \Phi_0, S_0, \mathds{P}_0 \ldotp
	(h, \Phi, S, \mathds{P}) \xrightarrow{x} (h_0, \Phi_0, S_0, \mathds{P}_0)  \xrightarrow{y} (h', \Phi', S', \mathds{P}') \\
	\iff \\
	\exists h_1, \Phi_1, S_1, \mathds{P}_1 \ldotp
	(h, \Phi, S, \mathds{P}) \xrightarrow{y} (h_1, \Phi_1, S_1, \mathds{P}_1) \xrightarrow{x} (h', \Phi', S', \mathds{P}'))
\end{gather*}

\lem
\begin{gather*}
	\forall h, h', \Phi, \Phi', S, S', \mathds{P}, \mathds{P}', i, j, n, n', l, l' \ldotp \\
	i \neq j \implies \\
	(\exists h_0, \Phi_0, S_0, \mathds{P}_0 \ldotp 
	(h, \Phi, S, \mathds{P}) \xrightarrow{\actalloc{i}{n}{l}} (h_0, \Phi_0, S_0, \mathds{P}_0)  \xrightarrow{\actalloc{j}{n'}{l'}} (h', \Phi', S', \mathds{P}') \\
	\iff \\
	\exists h_1, \Phi_1, S_1, \mathds{P}_1 \ldotp
	(h, \Phi, S, \mathds{P}) \xrightarrow{\actalloc{j}{n'}{l'}} (h_1, \Phi_1, S_1, \mathds{P}_1) \xrightarrow{\actalloc{i}{n}{l}} (h', \Phi', S', \mathds{P}'))
\end{gather*}

\lem
\begin{gather*}
	\forall h, h', \Phi, \Phi', S, S', \mathds{P}, \mathds{P}', i, j, n, l, k, x \ldotp \\
	x = \alpha(j, k) \land i \neq j \land (k < l \lor k \geq l + n) \implies \\
	(\exists h_0, \Phi_0, S_0, \mathds{P}_0 \ldotp 
	(h, \Phi, S, \mathds{P}) \xrightarrow{\actalloc{i}{n}{l}} (h_0, \Phi_0, S_0, \mathds{P}_0)  \xrightarrow{x} (h', \Phi', S', \mathds{P}') \\
	\iff \\
	\exists h_1, \Phi_1, S_1, \mathds{P}_1 \ldotp
	(h, \Phi, S, \mathds{P}) \xrightarrow{x} (h_1, \Phi_1, S_1, \mathds{P}_1) \xrightarrow{\actalloc{i}{n}{l}} (h', \Phi', S', \mathds{P}'))
\end{gather*}

\subsection{Total order}

\begin{align*}
	\pred{TSG}{\tau} &\triangleq (N, E) \\
	\text{where } N &= N' \\
	E &= E' \cup \{ (i, j)\ |\ \lnot \left( i \rightarrow^* j \in E' \land j \rightarrow^* i \in E' \right) \land i < j \} \\
	(N', E') &= \pred{SG}{\tau}
\end{align*}
