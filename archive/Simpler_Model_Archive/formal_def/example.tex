\section{blablabla\label{sec:example}}
We use \( \loc_{\dontcare} \) to denote a location in either global or local heap.

\[
    \begin{session}
        \specline{\loc_{x} \pointsto 0 \sep \loc_{y} \pointsto 0} \\                                          
        \begin{parl}
            \begin{session}
                \actionline{\rely}{\loc_{x} \pointsto_{r} \anyval \sep \loc_{y} \pointsto_{r} 0 \transfersto \loc_{x} \pointsto_{w} 1 \sep \loc_{y} \pointsto_{r} 0} \\
                \specline{\loc_{x} \pointsto 0 \sep \loc_{y} \pointsto 0 \lor \loc_{x} \pointsto 1 \sep \loc_{y} \pointsto 0} \\
                \begin{transaction}
                    \specline{\loc_{x} \pointsto_{r} 0 \sep \loc_{y} \pointsto_{r} 0 \lor {} \\
                        \loc_{x} \pointsto_{r} 1 \sep \loc_{y} \pointsto_{r} 0} \\
                    \pderef{\vx}{\loc_{x}} ; \\
                    \specline{\loc_{x} \pointsto_{r} 0 \sep \loc_{y} \pointsto_{r} 0 \land \vx = 0 \lor {} \\
                        \loc_{x} \pointsto_{r} 1 \sep \loc_{y} \pointsto_{r} 0 \land \vx = 1} \\
                    \pifs{\vx = 0} \\
                    \quad \pmutate{\loc_{y}}{1} ; \\
                    \specline{\loc_{x} \pointsto_{r} 0 \sep \loc_{y} \pointsto_{w} 1 \land \vx = 0 \lor {} \\
                        \loc_{x} \pointsto_{r} 1 \sep \loc_{y} \pointsto_{r} 0 \land \vx = 1} \\
                    MERGE \\
                    \specline{\loc_{x} \pointsto_{r} 0 \sep \loc_{y} \pointsto_{w} 1  \lor {} \\
                        \loc_{x} \pointsto_{r} 1 \sep \loc_{y} \pointsto_{r} 0 \lor {} \\
                        \loc_{x} \pointsto_{w} 1 \sep \loc_{y} \pointsto_{w} 1 \lor {} \\
                        \loc_{x} \pointsto_{w} 1 \sep \loc_{y} \pointsto_{r} 0 
                    } \\
                \end{transaction} \\
                \specline{\loc_{x} \pointsto 0 \sep \loc_{y} \pointsto 1  \lor {} \\
                    \loc_{x} \pointsto 1 \sep \loc_{y} \pointsto 0 \lor {} \\
                    \loc_{x} \pointsto 1 \sep \loc_{y} \pointsto 1 
                } \\
            \end{session} & 
            \begin{session}
                \actionline{\rely}{\loc_{x} \pointsto_{r} 0 \sep \loc_{y} \pointsto_{r} \anyval \transfersto \loc_{x} \pointsto_{r} 0 \sep \loc_{y} \pointsto_{w} 1} \\
                \specline{\loc_{x} \pointsto 0 \sep \loc_{y} \pointsto 0 \lor \loc_{x} \pointsto 0 \sep \loc_{y} \pointsto 1} \\
                \begin{transaction}
                    \specline{\loc_{x} \pointsto_{r} 0 \sep \loc_{y} \pointsto_{r} 0 \lor {} \\
                        \loc_{x} \pointsto_{r} 0 \sep \loc_{y} \pointsto_{r} 1} \\
                    \pderef{\vy}{\loc_{y}} ; \\
                    \pifs{\vy = 0} \\
                    \quad \pmutate{\loc_{x}}{1} ; \\
                    \specline{\loc_{x} \pointsto_{w} 1 \sep \loc_{y} \pointsto_{r} 0 \lor {} \\
                        \loc_{x} \pointsto_{r} 0 \sep \loc_{y} \pointsto_{r} 1} \\
                    MERGE \\
                    \specline{\loc_{x} \pointsto_{w} 1 \sep \loc_{y} \pointsto_{r} 0 \lor {} \\
                        \loc_{x} \pointsto_{r} 0 \sep \loc_{y} \pointsto_{r} 1 \lor {} \\
                        \loc_{x} \pointsto_{w} 1 \sep \loc_{y} \pointsto_{w} 1 \lor {} \\
                        \loc_{x} \pointsto_{r} 0 \sep \loc_{y} \pointsto_{w} 1
                    } \\
                \end{transaction} \\
                \specline{\loc_{x} \pointsto 0 \sep \loc_{y} \pointsto 1  \lor {} \\
                    \loc_{x} \pointsto 1 \sep \loc_{y} \pointsto 0 \lor {} \\
                    \loc_{x} \pointsto 1 \sep \loc_{y} \pointsto 1 
                } \\
            \end{session} \\
        \end{parl} \\
        \specline{\loc_{x} \pointsto 0 \sep \loc_{y} \pointsto 1  \lor \loc_{x} \pointsto 1 \sep \loc_{y} \pointsto 0 \lor \loc_{x} \pointsto 1 \sep \loc_{y} \pointsto 1 } \\
    \end{session}
\]

***The second rely might be useful in term of killing the possible states of other thread, even though it is irrelevant for the current thread.
About the problem, an ugly solution is: if the resource appear in rely, current thread should keep it whether uses it or not.
However this solution is against the idea of separation logic, i.e.\ we do not need to take care of those resource untouched.

\[
    \begin{array}{@{}c@{}}
        \begin{parl}
            \begin{session}
                \actionline{\rely}{ \loc_{y} \pointsto_{r} \anyval \transfersto \loc_{y} \pointsto_{w} 1 \\
                    \loc_{x} \pointsto_{r} x \sep \loc_{y} \pointsto_{r} y \sep \loc_{tx2} \pointsto_{r} \anyval \sep \loc_{ty2} \pointsto_{r} \anyval \\
                    \transfersto \loc_{x} \pointsto_{r} x \sep \loc_{y} \pointsto_{r} y \sep \loc_{tx2} \pointsto_{w} x \sep \loc_{ty2} \pointsto_{w} y } \\
                \specline{\loc_{x} \pointsto 0 \sep \loc_{y} \pointsto 0 \sep \loc_{tx1} \pointsto 0 \sep \loc_{ty1} \pointsto 0 \lor {} \\
                    \loc_{x} \pointsto 0 \sep \loc_{y} \pointsto 1 \sep \loc_{tx1} \pointsto 0 \sep \loc_{ty1} \pointsto 0
                } \\
                \begin{transaction}
                    \pmutate{\loc_{x}}{1} ;
                \end{transaction} \\
                \specline{\loc_{x} \pointsto 1 \sep \loc_{y} \pointsto 0 \sep \loc_{tx1} \pointsto 0 \sep \loc_{ty1} \pointsto 0 \lor {} \\
                    \loc_{x} \pointsto 1 \sep \loc_{y} \pointsto 1 \sep \loc_{tx1} \pointsto 0 \sep \loc_{ty1} \pointsto 0
                } \\
                \begin{transaction}
                    \specline{\loc_{x} \pointsto_{r} 1 \sep \loc_{y} \pointsto_{r} 0 \sep \loc_{tx1} \pointsto_{r} 0 \sep \loc_{ty1} \pointsto_{r} 0 \lor {} \\
                        \loc_{x} \pointsto_{r} 1 \sep \loc_{y} \pointsto_{r} 1 \sep \loc_{tx1} \pointsto_{r} 0 \sep \loc_{ty1} \pointsto_{r} 0
                    } \\
                    \pderef{\vx}{\loc_{x}} ; \\
                    \pmutate{\loc_{tx1}}{\vx} ; \\
                    \pderef{\vy}{\loc_{y}} ; \\
                    \pmutate{\loc_{ty1}}{\vy} ; \\
                    \specline{\loc_{x} \pointsto_{r} 1 \sep \loc_{y} \pointsto_{r} 0 \sep \loc_{tx1} \pointsto_{w} 1 \sep \loc_{ty1} \pointsto_{w} 0 \lor {} \\
                        \loc_{x} \pointsto_{r} 1 \sep \loc_{y} \pointsto_{r} 1 \sep \loc_{tx1} \pointsto_{w} 1 \sep \loc_{ty1} \pointsto_{w} 1
                    } \\
                    MERGE \\
                    \specline{\loc_{x} \pointsto_{r} 1 \sep \loc_{y} \pointsto_{r} 0 \sep \loc_{tx1} \pointsto_{w} 1 \sep \loc_{ty1} \pointsto_{w} 0 \lor {} \\
                        \loc_{x} \pointsto_{r} 1 \sep \loc_{y} \pointsto_{r} 1 \sep \loc_{tx1} \pointsto_{w} 1 \sep \loc_{ty1} \pointsto_{w} 1 \lor {} \\
                        \loc_{x} \pointsto_{r} 1 \sep \loc_{y} \pointsto_{w} 1 \sep \loc_{tx1} \pointsto_{w} 1 \sep \loc_{ty1} \pointsto_{w} 0 
                    } \\
                \end{transaction} \\
                \specline{\loc_{x} \pointsto 1 \sep \loc_{y} \pointsto 0 \sep \loc_{tx1} \pointsto 1 \sep \loc_{ty1} \pointsto 0 \lor {} \\
                    \loc_{x} \pointsto 1 \sep \loc_{y} \pointsto 1 \sep \loc_{tx1} \pointsto 1 \sep \loc_{ty1} \pointsto 1 \lor {} \\
                    \loc_{x} \pointsto 1 \sep \loc_{y} \pointsto 1 \sep \loc_{tx1} \pointsto 1 \sep \loc_{ty1} \pointsto 0 
                } \\
            \end{session} & 
            \begin{session}
                \actionline{\rely}{ \loc_{x} \pointsto_{r} \anyval \transfersto \loc_{x} \pointsto_{w} 1 \\
                    \loc_{x} \pointsto_{r} x \sep \loc_{y} \pointsto_{r} y \sep \loc_{tx1} \pointsto_{r} \anyval \sep \loc_{ty1} \pointsto_{r} \anyval \\
                    \transfersto \loc_{x} \pointsto_{r} x \sep \loc_{y} \pointsto_{r} y \sep \loc_{tx1} \pointsto_{w} x \sep \loc_{ty1} \pointsto_{w} y } \\
                \specline{\loc_{x} \pointsto 0 \sep \loc_{y} \pointsto 0 \sep \loc_{tx2} \pointsto 0 \sep \loc_{ty2} \pointsto 0 \lor {} \\
                    \loc_{x} \pointsto 1 \sep \loc_{y} \pointsto 0 \sep \loc_{tx2} \pointsto 0 \sep \loc_{ty2} \pointsto 0
                } \\
                \begin{transaction}
                    \pmutate{\loc_{y}}{1} ;
                \end{transaction} \\
                \specline{\loc_{x} \pointsto 0 \sep \loc_{y} \pointsto 1 \sep \loc_{tx2} \pointsto 0 \sep \loc_{ty2} \pointsto 0 \lor {} \\
                    \loc_{x} \pointsto 1 \sep \loc_{y} \pointsto 1 \sep \loc_{tx2} \pointsto 0 \sep \loc_{ty2} \pointsto 0
                } \\
                \begin{transaction}
                    \pderef{\vx}{\loc_{x}} ; \\
                    \pmutate{\loc_{tx2}}{\vx} ; \\
                    \pderef{\vy}{\loc_{y}} ; \\
                    \pmutate{\loc_{ty2}}{\vy} ; \\
                    MERGE \\
                    \specline{\loc_{x} \pointsto_{r} 0 \sep \loc_{y} \pointsto_{r} 1 \sep \loc_{tx2} \pointsto_{w} 0 \sep \loc_{ty2} \pointsto_{w} 1 \lor {} \\
                        \loc_{x} \pointsto_{r} 1 \sep \loc_{y} \pointsto_{r} 1 \sep \loc_{tx2} \pointsto_{w} 1 \sep \loc_{ty2} \pointsto_{w} 1 \lor {} \\
                        \loc_{x} \pointsto_{w} 1 \sep \loc_{y} \pointsto_{r} 1 \sep \loc_{tx2} \pointsto_{w} 0 \sep \loc_{ty2} \pointsto_{w} 1
                    } \\
                \end{transaction} \\
                \specline{\loc_{x} \pointsto 0 \sep \loc_{y} \pointsto 1 \sep \loc_{tx2} \pointsto 0 \sep \loc_{ty2} \pointsto 1 \lor {} \\
                    \loc_{x} \pointsto 1 \sep \loc_{y} \pointsto 1 \sep \loc_{tx2} \pointsto 1 \sep \loc_{ty2} \pointsto 1 \lor {} \\
                    \loc_{x} \pointsto 1 \sep \loc_{y} \pointsto 1 \sep \loc_{tx2} \pointsto 0 \sep \loc_{ty2} \pointsto 1 
                } \\
            \end{session} \\
        \end{parl} \\
        \specline{ \loc_{x} \pointsto 1 \sep \loc_{y} \pointsto 1 \sep {} \\
            \begin{formulea}
                \loc_{tx1} \pointsto 1 \sep \loc_{ty1} \pointsto 0 \sep \loc_{tx2} \pointsto 0 \sep \loc_{ty2} \pointsto 1 \lor {} \\
                \loc_{tx1} \pointsto 1 \sep \loc_{ty1} \pointsto 0 \sep \loc_{tx2} \pointsto 1 \sep \loc_{ty2} \pointsto 1 \lor {} \\
                \loc_{tx1} \pointsto 1 \sep \loc_{ty1} \pointsto 1 \sep \loc_{tx2} \pointsto 0 \sep \loc_{ty2} \pointsto 1 \lor {} \\
                \loc_{tx1} \pointsto 1 \sep \loc_{ty1} \pointsto 1 \sep \loc_{tx2} \pointsto 1 \sep \loc_{ty2} \pointsto 1 
            \end{formulea}
        } \\
    \end{array}
\]

Above, the 1 0 0 1 case will never happen.
This is called long fork in snapshot isolation, for a single machine snapshot isolation, it should not happen.

We use \( (\dontcare, \dontcare, \dontcare, \dontcare, \dontcare, \dontcare) \) to refer x,y,tx1,ty1,tx2,ty2.

\[
    \begin{array}{@{}c@{}}
        \begin{parl}
            \begin{session}
                \actionline{\rely}{ \loc_{y} \pointsto_{r} \anyval \transfersto \loc_{y} \pointsto_{w} 1 \\
                    \loc_{x} \pointsto_{r} x \sep \loc_{y} \pointsto_{r} y \sep \loc_{tx2} \pointsto_{r} \anyval \sep \loc_{ty2} \pointsto_{r} \anyval \\
                    \transfersto \loc_{x} \pointsto_{r} x \sep \loc_{y} \pointsto_{r} y \sep \loc_{tx2} \pointsto_{w} x \sep \loc_{ty2} \pointsto_{w} y } \\
                    \specline {(0,0,0,0,0,0) \lor (0,1,0,0,0,0) \lor (0,1,0,0,0,1)}\\
                \begin{transaction}
                    \specline {(0,0,0,0,0,0) \lor (0,1,0,0,0,0) \lor (0,1,0,0,0,1)}\\
                    \pmutate{\loc_{x}}{1} ; \\
                    \specline {(1,0,0,0,0,0) \lor (1,1,0,0,0,0) \lor (1,1,0,0,0,1)}\\
                    MERGE \\
                    \specline {(1,0,0,0,0,0) \lor (1,1,0,0,0,0) \lor (1,1,0,0,0,1)}\\
                \end{transaction} \\
                \specline {(1,0,0,0,0,0) \lor (1,1,0,0,0,0) \lor (1,1,0,0,0,1) \lor {} \\
                    (1,0,0,0,1,0) \lor (1,1,0,0,1,1)}\\
                \begin{transaction}
                    \specline {(1,0,0,0,0,0) \lor (1,1,0,0,0,0) \lor (1,1,0,0,0,1) \lor {} \\
                        (1,0,0,0,1,0) \lor (1,1,0,0,1,1)}\\
                    \pderef{\vx}{\loc_{x}} ; \\
                    \pmutate{\loc_{tx1}}{\vx} ; \\
                    \pderef{\vy}{\loc_{y}} ; \\
                    \pmutate{\loc_{ty1}}{\vy} ; \\
                    \specline {(1,0,1,0,0,0) \lor (1,1,1,1,0,0) \lor (1,1,1,1,0,1) \lor {} \\
                        (1,0,1,0,1,0) \lor (1,1,1,1,1,1)}\\
                    MERGE \\
                    \specline {(1,0,1,0,0,0) \lor (1,1,1,1,0,0) \lor (1,1,1,1,0,1) \lor {} \\
                        (1,0,1,0,1,0) \lor (1,1,1,1,1,1) \lor (1,1,1,0,0,0)}\\
                \end{transaction} \\
                \specline {(1,0,1,0,0,0) \lor (1,1,1,1,0,0) \lor (1,1,1,1,0,1) \lor {} \\
                    (1,0,1,0,1,0) \lor (1,1,1,1,1,1) \lor (1,1,1,0,0,0) \lor {}\\
                    (1,1,1,0,1,1)}\\
            \end{session} & 
            \begin{session}
                \actionline{\rely}{ \loc_{x} \pointsto_{r} \anyval \transfersto \loc_{x} \pointsto_{w} 1 \\
                    \loc_{x} \pointsto_{r} x \sep \loc_{y} \pointsto_{r} y \sep \loc_{tx1} \pointsto_{r} \anyval \sep \loc_{ty1} \pointsto_{r} \anyval \\
                    \transfersto \loc_{x} \pointsto_{r} x \sep \loc_{y} \pointsto_{r} y \sep \loc_{tx1} \pointsto_{w} x \sep \loc_{ty1} \pointsto_{w} y } \\
                    \specline {(0,0,0,0,0,0) \lor (1,0,0,0,0,0) \lor (1,0,1,0,0,0)}\\
                \begin{transaction}
                    \specline {(0,0,0,0,0,0) \lor (1,0,0,0,0,0) \lor (1,0,1,0,0,0)}\\
                    \pmutate{\loc_{y}}{1} ; \\
                    \specline {(0,1,0,0,0,0) \lor (1,1,0,0,0,0) \lor (1,1,1,0,0,0)}\\
                \end{transaction} \\
                \specline {(0,1,0,0,0,0) \lor (1,1,0,0,0,0) \lor (1,1,1,0,0,0) \lor {} \\
                    (0,1,0,1,0,0) \lor (1,1,1,1,0,0)}\\
                \begin{transaction}
                    \specline {(0,1,0,0,0,0) \lor (1,1,0,0,0,0) \lor (1,1,1,0,0,0) \lor {} \\
                        (0,1,0,1,0,0) \lor (1,1,1,1,0,0)}\\
                    \pderef{\vx}{\loc_{x}} ; \\
                    \pmutate{\loc_{tx2}}{\vx} ; \\
                    \pderef{\vy}{\loc_{y}} ; \\
                    \pmutate{\loc_{ty2}}{\vy} ; \\
                    \specline {(0,1,0,0,0,1) \lor (1,1,0,0,1,1) \lor (1,1,1,0,1,1) \lor {} \\
                        (0,1,0,1,0,1) \lor (1,1,1,1,1,1)}\\
                    MERGE \\
                    \specline {(0,1,0,0,0,1) \lor (1,1,0,0,1,1) \lor (1,1,1,0,1,1) \lor {} \\
                        (0,1,0,1,0,1) \lor (1,1,1,1,1,1) \lor (1,1,0,0,0,1) }
                \end{transaction} \\
                \specline {(0,1,0,0,0,1) \lor (1,1,0,0,1,1) \lor (1,1,1,0,1,1) \lor {} \\
                    (0,1,0,1,0,1) \lor (1,1,1,1,1,1) \lor (1,1,0,0,0,1) \lor {} \\
                    (1,1,1,1,0,1)}
            \end{session} \\
        \end{parl} \\
        \specline { (1,1,1,0,1,1) \lor (1,1,1,1,1,1) \lor (1,1,1,1,0,1)}
    \end{array}
\]

\[
    \begin{array}{@{}l@{}}
        \begin{parl}
            \begin{session}
                \begin{transaction}
                    \pmutate{\loc_{x}}{1} ; \\
                    \pmutate{\loc_{z}}{1} ; \\
                \end{transaction}
            \end{session} & 
            \begin{session}
                \begin{transaction}
                    \pmutate{\loc_{y}}{2} ; \\
                    \pmutate{\loc_{z}}{2} ; \\
                \end{transaction}
            \end{session} \\
        \end{parl}
    \end{array}
\]
