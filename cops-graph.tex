\begin{figure*}[!t]
\captionsetup[subfigure]{aboveskip=0pt, belowskip=5pt}

%\newcommand{\LEFTROW}{0.66\textwidth}
%\newcommand{\RIGHTROW}{0.33\textwidth}
%\[
%\cl_1 : \begin{transaction}
    %\pmutate{\key_1}{\val_1};
%\end{transaction}
%\]

%\[
%\cl_1 : \begin{transaction}
    %\pderef{\vx}{\key_1}; \
    %\pderef{\vy}{\key_2};
%\end{transaction}
%\]
\begin{subfigure}{\textwidth}
\begin{centertikz}
\draw pic {transaction={r1}{%
        /$\key_1$/$\val_0$/${(t_0,\repl_0),\emptyset}$%
        , /$\key_2$/$\val_0$/${(t_0,\repl_0),\emptyset}$%
}};
\path(r1.north) node[anchor=south] (r1lb) {$\repl_1$};

\draw pic at ($(r1.south east) + (3.4,0.45)$) {transaction={r2}{%
        /$\key_1$/$\val_0$/${(t_0,\repl_0),\emptyset}$%
        , /$\key_2$/$\val_0$/${(t_0,\repl_0),\emptyset}$%
}};
\path(r2.north) node[anchor=south] (r2lb) {$\repl_2$};

\end{centertikz}
\caption{Initial state of a COPS instance with two replicas. Each replica contains two keys with their initial versions.}
\label{fig:initial-cops}
\end{subfigure}

\hrulefill 

\begin{subfigure}{\textwidth}
\begin{centertikz}
\draw pic {transaction={r1}{%
        nonvisible/$\key_1$/$\val_0$/${(t_0,\repl_0),\emptyset}$%
        , nonvisible/$\key_2$/$\val_0$/${(t_0,\repl_0),\emptyset}$%
        , /$\key_1$/$\val_1$/${(t_1,\repl_1),\emptyset}$%
}};
\path(r1.north) node[anchor=south] (r1lb) {$\repl_1$};

\draw pic at ($(r1.south east) + (3.4,0.45)$) {transaction={r2}{%
        nonvisible/$\key_1$/$\val_0$/${(t_0,\repl_0),\emptyset}$%
        , nonvisible/$\key_2$/$\val_0$/${(t_0,\repl_0),\emptyset}$%
        , nonvisible/$\key_1$/$\val'_1$/${(t_1,\repl_2),\emptyset}$%
        , nonvisible/$\key_2$/$\val_2$/${(t_2,\repl_2),\Set{(\key_1,t_1,\repl_2)}}$%
}};
\path(r2.north) node[anchor=south] (r2lb) {$\repl_2$};

\end{centertikz}
\caption{Client \( \cl_1 \) commits a new version of \( \key_1 \) carrying value \( \val_1 \) to replica \( \repl_1 \). Other clients commit versions to different replicas. No synchronisation message has delivered yet.}
\label{fig:cops-after-write-transaction}
\end{subfigure}

%\begin{subfigure}{0.46\textwidth}
%\begin{centertikz}
%\draw pic {transaction={r1}{%
        %nonvisible/$\key_1$/$\val_0$/${(t_0,\repl_0),\emptyset}$%
        %, nonvisible/$\key_2$/$\val_0$/${(t_0,\repl_0),\emptyset}$%
        %, /$\key_1$/$\val_1$/${(t_1,\repl_1),\emptyset}$%
%}};
%\path(r1.north) node[anchor=south] (r1lb) {$\repl_1$};

%\end{centertikz}
%\label{fig:cops-request-key-1}
%\caption{Client \( \cl_1 \) requests reading \( \key_1 \) and \( \key_2 \) from replica \( \repl_1 \). Replica \( \repl_1 \) reads the newest version for \( \key_1 \).}
%\end{subfigure}
%\begin{subfigure}{0.46\textwidth}
%\begin{centertikz}
%%Location x
%\node(locx) {$\key_1 \mapsto$};
%\draw pic at ([xshift=\tikzkvspace]locx.east) {vlist={versionx}{%
        %/$\val_{0}$/${(\txid_0,\repl_0)}$/$\stub$
        %, /$\val_{1}$/${(\txid_1,\repl_1)}$/$\stub$
        %, /$\val'_{1}$/${(\txid_1,\repl_2)}$/$\stub \cup \Set{\txid^1_{\rd}}$
%}};

%%Location y
%\path (versionx.east) + (0.75,0) node (locy) {$\key_2 \mapsto$};
%\draw pic at ([xshift=\tikzkvspace]locy.east) {vlist={versiony}{%
        %/$\val_0$/${(\txid_0,\repl_0)}$/$\stub$
        %, /$\val_2$/${(t_3,\repl_2)}$/$\stub$
%}};
%\end{centertikz}
%\label{fig:cops-request-key-2-on-kvstore}
%\caption{Client \( \cl_1 \) view on kv-store.}
%\end{subfigure}

\begin{tabularx}{\textwidth}{@{} X | c @{}}
\hline\\[-5pt]
\begin{subfigure}{0.49\textwidth}
\begin{centertikz}
\draw pic {transaction={r1}{%
        nonvisible/$\key_1$/$\val_0$/${(t_0,\repl_0),\emptyset}$%
        , nonvisible/$\key_2$/$\val_0$/${(t_0,\repl_0),\emptyset}$%
        , /$\key_1$/$\val_1$/${(t_1,\repl_1),\emptyset}$%
        , nonvisible/$\key_1$/$\val'_1$/${(t_1,\repl_2),\emptyset}$%
        , /$\key_2$/$\val'_2$/${(t_2,\repl_2),\Set{(\key_1,t_1,\repl_2)}}$%
}};
\path(r1.north) node[anchor=south] (r1lb) {$\repl_1$};

\end{centertikz}
\caption{Replica optimistically fetches newest version for \( \key_1,\key_2 \) one by one, between which synchronisation from \( \repl_2 \) arrives.}
\vspace{-15pt}%
\label{fig:cops-request-values}
\end{subfigure}

& 

\begin{subfigure}{0.49\textwidth}
\begin{centertikz}
\draw pic {transaction={r1}{%
        nonvisible/$\key_1$/$\val_0$/${(t_0,\repl_0),\emptyset}$%
        , nonvisible/$\key_2$/$\val_0$/${(t_0,\repl_0),\emptyset}$%
        , nonvisible/$\key_1$/$\val_1$/${(t_1,\repl_1),\emptyset}$%
        , /$\key_1$/$\val'_1$/${(t_1,\repl_2),\emptyset}$%
        , /$\key_2$/$\val'_2$/${(t_2,\repl_2),\Set{(\key_1,t_1,\repl_2)}}$%
}};
\path(r1.north) node[anchor=south] (r1lb) {$\repl_1$};

\end{centertikz}%
\caption{Replica \( \repl_1 \) re-fetched a causally dependent snapshot for keys \( \key_1,\key_2 \) using the dependency sets.}
\vspace{-15pt}%
\label{fig:cops-re-read-values}
\end{subfigure}%
\\ \hline
\end{tabularx}

\caption{COPS protocol}
\label{fig:cops-digraph}
\end{figure*}
