
\begin{figure*}[!t]
\[
\begin{rclarray}
\toL & : & ((\Stacks \times \Snapshots \times \Fingerprints) \times \Transactions) \times ((\Stacks \times \Snapshots \times \Fingerprints) \times \Transactions)
\end{rclarray}
\]
\begin{mathpar}
    \infer[\rl{TPrimitive}]{%
        (\stk, \sn, \fp) , \transpri \ \toL \  (\stk', \sn', \fp \addO \op) , \pskip 
    }{%
        (\stk, \sn) \toLTS{\transpri} (\stk', \sn')
        \\ \op = \func{op}{\stk, \sn, \transpri}
    }
    \\\
    \infer[\rl{TChoice}]{%
        (\stk, \sn, \fp) , \trans_{1} \pchoice \trans_{2} \ \toL \  (\stk, \sn, \fp) , \trans_{i}
    }{
        i \in \Set{1,2}
    }
    \and
    \infer[\rl{TIter}]{%
        (\stk, \sn, \fp),  \trans\prepeat \ \toL \  (\stk, \sn, \fp), \pskip \pchoice (\trans \pseq \trans\prepeat)
    }{ } 
    \and
    \infer[\rl{TSeqSkip}]{%
        (\stk, \sn, \fp), \pskip \pseq \trans \ \toL \  (\stk, \sn, \fp), \trans
    }{ }
    \and
    \infer[\rl{TSeq}]{%
        (\stk, \sn, \fp), \trans_{1} \pseq \trans_{2} \ \toL \  (\stk', \sn', \fp'), \trans_{1}' \pseq \trans_{2}
    }{%
        (\stk, \sn, \fp), \trans_{1} \ \toL \  (\stk', \sn', \fp'), \trans_{1}'
    }
\end{mathpar}
\hrulefill
\[
\begin{rclarray}
	\toT{}  & : &
    \begin{array}[t]{@{}c@{}}
    \Clients \; \times \;
	\left( ( \MKVSs \times \Views \times \Stacks ) \times \Commands \right)  
    \; \times\; \ETs \;\times \sort{Labels} \times \;
	\left( ( \MKVSs \times \Views \times \Stacks ) \times \Commands \right) 
    \end{array}
\end{rclarray}
\]
\begin{mathpar}
    \infer[\rl{CAtomicTrans}]{%
        \cl \vdash 
        ( \mkvs, \vi, \stk ), \ptrans{\trans} \ 
        \toT{(\cl, \vi'', \fp)}_{\ET} \ 
        (\mkvs',\vi', \stk' ) , \pskip
    }{%
		\begin{array}{@{} c @{}}
			\vi \orderVI  \vi''
            \quad \sn = \snapshot[\mkvs,\vi'']
			\quad \txid \in \nextTxid(\cl, \mkvs) \\
			(\stk, \sn, \emptyset), \trans \toL^{*}   (\stk', \stub,  \fp) , \pskip
            \quad \mkvs' = \updateKV(\mkvs, \vi'', \fp, \txid) 
            \quad \ET \vdash (\mkvs, \vi'') \csat \fp : (\mkvs',\vi')
			%\qquad \ET \vdash (\mkvs, \vi'') \triangleright \fp : \vi'
		\end{array}
    }
    \and
    \infer[\rl{CPrimitive}]{%
    \cl \vdash ( \mkvs, \vi, \stk ) , \cmdpri \ \toT{(\cl,\iota)}_{\ET} \  ( \mkvs, \vi, \stk' ) , \pskip
    }{
        \stk \toLTS{\cmdpri} \stk'
    }
    \and
    \infer[\rl{CChoice}]{%
        \cl \vdash ( \mkvs, \vi, \stk ) , \cmd_{1} \pchoice \cmd_{2} \ \toT{(\cl,\iota)}_{\ET} \  ( \mkvs, \vi, \stk ) , \cmd_{i}
    }{
        i \in \Set{1,2}
    }
    \quad
    \infer[\rl{CIter}]{%
        \cl \vdash ( \mkvs, \vi, \stk ) , \cmd\prepeat \ \toT{(\cl,\iota)}_{\ET} \  ( \mkvs, \vi, \stk ) , \pskip \pchoice (\cmd \pseq \cmd\prepeat)
    }{ }
    \and
    \infer[\rl{CSeqSkip}]{%
        \cl \vdash ( \mkvs, \vi, \stk ) , \pskip \pseq \cmd \ \toT{(\cl,\iota)}_{\ET} \  ( \mkvs, \vi, \stk ) , \cmd
    }{ }
    \quad
    \infer[\rl{CSeq}]{%
        \cl \vdash ( \mkvs, \vi, \stk ) , \cmd_{1} \pseq \cmd_{2} \ \toT{(\cl,\iota)}_{\ET} \ ( \mkvs, \vi', \stk' ) , {\cmd_{1}}' \pseq \cmd_{2}
    }{% 
        \cl \vdash ( \mkvs, \vi, \stk ) , \cmd_{1} \ \toT{(\cl,\iota)}_{\ET} \  ( \mkvs, \vi', \stk' ) , {\cmd_{1}}' 
    }
\end{mathpar}
\vspace*{5pt}

\hrulefill

\[
	\toG{} : 
    ( \Confs \times \ThdEnv \times \Programs) 
    \;\times\; \ETs \;\times \sort{Label} \times \;
    ( \Confs \times \ThdEnv \times \Programs) 
\]
\begin{mathpar}
    \infer[\rl{PProg}]{%
    ( \mkvs, \viewFun, \thdenv ) , \prog \ \toG{\lambda}_{\ET} \  ( \mkvs', \viewFun\rmto{\cl}{\vi'}, \thdenv\rmto{\cl}{\stk'}) , \prog\rmto{\cl}{\cmd'} 
    }{%
        \cl \vdash ( \mkvs, \viewFun(\cl), \thdenv(\cl) ), \prog(\cl), \ \toT{\lambda}_{\ET} \  ( \mkvs', \vi', \stk' ) , \cmd'  
    }
\end{mathpar}
%
\hrulefill
\caption{Operational Semantics on Key-value Store}
\label{fig:transaction_semantics}
\label{def:thread_semantics}
\label{fig:thread_semantics}
\label{def:thread_pool_semantics}
\label{fig:thread_pool_semantics}
\label{def:program_semantics}
\label{fig:program_semantics}
\label{fig:full-semantics}
\end{figure*}
