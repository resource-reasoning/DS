\subsection{Normal \( \ET \) Traces}
\label{sec:normal-form-exist}
For technical reasons, it will be convenient to adopt a reduction strategy for inferring kv-stores induced by an 
execution test: such an execution strategy require that clients only commit transactions with non-empty fingerprints, 
and a client updates its view only immediately before committing a transaction. 
The next proposition states that all kv-stores induced by an execution test $\ET$ can be 
obtained via a sequence of reductions that adhere to the reduction strategy outlined above. 
Note that throughout this section, we assume that the execution test $\ET$ is fixed.

\begin{definition}
Let $\ET$ be an execution test. The $\ET$-trace
\[
\conf_0 \xrightarrowtriangle{\alpha_0}_{\ET} \conf_1 \xrightarrowtriangle{\alpha_1}_{\ET} \cdots \xrightarrowtriangle{\alpha_{2n}}_{\ET} \conf_{2n + 1}
\]
is in \emph{normal form} if \textbf{(i)} $\conf_0$ is initial, and 
\textbf{(ii)} $\forall i=0,\cdots, n$ there exists a client $\cl_i$ and set of operations $\fp_{i}$ such that 
$\alpha_{2 \cdot i} = (\cl_{i}, \varepsilon)$, and $\alpha_{2 \cdot i + 1}$ is defined and equal to $(\cl_{i}, \fp_{i})$ where \( \fp_i \neq \emptyset \).
\end{definition}

For any trace satisfying \( \CMs(\ET) \), 
there exists a equivalent normal trace ends up with the same state (\cref{prop:et.normalform}).

\begin{proposition}[Normal \( \ET \) Traces]
\label{prop:et.normalform}
Let $\ET$ be an execution test, and suppose that $\mkvs \in \CMs(\ET)$. Then there exists a $\ET$-trace  
\[
(\hh_0, \viewFun_0) \xrightarrowtriangle{\stub}_{\ET} \cdots \xrightarrowtriangle{\stub}_{\ET} (\hh_n, \viewFun_{n})
\]
that is in normal form, and such that $\hh_{n} = \mkvs$.
\end{proposition}
\begin{proof}
Let $\mkvs \in \CMs(\ET)$. By definition, there exists a sequence of reductions 
\begin{equation}
\label{eq:normalform.sequence}
(\hh_{0}, \viewFun_{0}) \xrightarrowtriangle{(\cl_0, \mu_0)}_{\ET} \cdots \xrightarrowtriangle{(\cl_{n-1}, \mu_{n-1})}_{\ET} (\hh_n, \viewFun_{n})
\end{equation}
such that $\hh_{n} = \mkvs$. Given an index $i = 1,\cdots, n-1$, we say that the action $(\cl_{i}, \mu_{i})$ is \emph{in place} 
if, $\mu_{i} = \fp_{i}$ for some $\fp_{i}$, $\cl_{i-1} = \cl_{i}$, $\mu_{i-1} = \varepsilon$, and if $(\cl_{j}, \mu_{j}) = (\cl_{i}, \varepsilon)$, 
for some  $j = 0,\cdots, i-2$, then there exists $j': j < j' < i$ such that $(\cl_{j'}, \mu_{j'}) = (\cl_i, \fp_{j'})$. An action of the 
form $(\cl_{i}, \mu_{i})$ is \emph{out of place} if it is not in place. 

Given the sequence of reductions in \cref{eq:normalform.sequence}, we show the following: 
\begin{enumerate}
\item if the sequence has no action out of place, then there exists a sequence 
\[
(\mkvs'_{0}, \viewFun'_{0}) \xrightarrowtriangle{(\cl'_{0}, \mu'_{0})}_{\ET} \cdots \xrightarrowtriangle{(\cl'_{m-1}, \mu'_{m-1})}_{\ET} (\mkvs'_{m}, \viewFun'_{m})
\]
that is in normal form, and such that $\mkvs'_{m} = \hh_{n}$, and 
\item if the sequence has $h$ actions out of place, for some $h > 0$, then there exists a sequence 
\[
(\mkvs'_{0}, \viewFun'_{0}) \xrightarrowtriangle{(\cl'_{0}, \mu'_{0})}_{\ET} \cdots \xrightarrowtriangle{(\cl'_{m-1}, \mu'_{m-1})}_{\ET} (\mkvs'_{m}, \viewFun'_{m})
\]
that has $h-1$ actions out of place, and such that $\mkvs'_{m} = \hh_{n}$.
\end{enumerate}
Combining the two facts above, we obtain that if $\mkvs \in \CMs(\ET)$, then there exists a sequence of reductions in formal form whose final 
configuration is $(\mkvs, \_)$, as we wanted to prove.

\begin{enumerate}
\item 
Suppose that the sequence of reductions from \cref{eq:normalform.sequence} has no action out of place. 
Let $i=0,\cdots, n-1$, and consider the greatest index $i=0,\cdots, n-1$ such that  
$\mu_{i} = \varepsilon$, and either $i = n-1$, or 
$\forall \fp.\; (\cl_{i+1}, \mu_{i+1}) \neq (\cl_{i}, \fp)$. 
If such an index does not exist, then the sequence of transitions from \cref{eq:normalform.sequence} is in 
normal form, and there is nothing to prove. Otherwise, note that for any $j = i+1,\cdots, n-1$, 
$\forall \fp.\;(\cl_{j}, \mu_{j}) \neq (\cl_{i}, \fp)$. 

Suppose in fact that there existed 
an index $j = i+1,\cdots, n-1$ such that $(\cl_{j}, \mu_{j}) = (\cl_{i}, \fp_{j})$ for some 
$\fp_{j}$, and without loss of generality assume that $j$ is the smallest such index. This implies that 
there exists no index $j': i < j' < j$ such that $(\cl_{j'}, \mu_{j'}) = (\cl_{i}, \fp_{j'})$ for some 
$\fp_{j'}$. Also, it cannot be $j = i+1$, because we are assuming that $\forall \fp.\;(\cl_{i+1}, \mu_{i+1}) \neq 
(\cl_{i}, \fp)$.  We have that $j \geq i+2$; we also have that  $(\cl_{j}, \mu_{j}) = (\cl_{i}, \fp_{j})$, 
$(\cl_{i}, \mu_{i}) = (\cl_{i}, \varepsilon)$, $\forall j': i < j < j'.\forall \fp.\; (\cl_{j'}, \mu_{j'}) \neq (\cl_{i}, \fp)$. 
By definition, the action $(\cl_{j}, \mu_{j})$ is out of place, contradicting the assumption that the sequence of 
reduction of \cref{eq:normalform.sequence} has no actions out of place.

We have proved that $\forall j = i+1, \cdots, n-1.\;\forall \fp.\;(\cl_{j}, \mu_{j}) \neq (\cl_{i}, \fp)$. 
Also, because we are assuming that $\mu_{i}$ is the greatest index such that $\mu_{i} = \varepsilon$, 
and either $i= n-1$ or $\forall \fp.\;(\cl_{i+1},\mu_{i+1}) \neq (\cl_{i}, \fp)$, 
then $\forall j=i+1,\cdots, n-1\;\forall \mu.\;(\cl_{j}, \mu_{j}) \neq (\cl_{i}, \mu)$. 
Consider the transition 
\[
(\hh_{i}, \viewFun_{i}) \xrightarrowtriangle{(\cl_{i}, \mu_{i})}_{\ET} (\hh_{i+1}, \viewFun_{i+1}).
\]
Let $\vi = \viewFun_{i}(\cl)$. Because $\mu_{i} = \varepsilon$, then it must be the case that 
$\hh_{i} = \hh_{i+1}$, $\viewFun_{i+1} = \viewFun_{i}\rmto{\cl}{\vi'}$ for some $\vi' : \vi \sqsubseteq \vi'$. 
For any $j \geq i$, we have that $\cl_{j} \neq \cl_{i}$. We can replace the transition 
\[
(\hh_{j}, \viewFun_{j}) \xrightarrowtriangle{(\cl_{j}, \mu_{j})}_{\ET} (\hh_{j+1}, \viewFun_{j+1})
\]
with 
\[
(\hh_{j}, \viewFun_{j}\rmto{\cl_{i}}{\vi}) \xrightarrowtriangle{(\cl_{j}, \mu_{j})}_{\ET} (\hh_{j+1}, \viewFun_{j+1}\rmto{\cl_{i}}{\vi}.
\]
It follows that the sequence of transitions 
\[ 
\begin{array}{@{}l@{}}
(\hh_{0}, \viewFun_{0}) \xrightarrowtriangle{(\cl_{0}, \mu_{0})}_{\ET} \cdots \xrightarrowtriangle{(\cl_{i-1},\mu_{i-1})} 
(\hh_{i}, \viewFun_{i}) = (\hh_{i+1}, \viewFun_{i+1}\rmto{\cl_{i}}{\vi})  \\
\quad \xrightarrowtriangle{(\cl_{i+1}, \mu_{i+1})}_{\ET} \cdots 
\xrightarrowtriangle{(\cl_{n-1}, \mu_{n-1})}_{\ET} (\cl_{n}, \viewFun_{n}\rmto{\cl_{i}, \vi})
\end{array}
\]
Note that this sequence has one reduction less than the original sequence from \eqref{eq:normalform.sequence} (specifically, 
the reduction $(\hh_{i}, \viewFun_{i}) \xrightarrowtriangle{(\cl_{i}, \mu_{i})} (\hh_{i+1}, \viewFun_{i+1})$ has 
been removed). We can repeat this procedure until the resulting sequence of reductions has no index $i=0,\cdots, n-1$ such that  
$\mu_{i} = \varepsilon$, and either $i = n-1$, or 
$\forall \fp.\; (\cl_{i+1}, \mu_{i+1}) \neq (\cl_{i}, \fp)$. That is, the resulting sequence of reductions is in normal form, 
and its final configuration is $(\hh_{n}, \_)$.

\item Suppose that the sequence from \cref{eq:normalform.sequence} has $h$ actions out of place, 
where $h > 0$. Let $i$ be the smallest index such that $(\cl_{i}, \mu_{i})$ is out of place. 
This means that either $i = 0$, or $(\cl_{i-1}, \mu_{i-1}) \neq (\cl_{i}, \varepsilon)$, 
or there exists an index $j < i -1 $ such that $(\cl_{j}, \mu_{j}) = (\cl_{i}, \varepsilon)$ 
and, $\forall j': j < j' < i.\;\forall \fp.\;(\cl_{j'}, \mu_{j'}) \neq (\cl_{i}, \fp)$. 
Without loss of generality, we can assume that $i \neq 0$ and $(\cl_{i-1}, \mu_{i-} = (\cl_{i}, \varepsilon)$. 
This is because we can always transform the sequence of reductions of \cref{eq:normalform.sequence} by 
introducing a transition of the form $(\hh_{i}, \viewFun_{i}) \xrightarrowtriangle{(\cl_{i}, \varepsilon)}_{\ET}
(\hh_{i}, \viewFun_{i})$, leading to the sequence of reductions
\[
\begin{array}{@{}l@{}}
(\hh_{0}, \viewFun_{0}) \xrightarrowtriangle{(\cl_{0}, \mu_{0})}_{\ET} \cdots \xrightarrowtriangle{(\cl_{i-1}, \mu_{i-1})}_{\ET}
(\hh_{i}, \viewFun_{i}) \\
\quad \xrightarrowtriangle{(\cl_{i}, \varepsilon)}_{\ET} (\hh_{i}, \viewFun_{i}) \xrightarrowtriangle{(\cl_{i+1}, \mu_{i+1})}_{\ET} 
\cdots \xrightarrowtriangle{(\cl_{n-1}, \mu_{n-1})}_{\ET} (\hh_{n}, \viewFun_{n})
\end{array}
\]

Therefore, it must be the case that there exists an index $j < i-1$ such that $(\cl_{j}, \mu_{j}) = (\cl_{i}, \varepsilon)$, 
and $\forall j': j< j' < i.\;\forall \fp.\;(\cl_{j'}, \mu_{j'}) \neq (\cl_{i}, \fp)$. Let then $j$ be the smallest such index. 
Let $d = (i-1)-j$ be the number of reductions that separate the configuration $(\hh_{j}, \mu_{j})$ from 
$(\hh_{i-1}, \mu_{i-1})$ in \cref{eq:normalform.sequence}. Note that it must be the case that $d > 0$. We show that we can 
construct a sequence of reductions where the distance between these two configurations is reduced to $0$: 
a consequence of this fact is such a sequence of reductions would have exactly $h-1$ actions out of place.
Consider the following fragment in the sequence of reductions from \cref{eq:normalform.sequence}:
\[
(\hh_{j}, \viewFun_{j}) \xrightarrowtriangle{(\cl_{j}, \mu_{j})}_{\ET} (\hh_{j+1}, \viewFun_{j+1}) 
\xrightarrowtriangle{(\cl_{j+1}, \mu_{j+1})}_{\ET} (\hh_{j+2}, \viewFun_{j+2})
\]
We have two possible cases: 
\begin{itemize}
\item $\cl_{j+1} \neq \cl_{j}$. In this case we can apply \cref{lem:viewshift.rightmover} and infer the sequence of 
reductions 
\[
(\hh_{j}, \viewFun_{j}) \xrightarrowtriangle{(\cl_{j+1}, \mu_{j+1})}_{\ET} (\hh_{j+1}', \viewFun_{j+1}') 
\xrightarrowtriangle{(\cl_{j}, \mu_{j})}_{\ET} (\hh_{j+1}, \viewFun_{j+1})
\]
which leads to the whole sequence of reductions 
\[
\begin{array}{@{}l@{}}
(\hh_{0}, \viewFun_{0}) \toEdge{(\cl_{0}, \mu_{0})}_{\ET} \cdots 
\xrightarrowtriangle{(\cl_{j-1}, \mu_{j-1})}_{\ET} (\cl_{j}, \mu_{j}) 
\xrightarrowtriangle{(\cl_{j+1}, \mu_{j+1})}_{\ET} (\mkvs'_{j+1}, \viewFun'_{j+1})  \\
\quad \xrightarrowtriangle{(\cl_{j}, \mu_{j})}_{\ET} (\hh_{j+1}, \viewFun_{j+1})  
\xrightarrowtriangle{(\cl_{j+2}, \mu_{j+2})}_{\ET} \cdots \xrightarrowtriangle{(\cl_{n-1}, \mu_{n-1})} \hh_{n}, \viewFun_{n}
\end{array}
\]
\item $\cl_{j+1} = \cl_{j}$. In this case we can apply \cref{lem:et.absorb} and infer the reduction 
\[
(\hh_{j}, \viewFun_{j}) \xrightarrowtriangle{(\cl_{j}, \varepsilon)}_{\ET} (\hh_{j+2}, \viewFun_{j+2})
\]
which leads to the sequence of reductions 
\[
\begin{array}{@{}l@{}}
(\hh_{0}, \viewFun_{0}) \toEdge{(\cl_{0}, \mu_{0})}_{\ET} \cdots 
\xrightarrow{(\cl_{j-1}, \mu_{j-1})}_{\ET} (\hh_{j}, \viewFun_{j}) \xrightarrowtriangle{(\cl_{j}, \varepsilon)}_{\ET}  \\
\quad (\hh_{j+2}, \viewFun_{j+2}) \xrightarrowtriangle{(\cl_{j+2}, \mu_{j+2})}_{\ET} \cdots 
\xrightarrowtriangle{(\cl_{n-1}, \mu_{n-1})}_{\ET} (\hh_{n}, \viewFun_{n})
\end{array}
\]
\end{itemize}
In both cases, in the resulting sequence of reductions the number of reductions that separate 
the configuration $(\hh_{j}, \viewFun_{j})$ from $(\hh_{i-1}, \viewFun_{i-1})$ is strictly 
less than $d$. We can repeating applying the procedure outlined above until there are 
no reductions that separate the configuration $(\hh_{j}, \viewFun_{j})$ from 
$(\hh_{i}, \viewFun_{i})$.
\end{enumerate}
\end{proof}
\ac{This was more of a proof sketch, rather than a real proof. For the moment it will suffice, though 
I will need to go back at it when all the other results are sorted.}


\begin{lemma}[Absorption]
\label{lem:et.absorb}
If $\conf \xrightarrowtriangle{(\cl, \varepsilon)}_{\ET} \conf' \xrightarrowtriangle{(\cl, \varepsilon)} \conf''$, then 
$\conf \xrightarrowtriangle{(\cl, \varepsilon)}_{\ET} \conf''$.
\end{lemma}

\begin{proof}
Let $\conf = (\mkvs, \viewFun)$, $\conf' = (\mkvs', \viewFun')$, $\conf'' = (\mkvs', \viewFun'')$. 
By the reduction it must be the case that $\mkvs = \mkvs'$, and $\viewFun' = \viewFun\rmto{\cl}{\vi'}$ 
for some $\vi' : \vi \sqsubseteq \vi'$. It must also be the case that $\mkvs' = \mkvs''$, and $\viewFun'' = \viewFun'\rmto{\cl}{\vi''}$ 
for some $\vi'': \vi' \sqsubseteq \vi''$. Therefore we have that $\mkvs'' = \mkvs' = \mkvs$, and 
$\viewFun'' = \viewFun'\rmto{\cl}{\vi''} = (\viewFun\rmto{\cl}{\vi'})\rmto{\cl}{\vi''} = \viewFun\rmto{\cl}{\vi''}$, 
and $\vi \sqsubseteq \vi''$. 
It follows that $\conf = (\mkvs, \viewFun) \xrightarrowtriangle{(\cl, \varepsilon)} (\mkvs'', \viewFun'') = \conf''$.
\end{proof}

\begin{lemma}[Independence of commit]
\label{lem:viewshift.rightmover}
Let $\conf \xrightarrowtriangle{(\cl, \varepsilon)}_{\ET} \conf_1 \xrightarrowtriangle{(\cl', \mu)}_{\ET} \conf'$ 
for some $\conf, \conf_1, \conf''$ and $\cl, \cl'$ such that $\cl' \neq \cl$. 
Then $\conf \xrightarrowtriangle{(\cl', \mu)}_{\ET} \conf_2 \xrightarrowtriangle{(\cl, \varepsilon)}_{\ET} \conf'$ 
\end{lemma}

\begin{proof}
We only consider the case where $\mu = \fp$ for some fingerprint $\fp$. The case where 
$\mu = \varepsilon$ is simpler to prove.
Let $\conf = (\mkvs, \viewFun)$, $\conf_1 = (\hh_1, \viewFun_1)$, $\conf' = (\mkvs', \viewFun')$. 
Let also $\vi = \viewFun(\cl)$.
By the reduction rule we have that $\hh_1 = \mkvs, \viewFun_1 = \viewFun\rmto{\cl}{\vi_1}$ for 
some $\vi_1: \vi_1 \sqsubseteq \vi_1$. Let $\vi' = \viewFun(\cl')$: then we have that $\viewFun_1(\cl') = 
\vi'$. Because $(\hh_1, \viewFun_1) \xrightarrowtriangle{(\cl', \fp)}_{\ET} (\mkvs', \viewFun')$, we have that 
$\ET \vdash (\hh_1, \vi') \csat \fp : (\mkvs',\vi'') $, where $\vi'' = \viewFun'(\cl')$. Because $\hh_1 = \mkvs$, 
that means that $\ET \vdash (\mkvs, \vi') \csat \fp: (\mkvs', \vi'')$, then it follows that 
$(\mkvs, \viewFun) \xrightarrowtriangle{(\cl', \fp)}_{\ET} (\mkvs', \viewFun\rmto{\cl'}{\vi''}) 
\xrightarrowtriangle{(\cl, \varepsilon)}_{\ET} (\mkvs', \viewFun\rmto{\cl'}{\vi''}\rmto{\cl}{\vi_1}) = 
(\mkvs', \viewFun\rmto{\cl}{\vi_1}\rmto{\cl'}{\vi''}) = (\mkvs', \viewFun_1\rmto{\cl'}{\vi''}) = 
(\mkvs', \viewFun')$, as we wanted to prove.
\end{proof}
