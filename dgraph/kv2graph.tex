\emph{Dependency graphs} are introduced by Adya to specify consistency models of transactional databases \cite{adya}. 
They are directed graphs consisting of transactions as nodes, 
each of which is labelled with transaction identifier and a set of read and write operations,
and labelled edges between transactions for specifying how information flows between nodes. 
Specifically, a transaction $\txid$ reads a version for a key $\ke$ that has been written by another transaction $\txid'$ 
(\emph{write-read dependency} \( \WR\)), overwrites a version of $\ke$ written by $\txid'$ (\emph{write-write dependency} \( \WW \)),
or reads a version of $\ke$ that is later overwritten by $\txid'$ (\emph{read-write anti-dependency} \( \RW \)).
Note that here we purposely use the same names \( \WR, \WW, \RW \) as those used in key-value store,
since there is one-to-one map between key-value stores and dependency graphs.

\ifTechReport
\input{\RootPath/dgraph/depend-aexec-fig.tex}
\fi

\begin{definition}
\label{def:dgraph}
A \emph{dependency graph} is a quadruple $\Gr = (\TtoOp{T}, \RF, \VO, \AD)$, where
\begin{itemize}
\item 
    $\TtoOp{T}_0: \TxID \parfinfun \powerset{\Ops}$ is a partial finite mapping from transaction identifiers 
    to the set of operations, where there are at most one read operation and one write operation per key;
\item 
    $\RF : \Keys \to \pset{\dom(\TtoOp{T}) \times \dom(\TtoOp{T})}$ is a function that 
maps each key $\ke$ into a relation between transactions, such that for any $\txid, \txid_1, \txid_2, 
\ke, \cl, m, n$: 
\begin{itemize}
\item if $(\otR, \ke, \val) \in \TtoOp{T}(\txid)$, either $\val = \val_0$ 
and there exists no $\txid'$ such that $\txid' \xrightarrow{\RF(\ke)} \txid$,  
or there exists $\txid'$ such that $(\otW, \ke, \val) \in \TtoOp{T}(\txid')$, and $\txid' \xrightarrow{\RF(\ke)} \txid$, 
\item if $\txid_1 \xrightarrow{\RF(\ke)} \txid$ and $\txid_2 \xrightarrow{\RF(\ke)} \txid$, then 
$\txid_2 = \txid_1$.
\item if $\txid_{\cl}^{m} \xrightarrow{\RF(\ke)} \txid_{\cl}^{n}$, then $m < n$.
\end{itemize}
\item $\VO: \Keys \to \pset{\dom(\TtoOp{T}) \times \dom(\TtoOp{T})}$ is a function 
that maps each key into an irreflexive relation between transactions, such that for any $\txid, \txid', \ke, \cl, m, n$, 
\begin{itemize}
\item if $\txid \xrightarrow{\VO(\ke)} \txid'$, then $(\otW, \ke, \_) \in \TtoOp{T}(\txid), (\otW, \ke, \_) \in \TtoOp{T}(\txid')$, 
\item if $(\otW, \ke, \_) \in \TtoOp{T}(\txid), (\otW, \ke, \_) \in \TtoOp{T}(\txid')$, then either $\txid = \txid'$, 
$\txid \xrightarrow{\VO(\ke)} \txid'$, or $\txid' \xrightarrow{\VO(\ke)} \txid$.
\item if $\txid_{\cl}^{m} \xrightarrow{\WW(\ke)} \txid_{\cl}^{n}$, then $m < n$.
\end{itemize}
\item $\AD: \Keys \to \pset{\dom(\TtoOp{T}) \times \dom(\TtoOp{T})}$ is defined 
by letting $\txid \xrightarrow{\AD(\ke)} \txid'$ if and only if $(\otR, \ke, \_) \in \TtoOp{T}(\txid)$, 
$(\otW, \ke, \_) \in \TtoOp{T}(\txid')$ and 
either there exists no $\txid''$ such that $\txid'' \xrightarrow{\RF(\ke)} \txid$, or 
$\txid'' \xrightarrow{\RF(\ke)} \txid$, $\txid'' \xrightarrow{\VO(\ke)} \txid'$ for 
some $\txid''$.
\end{itemize}
Let $\Dgraphs$ be the set of all dependency graphs.
\end{definition}

Given a dependency graph $\Gr = (\TtoOp{T}, \RF, \VO, \AD)$, we often 
commit an abuse of notation and use $\RF$ to denote the relation 
$\bigcup\limits_{\ke \in \Keys} \RF(\ke)$; a similar notation is adopted for $\VO, \AD$. 
It will always be clear from the context whether the symbol $\RF$ refers to a function 
from keys to relations, or to a relation between transactions. 

\begin{definition}
\label{def:kv2graph}
Given a kv-store $\hh$, the \emph{dependency graph} $\Gr_{\hh} = (\TtoOp{T}_{\hh}, \RF_{\hh}, 
\VO_{\hh}, \AD_{\hh})$ is defined as follows: 
\begin{itemize}
\item for any $\txid \neq \txid_0$, $\TtoOp{T}_{\hh}(\txid)$ is defined if and only if there exists an index $i$ and a key 
$\ke$ such that either $\txid = \WTx(\hh(\ke, i))$, or $\txid \in \RTx(\hh(\ke,i))$; furthermore, 
$(\otW, \ke, \val) \in \TtoOp{T}(\txid)$ if and only 
if $\txid = \WTx(\hh(\ke, i))$ for some $i$, and 
$(\otR, \ke, \val) \in \TtoOp{T}(\txid)$ if and only if $\txid \in \RTx(\hh(\ke, i))$ for some $i$, 
\item $\txid \xrightarrow{\RF(\ke)} \txid'$ if and only if there exists an index $i: 0 < i < \lvert \hh(\ke) \rvert$ 
such that $\txid = \WTx(\hh(\ke, i))$, and $\txid' \in \RTx(\hh(\ke, i))$, 
\item $\txid \xrightarrow{\VO(\ke)} \txid'$ if and only if there exist two indexes $i,j$: $0 < i < j < \lvert \hh(\ke) \rvert$ 
such that $\txid = \WTx(\ke, i)$, $\txid' = \WTx(\ke, j)$, 
\item $\txid \xrightarrow{\AD(\ke)} \txid'$ if and only if there exist two indexes $i,j$: $0 < i < j < \lvert \hh(\ke) \rvert$ 
such that $\txid \in \RTx(\ke, i)$ and $\txid' = \WTx(\ke, j)$.
\end{itemize}
\end{definition}

\begin{definition}
\label{def:dependency-to-kv-store}
Given a dependency graph $\Gr = (\TtoOp{T}, \RF, \VO, \AD)$, we define the kv-store $\hh_{\Gr}$ as follows: 
\begin{enumerate}
\item for any transaction $\txid \in \dom(\TtoOp{T})$ such that $(\otW, \ke, \val) \in \TtoOp{T}(\txid)$, 
let $\T = \{ \txid' \mid \txid \xrightarrow{\RF(\ke)} \txid'\}$, and let $\ver(\txid, \ke) = (\val, \txid, \T)$, 
\item For each key $\ke$, let $\ver_{\ke}^{0} = (\val_0, \txid_0, \T_k^{0})$, where $\T_{k}^{0} = \{ \txid \mid (\otR, \ke, \_) \in 
\TtoOp{T}(\txid) \wedge \forall \txid'.\; \neg( \txid' \xrightarrow{\RF(\ke)} \txid \}$. 
Let also  $\{ \ver_{\ke}^{i} \}_{i = 1}^{n}$ be the ordered set of versions such that, for any 
$i=1,\cdots,n$, $\ver_{\ke}^{i} = \ver(\txid, \ke)$ for some $\txid$ such that $(\otW, \ke, \_) \in \TtoOp{T}(\txid)$, 
and such that for any $i, j: 1 \leq i < j \leq n$, $\WTx(\ver_{\ke}^{i}) \xrightarrow{\VO(\ke)} \WTx(\ver_{\ke}^{j})$. 
Then we let $\hh_{\Gr}= \lambda \ke. \prod_{i=0}^{n} \ver_{\ke}^{i}$.
\end{enumerate}
\end{definition}

\begin{theorem}
\label{thm:kv2graph}
There is a one-to-one map between key-value stores and dependency graphs.
\end{theorem}
\begin{proof}
    We prove that given any a well-formed kv-store \( \mkvs \), then $\Gr_{\hh}$ is a well-formed dependency graph in \cref{prop:well-formed-kv-store-to-dependency},
    and given any \( \Gr \), then  $\hh_{\Gr}$ is a well-formed kv-store in \cref{prop:well-formed-dependency-to-kv-store}.
    Then we prove the bijection that $\hh_{\Gr_{\hh}} = \hh$ in \cref{prop:bijection:mkvs-dgraph}.
\end{proof}



\begin{proposition}
\label{prop:well-formed-kv-store-to-dependency}
Let $\hh$ be a well-formed kv-store. Then $\Gr_{\hh}$ is a well-formed dependency graph.
\end{proposition}

\begin{proof}
Let $\hh$ be a (well-formed) kv-store. We need to show that 
$\Gr_{\hh} = (\TtoOp{T}_{\hh}, \RF_{\hh}, \VO_{\hh}, \AD_{\hh})$ is a dependency graph. 
As a first step, we show that $\Gr_{\hh}$ is a dependency graph, 
i.e. it satisfies all the constraints placed by \cref{def:dgraph}.

\begin{itemize}
\item Let $\txid \in \dom(\TtoOp{T}_{\hh})$, and suppose that $(\otR, \ke, \val) \in \TtoOp{T}_{\hh}(\txid)$. 
We need to prove that either $\val = \val_{0}$, and there exists no $\txid' \in \dom(\TtoOp{T}_{\hh})$ such that 
$\txid' \xrightarrow{\RF_{\hh}(\ke)} \txid$, or $\txid' \xrightarrow{\RF_{\hh}(\ke)} \txid$ for some 
$\txid' \in \dom(\TtoOp{T}_{\hh})$ such that $(\otW, \ke, \val) \in \TtoOp{T}_{\hh}(\txid')$. 
Because $\txid \in \dom(\TtoOp{T}_{\hh})$, the definition of $\Gr_{\hh}$ (and in particular the 
fact that $\TtoOp{T}_{\hh} : \TxID_{0} \rightharpoonup \powerset{\Ops}$) ensures that 
$\txid \neq \txid_0$. Furthermore, because $(\otR, \ke, \val) \in \TtoOp{T}_{\hh}(\txid)$, there 
must exist an index $i: 0 \leq i < \lvert \hh(\ke) \rvert$ such that $\hh(\ke, i) = (\val, \txid', \{\txid \} \cup \_ )$ 
for some $\txid' \in \TxID$. 
We have two possibilities: 
\begin{enumerate}
\item $i = 0$, in which case the hypothesis that $\hh$ is well-formed ensures that $\txid' = \txid_0$, 
and $\val = \val_0$. We also have that there exists no transaction $\txid''$ such that $\txid'' \xrightarrow{\RF_{\hh}(\ke)} \txid$: 
in fact, by \cref{def:kv2graph}, we have that $\txid'' \xrightarrow{\RF(\ke)} \txid$ if and only if there exists an index 
$j: 0 < j < \lvert \hh(\ke) \rvert$ such that $\hh(\ke, j) = (\_, \txid'', \{\txid\} \cup \_)$. However, in this case we would 
have that $0 < j$, and $\txid \in \RTx(\hh(\ke, j)) \cap \RTx(\hh(\ke, 0))$, contradicting the constraint placed 
over well-formed kv-stores that a transaction never reads multiple versions for a key. Therefore, there exists 
no transaction $\txid''$ such that $\txid'' \xrightarrow{\RF_{\hh}(\ke)} \txid$, 
\item $i > 0$; in this case \cref{def:kv2graph} ensures that $\txid' \xrightarrow{\RF_{\hh}(\ke)} \txid$; also, 
because $\hh(\ke, i) = (\val, \txid', \_)$, it must be the case that $(\otW, \ke, \val) \in \TtoOp{T}_{\hh}(\txid')$.
\end{enumerate}
\item Let $\txid \in \dom(\TtoOp{T}_{\hh})$, and suppose that there exist $\txid_1, \txid_2$ such that 
$\txid_{1} \xrightarrow{\RF_{\ke}(\hh)} \txid$, $\txid_{2} \xrightarrow{\RF_{\ke}(\hh)} \txid$. 
By \cref{def:kv2graph}, there exist two indexes $i, j: 0 < i, j < \lvert \hh(\ke) \rvert$, such that 
$\hh(\ke, i) = (\_, \txid_1, \{\txid\} \cup \_)$, $\hh(\ke, j) = (\_, \txid_2, \{\txid\} \cup \_)$. 
We have that $\txid \in \RTx(\hh(\ke, i)) \cap \RTx(\hh(\ke, j))$, i.e. 
$\RTx(\hh(\ke,i)) \cap \RTx(\hh(\ke, j)) \neq \emptyset$. Because we are assuming 
that $\hh$ is well-formed, then it must be the case that $i = j$. This implies that $\txid_1 = \txid_2$.
\item Let $\cl \in \Clients$, $m, n \in \Nat$ and $\ke \in \Keys$ be such that 
$\txid_{\cl}^{n} \xrightarrow{\RF_{\hh}(\ke)} \txid_{\cl}^{m}$.  We prove that 
$n < m$. By \cref{def:kv2graph}, it must be the case that 
there exists an index $i : 0 \leq i < \lvert \hh(\ke) \rvert$ such that $\hh(\ke, i) = 
(\_, \txid_{\cl}^{n}, \{\txid_{\cl}^{m}\} \cup \_)$. Because $\hh$ is well-formed, 
it must be the case that $n < m$.
\item Let $\txid \in \dom(\TtoOp{T}_{\hh})$. We show that $\neg (\txid \xrightarrow{\VO_{\hh}} \txid)$. 
We prove this fact by contradiction: suppose that $\txid \xrightarrow{\VO_{\hh}(\ke)} \txid$ for some key $\ke$. By \cref{def:kv2graph}, 
there must exist two indexes $i,j: 0 < i < j < \lvert \hh(\ke) \rvert$ such that $\txid = \WTx(\hh(\ke,i))$ and 
$\txid = \WTx(\hh(\ke, j))$. Because we are assuming that $\hh$ is well-formed, then it must be the 
case that $i = j$, contradicting the statement that $i < j$. 
\item Let $\txid, \txid'$ be such that $\txid' \xrightarrow{\VO_{\ke}(\hh)} \txid$. 
We must show that  $(\otW, \ke, \_) \in \TtoOp{T}_{\hh}(\txid')$, and $(\otW, \ke, \_) \in \TtoOp{T}_{\hh}(\txid)$.
By \cref{def:kv2graph}, there exist $i, j: 0 < i,j < \lvert \hh(\ke) \rvert$ such that 
$\hh(\ke, i) = (\val', \txid', \_)$ and $\hh(\ke, j) = (\val, \txid, \_)$, for some 
$\val, \val' \in \Val$. \cref{def:kv2graph} also ensures that $(\otW, \ke, \val') \in 
\TtoOp{T}_{\hh}(\txid')$, and $(\otW, \ke, \val) \in \TtoOp{T}_{\hh}(\txid)$.
\item Let $\txid, \txid'$ be such that $(\otW, \ke, \_) \in \TtoOp{T}_{\hh}(\txid)$ 
and $(\otW, \ke, \_) \in \TtoOp{T}_{\hh}(\txid')$. We need to prove that 
either $\txid = \txid', \txid \xrightarrow{\VO_{\hh}(\ke)} \txid'$, or $\txid' \xrightarrow{\VO_{\hh}(\ke)} \txid$. 
By \cref{def:kv2graph} there exist two indexes $i, j: 0 < i,j< \lvert \hh(\ke) \rvert$ such that 
$\hh(\ke, i) = (\_, \txid, \_)$ and $\hh(\ke, j) = (\_, \txid', \_)$. If $i = j$, then $\txid = \txid'$ 
and there is nothing left to prove. Otherwise, suppose without loss of generality that 
$i < j$. Then \cref{def:kv2graph} ensures that $\txid \xrightarrow{\VO_{\hh}(\ke)} \txid'$. 
\item Suppose that $\txid_{\cl}^{m} \xrightarrow{\VO_{\hh}(\ke)} \txid_{\cl}^{n}$ for 
some $\cl \in \Clients$ and $m, n \in \Nat$. We need to show that $m < n$. 
By \cref{def:kv2graph}, because  $\txid_{\cl}^{m} \xrightarrow{\VO_{\hh}(\ke)} \txid_{\cl}^{n}$ 
there exist two indexes $i,j: 0 < i,j < \lvert \hh(\ke) \rvert$ such that $\WTx(\hh(\ke,i)) = \txid_{\cl}^{m}$ 
and $\WTx(\hh(\ke, j)) = \txid_{\cl}^{n}$. From the assumption that $\hh$ is well-formed, it 
follows that $n < m$.
\end{itemize}
\end{proof}



\begin{proposition}
\label{prop:well-formed-dependency-to-kv-store}
For any dependency graph $\Gr = (\TtoOp{T}, \VO, \RF, \AD)$, $\hh_{\Gr}$ is a well-formed kv-store.
\end{proposition}

\begin{proof}
We prove that each of the four constraints required by well-formed kv-stores 
are satisfied by $\hh_{\Gr}$. 
\begin{enumerate}[(i)]
\item For each key $\ke$, $\hh_{\Gr}(\ke, 0) = (\val_0, \txid_0, \_)$. 
By construction, we have that $\hh_{\Gr}(\ke, 0) = \ver_{\ke}^{0} = (\val_0, \txid_0, \_)$. 
\item $\forall \ke \in \Keys.\; \forall i,j: 0 \leq i, j < \lvert \hh_{\Gr}(\ke) \rvert$, 
$\WTx(\hh_{\Gr}(\ke, i)) = \WTx(\hh_{\Gr}(\ke, j)) \implies i = j$.
Let $\ke \in \Keys$, and let $i, j: 0 \leq i,j < \lvert \hh_{\Gr}(\ke) \rvert$ 
be such that $\WTx(\hh_{\Gr}(\ke, i)) = \WTx(\hh_{\Gr}(\ke, j))$. 
Without loss of generality, we can assume that $i \leq j$. 
First, note that if $i = 0$, then $\WTx(\hh_{\Gr}(\ke, i)) = \txid_0$, 
hence it must be the case that $\WTx(\hh_{\Gr}(\ke, j)) = \txid_0$. 
By construction, it is also the case that $\hh_{\Gr}(\ke, j) = \ver_{\ke}^{j}$, 
hence either one of the following is true: 
\begin{enumerate}
\item $j = 0$, in which case there is nothing to prove, or 
\item $j > 0$, and $\hh_{\Gr}(\ke, j) = \ver_{\ke}^{j} = 
\ver(\txid, \ke)$ for some $\txid \in \dom(\TtoOp{T})$. 
We have that $\WTx(\hh_{\Gr}(\ke, j) = \WTx(\ver(\txid, \ke)) = \txid$, 
and because $\txid \in \dom(\TtoOp{T})$, it must be $\txid \neq \txid_0$. 
Contradiction.
\end{enumerate}
Suppose then that $i > 0$. Therefore, it must be the case that $\hh_{\Gr}(\ke, i) = 
\ver_{\ke}^{i} = \ver(\txid, \ke)$ for some $\txid \in \dom(\TtoOp{T})$ such that 
$(\otW, \ke, \_) \in \TtoOp{T}(\txid_{i})$. Similarly, because we are assuming 
that $i \leq j$, we have that $\hh_{\Gr}(\ke, j) = \ver_{\ke}^{j} = \ver(\txid, \ke)$. 
Note that $\hh_{\Gr}(\ke, i) = \hh_{\Gr}(\ke, j)$. Finally, note that if it were 
$i < j$, then by construction we should have that $\txid \xrightarrow{\VO(\ke)} \txid$, 
contradicting the requirement that $\VO(\ke)$ is irreflexive. Therefore, it must 
be $i = j$. 
\item $\forall \ke \in \Keys.\; \forall i,j: 0 \leq i, j < \lvert \hh_{\Gr}(\ke) \rvert$, 
$\RTx(\hh_{\Gr}(\ke, i)) \cap \RTx(\hh_{\Gr}(\ke, j)) \neq \emptyset \implies i = j$. 
Let $\ke \in \Keys$, $i, j: 0 \leq i, j < \lvert \hh_{\Gr}(\ke) \rvert$, 
and $\txid \in \RTx(\hh_{\Gr}(\ke, i)) \cap \RTx(\hh_{\Gr}(\ke, j))$. Without loss 
of generality, suppose that $i \leq j$. We distinguish between two cases: 
\begin{enumerate}
\item $i = 0$; by construction, there exists no $\txid'$ such that 
$\txid' \xrightarrow{\RF(\ke)} \txid$. If it were $j > 0$, then it 
would be the case that $\hh_{\Gr}(\ke, j) = \ver(\txid', \ke)$ for some 
$\txid'$ such that $\txid' \xrightarrow{\RF(\ke)} \txid$; because 
such transaction $\txid'$ does not exist, it cannot be $j > 0$, and 
we are left with the case $j = 0$; in particular, $j = i$. 
\item $i > 0$; by construction, it must be the case that $\hh_{\Gr}(\ke, i) = 
\ver(\txid', \ke)$ for some $\txid'$ such that $\txid' \xrightarrow{\RF(\ke)} \txid$. 
Furthermore, because we are assuming that $i \leq j$, we also have that $j > 0$, 
and  therefore $\hh_{\Gr}(\ke, j) = \ver(\txid'', \ke)$ for some $\txid''$ such that 
$\txid'' \xrightarrow{\RF(\ke)} \txid$. We have that $\txid' \xrightarrow{\RF(\ke)} \txid$, 
and $\txid'' \xrightarrow{\RF(\ke)} \txid$. By definition of dependency graph, this implies 
that $\txid' = \txid''$. We have that $\WTx(\hh_{\Gr}(\ke, i)) = \txid'$, 
$\WTx(\hh_{\Gr}(\ke, j)) = \txid''$, and $\txid' = \txid''$; if it were $i < j$, 
then by construction we would have that $\txid' \xrightarrow{\VO(\ke)} \txid'$, 
contradicting the requirement of dependency graphs that $\VO(\ke)$ is irreflexive. 
Therefore, it must be the case that $i = j$.
\end{enumerate}
\item 
\begin{multline*}
\fora{ \ke \in \dom(\hh), \cl \in \Clients} \fora{ i,j; 0 \leq i < j < \lvert \hh_{\Gr}(\ke) \rvert}
\fora{ n, m \geq 0}\\ (\txid_{\cl}^{n} = \WTx(\hh_{\Gr}(\ke,i)) \wedge \txid_{\cl}^{m} \in \{\WTx(\hh_{\Gr}(\ke,j))\} \cup \RTx(\hh_{\Gr}(\ke, i)) \implies n < m.
\end{multline*}
Let $\ke \in \Keys$, $\cl \in \Clients$, $i, j: 0 \leq i < j < \lvert \hh_{\Gr}(\ke) \rvert$. Let also $n, m \geq 0$. 
First, suppose that $\txid_{\cl}^{n} = \WTx(\hh_{\Gr}(\ke, i)$.
Note that it cannot be $i = 0$, because by construction $\WTx(\hh_{\Gr}(\ke, i)) = \txid_0 \neq \txid_{\cl}^{n}$. 
Therefore, it must be $i > 0$. We prove the following facts: 
\begin{enumerate}
\item if $\txid_{\cl}^{m} = \WTx(\hh_{\Gr}(\ke, j))$, then $n < m$. By construction, 
$\hh_{\Gr}(\ke, i) = \ver(\txid_{\cl}^{n}, \ke)$, and $(\otW, \ke, \_) \in \TtoOp{T}(\txid_{\cl}^{n})$. 
Similarly, $\hh_{\Gr}(\ke, j) = \ver(\txid_{\cl}^{m}, \ke)$, and $(\otW, \ke, \_) \in \TtoOp{T}(\txid_{\cl}^{m})$. 
Because $i < j$, it must be the case that $\txid_{\cl}^{n} = \WTx(\ver(\txid_{\cl}^{n}, \ke) \xrightarrow{\VO(\ke)} 
\WTx(\ver(\txid_{\cl}^{m}, \ke)) = \txid_{\cl}^{m}, \ke)$, and by definition of dependency graph it follows that 
$n < m$, 
\item if $\txid_{\cl}^{m} \in \RTx(\hh_{\Gr}(\ke, i))$, then $n < m$. In this case we have that 
$\txid_{\cl}^{n} \xrightarrow{\RF(\ke)} \txid_{\cl}^{m}$ by construction, hence the definition 
of dependency graph ensures that $n < m$. 
\end{enumerate}
\end{enumerate}
\end{proof}

\begin{proposition}
    \label{prop:bijection:mkvs-dgraph}
For any kv-store $\hh$, $\hh_{\Gr_{\hh}} = \hh$.
\end{proposition}
\begin{proof}
The conversions from kv-store to dependency graph (\cref{def:kv2graph}) and vice versa (\cref{def:dependency-to-kv-store}) are based per key.
Those conversions are well-formed by \cref{prop:well-formed-kv-store-to-dependency} and \cref{prop:well-formed-dependency-to-kv-store}.
It is sufficient to fix a key \( \ke \) and to prove \( \hh_{\Gr_{\hh}}(\ke) = \hh(\ke) \).
We prove \( \hh_{\Gr_{\hh}}(\ke) = \hh(\ke) \) by induction on the length of \( \hh(\ke) \).

\begin{itemize}
    \item \caseB{|\hh(\ke)| = 1}
Let \( \hh(\ke) = (\val_0, \txid_0, \txidset_0 ) \) for some transactions \( \txidset_0 \) that read the initial value \( \val_0 \).
Given the definition of \( \Gr_\hh \) (\cref{def:kv2graph}), we know that \( (\otR, \ke, \val_0 ) \in \TtoOp{T}(\txid) \) for all \( \txid \in \txidset_0 \) and \( \VO(\ke) = \RF(\ke) = \AD(\ke) = \emptyset  \).
Given the definition of \( \hh_{\Gr_\hh}\) (\cref{def:dependency-to-kv-store}), it is easy to see \( \hh_{\Gr_\hh}(\ke) = \hh(\ke) \).

    \item \caseI{|\hh(\ke)| = m + 1 }
Suppose \( \hh_{\Gr_\hh}(\ke) = \hh(\ke) \) when \( |\hh(\ke)| = m \) and let consider  \( |\hh(\ke)| = m + 1 \).
Let \( \hh(\ke) = \List{(\val_0, \txid_0, \txidset_0 ), \dots, (\val_m, \txid_m, \txidset_m ), (\val_{m+1}, \txid_{m+1}, \txidset_{m+1} ) } \).
We now discuss the \( \VO(\ke) \), \( \RF(\ke) \) and \( \AD(\ke) \) relations in \( \Gr_\hh(\ke) \) and the corresponding versions in \( \hh_{\Gr_\hh}(\ke) \).
\begin{itemize}
    \item For any \( (\txid, \txid') \in \VO(\ke) \), there are two cases: \( \txid' \neq \txid_{m+1} \) and \( \txid' = \txid_{m+1} \).
    If \( \txid' \neq \txid_{m+1} \), then \( \txid = \txid_i \) and \( \txid = \txid_j \) for some \( i \) and \( j \) such that \( 0 < i < j < m + 1 \) by the definition of \( \Gr_\hh \) (\cref{def:kv2graph}).
    By the \ih, we have \( \WTx(\hh_{\Gr_\hh}(\ke,i))  = \txid_i \) and \( \WTx(\hh_{\Gr_\hh}(\ke,i))  = \txid_j \).
    If \( \txid' = \txid_{m + 1} \), then \( \txid = \txid_i \) for some \( i \) such that \( 0 \leq i < m + 1 \).
    By the definition of  \( \hh_{\Gr_\hh}(\ke) \) (\cref{def:dependency-to-kv-store}), the order of versions is the same as the order of \( \AD(\ke) \).
    That means the version \( (\val_{m+1}, \txid_{m+1}, \stub ) \) is the last one, \ie (m + 1)-\emph{th}, in the \( \hh_{\Gr_\hh}(\ke) \).
    Combine the two cases above, we know:
    \begin{equation}
        \label{equ:ww-back-to-ww}
        \fora{i : 0 \leq i \leq m + 1} \exsts{\txidset} \hh_{\Gr_\hh}(\ke, i) = (\val_i, \txid_i, \txidset)
    \end{equation}
    
    \item For any \( (\txid, \txid' ) \in \RF(\ke) \).
    Assume \( \txid = \txid_i \) for some \( i \) that \( 0 < i \leq m + 1\).
    Given the definition of \( \Gr_\hh \) (\cref{def:kv2graph}), it muse be that \( \txid' \in \txidset_i \)
    By the definition of  \( \hh_{\Gr_\hh}(\ke) \) and \cref{equ:ww-back-to-ww}, it follows:
    \begin{equation}
        \label{equ:k-to-kgk}
        \fora{i : 0 \leq i \leq m + 1} \hh_{\Gr_\hh}(\ke, i) = (\val_i, \txid_i, \txidset_i)
    \end{equation}
\end{itemize}
\end{itemize}
The \cref{equ:k-to-kgk} implies \( \hh(\ke) = \hh_{\Gr_\hh}(\ke) \) and then \( \hh = \hh_{\Gr_\hh} \).
\end{proof}
