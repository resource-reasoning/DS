%model
\newcommand{\Heap}{\texttt{Heap}}
\newcommand{\Stack}{\texttt{Stack}}
\newcommand{\Timestamp}{\texttt{TimeStamp}}
\newcommand{\Loc}{\texttt{Loc}}
\newcommand{\Val}{\texttt{Val}}
\newcommand{\Var}{\texttt{Var}}
\newcommand{\State}{\texttt{State}}
\newcommand{\Localstate}{\texttt{LocalState}}
\newcommand{\Threadstate}{\texttt{ThreadState}}
\newcommand{\Threadpool}{\texttt{ThreadPool}}
\newcommand{\threadpool}{\eta}
\newcommand{\tdpl}{\threadpool}
\newcommand{\Nat}{\mathbb{N}}
\newcommand{\Real}{\mathbb{R}}
\newcommand{\Transid}{\texttt{TransID}}
\newcommand{\TransID}{\Transid}
\newcommand{\transid}{\alpha}
\newcommand{\tsid}{\transid}
\newcommand{\settrans}{\mathcal{T}}
\newcommand{\setlabels}{\mathcal{L}}
\newcommand{\Threadid}{\texttt{ThreadID}}
\newcommand{\ThreadID}{\Threadid}
\newcommand{\threadid}{i}
\newcommand{\thid}{\threadid}
\newcommand{\nat}{n}
\newcommand{\parfun}{\rightharpoonup}
\newcommand{\parfinfun}{\overset{fin}{\rightharpoonup}}
\newcommand{\heap}{h}
\newcommand{\hp}{\heap}
\newcommand{\Timestampheap}{\texttt{TimeStampHeap}}
\newcommand{\timestampheap}{\hbar}
\newcommand{\tshp}{\globalheap}
\newcommand{\globalheap}{\timestampheap}
\newcommand{\ghp}{\globalheap}
\newcommand{\stack}{s}
\newcommand{\stk}{\stack}
\newcommand{\timestamp}{t}
\newcommand{\ts}{\timestamp}
\newcommand{\loc}{l}
\newcommand{\val}{v}
\newcommand{\var}{\vx}
\newcommand{\logicvar}{x}
\newcommand{\lvar}{x}
\newcommand{\localstate}{\sigma}
\newcommand{\lstt}{\localstate}
\newcommand{\Readset}{\texttt{ReadSet}}
\newcommand{\readset}{rs}
\newcommand{\rs}{\readset}
\newcommand{\Writeset}{\texttt{WriteSet}}
\newcommand{\writeset}{ws}
\newcommand{\ws}{\writeset}
\newcommand{\Operation}{\texttt{Operation}}
\newcommand{\operation}{o}
\newcommand{\op}{\operation}
\newcommand{\rop}{\texttt{r}}
\newcommand{\opr}{\rop}
\newcommand{\wop}{\texttt{w}}
\newcommand{\opw}{\wop}
\newcommand{\sop}{\texttt{s}}
\newcommand{\ops}{\sop}
\newcommand{\eop}{\texttt{e}}
\newcommand{\ope}{\eop}
\newcommand{\uop}{\texttt{u}}
\newcommand{\upe}{\eop}
\newcommand{\state}{\Sigma}
\newcommand{\stt}{\state}
\newcommand{\setstt}{\mathcal{G}}
\newcommand{\Translabel}{\texttt{Label}}
\newcommand{\translabel}{\iota}
\newcommand{\tll}{\translabel}
\newcommand{\lid}{{\texttt{id}}}
\newcommand{\lfork}[1]{\texttt{fork}(#1)}
\newcommand{\lcommit}[1]{\texttt{cmt}(#1)}
\newcommand{\lcmt}[1]{\lcommit{#1}}
\newcommand{\ljoin}[1]{\texttt{join}(#1)}
\newcommand{\lstart}[1]{\texttt{st}(#1)}
\newcommand{\lst}[1]{\lstart{#1}}
\newcommand{\lrestart}[1]{\texttt{rst}(#1)}
\newcommand{\lrst}[1]{\lrestart{#1}}
\newcommand{\lsession}{{\texttt{so}}}
\newcommand{\Globalassertion}{\texttt{GlobalAssertion}}
\newcommand{\globalassertion}{P}
\newcommand{\glass}{\globalassertion}
\newcommand{\gpre}{\globalassertion}
\newcommand{\gpost}{Q}
\newcommand{\Localassertion}{\texttt{LocalAssertion}}
\newcommand{\localassertion}{p}
\newcommand{\lcass}{\localassertion}
\newcommand{\lpre}{\localassertion}
\newcommand{\lpost}{q}
\newcommand{\lframe}{r}
\newcommand{\asstrue}{\texttt{true}}
\newcommand{\assfalse}{\texttt{false}}
\newcommand{\assemp}{\texttt{emp}}
\newcommand{\Action}{\texttt{Action}}
\newcommand{\action}{a}
\newcommand{\rely}{R}
\newcommand{\guarantee}{G}
\newcommand{\lenv}{\iota}
\newcommand{\grte}{\guarantee}
\newcommand{\agree}[2]{\vdash #1, #2 \ \texttt{agree} \ }
\newcommand{\stable}[2]{#1 \vdash #2 \ \texttt{stable} \ }
\newcommand{\mergable}[4]{#1 \vdash  #2, #3 \ \texttt{merge} \ #4 \ }
\newcommand{\propagate}[3]{\vdash  #1, #2 \ \texttt{propagate} \ #3 \ }
\newcommand{\so}{\texttt{so}}
\newcommand{\po}{\texttt{po}}
\newcommand{\ww}{\texttt{ww}}
\renewcommand{\wr}{\texttt{wr}}
\newcommand{\rw}{\texttt{rw}}
\newcommand{\vis}{\texttt{vis}}
\newcommand{\ar}{\texttt{ar}}
\newcommand{\tvis}{\texttt{tvis}}
\newcommand{\tar}{\texttt{tar}}
\newcommand{\rso}{\overset{\texttt{so}}{\to}}
\newcommand{\rww}{\overset{\texttt{ww}}{\to}}
\newcommand{\rwr}{\overset{\texttt{wr}}{\to}}
\newcommand{\rrw}{\overset{\texttt{rw}}{\to}}
\newcommand{\rvis}{\overset{\texttt{vis}}{\to}}
\newcommand{\rar}{\overset{\texttt{ar}}{\to}}
\newcommand{\rtvis}{\overset{\texttt{tvis}}{\to}}
\newcommand{\rtar}{\overset{\texttt{tar}}{\to}}

%notation
\newcommand{\localtransfer}{\leadsto_{l}}
\newcommand{\multilocaltransfer}{\localtransfer^{*}}
\newcommand{\threadtransfer}[1]{\overset{#1}{\leadsto_{t}}}
\newcommand{\globaltransfer}[1]{\overset{#1}{\leadsto_{g}}}
\newcommand{\denote}[1]{\left\llbracket #1 \right\rrbracket}
\newcommand{\eval}[1]{\denote{#1}}
\newcommand{\undef}{\uparrow}
\newcommand{\isdef}{\downarrow}
\newcommand{\projection}[1]{\!\!\downharpoonright_{#1}}
\newcommand{\defeq}{\triangleq}
\newcommand{\pred}[2]{\textsf{#1}(#2)}
\newcommand{\func}[1]{{#1}}
\newcommand{\rl}[1]{\textsc{#1}}
\newcommand{\concat}{\cdot}
\newcommand{\remapsto}[2]{{[#1 \mapsto #2]}}
\DeclareMathOperator{\dom}{dom}
\newcommand{\dontcare}{-}
\newcommand{\anyval}{\_}
\newcommand{\Set}[1]{\left\{ #1 \right\}}
\newcommand{\List}[1]{\left[ #1 \right]}
\newcommand{\powerset}[1]{\mathcal{P}(#1)}
\newcommand{\Trace}{\texttt{Trace}}
\newcommand{\trace}{\theta}
\newcommand{\trc}{\trace}
\newcommand{\settrace}{\Theta}
\newcommand{\settrc}{\settrace}
\newcommand{\SimpleTrace}{\texttt{SimpleTrace}}
\newcommand{\simpletrace}{\psi}
\newcommand{\sptrc}{\simpletrace}
\newcommand{\trcto}[1]{\overset{#1}{\to}}
\newcommand{\trcbf}[1]{<_{#1}}
\newcommand{\pointsto}{\mapsto}
\newcommand{\pt}{\pointsto}
\newcommand{\sep}{\mathbin{*}}
\newcommand{\sepimp}{-\kern-.6em\raisebox{-.659ex}{*}\ }
\newcommand{\efsep}{\mathbin{\hat *}}
\newcommand{\transfersto}{\mathbin{\leadsto}}
\newcommand{\notimplies}{\mathbin{\centernot\implies}}
\newcommand{\specline}[1]{ { \color{blue} \left\{ \begin{array}{@{}l@{}} #1 \end{array} \right\}} }
\newcommand{\actionline}[2]{ { \color{red} #1 : \left. \begin{array}{@{}l@{}} #2 \end{array} \right.} }
\newenvironment{syntax}[1]{%
    #1 ::= \begin{array}{l}
}{%
    \end{array}
}
\newenvironment{formulea}{%
    \left(
    \begin{array}{@{}l@{}}
}{%
    \end{array}
    \right)
}
\newenvironment{transaction}{%
    \left\lbrack%
    \begin{array}{@{}l@{}}
}{%
    \end{array}%
    \right\rbrack
}
\newcommand{\ptrans}[1]{%
\begin{transaction} #1 \end{transaction}%
}
\newcommand{\pruntrans}[2]{%
    \left\lbrack \! \left\lbrack \begin{array}{@{}l@{}} #1 \end{array} \right\rbrack\!  \right\rbrack_{#2}
}
\newcommand{\pass}[2]{#1:=#2}
\newcommand{\passign}[2]{#1:=#2}
\newcommand{\pmutate}[2]{[#1]:=#2}
\newcommand{\palloc}[2]{#1 \mathtt{\ :=\ } \mathtt{alloc}(#2)}
\newcommand{\pvar}[1]{\mathtt{#1}}
\newcommand{\pderef}[2]{#1:=[#2]}
\newcommand{\pifs}[1]{\texttt{if} \, (#1)}
\newcommand{\pifm}{\texttt{else}}
\newcommand{\pif}[3]{\pifs{#1} \  #2 \  \pifm \  #3}
\newcommand{\ploop}[2]{\texttt{while} \, (#1) \  #2}
\newcommand{\pskip}{\mathtt{skip}}
\newcommand{\pfuncall}[3]{#1 \mathtt{\ :=\ #2} (#3)}
\newcommand{\pfuncallnr}[2]{\mathtt{#1} (#2)} % funcall no return
\newcommand{\pseq}{\mathbin{;}}
\newcommand{\pchoice}{\mathbin{+}}
\newcommand{\prepeat}{^{*}}
\newcommand{\cmd}{\mathbb{C}}
\newcommand{\expr}{\mathbb{E}}
\newcommand{\bool}{\mathbb{B}}
\newcommand{\prog}{\mathbb{P}}
\newcommand{\progext}{\prog^{\uparrow}}
\newcommand{\pwait}[1]{\texttt{wait}(#1)}
\newcommand{\true}{\texttt{true}}
\newcommand{\false}{\texttt{false}}
\newcommand{\boolnot}{\texttt{not}~}
\newcommand{\booland}{\mathbin{\texttt{and}}}
\newcommand{\boolor}{\mathbin{\texttt{or}}}
\newcommand{\ppar}{\mathbin{\|}}
\newcommand{\pfork}[2]{#1 := \texttt{fork}(#2)}
\newcommand{\pjoin}[1]{\texttt{join}(#1)}
\newcommand{\close}[1]{{#1}^{*}}
\newcommand{\triple}[3]{ \left\{ \begin{array}{@{}l@{}} #1 \end{array} \right\}%
                        \ #2 \ %
                        \left\{ \begin{array}{@{}l@{}} #3 \end{array} \right\}}
\newcommand{\judgement}[4]{#1 \vdash \begin{array}{@{}l} \triple{#2}{#3}{#4} \end{array}}
\newenvironment{parl}{%
    \begin{array}{@{}c || c@{}}
}{%
    \end{array}
}
\newenvironment{session}{%
    \begin{array}{@{}c@{}}
}{%
    \end{array}
}
\newcommand{\boxass}[3]{%
\fbox{
    \(
    \begin{array}{@{}l@{}}
    #1
    \end{array}
    \)
}^{#2}_{#3}%
}
\newcommand{\boxassnp}[2]{%
\fbox{
    \(
    \begin{array}{@{}l@{}}
    #1
    \end{array}
    \)
}^{#2}%
}
\newcommand{\perm}[1]{\left[ \texttt{#1} \right]}
\newcommand{\comment}[1]{\texttt{#1}}
\newcommand{\cell}[2]{#1 \mapsto #2}
\newcommand{\twocell}[3]{#1 \mapsto #2, #3}
\newcommand{\threecell}[4]{#1 \mapsto #2, #3, #4}


% program variable
\newcommand{\vx}{\texttt{x}}
\newcommand{\vvx}{\texttt{vx}}
\newcommand{\vy}{\texttt{y}}
\newcommand{\vvy}{\texttt{vy}}
\newcommand{\vz}{\texttt{z}}
\newcommand{\vtmp}{\texttt{tmp}}

% extra
\newenvironment{rclarray}{%
    \begin{array}{r c l}
}{%
    \end{array}
}

% 2pl
\newcommand{\pgrow}{\curlywedge}
\newcommand{\pshrink}{\curlyvee}
\newcommand{\actprog}{\mathsf{sys}}
\newcommand{\actid}[1]{\pred{id}{#1}}
\newcommand{\actalloc}[3]{\pred{alloc}{#1, #2, #3}}
\newcommand{\actwrite}[3]{\pred{write}{#1, #2, #3}}
\newcommand{\actread}[3]{\pred{read}{#1, #2, #3}}
\newcommand{\actlock}[3]{\pred{lock}{#1, #2, #3}}
\newcommand{\actunlock}[2]{\pred{unlock}{#1, #2}}
%\newcommand{\tread}[2]{\mathsf{R}[#2]_{#1}}
\newcommand{\tred}{\rightarrow_{\textsc{Atom}}}
\newcommand{\treda}[1]{\xrightarrow{#1}_{\textsc{Atom}}}
\newcommand{\ptdef}[1]{\mathtt{begin}\ #1\ \mathtt{end}}
\newcommand{\tsem}[1]{\llbracket #1 \rrbracket}
\newcommand{\lstar}{\mathrel{*}}
\newcommand{\cons}{{:}}

% From interim.
\newcommand{\tread}[1]{\textsf{R}[\textit{#1}]}
\newcommand{\tmread}[1]{\textsf{R}[#1]}
\newcommand{\tmreade}[2]{\textsf{R}[#1, #2]}
\newcommand{\twrite}[2]{\textsf{W}[\textit{#1},\textit{#2}]}
\newcommand{\tmwrite}[2]{\textsf{W}[#1,#2]}
\newcommand{\twritee}[1]{\textsf{W}[\textit{#1}]}
\newcommand{\tmwritee}[1]{\textsf{W}[#1]}
\newcommand{\tcommit}{\textsf{C} }
\newcommand{\tabort}{\textsf{A} }
\newcommand{\tlock}[2]{\textsf{L}[#1,#2]}
\newcommand{\tunlock}[2]{\textsf{U}[#1,#2]}
\newcommand{\tshared}{\textsc{s}}
\newcommand{\texclusive}{\textsc{x}}
\newcommand{\tpl}{\textsc{2pl}}
\newcommand{\stpl}{\textsc{s2pl}}
\newcommand{\pord}{\dot\sqsubset}
\newcommand{\sharedr}[1]{\boxed{#1}_{\ I(r, \vec{x})}^{\ r}}
\newcommand{\sharedrs}[1]{\boxed{#1}_{\ I(r, x)}^{\ r}}

% Language.
\newcommand{\pfunctions}[2]{\mathtt{function} \ \mathtt{#1}(#2) \ \{}
\newcommand{\pfunctione}{\}}
\newcommand{\pifelses}[1]{\mathtt{if} \ (#1) \ \{}
\newcommand{\pifelsem}{\} \ \mathtt{else} \ \{}
\newcommand{\pifelsee}{\}}
\newcommand{\pwhiles}[1]{\mathtt{while} \ (#1) \ \{}
\newcommand{\pwhilee}{\}}
\newcommand{\preturn}[1]{\mathtt{return} \ #1}
\newcommand{\patomic}[1]{\langle #1\rangle}
\newcommand{\snull}{\mathtt{null}}

% Tada.
\newcommand{\transto}{\rightsquigarrow}
\newcommand{\sem}[1]{\llbracket {#1} \rrbracket}
% Non-atomic Hoare triple
% #1 |- {#2} #3 {#4}
\newcommand{\triplena}[4]{{\color{violet}#1} \vdash \triple{#2}{#3}{#4}}
\newcommand{\tguard}[1]{\textsc{#1}}
\newcommand{\aall}{\rotatebox[origin=c]{180}{$\mathds{A}$}}
% Atomic triple with no local
% #1 |- (AA) #2 . <#3> #4 <#5>
\newcommand{\atriplenl}[5]{ {\color{violet}#1} \vdash {\color{RoyalBlue}\aall #2 \ldotp} {\color{blue}\left\langle \begin{array}{@{}c@{}}#3\end{array} \middle\rangle \ {\color{black}#4} \ \middle\langle \begin{array}{@{}c@{}}#5\end{array} \right\rangle}}
% Atomic Hoare triple with exists
% #1 |- (AA) #2 . < #3 | #4 > #5 (EE) #6. < #7 | #8 >
\newcommand{\atriplee}[8]{ {\color{violet}#1} \vdash {\color{RoyalBlue} \aall #2 \ldotp} {\color{blue} \left\langle \begin{array}{@{}c@{}} #3 \end{array} \, \middle| \, \begin{array}{@{}c@{}} #4 \end{array} \middle\rangle \ {\color{black}#5} \quad {\color{RoyalBlue}\aexists #6 \ldotp} \middle\langle \begin{array}{@{}c@{}} #7 \end{array} \, \middle| \, \begin{array}{@{}c@{}} #8 \end{array} \right\rangle}}
\newcommand{\aexists}{\rotatebox[origin=c]{180}{$\mathds{E}$}}
% Atomic triple with no quantifiers
% #1 |- < #2 | #3 > #4 < #5 | #6 >
\newcommand{\atriplenq}[6]{ {\color{violet}#1} \vdash {\color{blue}\left\langle \begin{array}{@{}c@{}} #2 \end{array} \, \middle| \, \begin{array}{@{}c@{}} #3 \end{array} \middle\rangle \ {\color{black}#4} \ \middle\langle \begin{array}{@{}c@{}} #5 \end{array} \, \middle| \, \begin{array}{@{}c@{}} #6 \end{array} \right\rangle}}
% Vertical atomic triple with no local
%                 < #3 >
% #1 |- (AA) #2 .   #4
%                 < #5 >
\newcommand{\vatriplenl}[5]{\begin{array}{@{}l@{}c@{}} {\color{violet}#1} \vdash {\color{RoyalBlue}\aall #2 \ldotp} & {\color{blue}\left\langle \begin{array}{@{}c@{}}#3\end{array} \right\rangle} \\ & #4 \\ & {\color{blue}\left\langle \begin{array}{@{}c@{}}#5\end{array} \right\rangle} \end{array}}
\newcommand{\ite}[3]{\underline{\mathbf{if}} \ {#1} \ \underline{\mathbf{then}} \ {#2} \ \underline{\mathbf{else}} \ {#3}}
\newcommand{\bigoast}{\mathop{\mbox{\Large $\varoast$}}}
\newcommand{\atomtok}{\blacklozenge}
\newcommand{\pfunction}[3]{\mathtt{function} \ #1(#2) \ \{ \ #3 \}}
\newcommand{\quantifierline}[1]{{\color{RoyalBlue}#1}}
\newcommand{\aspecline}[1]{{\color{blue}\left\langle\begin{array}{@{}l@{}} #1 \end{array}\right\rangle}}
% An environment for annotating proof outlines
\newenvironment{leftvruled}[2][10pt]{\begin{array}{@{}m{#1}|l@{}}\text{\rotatebox{90}{\ {#2}\ }}&\begin{array}{@{}l@{}}}{\end{array}\end{array}}
\newcommand{\acontextline}[1]{{\color{violet}#1}}
% Atomic Hoare triple
% #1 |- (AA) #2 . < #3 | #4 > #5 < #6 | #7 >
\newcommand{\atriple}[7]{ {\color{violet}#1} \vdash {\color{RoyalBlue} \aall #2 \ldotp} {\color{blue} \left\langle \begin{array}{@{}c@{}} #3 \end{array} \, \middle| \, \begin{array}{@{}c@{}} #4 \end{array} \middle\rangle \ {\color{black}#5} \ \middle\langle \begin{array}{@{}c@{}} #6 \end{array} \, \middle| \, \begin{array}{@{}c@{}} #7 \end{array} \right\rangle}}

\newenvironment{funcarray}{%
    \left\{%
    \begin{array}{l  r}
}{%
    \end{array}%
    \right.
}

\newcommand{\nocontentsline}[3]{}
\newcommand{\tocless}[2]{\bgroup\let\addcontentsline=\nocontentsline#1{#2}\egroup}

\newcommand{\indline}{\rule{\textwidth}{1pt}\\}