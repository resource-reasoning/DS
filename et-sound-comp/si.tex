\subsection{Snapshot Isolation \( \SI \)}
\label{sec:sound-complete-si}

The axiomatic definition for \( \SI \) is 
\[ 
(\RP_{\LWW}, \Set{\lambda \aexec. \AR_\aexec ; \VIS_\aexec, \lambda \aexec \ldotp \SO_\aexec, \lambda \aexec \ldotp \WW_\aexec }) 
\]
By a lemma proven in \cite{SIanalysis}, for any \( \aexec \) satisfies the \( \SI \)
there exists an equivalent \( \aexec' \) with minimum visibility \( \VIS_{\aexec'} \subseteq \VIS_\aexec \) satisfying 
\[ 
    \left( \RP_{\LWW}, \Set{\lambda \aexec. \left( (\SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'} ) ; \RW_{\aexec'}? \right)^+ ; \VIS'_{\aexec'}, 
    \lambda \aexec \ldotp (\WW_{\aexec'} \cup \SO_{\aexec'}) } \right) 
\]
Under the minimum visibility \( \VIS \) all the transactions still have the same behaviour as before,
meaning they do not violate last-write-win.

To prove the soundness, we pick the invariant as the following:
\[  
\begin{rclarray}
    I_1(\aexec, \cl) & = & \left( \bigcup_{\Setcon{\txid_{\cl}^{i} \in \T_{\aexec} }{ i \in \Nat }} \VIS_{\aexec}^{-1}(\txid^i_\cl) \right) \setminus \T_\rd \\
    I_2(\aexec, \cl) & = & \left( \bigcup_{\Setcon{\txid_{\cl}^{i} \in \T_{\aexec} }{ i \in \Nat }} (\SO_{\aexec}^{-1})?(\txid^i_\cl) \right) \setminus \T_\rd
\end{rclarray}
\]
where \( \T_\rd \) is all the read-only transactions included in both 
\( \left( \bigcup_{\Setcon{\txid_{\cl}^{i} \in \T_{\aexec} }{ i \in \Nat }} \VIS_{\aexec}^{-1}(\txid^i_\cl) \right)\) 
and \( \left( \bigcup_{\Setcon{\txid_{\cl}^{i} \in \T_{\aexec} }{ i \in \Nat }} (\SO_{\aexec}^{-1})?(\txid^i_\cl) \right) \).
Assume a kv-store $\hh$, an initial and a final view $\vi, \vi'$  a fingerprint $\opset$ 
such that $\ET_{\SI} \vdash (\hh, \vi) \csat \opset: (\hh',\vi')$. 
Also choose an arbitrary $\cl$, a transaction identifier $\txid_\cl^n \in \nextTxId(\hh, \cl)$, 
and an abstract execution $\aexec$ such that $\hh_{\aexec} = \hh$ and 
\( I_1(\aexec, \cl) \cup I_2(\aexec, \cl) \subseteq \Tx(\hh, \vi) \).
Let a new abstract execution \( \aexec' = \extend(\aexec, \txid_\cl^n, \f, \Tx(\mkvs, \vi) \cup \T_\rd) \).
We are about to prove there exists an extra set of read-only transaction \( \T'_\rd \) such that:
\begin{gather}
    \fora{\txid} (\txid, \txid_\cl^n) \in \SO_{\aexec'} \implies \txid \in \Tx(\mkvs, \vi) \cup \T_\rd \cup \T'_\rd \label{equ:si-sound-update-so}\\
    \fora{\txid} (\txid, \txid_\cl^n) \in \WW_{\aexec'} \implies \txid \in \Tx(\mkvs, \vi) \cup \T_\rd \cup \T'_\rd \label{equ:si-sound-update-ww}\\
    \begin{array}{l}
    \fora{\txid} (\txid, \txid_\cl^n) \in \left( (\SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'} ) ; \RW_{\aexec'}? \right)^+ ; \VIS_{\aexec'} \\
    \qqquad \implies \txid \in \Tx(\mkvs, \vi) \cup \T_\rd \cup \T'_\rd 
    \end{array}
    \label{equ:si-sound-update-arvis}\\
    I_1(\aexec',\cl) \cup I_2(\aexec',\cl) \subseteq \Tx(\mkvs_{\aexec'}, \vi') \label{equ:si-sound-inv} 
\end{gather}
\begin{itemize}
\item The invariant \( I_2 \) implies \cref{equ:si-sound-update-so} as the same as \( \RYW \) in \cref{sec:sound-complete-ryw}.
\item Since \( \SI \) also satisfies \( \UA \), the \cref{equ:si-sound-update-ww} can be proven as the same as \( \UA \) in \cref{sec:sound-complete-ua}.
\item Note that for \cref{equ:si-sound-update-arvis}, it is sufficient to prove one step instead of transitive.
That is,
\[
    \begin{array}{l}
    \fora{\txid} (\txid, \txid_\cl^n) \in \left( (\SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'} ) ; \RW_{\aexec'}? \right) ; \VIS_{\aexec'} 
    \implies \txid \in \Tx(\mkvs, \vi) \cup \T_\rd \cup \T'_\rd 
    \end{array}
\]
Let \( \T'_\rd \) initially be empty set.
More read-only transactions will be added in until \cref{equ:si-sound-update-arvis} holds.
Assume a transaction \( \txid \) such that 
\[
    (\txid, \txid_\cl^n) \in \left( (\SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'} ) ; \RW_{\aexec'}? \right) ; \VIS_{\aexec'} 
\]
It means \( (\txid \toEdge{\left( (\SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'} ) ; \RW_{\aexec'}? \right) } \txid' \toEdge{\VIS_{\aexec'}}  \txid_\cl^n \) for some transaction \( \txid' \).
There are two cases: \( \txid' \) writes to at least one key; or \( \txid' \) is read-only.
\begin{itemize}
\item \( \txid' \) writes to at least one key.
Assume that the transaction \( \txid' \) writes to a key \( \ke \).
%Recall the \( \ddagger \) (and auxiliary relation under key-value store \( \mkvs\)) is defined as the following:
%\[
%\ddagger \equiv 
%\fora{\ke, \ke', i, j}
        %i \in \vi(\ke)
        %\wedge \WTx(\hh(\ke', j))\toEdge{((\PO \cup \RF_{\hh} \cup \VO_{\hh}) ; \AD_{\hh}?)^{+}} \WTx(\hh(\ke, i))
  %\implies j \in \vi(\ke')    
%\]
%We link the conditions in \( \ddagger \) to relation:
%\begin{itemize}
    %\item \( \RW_\aexec\). Assume a key \( \ke \),  an index \( i \) and the writer \( \txid  = \WTx(\mkvs(\ke,i))\),
%then \( \txid' \in \RW^{-1}(\mkvs, \ke, i)\) if and only if \( \txid' \toEdge{\RW_\aexec} \txid\).
    %\item \( \SO_\aexec\). The transaction identifiers encode the \( \SO_\aexec \).
    %That is, \( \txid' \in \SO^{-1}(\txid)\) if and only if \(\txid' \toEdge{\SO_\aexec} \txid \).
    %\item  \( \WR_\aexec \). It is easy to see \( \txid \in \RTx(\mkvs(\ke',j)) \land \txid' = \WTx(\mkvs(\ke',j)) \) if and only if \( \txid' \toEdge{\WR_\aexec} \txid \).
    %\item \( \WW_\aexec \). The write-write relation describes the order of write operations for a key which corresponds the version orders in key-value store.
    %That is, \( \txid' = \WTx(\mkvs(\ke,j)) \land \txid = \WTx(\mkvs(\ke,i)) \land j < i\) if and only if
    %\( \txid' \toEdge{\WW_\aexec} \txid\).
%\end{itemize}
%Let assume \( \txid' \) writes to i-\emph{th} version a key \( \ke \).
%Given above and 
%\[ (\txid \toEdge{\left( (\SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'} ) ; \RW_{\aexec'}? \right) } \txid' \toEdge{\VIS_{\aexec'}}  \txid_\cl^n \] we can substitute and rewrite the \( \ddagger \) as the following:
Now we perform case analysis if \( \txid \) is a read-only transaction.
\begin{itemize}
    \item if \( \txid \) has write, we prove \( \txid \in \Tx(\mkvs, \vi)\).
        Recall the \( \ddagger \) is defined as the following:
        \begin{gather}
            \begin{array}{@{}l@{}}
                \ddagger \equiv 
                \fora{\ke, \ke', i, j}
                i \in \vi(\ke)
                \wedge \WTx(\hh(\ke', j))\toEdge{((\PO \cup \RF_{\hh} \cup \VO_{\hh}) ; \AD_{\hh}?)^{+}} \WTx(\hh(\ke, i))
                \implies j \in \vi(\ke')    
            \end{array} 
            \label{equ:si-dagger}
        \end{gather}
        %by the \cref{equ:si-dagger} that \( j \in \vi(\ke')\) for all version \( \mkvs(\ke', j) \) written by the \( \txid \).
        Since \( \WR_\mkvs \), \( \WW_\mkvs \) and \( \RW_\mkvs \) coincide with
        \( \WR_\aexec \), \( \WW_\aexec \) and \( \RW_\aexec \) respectively.
        Also because \( \txid \) write to at least one key,
        it is easy to see there exists some version \( \ke'',m\) such that 
        \( \txid = \WTx(\mkvs(\ke'',m))\) and \( m \in \vi(\ke'')\).
        By definition of \( \Tx \), it follows \( \txid \in \Tx(\mkvs, \vi) \).
    \item if \( \txid \) is a read-only transaction, we add it into \( \T'_\rd \).
\end{itemize}

\item If \( \txid' \) is a read-only transaction, we know \( \txid' \in \T_\rd \) or \( \txid' \in \T'_\rd \).
    More specifically we have three cases: \textbf{(i)} \( \txid' \in \bigcup_{\Setcon{\txid_{\cl}^{i} \in \T_{\aexec} }{ i \in \Nat }} \VIS_{\aexec}^{-1}(\txid^i_\cl) \), \textbf{(ii)} \( \txid' \in \bigcup_{\Setcon{\txid_{\cl}^{i} \in \T_{\aexec} }{ i \in \Nat }} (\SO_{\aexec}^{-1})?(\txid^i_\cl) \) or \textbf{(iii)} \( \txid' \in \T'_\rd\).
    \begin{itemize}
        \item Assume \( \txid' \in \bigcup_{\Setcon{\txid_{\cl}^{i} \in \T_{\aexec} }{ i \in \Nat }} \VIS_{\aexec}^{-1}(\txid^i_\cl) \).
        There exist a previous transaction from the same client \( \txid_\cl^m\) such that \( m < n \) and 
        \[ 
            \txid \toEdge{\left( (\SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'} ) ; \RW_{\aexec'}? \right) } \txid' \toEdge{\VIS_{\aexec'}}  \txid_\cl^m 
        \]
        Since those edges already exists in the abstract execution \( \aexec\), and by the constraints of \( \aexec \) we have \( \txid \toEdge{\VIS_{\aexec'}} \txid_\cl^m\).
        Therefore by the invariant \( I_1 \), either \( \txid \in \Tx(\mkvs, \vi) \cup \T_\rd \).
    \item Assume \( \txid' \in \bigcup_{\Setcon{\txid_{\cl}^{i} \in \T_{\aexec} }{ i \in \Nat }} (\SO_{\aexec}^{-1})?(\txid^i_\cl) \).
        Note that  \( \txid' \) is a read-only transaction so we can simplify the edge,
        \[ 
            \txid \toEdge{\left( \SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'}  \right)} \txid_\cl^m \toEdge{\SO_{\aexec'}}  \txid_\cl^n 
        \] 
        for some \( m \) such that \( m < n \).
        The path from \( \txid \) to \( \txid_\cl^m \) must exist in the abstract execution before update and they satisfy the constraint, so \( \txid \toEdge{\VIS_\aexec} \txid_\cl^m \).
        Therefore by the invariant \( I_1 \), we have \( \txid \in \Tx(\mkvs, \vi) \cup \T_\rd \).
    \item \( \txid' \in \T'_\rd \). 
        Given that \( \T'_\rd \) initially is empty, there is anther transaction \( \txid'' \) that has at least a write such that:
        \[
        \begin{array}{l}
            \txid \toEdge{\left( (\SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'} ) ; \RW_{\aexec'}? \right) } \\
            \qquad \txid' \toEdge{\left( (\SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'} ) ; \RW_{\aexec'}? \right) } \txid'' \toEdge{\VIS_{\aexec'}}  \txid_\cl^n 
        \end{array}
        \]
        %By the fact that \( \txid' \) is read-only and \( \txid'' \) has write, it follows:
        %\[
            %\txid \toEdge{\left( \SO_{\aexec'} \cup \WR_{\aexec'} \right) } \txid' \toEdge{\left( \SO_{\aexec'} ; \RW_{\aexec'}? \right) } \txid'' \toEdge{\VIS_{\aexec'}}  \txid_\cl^n 
        %\]
        %Since \( \SO \) is transitive, we have the following two cases:
        %\[
            %\begin{array}{@{}c@{}}
                %\txid \toEdge{\WR_{\aexec'} } \txid' \toEdge{\SO_{\aexec'} ; \RW_{\aexec'}? } \txid'' \toEdge{\VIS_{\aexec'}}  \txid_\cl^n  \\
                %\txid \toEdge{\SO_{\aexec'} ; \RW_{\aexec'}? } \txid'' \toEdge{\VIS_{\aexec'}}  \txid_\cl^n 
            %\end{array}
        %\]
        If \( \txid \) has write, by \( \ddagger \) then \( \txid \in \Tx(\mkvs, \vi) \),
        otherwise we add \( \txid \) into \(\T'_\rd \).
    \end{itemize}
\end{itemize}
\item Since \( \SI \) satisfies \( \RYW \) and \( \MRd \), thus invariants \( I_1 \) and  \( I_2 \) are preserved, that is, \cref{equ:si-sound-inv}.
\end{itemize}

To prove completeness, we prove four parts of the execution test separately.
\begin{itemize}
\item It is easy to see it is complete with respect to \( \UA \) and \( \RYW \) as \( \WW \cup \SO \subseteq \VIS \).
    The details are the same as proofs for \( \UA \) in \cref{sec:sound-complete-ua} and \( \RYW \) in \cref{sec:sound-complete-ryw}.

\item By the \cite{SIanalysis}, we know that for any abstract execution that satisfies \( (\WW_\aexec \cup \SO_\aexec) \subseteq \VIS_\aexec \)
and \( \left( (\SO_\aexec \cup \WW_\aexec \cup \WR_\aexec ) ; \RW_{\aexec}? \right) ; \VIS_\aexec \subseteq \VIS_\aexec \),
the visibility relation will have have the following form for some relation \( R \):
\[
    \VIS_\aexec = \left( \left( (\SO_\aexec \cup \WW_\aexec \cup \WR_\aexec ) ; \RW_{\aexec}? \right)  \cup R \right)^* ; (\SO_\aexec \cup \WR_\aexec \cup \WW_\aexec) 
\]
Given above, it is easy to see \( \VIS_\aexec ; \SO_\aexec \subseteq \VIS_\aexec \) since \( \SO \) is transitive, 
thus we have the proof for \( \MRd \) where the detail is the same same \( \MRd \) in \cref{sec:sound-complete-mr}.

\item Let consider \( \ddagger \).
Assume i-\emph{th} transaction \( \txid_i \) in the arbitrary order,
and let view \( \vi_{i} = \getView(\aexec, \VIS^{-1}_{\aexec}(\txid_{i}) ) \).
We also pick any final view such that \( \vi'_{i} \subseteq \getView(\aexec, (\AR^{-1}_{\aexec})?(\txid_{i}) ) \).
Note that there is nothing to prove for \( \vi'_i \) since the \( \ddagger \) does not constrain the \( \vi'_i \).
Let the \( \mkvs = \mkvs_{\cut(\aexec, i-1)} \).
Now we need to prove the following:
\begin{gather}
    \label{equ:si-complete-arvis}
    \begin{array}{@{}l@{}}
        \fora{\ke, \ke', m, j, \txid, \txid', \txid''} 
        m \in \vi(\ke) 
        \land \WTx(\mkvs(\ke,m)) \in \VIS^{-1}_{\aexec}(\txid_{i})
        \land m \in \vi(\ke)  \\
        \quad {} \wedge \WTx(\hh(\ke', j)) \toEdge{((\PO \cup \RF_{\hh} \cup \VO_{\hh}) ; \AD_{\hh}?)^{+}} \WTx(\hh(\ke, m)) \\
        \qquad \implies \WTx(\mkvs(\ke',j)) \in \VIS^{-1}_{\aexec}(\txid_{i})
    \end{array} 
\end{gather}
%Note that \( \txid \in \Set{\WTx(\mkvs(\ke,i))} \cup \func{RW^{-1}}{\mkvs, \ke, i} \) 
%means \( \txid \toEdge{\RW_{\aexec}?} \WTx(\mkvs(\ke,i)) \),
%the formulae \(\left( \begin{array}{@{}l@{}} \txid \in \RTx(\mkvs(\ke',j)) \land \txid' = \WTx(\mkvs(\ke',j)) \end{array} \right) \) 
%means \( \txid \toEdge{\WR_\aexec} \txid' \),
%and \( \left( \begin{array}{@{}l@{}} \txid = \WTx(\mkvs(\ke',m)) \land \txid' = \WTx(\mkvs(\ke',j)) \land m > j \end{array} \right) \) 
%means \( \txid \toEdge{\WW_\aexec} \txid' \).
%So \cref{equ:si-complete-arvis} holds if the following holds:
%\[
    %\begin{array}{@{}l@{}}
        %\fora{\ke, \ke', i, j, \txid, \txid'} \\
        %\left( \begin{array}{@{}l@{}}
        %i \in \vi(\ke) 
        %\land \WTx(\mkvs(\ke,i)) \in \VIS^{-1}_{\aexec}(\txid_{i}) 
        %\land \txid' = \WTx(\mkvs(\ke',j)) \\
        %\quad {} \land \txid \toEdge{\RW_{\aexec}?} \WTx(\mkvs(\ke,i))  \land {} \\
        %\quad \left(
        %\begin{array}{@{}l @{}}
            %\txid' \toEdge{\SO_\aexec} \txid \lor
            %\txid' \toEdge{\WR_\aexec ; \SO_\aexec} \txid \lor
            %\txid' \toEdge{\WR_\aexec} \txid \lor
            %\txid' \toEdge{\WW_\aexec} \txid 
        %\end{array}
        %\right)  \\
        %\qqquad \implies \txid' \in \VIS^{-1}_{\aexec}(\txid_{i})
        %\end{array} \right)
    %\end{array} \\
%\]
%The above holds, if the following holds:
%\begin{gather}
    %\label{equ:si-complete-arvis-2}
    %\begin{array}{@{}l@{}}
        %\fora{\ke, i, \txid} \\
        %\left( \begin{array}{@{}l@{}}
        %i \in \vi(\ke) 
        %\land \WTx(\mkvs(\ke,i)) \in \VIS^{-1}_{\aexec}(\txid_{i})  \\
        %{} \land \txid \toEdge{(\SO_\aexec \cup (\WR_\aexec ; \SO_\aexec ) \cup \WR_\aexec \cup \WW_\aexec ) ; \RW_{\aexec}?} \WTx(\mkvs(\ke,i))  \\
        %\quad \implies \txid \in \VIS^{-1}_{\aexec}(\txid_{i})
        %\end{array} \right)
    %\end{array} 
%\end{gather}
%Note that the constraint for the \( \aexec \):
Since \( \WR_\mkvs \), \( \WW_\mkvs \) and \( \RW_\mkvs \) coincide with
\( \WR_\aexec \), \( \WW_\aexec \) and \( \RW_\aexec \) respectively,
and \( \left( (\SO_{\aexec} \cup \WW_{\aexec} \cup \WR_{\aexec} ) ; \RW_{\aexec}? \right)^* ; \VIS_{\aexec}  \subseteq \VIS_\aexec \),
it implies the \cref{equ:si-complete-arvis}.

\end{itemize}
