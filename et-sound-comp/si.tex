\subsection{Snapshot Isolation \( \SI \)}
\label{sec:sound-complete-si}

The axiomatic definition for \( \SI \) is 
\[ 
(\RP_{\LWW}, \Set{\lambda \aexec. \AR_\aexec ; \VIS_\aexec, \lambda \aexec \ldotp \SO_\aexec, \lambda \aexec \ldotp \WW_\aexec }) 
\]
By a lemma proven in \cite{SIanalysis}, for any \( \aexec \) satisfies the \( \SI \)
there exists an equivalent \( \aexec' \) with minimum visibility \( \VIS_{\aexec'} \subseteq \VIS_\aexec \) satisfying 
\[ 
    \left( \RP_{\LWW}, \Set{\lambda \aexec. \left( (\SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'} ) ; \RW_{\aexec'}\rflx \right)^+ ; \VIS'_{\aexec'}, 
    \lambda \aexec \ldotp (\WW_{\aexec'} \cup \SO_{\aexec'}) } \right) 
\]
Under the minimum visibility \( \VIS \) all the transactions still have the same behaviour as before,
meaning they do not violate last-write-win.

To prove the soundness, we pick the invariant as the following:
\begin{align*}
    I_1(\aexec, \cl) & = \left( \bigcup_{\Set{\txid_{\cl}^{i} \in \txidset_{\aexec} }[ i \in \Nat ]} \VIS_{\aexec}^{-1}(\txid^i_\cl) \right) \setminus \txidset_\rd \\
    I_2(\aexec, \cl) & = \left( \bigcup_{\Set{\txid_{\cl}^{i} \in \txidset_{\aexec} }[ i \in \Nat ]} (\SO_{\aexec}^{-1})\rflx(\txid^i_\cl) \right) \setminus \txidset_\rd
\end{align*}
where \( \txidset_\rd \) is all the read-only transactions included in both 
\( \left( \bigcup_{\Set{\txid_{\cl}^{i} \in \txidset_{\aexec} }[ i \in \Nat ]} \VIS_{\aexec}^{-1}(\txid^i_\cl) \right)\) 
and \( \left( \bigcup_{\Set{\txid_{\cl}^{i} \in \txidset_{\aexec} }[ i \in \Nat ]} (\SO_{\aexec}^{-1})\rflx(\txid^i_\cl) \right) \).
Assume a kv-store $\mkvs$, an initial and a final view $\vi, \vi'$  a fingerprint $\fp$ 
such that $\ET_{\SI} \vdash (\mkvs, \vi) \csat \fp: (\mkvs',\vi')$. 
Also choose an arbitrary $\cl$, a transaction identifier $\txid_\cl^n \in \nextTxid(\mkvs, \cl)$, 
and an abstract execution $\aexec$ such that $\mkvs_{\aexec} = \mkvs$ and 
\( I_1(\aexec, \cl) \cup I_2(\aexec, \cl) \subseteq \Tx[\mkvs, \vi] \).
Let a new abstract execution \( \aexec' = \extend[\aexec, \txid_\cl^n, \fp, \Tx[\mkvs, \vi] \cup \txidset_\rd]\).
We are about to prove there exists an extra set of read-only transaction \( \txidset'_\rd \) such that:
\begin{gather}
    \fora{\txid} (\txid, \txid_\cl^n) \in \SO_{\aexec'} \implies \txid \in \Tx[\mkvs, \vi] \cup \txidset_\rd \cup \txidset'_\rd \label{equ:si-sound-update-so}\\
    \fora{\txid} (\txid, \txid_\cl^n) \in \WW_{\aexec'} \implies \txid \in \Tx[\mkvs, \vi] \cup \txidset_\rd \cup \txidset'_\rd \label{equ:si-sound-update-ww}\\
    \begin{array}{l}
    \fora{\txid} (\txid, \txid_\cl^n) \in \left( (\SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'} ) ; \RW_{\aexec'}\rflx \right)^+ ; \VIS_{\aexec'} 
    \implies \txid \in \Tx[\mkvs, \vi] \cup \txidset_\rd \cup \txidset'_\rd 
    \end{array}
    \label{equ:si-sound-update-arvis}\\
    I_1(\aexec',\cl) \cup I_2(\aexec',\cl) \subseteq \Tx[\mkvs_{\aexec'}, \vi'] \label{equ:si-sound-inv} 
\end{gather}
\begin{itemize}
\item The invariant \( I_2 \) implies \cref{equ:si-sound-update-so} as the same as \( \RYW \) in \cref{sec:sound-complete-ryw}.
\item Since \( \SI \) also satisfies \( \UA \), the \cref{equ:si-sound-update-ww} can be proven as the same as \( \UA \) in \cref{sec:sound-complete-ua}.
\item Note that for \cref{equ:si-sound-update-arvis}, it is sufficient to prove one step instead of transitive.
That is,
\[
    \begin{array}{l}
    \fora{\txid} (\txid, \txid_\cl^n) \in \left( (\SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'} ) ; \RW_{\aexec'}\rflx \right) ; \VIS_{\aexec'} 
    \implies \txid \in \Tx[\mkvs, \vi] \cup \txidset_\rd \cup \txidset'_\rd 
    \end{array}
\]
Let \( \txidset'_\rd \) initially be empty set.
More read-only transactions will be added in until \cref{equ:si-sound-update-arvis} holds.
Assume a transaction \( \txid \) such that 
\[
    (\txid, \txid_\cl^n) \in \left( (\SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'} ) ; \RW_{\aexec'}\rflx \right) ; \VIS_{\aexec'} 
\]
It means \( (\txid \toEDGE{\left( (\SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'} ) ; \RW_{\aexec'}\rflx \right) } \txid' \toEDGE{\VIS_{\aexec'}}  \txid_\cl^n \) for some transaction \( \txid' \).
There are two cases: \( \txid' \) writes to at least one key; or \( \txid' \) is read-only.
\begin{itemize}
\item \( \txid' \) writes to at least one key.
Assume that the transaction \( \txid' \) writes to a key \( \key \).
Now we perform case analysis if \( \txid \) is a read-only transaction.
\begin{itemize}
    \item if \( \txid \) has write, we prove \( \txid \in \Tx[\mkvs, \vi]\).
        Recall the \( \ddagger \) is defined as the following:
        \begin{gather}
            \begin{array}{@{}l@{}}
                \ddagger \equiv 
                \fora{\key, \key', i, j}
                i \in \vi(\key)
                \land \wtOf(\mkvs(\key', j))\toEDGE{((\SO \cup \WR_{\mkvs} \cup \WW_{\mkvs}) ; \RW_{\mkvs}\rflx)^{+}} \wtOf(\mkvs(\key, i))
                \implies j \in \vi(\key')    
            \end{array} 
            \label{equ:si-dagger}
        \end{gather}
        Since \( \WR_\mkvs \), \( \WW_\mkvs \) and \( \RW_\mkvs \) coincide with
        \( \WR_\aexec \), \( \WW_\aexec \) and \( \RW_\aexec \) respectively.
        Also because \( \txid \) write to at least one key,
        it is easy to see there exists some version \( \key'',m\) such that 
        \( \txid = \wtOf(\mkvs(\key'',m))\) and \( m \in \vi(\key'')\).
        By definition of \( \Tx \), it follows \( \txid \in \Tx[\mkvs, \vi] \).
    \item if \( \txid \) is a read-only transaction, we add it into \( \txidset'_\rd \).
\end{itemize}

\item If \( \txid' \) is a read-only transaction, we know \( \txid' \in \txidset_\rd \) or \( \txid' \in \txidset'_\rd \).
    More specifically we have three cases: \textbf{(i)} \( \txid' \in \bigcup_{\Set{\txid_{\cl}^{i} \in \txidset_{\aexec} }[ i \in \Nat ]} \VIS_{\aexec}^{-1}(\txid^i_\cl) \), \textbf{(ii)} \( \txid' \in \bigcup_{\Set{\txid_{\cl}^{i} \in \txidset_{\aexec} }[ i \in \Nat ]} (\SO_{\aexec}^{-1})\rflx(\txid^i_\cl) \) or \textbf{(iii)} \( \txid' \in \txidset'_\rd\).
    \begin{itemize}
        \item Assume \( \txid' \in \bigcup_{\Set{\txid_{\cl}^{i} \in \txidset_{\aexec} }[ i \in \Nat ]} \VIS_{\aexec}^{-1}(\txid^i_\cl) \).
        There exist a previous transaction from the same client \( \txid_\cl^m\) such that \( m < n \) and 
        \[ 
            \txid \toEDGE{\left( (\SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'} ) ; \RW_{\aexec'}\rflx \right) } \txid' \toEDGE{\VIS_{\aexec'}}  \txid_\cl^m 
        \]
        Since those edges already exists in the abstract execution \( \aexec\), and by the constraints of \( \aexec \) we have \( \txid \toEDGE{\VIS_{\aexec'}} \txid_\cl^m\).
        Therefore by the invariant \( I_1 \), either \( \txid \in \Tx[\mkvs, \vi] \cup \txidset_\rd \).
    \item Assume \( \txid' \in \bigcup_{\Set{\txid_{\cl}^{i} \in \txidset_{\aexec} }[ i \in \Nat ]} (\SO_{\aexec}^{-1})\rflx(\txid^i_\cl) \).
        Note that  \( \txid' \) is a read-only transaction so we can simplify the edge,
        \[ 
            \txid \toEDGE{\left( \SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'}  \right)} \txid_\cl^m \toEDGE{\SO_{\aexec'}}  \txid_\cl^n 
        \] 
        for some \( m \) such that \( m < n \).
        The path from \( \txid \) to \( \txid_\cl^m \) must exist in the abstract execution before update and they satisfy the constraint, so \( \txid \toEDGE{\VIS_\aexec} \txid_\cl^m \).
        Therefore by the invariant \( I_1 \), we have \( \txid \in \Tx[\mkvs, \vi] \cup \txidset_\rd \).
    \item \( \txid' \in \txidset'_\rd \). 
        Given that \( \txidset'_\rd \) initially is empty, there is anther transaction \( \txid'' \) that has at least a write such that:
        \[
        \begin{array}{l}
            \txid \toEDGE{\left( (\SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'} ) ; \RW_{\aexec'}\rflx \right) }
            \txid' \toEDGE{\left( (\SO_{\aexec'} \cup \WW_{\aexec'} \cup \WR_{\aexec'} ) ; \RW_{\aexec'}\rflx \right) } \txid'' \toEDGE{\VIS_{\aexec'}}  \txid_\cl^n 
        \end{array}
        \]
        If \( \txid \) has write, by \( \ddagger \) then \( \txid \in \Tx[\mkvs, \vi] \),
        otherwise we add \( \txid \) into \(\txidset'_\rd \).
    \end{itemize}
\end{itemize}
\item Since \( \SI \) satisfies \( \RYW \) and \( \MR \), thus invariants \( I_1 \) and  \( I_2 \) are preserved, that is, \cref{equ:si-sound-inv}.
\end{itemize}

To prove completeness, we prove four parts of the execution test separately.
\begin{itemize}
\item It is easy to see it is complete with respect to \( \UA \) and \( \RYW \) as \( \WW \cup \SO \subseteq \VIS \).
    The details are the same as proofs for \( \UA \) in \cref{sec:sound-complete-ua} and \( \RYW \) in \cref{sec:sound-complete-ryw}.

\item By the \cite{SIanalysis}, we know that for any abstract execution that satisfies \( (\WW_\aexec \cup \SO_\aexec) \subseteq \VIS_\aexec \)
and \( \left( (\SO_\aexec \cup \WW_\aexec \cup \WR_\aexec ) ; \RW_{\aexec}\rflx \right) ; \VIS_\aexec \subseteq \VIS_\aexec \),
the visibility relation will have have the following form for some relation \( R \):
\[
    \VIS_\aexec = \left( \left( (\SO_\aexec \cup \WW_\aexec \cup \WR_\aexec ) ; \RW_{\aexec}\rflx \right)  \cup R \right)^* ; (\SO_\aexec \cup \WR_\aexec \cup \WW_\aexec) 
\]
Given above, it is easy to see \( \VIS_\aexec ; \SO_\aexec \subseteq \VIS_\aexec \) since \( \SO \) is transitive, 
thus we have the proof for \( \MR \) where the detail is the same same \( \MR \) in \cref{sec:sound-complete-mr}.

\item Let consider \( \ddagger \).
Assume i-\emph{th} transaction \( \txid_i \) in the arbitrary order,
and let view \( \vi_{i} = \getView[\aexec, \VIS^{-1}_{\aexec}(\txid_{i})] \).
We also pick any final view such that \( \vi'_{i} \subseteq \getView[\aexec, (\AR^{-1}_{\aexec})\rflx(\txid_{i})] \).
Note that there is nothing to prove for \( \vi'_i \) since the \( \ddagger \) does not constrain the \( \vi'_i \).
Let the \( \mkvs = \mkvs_{\cut[\aexec, i-1]} \).
Now we need to prove the following:
\begin{gather}
    \label{equ:si-complete-arvis}
    \begin{array}{@{}l@{}}
        \fora{\key, \key', m, j, \txid, \txid', \txid''} 
        m \in \vi(\key) 
        \land \wtOf(\mkvs(\key,m)) \in \VIS^{-1}_{\aexec}(\txid_{i})
        \land m \in \vi(\key)  \\
        \quad {} \land \wtOf(\mkvs(\key', j)) \toEDGE{((\SO \cup \WR_{\mkvs} \cup \WW_{\mkvs}) ; \RW_{\mkvs}\rflx)^{+}} \wtOf(\mkvs(\key, m)) 
        \implies \wtOf(\mkvs(\key',j)) \in \VIS^{-1}_{\aexec}(\txid_{i})
    \end{array} 
\end{gather}
Since \( \WR_\mkvs \), \( \WW_\mkvs \) and \( \RW_\mkvs \) coincide with
\( \WR_\aexec \), \( \WW_\aexec \) and \( \RW_\aexec \) respectively,
and \( \left( (\SO_{\aexec} \cup \WW_{\aexec} \cup \WR_{\aexec} ) ; \RW_{\aexec}\rflx \right)^* ; \VIS_{\aexec}  \subseteq \VIS_\aexec \),
it implies the \cref{equ:si-complete-arvis}.

\end{itemize}
