\subsection{Program Soundness}
\begin{thm}[Program soundness]
The program soundness is the follows,
\[
    \for{\gpre, \prog, \gpost}
    \tripleG{\gpre}{\prog}{\gpost} 
    \implies 
    \tripleSemG{\gpre}{\prog}{\gpost} 
\]
\end{thm}
\begin{proof}
Induction on the derivations.
\caseB{\rl{PRCommit}}
We have \( \prog \equiv \ptrans{\trans} \).
Because a transaction \( \ptrans{\trans} \) is reduced by one step in the semantics, it is sufficient to prove for any state \(\w\) that satisfies pre-condition, if a machine state \((\hh',\thcu') \in \clpsW{\w'}\),  after arbitrary steps of rely, \ie \( (\w, \w') \in \Rely^{*} \), can transfers to a new state \((\hh'',\thcu'')\) followed by arbitrary steps of rely \((\w'',\w''') \in \Rely^{*} \), the final state \( \w''' \) should satisfy the post-condition \(\gpost\).
\[
\begin{array}{l}
    \begin{B}
        \stable{\gpre} 
        \land \gpre \snap \bar{\lpre}
        \land \tripleL{\bar{\lpre} \sep \fpEMP}{\trans}{\lpost \sep \fpF}
        \land \rpt{\gpre}{\gpost}{\fp} 
        \land \stable{\gpost}
    \end{B} \\
    \implies 
    \for{\w, \w', \w'', \w''', \hh', \hh'', \cu', \cu'', \thcu', \thcu'', \thid, \lenv, \thstk, \thstk''} \\
    \quad \begin{B}
        \w \in \evalW[\lenv, \thstk]{\gpre} 
        \land (\w, \w') \in \Rely^{*} 
        \land (\hh', \cu') \in \clpsW{\w'}
        \land \thcu'(\thid) = \cu' \\
        {} \land \thid, \func{como}{\w'} \vdash (\thstk, \hh', \thcu'), \ptrans{\trans} 
        \toT{\lbC{\txid}} (\thstk'', \hh'', \thcu''), \pskip  \\
        {} \land \thcu''(\thid) = \cu''
        \land (\hh'', \cu'') \in \clpsW{\w''} 
        \land (\w'', \w''') \in \Rely^{*} 
    \end{B} 
    \implies  \w''' \in \evalW[\lenv, \thstk'']{\gpost} 
\end{array}
\]
We will prove a stronger result in a way that any stable states are included in the assertions.
We split the formulae into three parts,
\begin{gather}
    \for{\w, \w',\lenv, \thstk} 
    \stable{\gpre} 
    \land \w \in \evalW[\lenv, \thstk]{\gpre} 
    \land (\w, \w') \in \Rely^{*}
    \implies \w' \in \evalW[\lenv, \thstk]{\gpre} \tag{Stable Pre} \label{equ:stable-pre-condition} \\
    \begin{array}{@{}l}
    \begin{B}
        \gpre \snap \bar{\lpre}
        \land \tripleL{\bar{\lpre} \sep \fpEMP}{\trans}{\lpost \sep \fpF}
        \land \rpt{\gpre}{\gpost}{\fp} 
    \end{B} \\
    \implies 
    \for{\w, \w', \hh, \hh', \cu, \cu', \thcu, \thcu', \thid, \lenv, \thstk, \thstk'} \\
    \quad \begin{B}
        \w \in \evalW[\lenv, \thstk]{\gpre}
        \land (\hh, \cu) \in \clpsW{\w}
        \land \thcu(\thid) = \cu \\
        {} \land \thid, \func{como}{\w} \vdash (\thstk, \hh, \thcu), \ptrans{\trans} 
        \toT{\lbC{\txid}} (\thstk', \hh', \thcu'), \pskip  \\
        {} \land \thcu'(\thid) = \cu'
        \land (\hh', \cu') \in \clpsW{\w'} 
    \end{B} 
    \implies  \w' \in \evalW[\lenv, \thstk']{\gpost} 
    \end{array} \tag{Commit} \\
    \for{\w, \w',\lenv, \thstk}  
    \stable{\gpost} 
    \land \w \in \evalW[\lenv, \thstk]{\gpost} 
    \land (\w, \w') \in \Rely^{*}
    \implies \w' \in \evalW[\lenv, \thstk]{\gpost} \tag{Stable Post} 
\end{gather}
\textbf{Stable pre-condition.} 
The \( \stable{\gpre} \) predicate asserts any world \( \w \) that satisfies the pre-condition \( \gpre \), if the world can transfer to another world \( \w' \) through rely \( \Rely \), the new world \( \w' \) also satisfies the pre-condition, which implies \equref{equ:stable-pre-condition}. \\
\textbf{Commit.}
For any \( \w, \hh, \cu, \lenv, \thstk \) such that \( \w \in \evalW[\lenv,\thstk]{\gpre} \) and \( (\hh, \cu) \in \clpsW{\w} \), by the predicate \( \gpre \snap \bar{\lpre} \) we know \( \clpsHH{\hh, \cu} \in \evalLS{\bar{\lpre}} \), this is,
\begin{equation}
\label{equ:local-pre-condition}
\for{\w, \hh, \cu, \lenv, \stk} \w \in \evalW{P} \land (\hh, \cu) \in \clpsW{\w} \implies (\clpsHH{\hh, \cu}, \unitO) \in \evalLS{\bar{\lpre} \sep \fpEMP}
\end{equation}
Because of the soundness of transaction (\thmref{thm:transaction-soundness}), given a thread stack \( \thstk \) and a logical environment \( \lenv \), if a initial configuration \( (\txstk, \h, \unitO), \trans \) satisfies the pre-condition, \ie \( (\h, \unitO) \in \evalLS[\lenv,\thstk \uplus \txstk]{\bar{\lpre} \sep \fpEMP} \), and if it can transfer to a final configuration \( (\txstk', \h', \opset), \pskip \), this final configuration should satisfy the post-condition \( \lpost \sep \fpF \).
This is, for any \( \thstk, \txstk, \txstk', \h, \h', \opset \), they satisfy the follows,
\begin{equation}
\label{equ:local-transaction-sound}
\begin{array}{@{}l}
    \for{\thstk, \txstk, \txstk', \h, \h', \opset} \\
    \quad (\h, \unitO) \in \evalLS[\lenv,\thstk \uplus \txstk]{\bar{\lpre} \sep \fpEMP}
    \land \thstk \vdash (\txstk, \h, \unitO), \trans \toL (\txstk', \h', \opset), \pskip
    \implies (\h, \opset) \in \evalLS[\lenv,\thstk \uplus \txstk']{\bar{\lpost} \sep \fpF}
\end{array}
\end{equation}
The repartition \( \rpt{\gpre}{\gpost}{\fp} \) asserts that any world \( \w \) satisfying the pre-condition \( \gpre \), if the corresponding machine of the world, \ie \( (\hh, \thcu) \), can transfer to a new state \( (\hh',\thcu') \) by committing fingerprints \( \fp \), then if a world \( \w' \) can collapses to the new machine state and the transition \( (\w, \w') \) is allowed by guarantee, the new world \( \w' \) should satisfy the post-condition.
Formally, for any \( \w, \w', \hh, \hh', \cu, \cu', \lenv, \stk, \txid \), they should satisfy the follows,
\begin{equation}
\label{equ:repartition}
\begin{array}{@{}l}
    \for{\w, \w', \hh, \hh', \cu, \cu', \lenv, \stk, \txid} \\
    \begin{B}
        \w \in \evalW{\gpre}
        \land (\hh, \cu) \in \eraseW{\w}
        \land \txid \in \func{fresh}{\hh} 
        \land \hh' = \func{commit}{\hh, \cu, \txid, \evalF{\fp}}  \\
        {} \land \cu' = \func{update}{\hh, \cu, \evalF{\fp}}
        \land (\hh',\cu') \in \eraseW{\w'}
        \land (\w, \w') \in \Guar 
    \end{B}
    \implies \w' \in \evalW{\gpost}
\end{array}
\end{equation}
First, if we eliminate the fingerprint \( \fp \) from \equref{equ:repartition} using \equref{equ:local-pre-condition} and \equref{equ:local-transaction-sound}, we know that for any world that satisfies \( \gpre \), there exists a set of operations corresponding to the transaction code \( \trans \), and the new world is the result by committing the operations to the old world.
\begin{equation}
\label{equ:combined-transaction-sound}
\begin{array}{@{}l}
    \for{\w, \w', \hh, \hh', \cu, \cu', \lenv, \stk, \txid, \h, \h', \txstk', \opset} \\
    \begin{B}
        \w \in \evalW{\gpre}
        \land (\hh, \cu) \in \eraseW{\w}
        \land \txid \in \func{fresh}{\hh} 
        \land \h = \clpsHH{\hh, \cu}  \\
        {} \land \thstk \vdash (\txstk, \h, \unitO), \trans \toL (\txstk', \h', \opset), \pskip   
        \land \hh' = \func{commit}{\hh, \cu, \txid, \opset}  \\
        {} \land \cu' = \func{update}{\hh, \cu, \opset}
        \land (\hh',\cu') \in \eraseW{\w'}
        \land (\w, \w') \in \Guar 
    \end{B}
    \implies \w' \in \evalW{\gpost}
\end{array}
\end{equation}
Second, the guarantee \( \Guar \) ensures the updated states of regions must not violate their invariants,
\[
\begin{array}{@{}l}
\for{\w,\w', \rid, \intf, \hh, \hh', \cu, \cu', \opset}
(\w,\w') \in \Guar  \\
\implies 
\w(\rid) = \w'(\rid) \lor 
\w(\rid) = (\hh, \cu, \intf)
\land \w'(\rid) = (\hh', \cu', \intf)
\land (\hh, \cu) \toLTS{\opset} (\hh', \cu') \in \func{inv}{\rid, \intf}
\end{array}
\]
\sx{The quantification}
Given the definition of labelled transition system for a region (\defref{def:labelled-transition-system}), we have the transition \( (\hh, \cu) \toLTS{\opset} (\hh', \cu') \) satisfies the consistency model and all the read operations must compatible with the cut \( \cu \),
\[
\begin{array}{@{}l}
    \for{\hh, \hh', \cu, \cu', \rid, \intf}
    \exsts{ \thcu, \thcu', \txid, \thid, \opset } \\
    \quad (\hh, \cu) \toLTS{\opset} (\hh', \cu') \in \func{inv}{\rid, \intf} \\
    \quad \implies
    \begin{B}
    \txid \in \func{fresh}{\hh} 
    \land \hh' = \func{commit}{\hh, \cu, \txid, \opset} 
    \land \cu' = \func{update}{\hh', \cu, \opset} \\
    {} \land ((\hh,\thcu),(\hh',\thcu')) \in \como
    \land \h = \clpsHH{\hh,\cu} 
    \land \thcu(\thid) = \cu 
    \land \thcu'(\thid) = \cu' \\
    {} \land \for{\addr,\val} (\otR, \addr, \val)  \in \opset \implies \h(\addr) = \val
    \end{B}
\end{array}
\]
\sx{might need a lemma}
Since regions included in a well-formed world are associated with the same consistency model and heaps associated with different regions are disjointed, therefore, transitions from the guarantee should satisfy the consistency model,
\begin{equation}
\label{equ:transition-sat-consitency-model}
\begin{array}{@{}l}
    \for{\w, \w', \hh, \hh', \cu, \cu'}
    \exsts{ \thcu, \thcu', \txid, \thid, \opset }
    (\w, \w') \in \Guar \\
    \implies 
    \begin{B}
    (\hh, \cu) \in \clpsW{\w}
    \land (\hh', \cu') \in \clpsW{\w'} \\
    {} \land \txid \in \func{fresh}{\hh} 
    \land \hh' = \func{commit}{\hh, \cu, \txid, \opset} 
    \land \cu' = \func{update}{\hh', \cu, \opset} \\
    {} \land ((\hh,\thcu),(\hh',\thcu')) \in \func{como}{\w}
    \land \h = \clpsHH{\hh,\cu} 
    \land \thcu(\thid) = \cu 
    \land \thcu'(\thid) = \cu' \\
    \end{B}
\end{array}
\end{equation}
We apply the \equref{equ:transition-sat-consitency-model} to the \equref{equ:combined-transaction-sound} and pick the empty transaction stack as the initial \( \txstk = \txstk_{0} = \emptyset \) transaction stack for the transaction code \( \trans \), then we have the follows,
\[
\begin{array}{@{}l}
    \begin{B}
        \exsts{\h, \h', \txstk_{0}, \txstk', \thcu, \thcu', \txid, \thid, \opset } \\
        \quad \w \in \evalW{\gpre} 
        \land (\hh, \cu) \in \eraseW{\w}
        \land \txid \in \func{fresh}{\hh} 
        \land \h = \clpsHH{\hh, \cu}
        \land \txstk_{0} = \emptyset \\
        \quad {} \land \thstk \vdash (\txstk, \h, \unitO), \trans \toL (\txstk', \h', \opset), \pskip 
        \land \hh' = \func{commit}{\hh, \cu, \txid, \opset} \\
        \quad {} \land \cu' = \func{update}{\hh, \cu, \opset} 
        \land (\hh',\cu') \in \eraseW{\w'}  \\
        \quad {} \land ((\hh,\thcu),(\hh',\thcu')) \in \func{como}{\w}
        \land \thcu(\thid) = \cu 
        \land \thcu'(\thid) = \cu' \\
    \end{B}
    \implies \w' \in \evalW{\gpost}
\end{array}
\]
In the equation above, we have all the side conditions of the semantics for reducing a single transaction \( \ptrans{\trans}\), by folding these side conditions we have the proof for the \equref{equ:commit-new-transaction}.
\sx{Need to think twice}
\textbf{Stable post-condition.} 
It can be proven for the similar reason as the proof for stable pre-condition.
\end{proof}
