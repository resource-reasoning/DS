\subsection{Transaction Soundness}


\begin{thm}[Transaction soundness]
\label{thm:transaction-soundness}
The transaction soundness is as follows:
\[
    \begin{array}{@{}l@{}}
        \for{ \lpre, \trans, \lpost } \tripleL{\lpre}{\trans}{\lpost} \implies \ \tripleSemL{\lpre}{\trans}{\lpost} \\
    \end{array}
\]
where,
\[
    \begin{rclarray}
    \tripleSemL{\lpre}{\trans}{\lpost} & \eqdef &
    \begin{array}[t]{@{}l@{}}
        \for{\lenv, \thstk, \txstk_{p}, \txstk_{q}, \h_{p}, \h_{q}, \evset_{p}, \evset_{q} } 
        \h_{p} \in \evalLS[\lenv, \thstk \uplus \txstk_{p}]{\lpre} \\
        \quad {} \land \thstk \vdash (\txstk_{p}, \h_{p}, \evset_{p} ), \trans \toL^{*}  (\txstk_{q}, \h_{q}, \evset_{q} ), \pskip 
        \implies \h_{q} \in \evalLS[\lenv, \thstk \uplus \txstk_{q}]{\lpost}
    \end{array}
    \end{rclarray}
\]
\end{thm}
\begin{proof}
Induction on the rules for transactions.

\caseB{\rl{TRSkip}}

We have  \(\trans \equiv \pskip\), \( \lpre \equiv \lpost \equiv \assemp \).
Given the transactions semantics (\fig \ref{fig:thread_semantics}), we have \( \h_{p} = \h_{q} = \unitH \), \( \evset_{p} = \evset_{q} \) and \( \txstk_{p} = \txstk_{q} \), so \( (\h_{q},\evset_{q} ) \in \evalLS[\lenv, \thstk \uplus \txstk_{q}]{\lpost} \).

\caseB{\rl{TRAss}}

We have \(\trans \equiv ( \pass{\txvar}{\expr} ) \), \( \lpre \equiv ( \txvar \doteq \lexpr ) \) and \( \lpost \equiv ( \txvar \doteq \expr\sub{\txvar}{\lexpr} ) \) for some \( \expr, \lexpr \) and \( \txvar \) such that \( \txvar \notin \func{fv}{\lexpr} \land \txvar \in \TxVars\).
Given the transaction semantics (\figref{fig:thread_semantics}), it has \( \txstk_{q} = \txstk_{p}\remapsto{\txvar}{\val} \) where \( \val = \evalLE[\lenv, \thstk \uplus \txstk_{p}]{\expr\sub{\var}{\lexpr}} \).
Given that \( \var \notin \func{fv}{\lexpr} \), it has \( \evalLE[\lenv, \thstk \uplus \txstk_{p}]{\lexpr} = \evalLE[\lenv, \thstk \uplus \txstk_{q}]{\lexpr} \), and so that \( \evalLE[\lenv, \thstk \uplus \txstk_{p}]{\expr\sub{\var}{\lexpr}} = \evalLE[\lenv, \thstk \uplus \txstk_{q}]{\expr\sub{\var}{\lexpr}} \).
This means the assertions related to stack states and syntactic values still holds even thought the stack changes.
Also because the heap and events set remains unchanged, this is \( \h_{p} = \h_{q} \) and \( \evset_{p} = \evset_{q} \), we have \( (\h_{q}, \evset_{q} ) \in \evalLS[\lenv, \thstk \uplus \txstk_{q}]{\lpost} \).

\caseB{\rl{TRDeref}}

We have  \(\trans \equiv ( \pderef{\txvar}{\expr} ) \), \( \lpre \equiv ( \expr \pt \lexpr \sep \fp ) \) and \( \lpost \equiv ( \txvar \doteq \lexpr \sep \expr \pt \lexpr \sep \fp' ) \) for some \( \txvar, \lexpr, \expr , \fp \) and \( \fp' \) such that \( \txvar \notin \func{fv}{\expr} \cup \func{fv}{\lexpr}\), \( \txvar \in \TxVars \) and \( \fp' = \fp \flushR (\etR, \expr, \lexpr)\).
Given the transaction semantics (\figref{fig:thread_semantics}), it has \( \txstk_{q} = \txstk_{p}\remapsto{\txvar}{\val} \) where \( \val = \h_{p}(\evalLE[\lenv, \thstk \uplus \txstk_{p}]{\expr}) \).
Since the heap \( \h_{p}\) satisfies the pre-condition \( \lpre\), so that \( \val =  \evalLE[\lenv, \thstk \uplus \txstk_{p}]{\lexpr} \).
Given that \( \txvar \notin \func{fv}{\expr} \cup \func{fv}{\lexpr} \), it must have \(  \evalLE[\lenv, \thstk \uplus \txstk_{p}]{\lexpr} = \evalLE[\lenv, \thstk \uplus \txstk_{q}]{\lexpr} \) and \( \evalLE[\lenv, \thstk \uplus \txstk_{p}]{\expr} = \evalLE[\lenv, \thstk \uplus \txstk_{q}]{\expr} \).
This means the assertions related to stack states and syntactic values still holds even thought the stack changes.
It also implies that \( \evalF[\lenv, \thstk \uplus \txstk_{p}]{\fp} = \evalF[\lenv, \thstk \uplus \txstk_{q}]{\fp} = \evset_{p} \), therefore \( \evalF[\lenv, \thstk \uplus \txstk_{q}]{\fp'} = \evalF[\lenv, \thstk \uplus \txstk_{q}]{\fp \flushR (\etR, \expr, \lexpr)}= \evset_{p} \flushR (\etR, \evalLS[\lenv, \thstk \uplus \txstk_{q}]{\expr}, \evalLS[\lenv, \thstk \uplus \txstk_{q}]{\lexpr}) = \evset_{p} \flushR (\etR, \evalLS[\lenv, \thstk \uplus \txstk_{p}]{\expr}, \evalLS[\lenv, \thstk \uplus \txstk_{p}]{\lexpr}) = \evset_{q} \).
Given above and \( \h_{p} = \h_{q} \), we have \( ( \h_{q},\evset_{q} ) \in \evalLS[\lenv, \thstk \uplus \txstk_{q}]{\lpost} \).

\caseB{ \rl{TRMutate} }

We have \( \trans \equiv (\pmutate{\expr_{1}}{\expr_{2}}) \), \( \lpre \equiv ( \expr_{1} \pt \stub \sep \fp ) \) and \( \lpost \equiv ( \expr_{1} \pt \expr_{2} \sep \fp') \), for some \( \expr_{1}, \expr_{2}, \fp \) and \( \fp' \) where \( \fp' = \fp \flushW (\etW, \expr_{1}, \expr_{2} ) \).
Given the transaction semantics (\figref{fig:thread_semantics}), it has \( \txstk_{p} = \txstk_{q} \), so \(  \evalLE[\lenv, \thstk \uplus \txstk_{p}]{\expr_{1}} = \evalLE[\lenv, \thstk \uplus \txstk_{q}]{\expr_{1}} \) and \(  \evalLE[\lenv, \thstk \uplus \txstk_{p}]{\expr_{2}} = \evalLE[\lenv, \thstk \uplus \txstk_{q}]{\expr_{2}} \).
This implies \( \h_{q} = \Set{\evalLE[\lenv, \thstk \uplus \txstk_{p}]{\expr_{1}} \mapsto \evalLE[\lenv, \thstk \uplus \txstk_{p}]{\expr_{2}} } = \Set{\evalLE[\lenv, \thstk \uplus \txstk_{q}]{\expr_{1}} \mapsto \evalLE[\lenv, \thstk \uplus \txstk_{q}]{\expr_{2}} } \) , and \( \evalF[\lenv, \thstk \uplus \txstk_{q}]{\fp'} = \evalF[\lenv, \thstk \uplus \txstk_{q}]{\fp \flushW (\etW, \expr_{1}, \expr_{2})}= \evset_{p} \flushW (\etW, \evalLS[\lenv, \thstk \uplus \txstk_{q}]{\expr_{1}}, \evalLS[\lenv, \thstk \uplus \txstk_{q}]{\expr_{2}}) = \evset_{p} \flushW (\etW, \evalLS[\lenv, \thstk \uplus \txstk_{p}]{\expr_{1}}, \evalLS[\lenv, \thstk \uplus \txstk_{p}]{\expr_{2}}) = \evset_{q} \).
Thus, \( ( \h_{q},\evset_{q} ) \in \evalLS[\lenv, \thstk \uplus \txstk_{q}]{\lpost} \). 

\caseI{\rl{TRChoice}}

We have  \(\trans \equiv \trans_{1} + \trans_{2} \), where \( \tripleL{\lpre}{\trans_{1}}{\lpost} \) and \( \tripleL{\lpre}{\trans_{2}}{\lpost} \) hold, for some \( \trans_{1}, \trans_{2} \).
Given the transaction semantics (\figref{fig:thread_semantics}), it either has \( \thstk \vdash ( \txstk_{p}, \h_{p}, \evset_{p} ), \trans_{1} \pchoice \trans_{2} \toL ( \txstk_{p}, \h_{p}, \evset_{p} ), \trans_{1} \) or  \( \thstk \vdash ( \txstk_{p}, \h_{p}, \evset_{p} ), \trans_{1} \pchoice \trans_{2} \toL ( \txstk_{p}, \h_{p}, \evset_{p} ), \trans_{2} \).
Since it is symmetric, assume picking \( \trans_{1} \).
Therefore we have \( \thstk \vdash ( \txstk_{p}, \h_{p}, \evset_{p} ), \trans_{1}  \toL^{*} ( \txstk_{q}, \h_{q}, \evset_{q} ), \pskip \).
By the \ih that \( \tripleSemL{\lpre}{\trans_{1}}{\lpost} \), so \( (\h_{q}, \evset_{q}) \in \evalLE[\lenv, \thstk \uplus \txstk_{q}]{\lpost} \).
Symmetrically, if it picks \( \trans_{2} \), it yields the same result.

\caseI{\rl{TRSeq}}

We have \( \trans \equiv \trans_{1} \pseq \trans_{2} \) where \( \tripleL{\lpre}{\trans_{1}}{\lframe} \) and \( \tripleL{\lframe}{\trans_{2}}{\lpost} \) hold, for some \( \lframe, \trans_{1}, \trans_{2} \).
Given the transaction semantics (\figref{fig:thread_semantics}), it has \( \thstk \vdash ( \txstk_{p}, \h_{p}, \evset_{p} ), \trans_{1} \pseq \trans_{2} \toL^{*} \thstk \vdash ( \txstk_{r}, \h_{r}, \evset_{r} ), \pskip \pseq \trans_{1} \toL \thstk \vdash ( \txstk_{r}, \h_{r}, \evset_{r} ), \trans_{1} \toL^{*} \thstk \vdash ( \txstk_{q}, \h_{q}, \evset_{q} ), \pskip \) for some \( \txstk_{r}, \h_{r}, \evset_{r} \).
By the \ih that \( \tripleSemL{\lpre}{\trans_{0}}{\lframe} \), so \( (\h_{r}, \evset_{r}) \in \evalLE[\lenv, \thstk \uplus \txstk_{r}]{\lframe} \).
Then, by the \ih that \( \tripleSemL{\lframe}{\trans_{1}}{\lpost} \), so \( (\h_{q}, \evset_{q}) \in \evalLE[\lenv, \thstk \uplus \txstk_{q}]{\lpost} \).

\caseI{\rl{TRLoop}}

Since the triple is only partial correct, meaning that if the transaction \( \trans \) terminates it will reach a state satisfying the post-condition \( \lpost \), it is sufficient to prove the follows,
\[
    \for{\lpre, \trans, \nat > 0} \tripleL{\lpre}{\trans^{\nat}}{\lpre} \implies \ \tripleSemL{\lpre}{\trans^{\nat}}{\lpre} \\
\]
where,
\[
\begin{rclarray}
    \trans^{1} & \defeq  & \trans \\
    \trans^{\nat} & \defeq  & \trans \pseq \trans^{\nat - 1} \\
\end{rclarray}
\]
given the \ih that \(\tripleL{\lpre}{\trans}{\lpre} \implies \ \tripleSemL{\lpre}{\trans}{\lpre} \).

We prove that by induction on the number \( \nat \).
For \( \nat = 1 \), it is proven by the \ih
For \( \nat > 1 \), we have \( \thstk \vdash (\txstk_{p}, \h_{p}, \evset_{p}), \trans \pseq \trans^{\nat - 1} \toL^{*} (\txstk_{r}, \h_{r}, \evset_{r}), \trans^{\nat - 1} \toL^{*} (\txstk_{q}, \h_{q}, \evset_{q}), \pskip \) for some \( \txstk_{r}, \h_{r}, \evset_{r} \).
By the \ih that \(\tripleSemL{\lpre}{\trans}{\lpre} \), it has \(  (\h_{r}, \evset_{r}) \in \evalLS[\lenv, \thstk \uplus \txstk_{r}]{\lpre} \).
Then by the \ih that \(\tripleSemL{\lpre}{\trans^{\nat - 1}}{\lpre} \), it has \(  (\h_{q}, \evset_{q}) \in \evalLS[\lenv, \thstk \uplus \txstk_{q}]{\lpre} \).

\caseI{\rl{TRFrame}}

We need to prove \( \tripleSemL{\lpre \sep \lframe }{\trans}{\lpost \sep \lframe} \) given that \( \tripleSemL{\lpre}{\trans}{\lpost} \).
there exists \( \h_{p} \), \( \h_{r} \), \( \h_{q} \), \( \evset_{p}\), \( \evset_{r}\)  and \( \evset_{q} \) that \( (\h_{p} \composeH \h_{r}, \evset_{p} \uplus \evset_{r}) \in \evalLS[\lenv, \thstk \uplus \txstk_{p}]{\lpre \sep \lframe} \land ( \h_{p}, \evset_{p} ) \in \evalLS[\lenv, \thstk \uplus \txstk_{p}]{\lpre} \land ( \h_{r}, \evset_{r} ) \in \evalLS[\lenv, \thstk \uplus \txstk_{p}]{\lframe}\) and similarly \( ( \h_{q} \composeH \h_{r}, \evset_{q} \uplus \evset_{r} ) \in \evalLS[\lenv, \thstk \uplus \txstk_{q}]{\lpost \sep \lframe} \land ( \h_{q} ,\evset_{q} ) \in \evalLS[\lenv, \thstk \uplus \txstk_{q}]{\lpost} \land ( \h_{r}, \evset_{r} ) \in \evalLS[\lenv, \thstk \uplus \txstk_{q}]{\lframe}\).
By the \ih that \( \tripleSemL{\lpre}{\trans}{\lpost} \), it means \( \thstk \vdash ( \txstk_{p}, \h_{p}, \evset_{p} ), \trans \toL^{*} ( \txstk_{q}, \h_{q}, \evset_{q} ), \pskip \).
Now we need to prove the follows,
\[
    \thstk \vdash ( \txstk_{p}, \h_{p}  \composeH \h_{r}, \evset_{p} \uplus \evset_{r}), \trans \toL^{*} ( \txstk_{q}, \h_{q} \composeH \h_{r}, \evset_{q} \uplus \evset_{r}), \pskip 
\]


\end{proof}

