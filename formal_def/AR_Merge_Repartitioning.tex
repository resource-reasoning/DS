\section{AR Merge and Repartitioning}
\newcommand{\effect}[1]{\Delta #1}
\newcommand{\orth}[1]{\ensuremath{{#1}^{\bot}}}
The effect of an action $\action {=} (\ls, \ls')$, written $\effect{\action}$, computes the changes applied to the action precondition $\ls$ when updated to the postcondition $\ls'$. In particular, $\effect{(\ls, \ls')}$ yields a 5-tuple $(\ls_r, \ls_f, \ls_c, \ls'_c, \ls_a)$, where $\ls_r$ denotes the maximal substate removed by $\action$ (i.e.~those parts present in $\ls$ and absent from $\ls'$), the $\ls_f$ denotes the maximal substate unchanged by $\action$ (i.e.~those parts present in both $\ls$ and $\ls'$), the $\ls_a$ denotes the maximal substate added by $\action$ (i.e.~those parts absent from $\ls$ and present in $\ls'$), and $\ls_c$ denotes the substate updated by $\action$ to $\ls'_c$.
%
\begin{definition}[Action effect]
Given the set of actions $\Actions$ (\defin\ref{def:action}), the \emph{effect of an action}, $\effect{(.)} : \Actions \rightarrow \LStates \times \LStates \times \LStates \times \LStates \times \LStates$, is defined as follows, for all $(\ls, \ls') \in \Actions$:
%
\[
	\effect{(\ls, \ls')} \eqdef 
	\myset{
		(\ls_r, \ls_f, \ls_c, \ls'_c, \ls_a)
	}{
		\ls = \ls_r \composeLS \ls_f \composeLS \ls_c
		\;\land\; \ls' = \ls_f \composeLS  \ls'_c \composeLS \ls_a 
		\;\land\; \ls_r \composeLS \ls_f \composeLS \ls'_c \composeLS \ls_a \isdef \\
		\land\ \for{\ls''} \ls'' \leq \ls \land \ls'' \leq \ls' \Rightarrow \ls'' \leq \ls_f \\
		\land\ \for{\ls''} \ls'' \leq \ls_c \land \ls'' \leq \ls'_c  \Rightarrow \ls'' {=} \unitLS 
		\;\land\; \orth{\ls_c} = \orth{\ls'_c} \\
		\land\ \for{\ls''} \ls'' \leq \ls_r \land \ls'' \leq \ls_a  \Rightarrow \ls'' {=} \unitLS \\
		\land\ \for{\ls_1, \ls_2} \ls_1 \ne \unitLS \land \ls_2 \ne \unitLS \land \ls_1 \leq \ls_r \land \ls_2 \leq \ls_a 
		\Rightarrow \orth{\ls_1} \ne \orth{\ls_2} \\
	}
\]
%
where
%
\[
	\orth{\ls} \eqdef \myset{\ls'}{\ls \composeLS \ls' \isdef}
\]
\end{definition}
%
%
\newcommand{\mergeLS}[3]{\func{merge}{#1, #2, #3}}
\begin{definition}[Local state merge]
\[
	\mergeLS{\ls}{\ls_1}{\ls_2}
	\eqdef
	\myset{
		\ls_1^a \composeLS \ls_2^a \\
		\composeLS (\unitFP, \ca_4) \composeLS \ls_5 \\
		\composeLS (, \ca_3)	
	}{
		\exsts{\ls_1^r, \ls_1^f, \ls_1^c, \ls_3^c, \ls_1^a, \ls_2^r, \ls_2^f, \ls_2^c, \ls_4^c, \ls_2^a, \h_1, \h_2, \h_3, \h_4, \ca_1, \ca_2, \ca_3, \ca_4, \ls_5, \ls_6}\\
		\quad (\ls_1^r, \ls_1^f, \ls_1^c, \ls_3^c, \ls_1^a) \in \effect{(\ls, \ls_1)}  
		\land (\ls_2^r, \ls_2^f, \ls_2^c, \ls_4^c, \ls_2^a) \in \effect{(\ls, \ls_2)}  \\
		\quad \land\; \ls_1 \composeLS \ls_1^r  \composeLS \ls_2^a  \isdef
		\land\ \ls_2 \composeLS \ls_2^r  \composeLS \ls_1^a  \isdef \\
		\quad \land\; \ls_1^c {=} (\h_1, \ca_1)
		\land \ls_2^c {=} (\h_2, \ca_2)
		\land \ls_3^c {=} (\h_3, \ca_3)
		\land \ls_4^c {=} (\h_4, \ca_4) \\
		\quad \land\; \ws{\h_3} \cap \ws{\h_4} {=} \emptyset \\
		\quad \land\; \ls_1^f {=} \ls_2^r \composeLS (\unitFP, \ca_2) \composeLS \ls_5
		\land \ls_2^f {=} \ls_1^r \composeLS (\unitFP, \ca_1) \composeLS \ls_6 \\
	}
\]
\end{definition}