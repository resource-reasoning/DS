\section{blablabla\label{sec:example}}
We use \( \loc[\dontcare] \) to denote a location in either global or local heap.

\[
    \begin{session}
        \specline{\loc[x] \pointsto 0 \sep \loc[y] \pointsto 0} \\                                          
        \begin{parl}
            \begin{session}
                \actionline{\rely}{\loc[x] \pointsto[r] \anyval \sep \loc[y] \pointsto[r] 0 \transfersto \loc[x] \pointsto[w] 1 \sep \loc[y] \pointsto[r] 0} \\
                \specline{\loc[x] \pointsto 0 \sep \loc[y] \pointsto 0 \lor \loc[x] \pointsto 1 \sep \loc[y] \pointsto 0} \\
                \begin{transaction}
                    \specline{\loc[x] \pointsto[r] 0 \sep \loc[y] \pointsto[r] 0 \lor {} \\
                        \loc[x] \pointsto[r] 1 \sep \loc[y] \pointsto[r] 0} \\
                    \tderef{\vx}{\loc[x]} ; \\
                    \specline{\loc[x] \pointsto[r] 0 \sep \loc[y] \pointsto[r] 0 \land \vx = 0 \lor {} \\
                        \loc[x] \pointsto[r] 1 \sep \loc[y] \pointsto[r] 0 \land \vx = 1} \\
                    \tifs{\vx = 0} \\
                    \quad \tmutate{\loc[y]}{1} ; \\
                    \specline{\loc[x] \pointsto[r] 0 \sep \loc[y] \pointsto[w] 1 \land \vx = 0 \lor {} \\
                        \loc[x] \pointsto[r] 1 \sep \loc[y] \pointsto[r] 0 \land \vx = 1} \\
                    MERGE \\
                    \specline{\loc[x] \pointsto[r] 0 \sep \loc[y] \pointsto[w] 1  \lor {} \\
                        \loc[x] \pointsto[r] 1 \sep \loc[y] \pointsto[r] 0 \lor {} \\
                        \loc[x] \pointsto[w] 1 \sep \loc[y] \pointsto[w] 1 \lor {} \\
                        \loc[x] \pointsto[w] 1 \sep \loc[y] \pointsto[r] 0 
                    } \\
                \end{transaction} \\
                \specline{\loc[x] \pointsto 0 \sep \loc[y] \pointsto 1  \lor {} \\
                    \loc[x] \pointsto 1 \sep \loc[y] \pointsto 0 \lor {} \\
                    \loc[x] \pointsto 1 \sep \loc[y] \pointsto 1 
                } \\
            \end{session} & 
            \begin{session}
                \actionline{\rely}{\loc[x] \pointsto[r] 0 \sep \loc[y] \pointsto[r] \anyval \transfersto \loc[x] \pointsto[r] 0 \sep \loc[y] \pointsto[w] 1} \\
                \specline{\loc[x] \pointsto 0 \sep \loc[y] \pointsto 0 \lor \loc[x] \pointsto 0 \sep \loc[y] \pointsto 1} \\
                \begin{transaction}
                    \specline{\loc[x] \pointsto[r] 0 \sep \loc[y] \pointsto[r] 0 \lor {} \\
                        \loc[x] \pointsto[r] 0 \sep \loc[y] \pointsto[r] 1} \\
                    \tderef{\vy}{\loc[y]} ; \\
                    \tifs{\vy = 0} \\
                    \quad \tmutate{\loc[x]}{1} ; \\
                    \specline{\loc[x] \pointsto[w] 1 \sep \loc[y] \pointsto[r] 0 \lor {} \\
                        \loc[x] \pointsto[r] 0 \sep \loc[y] \pointsto[r] 1} \\
                    MERGE \\
                    \specline{\loc[x] \pointsto[w] 1 \sep \loc[y] \pointsto[r] 0 \lor {} \\
                        \loc[x] \pointsto[r] 0 \sep \loc[y] \pointsto[r] 1 \lor {} \\
                        \loc[x] \pointsto[w] 1 \sep \loc[y] \pointsto[w] 1 \lor {} \\
                        \loc[x] \pointsto[r] 0 \sep \loc[y] \pointsto[w] 1
                    } \\
                \end{transaction} \\
                \specline{\loc[x] \pointsto 0 \sep \loc[y] \pointsto 1  \lor {} \\
                    \loc[x] \pointsto 1 \sep \loc[y] \pointsto 0 \lor {} \\
                    \loc[x] \pointsto 1 \sep \loc[y] \pointsto 1 
                } \\
            \end{session} \\
        \end{parl} \\
        \specline{\loc[x] \pointsto 0 \sep \loc[y] \pointsto 1  \lor \loc[x] \pointsto 1 \sep \loc[y] \pointsto 0 \lor \loc[x] \pointsto 1 \sep \loc[y] \pointsto 1 } \\
    \end{session}
\]

***The second rely might be useful in term of killing the possible states of other thread, even though it is irrelevant for the current thread.
About the problem, an ugly solution is: if the resource appear in rely, current thread should keep it whether uses it or not.
However this solution is against the idea of separation logic, i.e.\ we do not need to take care of those resource untouched.

\[
    \begin{array}{@{}c@{}}
        \begin{parl}
            \begin{session}
                \actionline{\rely}{ \loc[y] \pointsto[r] \anyval \transfersto \loc[y] \pointsto[w] 1 \\
                    \loc[x] \pointsto[r] x \sep \loc[y] \pointsto[r] y \sep \loc[tx2] \pointsto[r] \anyval \sep \loc[ty2] \pointsto[r] \anyval \\
                    \transfersto \loc[x] \pointsto[r] x \sep \loc[y] \pointsto[r] y \sep \loc[tx2] \pointsto[w] x \sep \loc[ty2] \pointsto[w] y } \\
                \specline{\loc[x] \pointsto 0 \sep \loc[y] \pointsto 0 \sep \loc[tx1] \pointsto 0 \sep \loc[ty1] \pointsto 0 \lor {} \\
                    \loc[x] \pointsto 0 \sep \loc[y] \pointsto 1 \sep \loc[tx1] \pointsto 0 \sep \loc[ty1] \pointsto 0
                } \\
                \begin{transaction}
                    \tmutate{\loc[x]}{1} ;
                \end{transaction} \\
                \specline{\loc[x] \pointsto 1 \sep \loc[y] \pointsto 0 \sep \loc[tx1] \pointsto 0 \sep \loc[ty1] \pointsto 0 \lor {} \\
                    \loc[x] \pointsto 1 \sep \loc[y] \pointsto 1 \sep \loc[tx1] \pointsto 0 \sep \loc[ty1] \pointsto 0
                } \\
                \begin{transaction}
                    \specline{\loc[x] \pointsto[r] 1 \sep \loc[y] \pointsto[r] 0 \sep \loc[tx1] \pointsto[r] 0 \sep \loc[ty1] \pointsto[r] 0 \lor {} \\
                        \loc[x] \pointsto[r] 1 \sep \loc[y] \pointsto[r] 1 \sep \loc[tx1] \pointsto[r] 0 \sep \loc[ty1] \pointsto[r] 0
                    } \\
                    \tderef{\vx}{\loc[x]} ; \\
                    \tmutate{\loc[tx1]}{\vx} ; \\
                    \tderef{\vy}{\loc[y]} ; \\
                    \tmutate{\loc[ty1]}{\vy} ; \\
                    \specline{\loc[x] \pointsto[r] 1 \sep \loc[y] \pointsto[r] 0 \sep \loc[tx1] \pointsto[w] 1 \sep \loc[ty1] \pointsto[w] 0 \lor {} \\
                        \loc[x] \pointsto[r] 1 \sep \loc[y] \pointsto[r] 1 \sep \loc[tx1] \pointsto[w] 1 \sep \loc[ty1] \pointsto[w] 1
                    } \\
                    MERGE \\
                    \specline{\loc[x] \pointsto[r] 1 \sep \loc[y] \pointsto[r] 0 \sep \loc[tx1] \pointsto[w] 1 \sep \loc[ty1] \pointsto[w] 0 \lor {} \\
                        \loc[x] \pointsto[r] 1 \sep \loc[y] \pointsto[r] 1 \sep \loc[tx1] \pointsto[w] 1 \sep \loc[ty1] \pointsto[w] 1 \lor {} \\
                        \loc[x] \pointsto[r] 1 \sep \loc[y] \pointsto[w] 1 \sep \loc[tx1] \pointsto[w] 1 \sep \loc[ty1] \pointsto[w] 0 
                    } \\
                \end{transaction} \\
                \specline{\loc[x] \pointsto 1 \sep \loc[y] \pointsto 0 \sep \loc[tx1] \pointsto 1 \sep \loc[ty1] \pointsto 0 \lor {} \\
                    \loc[x] \pointsto 1 \sep \loc[y] \pointsto 1 \sep \loc[tx1] \pointsto 1 \sep \loc[ty1] \pointsto 1 \lor {} \\
                    \loc[x] \pointsto 1 \sep \loc[y] \pointsto 1 \sep \loc[tx1] \pointsto 1 \sep \loc[ty1] \pointsto 0 
                } \\
            \end{session} & 
            \begin{session}
                \actionline{\rely}{ \loc[x] \pointsto[r] \anyval \transfersto \loc[x] \pointsto[w] 1 \\
                    \loc[x] \pointsto[r] x \sep \loc[y] \pointsto[r] y \sep \loc[tx1] \pointsto[r] \anyval \sep \loc[ty1] \pointsto[r] \anyval \\
                    \transfersto \loc[x] \pointsto[r] x \sep \loc[y] \pointsto[r] y \sep \loc[tx1] \pointsto[w] x \sep \loc[ty1] \pointsto[w] y } \\
                \specline{\loc[x] \pointsto 0 \sep \loc[y] \pointsto 0 \sep \loc[tx2] \pointsto 0 \sep \loc[ty2] \pointsto 0 \lor {} \\
                    \loc[x] \pointsto 1 \sep \loc[y] \pointsto 0 \sep \loc[tx2] \pointsto 0 \sep \loc[ty2] \pointsto 0
                } \\
                \begin{transaction}
                    \tmutate{\loc[y]}{1} ;
                \end{transaction} \\
                \specline{\loc[x] \pointsto 0 \sep \loc[y] \pointsto 1 \sep \loc[tx2] \pointsto 0 \sep \loc[ty2] \pointsto 0 \lor {} \\
                    \loc[x] \pointsto 1 \sep \loc[y] \pointsto 1 \sep \loc[tx2] \pointsto 0 \sep \loc[ty2] \pointsto 0
                } \\
                \begin{transaction}
                    \tderef{\vx}{\loc[x]} ; \\
                    \tmutate{\loc[tx2]}{\vx} ; \\
                    \tderef{\vy}{\loc[y]} ; \\
                    \tmutate{\loc[ty2]}{\vy} ; \\
                    MERGE \\
                    \specline{\loc[x] \pointsto[r] 0 \sep \loc[y] \pointsto[r] 1 \sep \loc[tx2] \pointsto[w] 0 \sep \loc[ty2] \pointsto[w] 1 \lor {} \\
                        \loc[x] \pointsto[r] 1 \sep \loc[y] \pointsto[r] 1 \sep \loc[tx2] \pointsto[w] 1 \sep \loc[ty2] \pointsto[w] 1 \lor {} \\
                        \loc[x] \pointsto[w] 1 \sep \loc[y] \pointsto[r] 1 \sep \loc[tx2] \pointsto[w] 0 \sep \loc[ty2] \pointsto[w] 1
                    } \\
                \end{transaction} \\
                \specline{\loc[x] \pointsto 0 \sep \loc[y] \pointsto 1 \sep \loc[tx2] \pointsto 0 \sep \loc[ty2] \pointsto 1 \lor {} \\
                    \loc[x] \pointsto 1 \sep \loc[y] \pointsto 1 \sep \loc[tx2] \pointsto 1 \sep \loc[ty2] \pointsto 1 \lor {} \\
                    \loc[x] \pointsto 1 \sep \loc[y] \pointsto 1 \sep \loc[tx2] \pointsto 0 \sep \loc[ty2] \pointsto 1 
                } \\
            \end{session} \\
        \end{parl} \\
        \specline{ \loc[x] \pointsto 1 \sep \loc[y] \pointsto 1 \sep {} \\
            \begin{formulea}
                \loc[tx1] \pointsto 1 \sep \loc[ty1] \pointsto 0 \sep \loc[tx2] \pointsto 0 \sep \loc[ty2] \pointsto 1 \lor {} \\
                \loc[tx1] \pointsto 1 \sep \loc[ty1] \pointsto 0 \sep \loc[tx2] \pointsto 1 \sep \loc[ty2] \pointsto 1 \lor {} \\
                \loc[tx1] \pointsto 1 \sep \loc[ty1] \pointsto 1 \sep \loc[tx2] \pointsto 0 \sep \loc[ty2] \pointsto 1 \lor {} \\
                \loc[tx1] \pointsto 1 \sep \loc[ty1] \pointsto 1 \sep \loc[tx2] \pointsto 1 \sep \loc[ty2] \pointsto 1 
            \end{formulea}
        } \\
    \end{array}
\]

Above, the 1 0 0 1 case will never happen.
This is called long fork in snapshot isolation, for a single machine snapshot isolation, it should not happen.

We use \( (\dontcare, \dontcare, \dontcare, \dontcare, \dontcare, \dontcare) \) to refer x,y,tx1,ty1,tx2,ty2.

\[
    \begin{array}{@{}c@{}}
        \begin{parl}
            \begin{session}
                \actionline{\rely}{ \loc[y] \pointsto[r] \anyval \transfersto \loc[y] \pointsto[w] 1 \\
                    \loc[x] \pointsto[r] x \sep \loc[y] \pointsto[r] y \sep \loc[tx2] \pointsto[r] \anyval \sep \loc[ty2] \pointsto[r] \anyval \\
                    \transfersto \loc[x] \pointsto[r] x \sep \loc[y] \pointsto[r] y \sep \loc[tx2] \pointsto[w] x \sep \loc[ty2] \pointsto[w] y } \\
                    \specline {(0,0,0,0,0,0) \lor (0,1,0,0,0,0) \lor (0,1,0,0,0,1)}\\
                \begin{transaction}
                    \specline {(0,0,0,0,0,0) \lor (0,1,0,0,0,0) \lor (0,1,0,0,0,1)}\\
                    \tmutate{\loc[x]}{1} ; \\
                    \specline {(1,0,0,0,0,0) \lor (1,1,0,0,0,0) \lor (1,1,0,0,0,1)}\\
                    MERGE \\
                    \specline {(1,0,0,0,0,0) \lor (1,1,0,0,0,0) \lor (1,1,0,0,0,1)}\\
                \end{transaction} \\
                \specline {(1,0,0,0,0,0) \lor (1,1,0,0,0,0) \lor (1,1,0,0,0,1) \lor {} \\
                    (1,0,0,0,1,0) \lor (1,1,0,0,1,1)}\\
                \begin{transaction}
                    \specline {(1,0,0,0,0,0) \lor (1,1,0,0,0,0) \lor (1,1,0,0,0,1) \lor {} \\
                        (1,0,0,0,1,0) \lor (1,1,0,0,1,1)}\\
                    \tderef{\vx}{\loc[x]} ; \\
                    \tmutate{\loc[tx1]}{\vx} ; \\
                    \tderef{\vy}{\loc[y]} ; \\
                    \tmutate{\loc[ty1]}{\vy} ; \\
                    \specline {(1,0,1,0,0,0) \lor (1,1,1,1,0,0) \lor (1,1,1,1,0,1) \lor {} \\
                        (1,0,1,0,1,0) \lor (1,1,1,1,1,1)}\\
                    MERGE \\
                    \specline {(1,0,1,0,0,0) \lor (1,1,1,1,0,0) \lor (1,1,1,1,0,1) \lor {} \\
                        (1,0,1,0,1,0) \lor (1,1,1,1,1,1) \lor (1,1,1,0,0,0)}\\
                \end{transaction} \\
                \specline {(1,0,1,0,0,0) \lor (1,1,1,1,0,0) \lor (1,1,1,1,0,1) \lor {} \\
                    (1,0,1,0,1,0) \lor (1,1,1,1,1,1) \lor (1,1,1,0,0,0) \lor {}\\
                    (1,1,1,0,1,1)}\\
            \end{session} & 
            \begin{session}
                \actionline{\rely}{ \loc[x] \pointsto[r] \anyval \transfersto \loc[x] \pointsto[w] 1 \\
                    \loc[x] \pointsto[r] x \sep \loc[y] \pointsto[r] y \sep \loc[tx1] \pointsto[r] \anyval \sep \loc[ty1] \pointsto[r] \anyval \\
                    \transfersto \loc[x] \pointsto[r] x \sep \loc[y] \pointsto[r] y \sep \loc[tx1] \pointsto[w] x \sep \loc[ty1] \pointsto[w] y } \\
                    \specline {(0,0,0,0,0,0) \lor (1,0,0,0,0,0) \lor (1,0,1,0,0,0)}\\
                \begin{transaction}
                    \specline {(0,0,0,0,0,0) \lor (1,0,0,0,0,0) \lor (1,0,1,0,0,0)}\\
                    \tmutate{\loc[y]}{1} ; \\
                    \specline {(0,1,0,0,0,0) \lor (1,1,0,0,0,0) \lor (1,1,1,0,0,0)}\\
                \end{transaction} \\
                \specline {(0,1,0,0,0,0) \lor (1,1,0,0,0,0) \lor (1,1,1,0,0,0) \lor {} \\
                    (0,1,0,1,0,0) \lor (1,1,1,1,0,0)}\\
                \begin{transaction}
                    \specline {(0,1,0,0,0,0) \lor (1,1,0,0,0,0) \lor (1,1,1,0,0,0) \lor {} \\
                        (0,1,0,1,0,0) \lor (1,1,1,1,0,0)}\\
                    \tderef{\vx}{\loc[x]} ; \\
                    \tmutate{\loc[tx2]}{\vx} ; \\
                    \tderef{\vy}{\loc[y]} ; \\
                    \tmutate{\loc[ty2]}{\vy} ; \\
                    \specline {(0,1,0,0,0,1) \lor (1,1,0,0,1,1) \lor (1,1,1,0,1,1) \lor {} \\
                        (0,1,0,1,0,1) \lor (1,1,1,1,1,1)}\\
                    MERGE \\
                    \specline {(0,1,0,0,0,1) \lor (1,1,0,0,1,1) \lor (1,1,1,0,1,1) \lor {} \\
                        (0,1,0,1,0,1) \lor (1,1,1,1,1,1) \lor (1,1,0,0,0,1) }
                \end{transaction} \\
                \specline {(0,1,0,0,0,1) \lor (1,1,0,0,1,1) \lor (1,1,1,0,1,1) \lor {} \\
                    (0,1,0,1,0,1) \lor (1,1,1,1,1,1) \lor (1,1,0,0,0,1) \lor {} \\
                    (1,1,1,1,0,1)}
            \end{session} \\
        \end{parl} \\
        \specline { (1,1,1,0,1,1) \lor (1,1,1,1,1,1) \lor (1,1,1,1,0,1)}
    \end{array}
\]

\[
    \begin{array}{@{}l@{}}
        \begin{parl}
            \begin{session}
                \begin{transaction}
                    \tmutate{\loc[x]}{1} ; \\
                    \tmutate{\loc[z]}{1} ; \\
                \end{transaction}
            \end{session} & 
            \begin{session}
                \begin{transaction}
                    \tmutate{\loc[y]}{2} ; \\
                    \tmutate{\loc[z]}{2} ; \\
                \end{transaction}
            \end{session} \\
        \end{parl}
    \end{array}
\]
