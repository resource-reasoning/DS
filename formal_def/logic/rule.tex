\subsection{Rules for Local}

The proof rules are standard except \rl{TRDeref} and \rl{TRMutate}.
The \rl{TRDeref} rule add read fingerprint in finger-tracking set, only if there is no write finger-print.
This is because once a location has been re-written, the rest read are considered as local operations, while the finger-print only records those operations might have effect on global state.

\begin{figure}[t]
\hrule\vspace{5pt}
\[
    \infer[\rl{TRSkip}]{%
        \tripleL{\assemp \mid \fp }{ \pskip }{\assemp \mid \fp }
    }{}
\]

\[
    \infer[\rl{TRAss}]{%
        \tripleL{\txvar \dot= \lexpr \mid \fp }{ \pass{\txvar}{\expr} }{\txvar \dot= \expr\sub{\txvar}{\lexpr} \mid \fp\sub{\txvar}{\lexpr} }
    }{%
        \txvar \notin \func{fv}{\lexpr} 
        && \txvar \in \TxVars  
    }
\]

\[
    \infer[\rl{TRDeref}]{%
        \tripleL{\expr \pt \lexpr \mid \fp }{ \pderef{\txvar}{\expr} }{\txvar \dot= \lexpr \sep \expr \pt \lexpr \mid \fp' }
    }{%
        \var \notin \func{fv}{\expr}
        && \var \notin \func{fv}{\lexpr}  
        && \txvar \in \TxVars  
        && \fp' = \fp \flushR (\etR, \expr, \lexpr)
    }
\]

\[
    \infer[\rl{TRMutate}]{%
        \tripleL{\expr_1 \pt \stub \mid \fp }{ \pmutate{\expr_1}{\expr_2} }{ \expr_1 \pt \expr_2 \mid \fp' } 
    }{
        \fp' = \fp \flushW (\etW, \expr_{1}, \expr_{2})
    }
\]

\[
    \infer[\rl{TRChoice}]{%
        \tripleL{ \lpre \mid \fp }{ \trans_{1} \pchoice \trans_{2} }{ \lpost \mid \fp' }
    }{%
        \tripleL{ \lpre \mid \fp }{ \trans_{1} }{ \lpost \mid \fp' } && 
        \tripleL{ \lpre \mid \fp }{ \trans_{2} }{ \lpost \mid \fp' } 
    }
\]

\[
    \infer[\rl{TRSeq}]{%
        \tripleL{ \lpre \mid \fp }{ \trans_{1} \pseq \trans_{2} }{ \lpost \mid \fp' }
    }{%
        \tripleL{ \lpre \mid \fp }{ \trans_{1} }{ \lframe \mid \fp'' }  && 
        \tripleL{ \lframe \mid \fp'' }{ \trans_{1} }{ \lpost \mid \fp' }
    }
\]

\sx{here we assume the fingerprint \( \fp\) can be parametrised by the assertion \( \lpre \)}
\[
    \infer[\rl{TRLoop}]{%
        \tripleL{ \lpre \mid \fp }{ \trans\prepeat }{ \lpre \mid \fp }
    }{%
        \tripleL{ \lpre \mid \fp }{ \trans }{ \lpre \mid \fp } 
    }
\]
 
\[
   \infer[\rl{TRFrame}]{%
       \tripleL{ \lpre \sep \lframe \mid \fp }{ \trans }{ \lpost \sep \lframe \mid \fp }
   }{%
       \tripleL{ \lpre \mid \fp }{ \trans }{ \lpost \mid \fp } 
   }
\]
\hrule\vspace{5pt}
\caption{The rules for transactions}
\label{fig:rule-trans}
 \end{figure}


\subsection{Rely and Guarantee}

\begin{definition}[Rely and guarantee]
\label{def:rely-guarantee}
Given the set of worlds $\World$ (\defref{def:world}), the \emph{update rely} relation, $\relyU \eqdef \ConsisModels \to \World \times \World$, is defined as follows:
%
\[	
    \begin{rclarray}
	\relyU & \eqdef &
	\myset{
		((\ca, \ \Set{\rid \mapsto (\h, \intf)} \composeFPH  \gs_{f}), (\ca, \Set{\rid \mapsto (\h', \intf)} \composeFPH \gs_{f}))	
	}{
        \dagger
	} \\
    \dagger & \equiv & 
    \begin{array}[t]{l}
        \exsts{\aexec, \aexec',\vis, \po, \ar, \txid, \evset} 
        \aexec \in \func{h2e_{\como}}{\h} 
        \land \aexec' \in \func{h2e_{\como}}{\h'}  \\
        {} \land \aexec' = (\aexec\prjT \uplus \Set{ \txid \mapsto \evset }, \aexec\prjP \uplus \po, \aexec\prjV \uplus \vis, \aexec\prjA \uplus \ar) \\
        {} \land \vis, \po \subseteq \ar = \Setcon{(\txid', \txid)}{\txid' \in \dom(\aexec\prjT)} \\
        {} \land \exsts{\h_{p}, \h_{q}, \kap, \kap'} 
        \kap' \leq \kap
        \land \kap \composeK \ca(\rid)\isdef
        \land ((\h_{p},\emptyset)(\h_{q},\evset)) \in \intf(\kap') \\
        {} \land \for{\addr,\val} 
        (\etR, \addr, \val) \in \evset \implies \h_{p}(\addr)  = \val \\
        \quad {} \land (\etW, \addr, \val) \in \evset \implies \h_{q}(\addr)  = \val
    \end{array}
    \end{rclarray}
\]
The \emph{rely} relation, $\RelyI \eqdef \ConsisModels \to \World \times \World$, is defined as follows:
\[
    \begin{rclarray}
         \RelyI &\eqdef & \closure{\left(\relyU\right)} \\
    \end{rclarray}
\]
%
A set of fingerprint worlds $\setworld \subseteq \World$ is \emph{stable}, written $\stable{\setworld}$, if and only if it is closed under the rely relation: 
%
\[
    \begin{rclarray}
        \stable{\setworld} & \eqdef & \for{\w_{p}, \w_{q}}  \w_{p} \in \setworld \land (\w_{p}, \w_{q}) \in \RelyI \implies \w_{q} \in \setworld
    \end{rclarray}
\]
%
The \emph{update guarantee} relation, $\guarU: \ConsisModels \to \World \times \World$, is defined as follows:
%
\[	
    \begin{rclarray}
	\guarU & \eqdef &
	\myset{
		((\ca, \ \Set{\rid \mapsto (\h, \intf)} \composeFPH  \gs_{f}), (\ca, \Set{\rid \mapsto (\h', \intf)} \composeFPH \gs_{f}))	
	}{
        \dagger
	} \\
    \dagger & \equiv & 
    \begin{array}[t]{l}
        \exsts{\aexec, \aexec',\vis, \po, \ar, \txid, \evset} 
        \aexec \in \func{h2e_{\como}}{\h} 
        \land \aexec' \in \func{h2e_{\como}}{\h'}  \\
        {} \land \aexec' = (\aexec\prjT \uplus \Set{ \txid \mapsto \evset }, \aexec\prjP \uplus \po, \aexec\prjV \uplus \vis, \aexec\prjA \uplus \ar) \\
        {} \land \vis, \po \subseteq \ar = \Setcon{(\txid', \txid)}{\txid' \in \dom(\aexec\prjT)} \\
        {} \land \exsts{\h_{p}, \h_{q}, \kap} 
        \kap \leq \ca(\rid)
        \land ((\h_{p},\emptyset)(\h_{q},\evset)) \in \intf(\kap) \\
        {} \land \for{\addr,\val} 
        (\etR, \addr, \val) \in \evset \implies \h_{p}(\addr)  = \val \\
        \quad {} \land (\etW, \addr, \val) \in \evset \implies \h_{q}(\addr)  = \val
    \end{array}
    \end{rclarray}
\]
The \emph{guarantee} relation, $\GuarI: \ConsisModels \to \World \times \World$, is defined as follows:
\[
	\GuarI \eqdef \closure{\left(\guarU\right)}
\]
\end{definition}

\subsection{Rules for Global}

The \rl{PRCommit} rule lifts the local effect of transaction \( \trans \) to global level by repartition \( \repartition{\gpre}{\gpost}{\lpre}{\lpost} \).
The repartition stripes off the fingerprints but uses the fingerprints to merge the local effect and the interference.
This is, the environment is allowed to write to locations that are different from the ones by transaction \( \trans \).
%
\[
    \infer[\rl{PRCommit}]{%
        \tripleG{\gpre}{ \ptrans{\trans} }{\gpost}
    }{%
        \tripleL{\lpre}{\trans}{\lpost} &&
        \repartition{\gpre}{\gpost}{\lpre}{\lpost} &&
        \stable{\gpre}{\intf} &&
        \stable{\gpost}{\intf} &&
    }
\]

\begin{definition}[Repartitioning]
\label{def:repartitioning}
The \emph{repartitioning} is defined as follows:
\[
    \begin{rclarray}
        \repartition{\setworld_{p}}{\setworld_{q}}{\setfph_{p}}{\setfph_{q}} & \iffdef &
        \begin{array}[t]{@{} l @{}}
            \for{ \fpw_{p}, \fph_{p}, \fph_{f} }  \\
            \quad \eraseFW{ \fpw_{p} } \in \setworld_{p} 
            \land \fpw_{p} = ( \stub, \fph_{p} \composeFPH \fph_{f} ) \land \fph_{p} \in \setfph_{p} \\
            \quad \land\ \for{\fph_{q} \in \setfph_{q}} \exsts{ \fpw_{i}} \\
            \qquad \fpw_{i} = ( \stub, \fph_{q} \composeFPH \fph_{f} ) \land (\fpw_{p}, \fpw_{i}) \in \GuarI \\
            \qquad \land\ \for{\fpw_{q} \in \mergeR{\fpw_{p}}{\fpw_{i}}{\inter}} \eraseFW{\fpw_{q}} \in \setworld_{q}
        \end{array}
    \end{rclarray}
\]
with, $\mergeName[\scalebox{.5}{\(\Rely\)}]: \FPWorlds \times \FPWorlds \times \Interference \to \powerset{\FPWorlds}$, defined as follows, for all $\fpw_{p}, \fpw_{q} \in \FPWorlds$:
\[
	\mergeR{\fpw_{p}}{\fpw_{l}}{\inter} \eqdef \bigcup\limits_{\fpw_{r} \in \RelyI(\fpw_{p})} \mergeFW{\fpw_{l}}{\fpw_{r}}
\]
\end{definition}
