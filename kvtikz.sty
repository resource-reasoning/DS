\ProvidesPackage{kvtikz}[2019/02/09 Tikz setting and macros for kv-store semantics, proofs, applications]

% global variable environment
\newcommand{\tikzkvspace}{1.5pt}
\newcommand{\tikzkeyspace}{-1.1}

\NewEnviron{centertikz}[1][\scaleboxscaling]{%
    \begin{center}%
    \scalebox{#1}{%
    \begin{tikzpicture}[font=\large]%
    \BODY%
    \end{tikzpicture}%
    }%
    \end{center}%
}


\tikzset{
    v-cell/.style={
        rectangle
        , minimum height=5mm
        , text depth=0.5ex
        , minimum width=5mm
        , text height=1.5ex
        , inner sep=0pt
        , outer sep=1pt
        %, font=\footnotesize
    },      
    nonvisible/.style={
        dotted
        , gray
    },
    pics/singleversion/.style n args = {4}{
        code = {
        \node[v-cell] (A) at (0,0) {#2};  
        \node[anchor=south west,v-cell] (B) at (A.east){#3};
        \node[anchor=north west,v-cell] (C) at (A.east){#4};
        \draw (B.north west) -- (C.south west)
              (B.south west) -- (C.north east);    
        \node[outer sep=0pt,inner sep=0pt,draw,fit=(A)(B)(C)] (#1) {}; 
        }
    },
    pics/vlist/.style n args = {2}{
        code={
        \def\vlistname{#1}
        \coordinate (VERSION-TEMP) at (0,0);
        \coordinate (\vlistname) at (0,0);
        \foreach \vi/\v/\wt/\rs in {#2}
        {
            % draw a new version
            \draw pic [\vi,anchor=east,right=0pt of VERSION-TEMP] {singleversion={VERSION-TEMP}{\v}{\wt}{\rs}};
            % add the new version into the node vlistname
            \node[inner sep=0pt, outer sep=0pt,fit=(\vlistname)(VERSION-TEMP)] (\vlistname) {};
        }
        }
    }
}
%% the following is the demo of vilist
%\node (NODE-NAME) {$KEY-NAME \mapsto$};

%\draw pic at ([xshift=\tikzkvspace]locx.east) {vlist={LEFT-MOST-COORDINATOR-NAME}{%
        %VERSION-LIST-CONTENT
        % [nonvisible]/value/writer/readers, ...
        % with maximum 10 elements
%}};
%e.g.
%\node(locx) {$\key_1 \mapsto$};

%\draw pic at ([xshift=\tikzkvspace]locx.east) {vlist={xlist}{%
        %/0/$\txid_0$/$\t$,%
        %nonvisible/1/$\txid_1$/$\t'$,%
        %/2/$\txid_2$/$\Set{\txid_3}$%
%}};
\tikzset{
    transaction-node/.style={
        rectangle
        , draw=black
        , rounded corners=1.2mm
        , inner ysep=3pt
        , inner xsep=6pt
    },
    background/.style={
        transaction-node
    },
    pics/transaction/.style n args = {2}{
        code={
        \def\transactionnode{#1}
        \def\nodexspace{10pt}
        \def\nodeyspace{5pt}
        \coordinate (TRANSACTION-TEMP) at (0,0);
        \coordinate (ROW-BEGIN) at (0,0);
        \coordinate (\transactionnode) at (0,0);
        \edef\i{1}
        \edef\firstrow{0}
        \foreach \tg/\k/\v in {#2}
        {
            % draw a new version
            \ifnum\i=1
                \ifnum\firstrow=0
                    \node[inner sep=0pt,outer sep=0pt,anchor=north,below=0pt of ROW-BEGIN.south] (TRANSACTION-TEMP) {\(\left(\text{\tg},\text{\k},\text{\v}\right)\)};
                    \xdef\firstrow{\the\numexpr(\firstrow)+1}
                \else
                \node[inner sep=0pt,outer sep=0pt,anchor=north,below=\nodeyspace of ROW-BEGIN.south] (TRANSACTION-TEMP) {\(\left(\text{\tg},\text{\k},\text{\v}\right)\)};
                \fi
                \node[fit=(TRANSACTION-TEMP)] (ROW-BEGIN) {};
            \else
                \node[inner sep=0pt,outer sep=0pt,anchor=east,right=\nodexspace of TRANSACTION-TEMP] (TRANSACTION-TEMP) {\(\left(\text{\tg},\text{\k},\text{\v}\right)\)};
            \fi
            \xdef\i{\the\numexpr(\i)+1}
            \ifnum\i=4
                \xdef\i{1}
            \fi
            % add the new version into the node vlistname
            \node[inner sep=0pt, outer sep=0pt,fit=(\transactionnode)(TRANSACTION-TEMP)] (\transactionnode) {};
        }
        \node[transaction-node, fit=(\transactionnode)] (\transactionnode) {};
        }
    }
}
%% the following is the demo of transaction
%\draw pic at ($(t0) + (2,1)$) {transaction={t1}{%
        %$\otR$/$\key_2$/$\val'_0$%
        %, $\otW$/$\key_1$/$\val_1$%
        %, $\otR$/$\key_2$/$\val_1$%
        %, $\otR$/$\key_5$/$\val_3$%
%}};
%\path(t1.north) node[anchor=south] (t1lbl) {$\txid_1$};
