\section{Program Analysis}
\label{app:robustness}
%
%Contents: \\
%transactional implementation of a counter. \\
%Counter is not robust when a 
%weak consistency model (i.e. causal consistency, in practice anything that does not 
%guarantee both write-conflict detection and monotonic reads) is assumed. \\
%A single counter is robust as long as the consistency model used by the database 
%guarantees both write-conflict detection and monotonic reads.\\
%Multiple counters are not robust even when monotonic reads and write-conflict 
%detection are guaranteed by the database. In particular, multiple counters are 
%not robust when PSI is guaranteed by the database.\\
%Multiple counters are robust if a stronger consistency models, such as SI, is employed 
%by the database.
We give two applications of our theory aimed at showing the 
robustness of a transactional library against a given consistency 
model. The first application considers a single counter library, 
and proves that it is robust against Parallel Snapshot Isolation. 
The second application aims at proving the robustness of two 
counters against Snapshot Isolation. 

\mypar{Code for Counter Objects} 
We start by reviewing the transactional code for the 
increment and read operations provided by a counter 
object over a key $\key$, denoted as  $\ctrinc(\key)$ and 
$\ctrread(\key)$, respectively.

\[
\begin{array}{lrlr}
\ctrinc(\key) = &
\begin{session}
\begin{transaction}
\plookup{\pv{a}}{\key};\\
\pmutate{\key}{\pv{a}+1};
\end{transaction}
\end{session}
&
\hspace{10pt}\ctrread(\key) = &
\begin{session}
\begin{transaction}
\plookup{\pv{a}}{\key};\\
\end{transaction}
\end{session}
\end{array}
\]
%For the moment, we assume that the key-value store contains a single object $\key$. 
Clients can interact with the key-value store only by invoking the $\ctrinc(\key)$ and 
$\ctrread(\key)$ operations. A transactional library is a set of transactional operations. 
For a single counter over key $\key$, we define the transactional library $\Counter(\key) = \{ \ctrinc(\key), \ctrread(\key)\}$, 
while for multiple counters over a set of keys $\mathsf{K} = \{\key_i\}_{i \in I}$, respectively, we define $\Counter(\mathsf{K}) = 
\bigcup_{i \in I} \Counter(\key_i)$.

\mypar{KV-store semantics of a transactional library}
Given the transactional code 
$\ptrans{\trans}$, we define $\fp(\mkvs, \vi, \ptrans{\trans})$ 
to be the fingerprint that would be produced by a client that has view $\vi$ 
over the kv-store $\mkvs$, upon executing $\ptrans{\trans}$.
For the $\ctrinc(\key)$ and $\ctrread(\key)$ operations discussed above, 
we have that 
%$\fp(\mkvs, \vi, \mathsf{inc}(\key))$ is the fingerprint generated 
%by a client $\cl$ with view $\vi$ after executing the operation $\mathsf{inc}(\key)$. 
%Specifically, 
$\fp(\mkvs, \vi, \ctrinc(\key)) = \{(\otR, \key, n), (\otW, \key, n+1) \mid 
n = \snapshot[\mkvs, \vi]\}$, and $\fp(\mkvs, \vi ,\mathsf{read}(\key)) = 
\{(otR, \key, n) \mid n = \snapshot[\mkvs, \vi]\}$.
%A transactional module is a set of transaction codes $\{\ptrans{\trans_i}_{i \in I}\}$.
Given an execution test $\ET$, and a transactional library $L = \{\ptrans{\trans_i}\}_{i \in I}$, 
we define the set of valid $\ET$-traces for t$L$ as the set 
$\mathsf{Traces}(\ET, \{\ptrans{\trans_i}\}_{i \in I})$ 
of $\ET$-traces in which only $\ET$-reductions of the form 
\[
(\mkvs_{0}, \vienv_{0}) \toET{(\cl_0, \lambda_0)} (\mkvs_{1}, \vienv_{1}) \toET{(\cl_1, \lambda_1)} \cdots 
\toET{(\cl_{n-1}, \lambda_{n-1})} (\mkvs_{n}, \vienv_{n}),
\]
where for any $j=0,\cdots,n-1$, either $\lambda_{j} = \varepsilon$ or $\lambda_{j} = \fp(\mkvs_{j}, \vienv_{j}(\cl_{j}), \ptrans{\trans_{i}})$ 
for some $i \in I$. Henceforth we commit an abuse of notation and write $(\mkvs, \vienv) \toET{(\cl, \ptrans{\trans})} (\mkvs', \vienv')$ 
in lieu of $(\mkvs, \vienv) \toET{(\cl, \fp(\mkvs,\vienv(\cl), \ptrans{\trans})} (\mkvs', \vienv')$.
We also let $\mathsf{KVStores}(\ET, \{\ptrans{\trans_i}\}_{i \in I})$ be the set of kv-stores 
that can be obtained when clients can only perform operations from $\{\ptrans{\trans_i}\}_{i \in I}$ 
under the execution test $\ET$. Specifically, 
\[
\mathsf{KVStores}(\ET, \{\ptrans{\trans_i}\}_{i \in I}) = \{ \mkvs \mid \left( (\mkvs_0, \vienv_{0}) \toET{\cdot} \cdots 
\toET{\cdot} (\mkvs, \_)\right) \in \mathsf{Traces}(\ET, \{\ptrans{\trans_{i}}\}_{i \in I}) \}.
\]

\mypar{Anomaly of a single counter under Causal Consistency}
It is well known that the transactional library consisting of a single counter over a single 
key, $\Counter(\key)$, implemented on top of a kv-store guaranteeing Causal Consistency, 
leads to executions over the kv-store that cannot be simulated by the same transactional 
library implemented on top of a serialisable kv-store. 
For simplicity, let us assume that $\Keys = \{ke\}$.
Let $\mkvs_{0} = [\key \mapsto (0, \txid_{0}, \emptyset)]$,  
$\mkvs_1 = [\key \mapsto (0, \txid_{0}, \{\txid_{\cl_1}^{1}\} \lcat (0, \txid_{\cl_1}^{1}, \emptyset)$, 
$\mkvs_2 = [\key \mapsto (0, \txid_{0}, \{\txid_{\cl_1}^{1}, \txid_{\cl_2}^{1}\}) \lcat (0, \txid_{\cl_1}^{1}, \emptyset) 
\lcat (0, \txid_{\cl_2}^{1}, \emptyset)$. Let also
$\vi_{0} = [\key \mapsto {0}]$. Then we have that 
\[
    (\mkvs_{0}, [\cl_1 \mapsto \vi_0, \cl_2 \mapsto \vi_0]) \toET{(\cl_1, \mathsf{inc(\key)})}[\ET_{\CC}]
    (\mkvs_1, [\cl_1 \mapsto \_, \cl_2 \mapsto \vi_0]) \toET{(\cl_1, \mathsf{inc(\key)})}[\ET_{\CC}]
(\mkvs_2, \_).
\]
By looking at the kv-store $\mkvs_{2}$, we immediately find a cycle in the graph induced by 
the relations $\SO_{\mkvs_{2}}, \WR_{\mkvs_{2}}, \WW_{\mkvs_{2}}, \RW_{\mkvs_{2}}$: 
$\txid_{\cl_1}^{1} \toEDGE{\RW} \txid_{\cl_2}^{1} \toEDGE{\RW} \txid_{\cl_1}^{1}$. 
Following from \cref{thm:serialisable_nocycle}, then 
which proves that $\mkvs_2$ is not included in $\CMs(\ET_{\SER})$, i.e. it is 
not serialisable.

\mypar{Robustness of a Single counter under Parallel Snapshot Isolation}
Here we show that the  single counter library $\Counter(\key)$ is robust under any consistency model 
that guarantees both write conflict detection (formalised by the execution test 
$\ET_{\UA}$), monotonic reads (formalised by the execution test $\ET_{\MR}$) 
and read your writes (formalised by the execution test $\ET_{\RYW}$). 
Because $\ET_{\PSI}$ guarantees all such consistency guarantees, i.e. 
$\CMs(\ET_{\PSI}) \subseteq \CMs(\ET_{\MR} \cap \ET_{\RYW} \cap \ET_{\UA})$, 
then it also follows that a single counter is robust under Parallel Snapshot Isolation.
\begin{proposition}
\label{prop:counter_hhshape}
%Let $\mathsf{Counter}(\key) = \{\mathsf{inc}(\key), \mathsf{read}(\key)\}$.
Let $\mkvs \in \mathsf{KVStores}(\ET_{\UA} \cap \ET_{\MR} \cap \ET_{\RYW}, \Counter(\key))$. 
Then there exist $\{\txid_i\}_{i = 1}^{n}$ and $\{\txidset_{i}\}_{i = 0}^{n}$ such that 
\begin{align}
\mkvs(\key) = \left( (0, \txid_{0}, \txidset_{0} \uplus \{\txid_1\}) \lcat \cdots \lcat (n-1, \txid_{n-1}, \txidset_{n-1} \uplus \{\txid_{n}\}) \right) 
\lcat (n, \txid_{n}, \txidset_{n}) \label{eq:psi_counter_shape}\\
\forall i=0,\cdots,n.\txidset_{i} \cap \{\txid_{i}\}_{i=0}^{n} = \emptyset \label{eq:psi_counter_rwtxs}\\
\forall \txid, \txid'.\;\forall i,j=0,\cdots, n.\; \txid \toEDGE{\SO} \txid' 
\land \txid \in \{\txid_{i}\} \cup \txidset_{i} \implies 
\left(\begin{array}{l}
(\txid' = \txid_{j} \implies i < j) \land {} \\
(\txid' \in \txidset_{j} \implies i \leq j) \\
%(\txid \in \txidset_{i} \land \txid' = \txid_{j} \implies i < j) \land {} \\
%(\txid \in \txidset_{i} \land \txid' \in \txidset_{j} \implies i \leq j)
\end{array}\right) \label{eq:psi_counter_so}
\end{align}
%
%
%
%for any $i = 1,\cdots, n$, $\txidset_{i} \cap \{\txid_i\}_{i=0}^{n} = \emptyset$, and 
%$\mkvs(\key) = \left(\prod_{i=0}^{n-1} (i, \txid_{i}, \txidset_{i} \uplus \{\txid_{i+1}\}) \right) \lcat 
%(n, \txid_{n}, \txidset_{n})$. Furthermore, if there exist four indexes $i,j, p, q$ such that 
%$\txid_{\cl}^{p} \in \wtOf(\mkvs(\key, i) \cup \rsOf(\mkvs(\key, i))$ and 
%$\txid_{\cl}^{q} \in \wtOf(\mkvs(\key, j) \cup \rsOf(\mkvs(\key, j))$, then 
%$i < j \implies p < q$.
\end{proposition}

\begin{proof}
It suffices to prove that the properties \eqref{eq:psi_counter_shape},\eqref{eq:psi_counter_rwtxs}, 
\eqref{eq:psi_counter_so} given in \cref{prop:counter_hhshape}, are invariant under 
$(\ET_{\MR} \cap \ET_{\RYW} \cap \ET_{\UA})$-reductions of the form 
\begin{align}
(\mkvs, \vienv) \toET{(\cl, \func{inc}[\key])}[\ET_{\UA} \cap \ET_{\MR} \cap \ET_{\RYW}] (\mkvs', \vienv') \label{eq:psi_counter_inc}\\
(\mkvs, \vienv) \toET{(\cl, \func{read}[\key])}[\ET_{\UA} \cap \ET_{\MR} \cap \ET_{\RYW}] (\mkvs', \vienv). \label{eq:psi_counter_read}
\end{align}
To this end, we will need the following auxiliary result which holds for any configuration $(\mkvs, \vienv)$ 
that can be obtained under the execution test $\ET_{\RYW} \cap \ET_{\MR}$:
%\begin{equation}
%\forall i, n.\; \forall \cl.\; \txid_{\cl}^{n} \in \{\wtOf(\mkvs(\key, i))\} \cup \rsOf(\mkvs(\key, i)) \implies 
%\exists j \geq i.\;\vienv(\cl) = [\key \mapsto \{0, \cdots, j\}] \label{eq:psi_counter_view}
%\end{equation} 

%\begin{equation}
%\forall i, n.\; \forall \cl.\; \txid_{\cl}^{n} \in \{\wtOf(\mkvs(\key, i))\} \cup \rsOf(\mkvs(\key, i)) \implies 
%i \in \vienv(\cl). \label{eq:psi_counter_view}
%\end{equation} 

\begin{equation}
\forall i, j, n,m, \cl, \key. \; \txid_{\cl}^{n} \in \{\wtOf(\mkvs(\key, i))\} \cup \rsOf(\mkvs(\key, i)) 
\land \txid_{\cl}^{m} \in \{\wtOf(\mkvs(\key, j))\} \cup \rsOf(\mkvs(\key, j)) \land m < n 
\land i \in \vienv(\cl)(\key) \implies 
j \in \vienv(\cl)(\key). \label{eq:psi_counter_view}
\end{equation} 

Suppose that there exist two sets $\{\txid_{i}\}_{i=1}^{n}$ and 
$\{\txidset_{i}\}_{i=0}^{n}$ such that $(\mkvs, \{\txid_{i}\}_{i=1}^{n}, \{\txidset_{i}\}_{i=0}^{n})$ 
satisfies the properties \eqref{eq:psi_counter_shape}-\eqref{eq:psi_counter_so}. 
We prove that, for transitions of the form \eqref{eq:psi_counter_inc}-\eqref{eq:psi_counter_read}, 
there exist an index $m$ and two collections $\{\txid_{i}\}_{i=1}^{m}$, $\{\txidset'_{i}\}_{i=0}^{m}$ 
such that $(\mkvs', \{\txid_{i}\}_{i=1}^{m}, \{\txidset'_{i}\}_{i=0}^{m})$ satisfies the properties 
\eqref{eq:psi_counter_shape}-\eqref{eq:psi_counter_so}. We consider the two transitions separately.

\begin{itemize}
\item 
Assume that
\[
(\mkvs, \vienv) \toET{(\cl, \func{inc}[\key])}[\ET_{\UA} \cap \ET_{\MR} \cap  \ET_{\RYW}] (\mkvs', \vienv')
\]
for some $\cl, \mkvs', \vienv'$. Let $n+1 = \lvert \mkvs(\key) \rvert$. Because of the definition of 
$\ET_{\UA}$, we must have that $\vienv(\cl) = [\key \mapsto \{0, \cdots, n\}]$. Also, 
because $\mkvs$ satisfies \eqref{eq:psi_counter_shape}, we have that $\snapshot[\mkvs, \vienv(\cl)](\key) = n$. 
In particular, $\fp(\key, \vienv(\cl), \func{inc}[\key]) = \{(\otR, \key, n), (\otW, \key, n+1)\}$. 
Thus we have that $\mkvs' \in \updateKV[\mkvs, \vienv(\cl), \cl, \Set{(\otR, \key, n), (\otW, \key, n+1)}]$. 
Let $\txid_{n+1}$ be the transaction identifier 
chosen to update $\mkvs$, i.e. $\mkvs' = \updateKV[\mkvs, \vienv(\cl), \txid_{n+1}, \Set{(\otR, \key, n), (\otW, \key, n+1)}]$, 
where $\txid_{n+1} \in \nextTxid(\mkvs, \cl)$; 
let also $\txidset_{n+1} = \emptyset$. Then we have the following: 
\begin{itemize}
\item  $(\mkvs', \{\txid_{i}\}_{i=1}^{n+1}, \{\txidset_{i}\}_{i=0}^{n+1})$ satisfies Property \eqref{eq:psi_counter_shape}. 
    %Recall that $\mkvs' \in \updateKV[\mkvs, \vienv(\cl), \cl, \Set{(\otR, \key, n), (\otW, \key, n+1)}]$. 
Recall that $(\mkvs, \{\txid_{i}\}_{i=1}^{n}, \{\txidset_{i}\}_{i=0}^{n})$ satisfies \eqref{eq:psi_counter_shape}, 
i.e.
\[\mkvs(\key) = \left( (0, \txid_{0}, \txidset_{0} \uplus \{\txid_1\}) \lcat \cdots \lcat (n-1, \txid_{n-1}, \txidset_{n-1} \uplus \{\txid_{n}\}) \right) 
\lcat (n, \txid_{n}, \txidset_{n}).
\]
%for some $\{\txid_{i}\}_{i=1}^{n}$ and $\{\txidset_{i}\}_{i=0}^{n}$. 
%Let $\txid_{n+1}$ be the transaction identifier 
%chosen to update $\mkvs$, i.e. $\mkvs' = \updateKV[\mkvs, \vienv(\cl), \txid_{n+1}, \Set{(\otR, \key, n), (\otW, \key, n+1)}]$, 
%where $\txid_{n+1} \in \nextTxid(\mkvs, \cl)$. 
It follows that $\mkvs'(\key) = \left( (0, \txid_{0}, \txidset_{0} \uplus \{\txid_1\}) \lcat \cdots \lcat (n-1, \txid_{n-1}, \txidset_{n} \uplus \{\txid_{n+1}\}) \right) 
\lcat (n+1, \txid_{n+1}, \txidset_{n+1})$, 
where we recall that $\txidset_{n+1} = \emptyset$.

\item $(\mkvs', \{\txid_{i}\}_{i=1}^{n+1}, \{\txidset_{i}\}_{i=0}^{n+1})$ 
satisfies Property \eqref{eq:psi_counter_rwtxs}. Let $i =0, \cdots, n+1$. If $i = n+1$, then 
$\txidset_{i} = \emptyset$, from which $\txidset_{i} \cap \{\txid_{j}\}_{j=0}^{n+1} = \emptyset$ follows. If $i < n+1$, then 
because $(\mkvs, \{\txid_{i}\}_{i=1}^{n}, \{\txidset_{i}\}_{i=0}^{n})$ 
satisfies Property \eqref{eq:psi_counter_rwtxs}, then $\txidset_{i} \cap \{\txid_{j}\}_{j=0}^{n} = \emptyset$. 
Finally, because $\txid_{n+1}$ was chosen to be fresh with respect to the transaction identifiers appearing in 
$\mkvs$, and $\txidset_{i} \subseteq \rsOf(\mkvs(\key, i))$, then  we also have that $\txidset_{i} \cap \{\txid_{n+1}\} = \emptyset$. 
%By combining all these facts, we obtain that $\mkvs'$ satisfies Property \eqref{eq:psi_counter_rwtxs}.
\item $(\mkvs', \{\txid_{i}\}_{i=1}^{n+1}, \{\txidset_{i}\}_{i=0}^{n+1})$ satisfies Property \eqref{eq:psi_counter_so}. Let 
$\txid, \txid'$ be such that $\txid \toEDGE{\SO} \txid'$. Choose two arbitrary indexes $i,j=0,\cdots, n+1$, 
and assume that $\txid \in \{\txid_{i}\} \cup \txidset_{i}$. Note that if $i \leq n$, $j \leq n$, then 
because $(\mkvs, \{\txid_{i}\}_{i=1}^{n}, \{\txidset_{i}\}_{i=0}^{n})$ satisfies Property $\eqref{eq:psi_counter_so}$, then 
if $\txid' = \txid_{j}$ it follows that $i < j$, and if $\txid' \in \txidset_{j}$ it follows that $i \leq j$, as 
we wanted to prove. 
If $\txid \in \{\txid_{n+1}\} \cup \txidset_{n+1}$, then it must be $\txid = \txid_{n+1}$ because 
$\txidset_{n+1} = \emptyset$. Recall that $\txid_{n+1}$ is the transaction identifier that was used 
to update $\mkvs$ to $\mkvs'$, i.e. $\mkvs' = \updateKV[\mkvs, \vienv(\cl), \txid_{n+1}, \stub]$. By 
definition of $\updateKV$, it follows that $\txid_{n+1} \in \nextTxid(\mkvs, \cl)$, 
and because $\txid_{n+1} \toEDGE{\SO} \txid'$, then $\txid'$ cannot appear in $\mkvs'$. 
In particular, 
$\txid' \notin \{\txid_{j}\}_{j=0}^{n+1} \cup \bigcup \{\txidset_{j}\}_{j=0}^{n+1}$, hence in this case there is nothing to prove. 
Finally, if $\txid' \in \{\txid_{n+1}\} \cup \txidset_{n+1}$, then 
it must be the case that $\txid' = \txid_{n+1}$. If $\txid = \txid_{j}$, because 
$\txid \toEDGE{\SO} \txid'$ and $\txid' = \txid_{n+1}$, it cannot be $\txid = \txid_{n+1}$, 
hence it must be $i \leq n < n+1$. 
%If $\txid \in \txidset_{i}$, because $\txidset_{n+1} = \emptyset$ it 
%follows that $j < i$. 
%\item $(\mkvs', \vienv')$ satisfies Property \eqref{eq:psi_counter_view}.  
%Consider an arbitrary client $\cl'$. If $\cl' \neq \cl$, $\vienv'(\cl') = \vienv(\cl')$: if $\txid_{\cl'}^{m} \in \{\wtOf(\mkvs'(\key, i))\} 
%\cup \rsOf(\mkvs'(\key, i))$ for some $i = 0,\cdots, n+1$, then because $\rsOf(\mkvs'(\key, n+1)) = \emptyset$, $\cl' \neq \cl$ and $\txid_{n+1} = \txid_{\cl}^{\cdot}$, 
%then it must be the case that $i \leq n$. Because $(\mkvs, \vienv)$ satisfies Property \eqref{eq:psi_counter_view}, 
%then there exists an index $j \geq i$ such that $\vienv'(\cl') = \vienv(\cl') = [\key \mapsto \{0,\cdots, j\}]$. 
%Finally, suppose that $\cl' = \cl$. 
%By definition of $\ET_{\UA}$, $\vienv(\cl) = [\key \mapsto \{0,\cdots, n\}]$, and the definition 
%of $\ET_{\MR}$ and $\ET_{\RYW}$ imply that $\vienv'(\cl) = [\key \mapsto \{0,\cdots, n+1\}]$. 
%Clearly, whenever $\txid_{\cl}^{\cdot} \in  \{\wtOf(\mkvs'(\key, i))\} 
%\cup \rsOf(\mkvs'(\key, i))$ for some $i$, then it must be the case that $i \leq n$.
\end{itemize}

\item Suppose that 
%$(\mkvs, \vienv)$ satisfies the properties \eqref{eq:psi_counter_rwtxs}-\eqref{eq:psi_counter_view}; 
%assume also that 
\[
(\mkvs, \vienv) \toET{(\cl, \func{read}[\key])}[\ET_{\UA} \cap \ET_{\MR} \cap \ET_{\RYW}] (\mkvs', \vienv').
\]
As in the previous case, we have that $\mkvs' = \updateKV[\mkvs, \vienv(\cl), \txid, \Set{(\otR, \key, i)}]$, where 
$m = \snapshot[\mkvs, \vienv(\cl)](\key)$  - 
in particular, because $(\mkvs, \{\txid_{i}\}_{i=1}^{n}, \{\txidset_{i}\}_{i=0}^{n}$ satisfies 
Property \eqref{eq:psi_counter_shape}, then it must be the case that $m = \max_{<}(\vienv(\cl)(\key))$ - 
and $\txid \in \nextTxid(\mkvs, \cl)$. 
For $i=0,\cdots, n$, let $\txidset'_{i} := \txidset_{i}$ if $i \neq m$, $\txidset'_{i} = \txidset_{i} \cup \{\txid\}$ if 
$i = m$. Then we have that $(\mkvs', \{\txid_{i}\}_{i=0}^{n}, \{\txidset'_{i}\}_{i=0}^{n})$ satisfies 
properties \eqref{eq:psi_counter_shape}-\eqref{eq:psi_counter_so}.
%We also have that $\vienv'(\cl') = \vienv(\cl')$ for any $\cl' \neq \cl$, and 
%from the definition of $\ET_{\MR}$ we also have that $\vienv(\cl) \viewleq \vienv'(\cl)$. 
%Henceforth, we let $i = \max_{<}\vienv(\cl)(\key)$.
Putting all these facts together, we obtain the following: 
\begin{itemize}
\item $(\mkvs', \{\txid_{i}\}_{i=0}^{n}, \{\txidset'_{i}\}_{i=0}^{n})$ satisfies Property \eqref{eq:psi_counter_shape}. 
WIthout loss of generality, suppose that $m < n$. 
Because $(\mkvs,  \{\txid_{i}\}_{i=0}^{n}, \{\txidset_{i}\}_{i=0}^{n})$ satisfies Property \eqref{eq:psi_counter_shape}, 
we have that 
\[
\mkvs(\key) = \left( (0, \txid_{0}, \txidset_{0} \uplus \{\txid_1\}) \lcat \cdots \lcat (m, \txid_{m}, \txidset_{m} \uplus \{\txid_{m+1}\}) 
\lcat \cdots \lcat (n-1, \txid_{n-1}, \txidset_{n-1} \uplus \{\txid_{n}\}) \right) \lcat (n, \txid_{n}, \txidset_{n}),
\] 
and from the definition of $\updateKV$ it follows that 
\[
\begin{array}{ll}
\mkvs(\key) &= \left( (0, \txid_{0}, \txidset_{0} \uplus \{\txid_1\}) \lcat \cdots \lcat (m, \txid_{m}, \txidset_{m} \cup \{\txid\} \uplus \{\txid_{m+1}\}) 
\lcat \cdots \lcat (n-1, \txid_{n-1}, \txidset_{n-1} \uplus \{\txid_{n}\}) \right) \lcat (n, \txid_{n}, \txidset_{n}) \\
& = \left( (0, \txid_{0}, \txidset'_{0} \uplus \{\txid_1\}) \lcat \cdots \lcat (m, \txid_{m}, \txidset'_{m} \uplus \{\txid_{m+1}\}) 
\lcat \cdots \lcat (n-1, \txid_{n-1}, \txidset_{n-1} \uplus \{\txid_{n}\}) \right) \lcat (n, \txid_{n}, \txidset_{n})
\end{array}
\]
%satisfies $\eqref{eq:psi_counter_shape}$, then if $i < n$, then $\mkvs(\key, i) = 
%(i, \txid_{i}, \txidset_{i} \cup \{\txid_{i+1}\})$;  
%otherwise $i = n$ and $\mkvs(\key, i) = \mkvs(\key, n) = (n, \txid_{n}, \txidset_{n})$. 
%In both cases we have that 
%hence $m = \snapshot[\mkvs(\key), \vienv(\cl)] = \valueOf(i, \_, \_) = i$.
%
%Because $\mkvs' = \updateKV[\mkvs, \vienv(\cl), \txid, \Set{(\otR, \key, n)}]$, 
%then $\lvert \mkvs'(\key) \rvert = \lvert \mkvs(\key) \rvert = n+1$. 
%By definition of $\updateKV$, we have that for any $j=0,\cdots, n$, 
%$j \neq i$, then $\mkvs(\key, j) = \mkvs'(\key, j)$; without loss of generality, 
%let us assume that $i \neq n$: we also have that 
%\[
%\begin{array}{l}
%\mkvs'(\key, i) = \text{let } (v, \txid', \txidset) = \mkvs(\key, i) \text{ in } (v, \txid', \txidset \cup \{\txid\}) = \\
%\text{let } (v, \txid', \txidset) = (i, \txid_{i}, \txidset_{i} \cup \{\txid_{i+1}\}) \text{ in } 
%(v, \txid', \txidset \cup \{\txid\}) = (n ,\txid', \txidset_{i} \cup \{\txid \} \cup \{\txid_{i+1}\}.
%\end{array}
%\]
%Similarly, in the case that $i = n$, we have that $\mkvs'(\key, i) =(i, \txid_{i}, \txidset_{i} \cup \{\txid\})$.
%If we let $\txidset'_{j} := \txidset_{j}$ for any $j \neq i$, and $\txidset'_{i} := \txidset_{i} \cup \{ \txid \}$, then 
%we have that $\mkvs'$ satisfies Property \ref{eq:psi_counter_shape}, relatively to the sets 
%$\{\txid_{i}\}_{i=1}^{n}$ and $\{\txidset'_{j}\}_{j = 0}^{n}$.

\item $(\mkvs',  \{\txid_{i}\}_{i=0}^{n}, \{\txidset'_{i}\}_{i=0}^{n})$ satisfies Property \eqref{eq:psi_counter_rwtxs}. 
%To this end, let $i =0,\cdots, n$, 
%and consider the set of transactions $\{\txidset'_{i}\}_{i=0}^{n}$. 
Recall that $m = \max_{<}(\vienv(\cl)(\key))$; let $i=0,\cdots,n$.

Let again $i = \max_{<}\vienv(\cl)(\key)$ . 
If $i \neq m$, then $\txidset'_{i} = \txidset_{i}$, and because $(\mkvs,  \{\txid_{i}\}_{i=0}^{n}, \{\txidset_{i}\}_{i=0}^{n})$ 
satisfies Property \eqref{eq:psi_counter_rwtxs} 
we have that $\txidset'_{i} \cap \{\txid_{i}\}_{i=0}^{n} = \emptyset$. If $i = m$, then 
we have that $\txidset'_{i} = \txidset'_{m} = \txidset_{m} \cup \{\txid\}$, where we recall that $\txid \in \nextTxid(\mkvs, \cl)$. 
Because $(\mkvs,  \{\txid_{i}\}_{i=0}^{n}, \{\txidset_{i}\}_{i=0}^{n})$ 
satisfies Property \eqref{eq:psi_counter_rwtxs}, we have that $\txidset_{m} \cap \{\txid_{i}\}_{i=0}^{n} 
= \emptyset$. Finally, because $\txid \in \nextTxid(\mkvs,\cl)$, then it must be the case that 
for any $i = 0,\cdots, n$, $\txid \notin \{\wtOf(\mkvs'(\key,i))\}_{i=0}^{m} = \{\txid_{i}\}_{i=0}^{m}$,  
where the last equality follows because we have already proved that $(\mkvs',  \{\txid_{i}\}_{i=0}^{n}, \{\txidset'_{i}\}_{i=0}^{n})$ 
satisfies Property \eqref{eq:psi_counter_shape}.
%from which it follows that $\{\txid\} 
%\cap \{\txid_{i}\}_{i=0}^{n} = \emptyset$. By putting these two facts together, we obtain that 
%$\txidset'_{i} \cap \{\txid_{i}\}_{i=0}^{n} = (\txidset_{i} \cup \{\txid\}) \cap \{\txid_{i}\}_{i=0}^{n} = 
%emptyset$. 

\item $(\mkvs',  \{\txid_{i}\}_{i=0}^{n}, \{\txidset'_{i}\}_{i=0}^{n})$ satisfies Property \eqref{eq:psi_counter_so}. 
%By assumption, we know 
%that $(\mkvs, \vienv)$ satisfies properties \eqref{eq:psi_counter_so} and \eqref{eq:psi_counter_view}. 
Let $\txid', \txid''$ be such that $\txid' \toEDGE{\SO} \txid''$. 
Suppose also that $\txid' \in \{\txid_{i}\} \cup \txidset'_{i}$ for some $i = 0,\cdots, n$. We consider two different cases:
\begin{itemize}
\item $\txid' = \txid_{i}$. Suppose then that $\txid'' = \txid_{j}$ for some $j = 0, \cdots, n$. Because 
$(\mkvs,  \{\txid_{i}\}_{i=0}^{n}, \{\txidset_{i}\}_{i=0}^{n})$ satisfies Property 
\eqref{eq:psi_counter_so}, then it must be the case that $i < j$. Otherwise, 
suppose that $\txid'' \in \txidset'_{j}$ for some $j=0,\cdots,n$. If $j \neq m$, then $\txidset'_{j} = \txidset_{j}$, 
and because $(\mkvs,  \{\txid_{i}\}_{i=0}^{n}, \{\txidset_{i}\}_{i=0}^{n})$ satisfies Property \eqref{eq:psi_counter_so}, we have that $i \leq j$. 
Otherwise, $\txidset'_{j} = \txidset'_{m} =  \txidset_{m} \cup \{\txid\}$. Without loss of generality, in this case 
we can assume that $\txid'' = \txid$ (we have already shown that if $\txid'' \in \txidset_{j}$, then 
it must be $i \leq j$. Recall that $j = m = \max(\vienv(\cl)(\key))$, by the Definition of 
$\ET_{\UA}$ it must be the case that $\vienv(\cl) = [\key \mapsto \{0,\cdots, j\}]$. 
It also follows that $\txid = \txid_{\cl}^{p}$ for some $p \geq 0$, and because $\txid' \toEDGE{\SO} \txid'' = \txid$, 
then $\txid' = \txid_{\cl}^{q}$ for some $q < p$. Because of Property 
\eqref{eq:psi_counter_view}, and because $\txid' = \txid_{i} = \wtOf(\mkvs(\key, i))$, then it must be the case the 
case that $i \in \vienv(\cl)(\key)$, hence  $i \leq m = j$.

\item $\txid' \in \txidset'_{i}$. We need to distinguish the cases $i \neq m$, leading to $\txidset'_{i} = \txidset_{i}$, 
or $i = m$, in which case $\txidset'_{i} = \txidset'_{m} = \txidset_{m} \cup \{\txid\}$. If either $i \neq m$, or $i = m$ and $\txid \in 
\txidset_{m}$, then we can proceed as in the case $\txid' = \txid_{i}$. Otherwise, suppose that $i = m$ and 
$\txid' = \txid$. Then, because $\txid' \toEDGE{\SO} \txid''$, and $\txid \in \nextTxid(\mkvs,\cl)$, 
it must be the case that $\txid = \txid_{\cl}^{p}$ for some $p \geq 0$, and whenever 
$\txid_{\cl}^{\cdot} \in \key$, then $\txid_{\cl}^{\cdot} \toEDGE{\SO} \txid$. In particular 
we cannot have that $\txid'' \in \key$, because $\txid \toEDGE{\SO} \txid''$, which 
concludes the proof.
\end{itemize}

\item $(\mkvs', \vienv')$ satisfies Property \eqref{eq:psi_counter_view}.

\end{itemize}

\end{itemize}

\end{proof}

\begin{corollary}
\label{cor:psi_counter_acyclic}
Given $\mkvs \in \mathsf{KVStores}(\ET_{\UA} \cap \ET_{\MR} \cap \ET_{\RYW}, \mathsf{Counter})$, 
then $\graphOf(\mkvs)$ is acyclic.
\end{corollary}

\begin{proof}
Let $\{\txid_{i}\}_{i=1}^{n}$, $\{\txidset_{i}\}_{i=0}^{n}$ 
be such that $(\{\txid_{i}\}_{i=1}^{n}, \{\txidset_{i}\}_{i=0}^{n})$ 
satisfies properties \eqref{eq:psi_counter_shape}-\eqref{eq:psi_counter_so}. 
First, we define a partial order between transactions appearing in $\mkvs$ 
as the smallest relation $\dashrightarrow$ such that for any $\txid, \txid', \txid''$ and 
$i,j = 0,\cdots, n$
\[
\begin{array}{ll}
\txid \in \txidset_{i} &\implies \txid_{i} \dashrightarrow \txid,\\
i < j &\implies \txid_{i} \dashrightarrow \txid_{j},\\
\txid \in \txidset_{i} \land i < j & \implies \txid \dashrightarrow \txid_{j}\\
\txid, \txid' \in \txidset_{i} \land \txid \toEDGE{\SO} \txid' &\implies \txid \dashrightarrow \txid'\\
\txid \dashrightarrow \txid' \rightarrow \txid'' &\implies \txid \dashrightarrow \txid''
\end{array}
\]
It is immediate that if $\txid \dashrightarrow \txid'$ then either $\txid \in \{\txid_{i}\} \cup \txidset_i$, 
$\txid' = \{\txid_{j}\} \cup \txidset_{j}$ for some $i,j$ such that $i < j$, or $\txid = \txid_{i}$, $\txid' \in \txidset_i$, 
or $\txid, \txid' \in \txidset_{i}$ and $\txid \toEDGE{\SO_{\mkvs}} \txid'$. A consequence of this fact, 
is that $\dashrightarrow$ is irreflexive.

Next, observe that we have the following: 
\begin{itemize}
\item whenever $\txid \toEDGE{\WR_{\mkvs}} \txid'$, then 
there exists an index $i = 0,\cdots, n$ such that $\txid = \txid_{i}$, 
and either $i < n$ and $\txid' \in \txidset_{i} \cup \{ \txid_{i+1} \}$, 
or $i = n$ and $\txid' \in \txidset_{i}$: by definition, we have that $\txid \dashrightarrow \txid'$;
\item whenever $\txid, \toEDGE{\WW_{\mkvs}} \txid'$, 
then there exist two indexes $i, j: 0 \leq i < j \leq n$ such that 
$\txid = \txid_{i}, \txid' = \txid_{j}$; again, we have that $\txid \dashrightarrow \txid'$, 
\item whenever $\txid \toEDGE{\RW_{\mkvs}} \txid'$, then 
there exist two indexes $i, j: 0 \leq i < j \leq n$ such that either 
$\txid \in \txidset_{i}$ and $\txid' = \txid_{j}$, or $\txid = \txid_{i+1}$, 
$i+1 < j$ and $\txid' = \txid_{j}$; in both cases, we obtain that $\txid \dashrightarrow \txid'$,
\item whenever $\txid \toEDGE{\SO_{\mkvs}} \txid'$, then 
$\txid \in \{\txid_{i}\} \cup \txidset_{i}$ for some $i=0,\cdots,n$, 
and either $\txid' = \txid_{j}$ for some $i < j$,  or $\txid' \in \txidset_{j}$ for 
some $i \leq j$; it follows that $\txid \dashrightarrow \txid'$.
\end{itemize}

We have proved that $\dashrightarrow$ is an irreflexive relation, and it contains $(\SO_{\mkvs} \cup \WR_{\mkvs} \cup \WW_{\mkvs} \cup \RW_{\mkvs})^+$; 
because any subset of an irreflexive relation is itself irreflexive, we obtain that $\graphOf(\mkvs)$ is acyclic.
\end{proof}

\begin{corollary}
$\mathsf{KVStores}(\ET_{\PSI}, \mathsf{Counter}(\key)) \subseteq \mathsf{KVStores}(\ET_{\SER}, \mathsf{Counter}(\key))$. 
\end{corollary}

\begin{proof}
Let $\mkvs \in \mathsf{KVStores}(\ET_{\PSI}, \mathsf{Counter}(\key))$. Because $\ET_{\PSI} \supseteq \ET_{\MR} \cap \ET_{\RYW} \cap \ET_{\UA}$, 
we have that $\mkvs \in \mathsf{KVStores}(\ET_{\MR} \cap \ET_{\RYW} \cap \ET_{\UA}, \mathsf{Counter}(\key))$. 
By \cref{cor:psi_counter_acyclic} we have that $\graphOf(\mkvs)$ is acyclic. We can now employ the construction 
outlined in \cite{laws} to recover an abstract execution $\aexec = (\txidset_{\mkvs}, \VIS, \AR)$ such that $\SO \subseteq \VIS$ and $\AR \subseteq \VIS$, 
and $\graphOf(\aexec) = \graphOf(\mkvs)$.
Finally, the results from \cref{sec:sound-complete-ser} establish that, from $\aexec$ we can recover a $\ET_{\SER}$-trace in 
$\mathsf{Traces}(\ET_{\SER}, \mathsf{Counter}(\key))$ 
whose last configuration is $(\mkvs', \_)$, and 
$\graphOf(\mkvs') = \graphOf(\aexec) = \graphOf(\mkvs)$, leading to $\mkvs' = \mkvs$. It follows that $\mkvs \in 
\mathsf{KVStores}(\ET_{\SER}, \mathsf{Counter}(\key))$.
\end{proof}

\paragraph{Multiple counters are not robust against PSI}
Suppose that the kv-store contains multiple keys $\key, \key', \cdots$, each of which 
can be accessed and modified by clients using the code of transactional libraries 
$\mathsf{Counter}(\key), \mathsf{Counter}(\key'), \cdots$. We show that in this
 case it is possible to have the interactions of two client with the kv-store result 
 in  a non-serialisable final configuration. 
 
 More formally, suppose that $\Keys = \{\key_1, \key_2\}$, and let $\mathsf{Counter} = \bigcup_{\key \in \Keys} \mathsf{Counter}(\key)$. 
 Let also 
 \[
 \begin{array}{lcl}
 \mkvs_{0} &=& [\key_1 \mapsto (0, \txid_{0}, \emptyset), \key_2 \mapsto (0, \txid_0, \emptyset)]\\
 \mkvs_{1} &=& [\key_1 \mapsto (0, \txid_{0}, \{\txid_{\cl_1}^{1}\}) \lcat (1, \txid_{\cl_1}^{1}, \emptyset), \key_2 \mapsto (0, \txid_0, \emptyset)]\\
 \mkvs_{2} &=& [\key_1 \mapsto (0, \txid_{0}, \{\txid_{\cl_1}^{1}\}) \lcat (1, \txid_{\cl_1}^{1}, \emptyset), \key_2 \mapsto (0, \txid_0, \{\txid_{\cl_2}\}) \lcat(1, \txid_{\cl_2}^{1}, \emptyset)\\
 \mkvs_{3} &=& [\key_1 \mapsto (0, \txid_{0}, \{\txid_{\cl_1}^{1}\}) \lcat (1, \txid_{\cl_1}^{1}, \emptyset), \key_2 \mapsto (0, \txid_0, \{\txid_{\cl_2}\}) \lcat(1, \txid_{\cl_2}^{1}, \{\txid_{\cl_1}^{2}\})\\
  \mkvs_{4} &=& [\key_1 \mapsto (0, \txid_{0}, \{\txid_{\cl_1}^{1}\}) \lcat (1, \txid_{\cl_1}^{1}, \{\txid_{\cl_2}^{2}\}), \key_2 \mapsto (0, \txid_0, \{\txid_{\cl_2}\}) \lcat(1, \txid_{\cl_2}^{1}, \{\txid_{\cl_1}^{2}\})\\
 && \\
 \vienv_0 &=& [\cl_1 \mapsto [\key_1 \mapsto \{0\},  \key_2 \mapsto \{0\}], \cl_2 \mapsto [\key_1 \mapsto \{0\}, \key_2 \mapsto \{0\}]]\\
 \vienv_1 &=& [\cl_1 \mapsto [\key_1 \mapsto \{0,1\}, \key_2 \mapsto \{0\}], \cl_2 \mapsto [\key_1 \mapsto \{0\}, \key_2 \mapsto \{0\}]]\\
 \vienv_2 &=& [\cl_1 \mapsto [\key_1 \mapsto \{0,1\}, \key_2 \mapsto \{0\}], \cl_2 \mapsto [\key_1 \mapsto \{0\}, \key_2 \mapsto \{0,1\}]]\\
 \vienv_3 &=& \vienv_2\\
 \vienv_4 &=& \vienv_2\\
\end{array}
\]
  
 Observe that we have the sequence of $\ET_{\PSI}$-reductions 
 \[
     (\mkvs_0, \vienv_0) \toET{\cl_1, \mathsf{inc}(\key_1)}[\ET_{\PSI}] (\mkvs_1, \vienv_1) \toET{(\cl_2, \mathsf{inc}(\key_2)}[\ET_{\PSI}]
 (\mkvs_2, \vienv_2) \toET{(\cl_1, \mathsf{read}(\key_2)}[\ET_{\PSI}] (\mkvs_3, \vienv_3) \toET{(\cl_2, \mathsf{read}(\key_1)}[\ET_{\PSI}] 
 (\mkvs_4, \vienv_4)
 \]
and therefore $\mkvs_4 \in \mathsf{KVStores}(\ET_{\PSI}, \mathsf{Counter})$. 
On the other hand, for $\graphOf(\mkvs_4)$ we have the following cycle, which proves that 
$\mkvs_4 \notin \mathsf{KVStrores}(\ET_{\SER}, \mathsf{Counter})$: 
\[
\txid_{\cl_1}^{1} \toEDGE{\SO_{\mkvs_4}} \txid_{\cl_1}^{2} \toEDGE{\RW_{\mkvs_4}} \txid_{\cl_2}^{1} \toEDGE{\SO_{\mkvs_4}} 
\txid_{\cl_2}^{2} \toEDGE{\RW_{\mkvs_4}} \txid_{\cl_1}^{1}.
\]

\paragraph{Robustness of multiple counters under Snapshot Isolation.}
The reason why multiple counters fail to be robust under Parallel Snapshot Isolation is 
that two different clients can observe increments over different counters to have been 
executed in different order. For example, in the example above we had that client $\cl_1$ 
observed the initial value of $\key_2$ after it incremented $\key_1$, and vice-versa $\cl_2$ 
observed the initial value of $\key_1$ after it incremented $\key_2$. This situation does not 
arise when the execution test employed by clients guarantees Snapshot Isolation: 
by definition, this consistency model ensures that there is a total order among all the the updates 
performed over $\key_1$ and $\key_2$, and that is consistent with the order in which such updates 
are observed by clients. 

We show that multiple counters are robust against Snapshot Isolation. 
The proof strategy we employ is the same as for the proof of robustness of a single 
counter against PSI: we characterise the shape of kv-stores that can be obtained 
as a result of multiple clients invoking arbitrary operations on counters, and we show 
that the corresponding dependency graph has no cycle. 
To this end, we will need the following, auxiliary result that characterises cycles in 
Snapshot Isolation: 
\begin{proposition}
\label{prop:si_cycles}
Let $\mkvs \in \CM(\ET_{\SI})$. Then the relation $((\SO_{\mkvs} \cup \WR_{\mkvs} \cup \WW_{\mkvs}) ; \RW_{\mkvs}?)^{+}$ is 
irreflexive. ALternatively, $\mkvs$ only admits cycles with two consecutive $\RW_{\mkvs}$-edges.
\end{proposition}

\begin{proof}
This is a straightforward consequence of the correspondence between $\ET_{\SI}$-traces and 
abstract executions that satisfy the axiomatic definition of $\SI$ (\cref{sec:sound-complete-si}), and the fact that for any 
such abstract execution $\aexec$, the relation $((\SO_{\mkvs} \cup \WR_{\mkvs} \cup \WW_{\mkvs}); \RW_{\mkvs}?)^{+}$ 
is irreflexive (\cite{fekete-tods,SIanalysis,laws}).
\end{proof}

We only consider 
the case where the transactional library contains two counters, i.e. we 
consider the transactional library $\Counter(\{\key_1, \key_2\})$ for some $\key_1, \key_2 \in \Keys$. 
However, our line of reasoning can be generalised to an arbitrary number of counters. 
%Therefore, let $\mathsf{Counter} = \mathsf{Counter}(\key_1) \cup \mathsf{Counter}(\key_2)$. 

Let also $\mkvs$ be in $\mathsf{KVStores}(\ET_{\SI}, \Counter(\{\key_1, \key_2\})$. Because 
$\ET_{\SI} \subseteq \ET_{\PSI}$, $\mkvs(\key_1)$ and $\mkvs(\key_2)$ satisfy the 
properties from Proposition \ref{prop:counter_hhshape}. 
Furthermore, none of the transaction identifiers appearing in $\mkvs$ appears 
both in $\mkvs_{\key_1}$ and $\mkvs_{\key_2}$.
\begin{proposition}
\label{prop:si_counter_hhshape1}
Let $\mkvs$ be in $\mathsf{KVStores}(\ET_{\SI}, \Counter(\{\key_1, \key_2\}))$. 
Let $n_1 = \lvert \mkvs(\key_1) \rvert$, $n_2 = \lvert \mkvs(\key_2) \rvert$. 
Then there exist $\{\txid_{i}^{\key_1}\}_{i=1}^{n_1 - 1}$, $\{\txid_{i}^{\key_2}\}_{i=0}^{n_2 - 1}$, 
$\{\txidset_{i}^{\key_1}\}_{i=0}^{n_1-1}$, $\{\txidset_{i}^{\key_2}\}_{i=0}^{n_2 - 1}$ such that, 
for $h = 1,2$: 
\begin{align}
\mkvs(\key_{h}) = \left( (0, \txid_{0}, \txidset^{\key_{h}}_{0} \uplus \{\txid^{\key_{h}}_1\}) \lcat \cdots \lcat (n-1, \txid^{\key_{h}}_{n-1}, \txidset_{n_{h}-2} \uplus \{\txid^{\key_{h}}_{n}\}) \right) 
\lcat (n-1, \txid_{n_{h} - 1}, \txidset^{\key_{h}}_{n_{h} - 1}) \label{eq:si_counter_shape}\\
\forall i=0,\cdots,n.\txidset^{\key_{h}}_{i} \cap \{\txid^{\key_{h}}_{i}\}_{i=0}^{n_{h}-1} = \emptyset \label{eq:si_counter_rwtxs}\\
\forall \txid, \txid'.\;\forall i,j=0,\cdots, n_{h} - 1.\; \txid \toEDGE{\SO} \txid' 
\land \txid \in \{\txid^{\key_{h}}_{i}\} \cup \txidset^{\key_{h}}_{i} \implies 
\left(\begin{array}{l}
(\txid' = \txid^{\key_{h}}_{j} \implies i < j) \land {} \\
(\txid' \in \txidset^{\key_{h}}_{j} \implies i \leq j) \\
%(\txid \in \txidset_{i} \land \txid' = \txid_{j} \implies i < j) \land {} \\
%(\txid \in \txidset_{i} \land \txid' \in \txidset_{j} \implies i \leq j)
\end{array}\right) \label{eq:si_counter_so}\\
\left( \{\txid^{\key_{1}}_{i}\}_{i=1}^{n_1 -1} \cup \bigcup_{i=0}^{n_1 - 1} \txidset_{i}^{\key_1} \right) \cap 
\left( \{\txid^{\key_{2}}_{i}\}_{i=1}^{n_2 -1} \cup \bigcup_{i=0}^{n_2 - 1} \txidset_{i}^{\key_1} \right) = \emptyset \label{eq:si_counter_disjoint}
\end{align}

\end{proposition}

\begin{proof}
Each of the properties \eqref{eq:psi_counter_shape}, \eqref{eq:si_counter_rwtxs}, \eqref{eq:si_counter_so} 
can be proved as in \cref{prop:counter_hhshape}. The fact that $(\mkvs, \{\txid_{i}^{\key_{1}}\}_{i=1}^{n_1 - 1}, \{\txid^{\key_2}_{i}\}_{i=1}^{n_2 - 1}, 
\{\txidset_{i}^{\key_1}\}_{i=0}^{n_1 - 1}, \{\txidset_{i}^{\key_2}\}_{i=0}^{n_2-1})$ also satisfies Property \eqref{eq:si_counter_disjoint} 
follows from the fact that each of the operations in $\Counter(\{\key_1, \key_2\})$ only access a single key. 
\end{proof}

Following the proof pattern we employed for a single counter under $\ET_{\PSI}$, we now 
define a strict partial order $\rightarrow$ among transaction identifiers appearing in a store 
$\mkvs \in \mathsf{KVStores}(\ET_{\SI},  \Counter(\{\key_1, \key_2\}))$, and show that such a 
total order covers the relation $(\SO_{\mkvs} \cup \WR_{\mkvs} \cup \WW_{\mkvs} \cup \RW_{\mkvs})^{\ast}$. 
Because clients may invoke counter operations on different keys, and because the 
order in which a clients observes versions of different keys is regulated by $\ET_{\SI}$, 
the definition of the total order is considerably more complicated than the one 
obtained for a single-key counter under $\ET_\PSI$.

\begin{definition}
\label{def:si_counter_order}
Let $\mkvs \in \mathsf{KVStores}(\ET_{\SI}, \Counter(\{\key_1, \key_2\})$, and let 
$n_1 = \lvert \mkvs(\key_1) \rvert$, $n_2 = \lvert \mkvs(\key_2) \rvert$. 
and $\{\txid_{i}^{\key_1}\}_{i=1}^{n_1 - 1}$, $\{\txid_{i}^{\key_2}\}_{i=0}^{n_2 - 1}$, 
$\{\txidset_{i}^{\key_1}\}_{i=0}^{n_1-1}$, $\{\txidset_{i}^{\key_2}\}_{i=0}^{n_2 - 1}$ the indexes 
and sets such that $(\mkvs, \{\txid_{i}^{\key_{1}}\}_{i=1}^{n_1 - 1}, \{\txid^{\key_2}_{i}\}_{i=1}^{n_2 - 1}, 
\{\txidset_{i}^{\key_1}\}_{i=0}^{n_1 - 1}, \{\txidset_{i}^{\key_2}\}_{i=0}^{n_2-1})$ satisfies the property from 
Proposition \ref{prop:si_counter_hhshape1}. Let $h, l \in \{1,2\}$ with $h \neq l$; we 
let $(\dashrightarrow, \twoheadrightarrow, \rightarrow)$ be the smallest relation such that 
\[
\begin{array}{ll}
\txid \in \txidset^{\key_{h}}_{i} &\implies \txid^{\key_{h}}_{i} \dashrightarrow \txid,\\
i < j &\implies \txid_{i} \dashrightarrow \txid_{j},\\
\txid \in \txidset^{\key_{h}}_{i} \land i < j & \implies \txid \dashrightarrow \txid^{\key_{h}}_{j}\\
\txid, \txid' \in \txidset^{\key_{h}}_{i} \land \txid \toEDGE{\SO} \txid' &\implies \txid \dashrightarrow \txid'\\
\txid \dashrightarrow \txid'' \dashrightarrow \txid &\implies \txid \dashrightarrow \txid'\\
\txid \in (\txidset^{\key_{h}}_{I} \cup \{\txid^{\key_{h}}_{l}\}) \land \txid' \in (\txidset^{\key_{l}}{j} \cup \{\txid^{\key_l}_{j}\} \land \txid \toEDGE{\SO} \txid' &\implies \txid \twoheadrightarrow \txid'\\
\txid \dashrightarrow \txid' \vee \txid \twoheadrightarrow \txid' &\implies \txid \rightarrow \txid'\\
\txid \rightarrow \txid'' \rightarrow \txid' &\implies \txid \rightarrow \txid'
\end{array}
\]
%
%For the sake of clarity, we write $\txid \twoheadrightarrow \txid'$ in the case that $\txid \rightarrow \txid'$ 
%and either $\txid \in \mkvs(\key_1), \txid' \in \mkvs(\key_2)$, or $\txid \in \mkvs(\key_2), \txid' \in \mkvs(\key_1)$. 
%We also let $\txid \dashrightarrow \txid'$ if $\txid \rightarrow \txid'$, and $\txid, \txid' \in \mkvs(\key_h)$ 
%for $h = 1,2$.
\end{definition}
Given $\mkvs \in \CMs(\ET_{\SI}, \Counter(\{\key_1, \key_2\}))$, 
It is important to observe that the definition of $\dashrightarrow$ is a generalisation of the relation 
with the same notation we defined for a single counter over $\ET_{\PSI}$, and therefore it is irreflexive. 
Furthermore, whenever $\txid \toEDGE{\WR_{\mkvs} \cup \WW_{\mkvs} \cup \RW_{\mkvs}} \txid'$, it must be the case that 
$\txid \dashrightarrow \txid'$ (the same does not hold anymore in the case of $\txid \toEDGE \txid'$, 
We also observe that whenever $\txid \twoheadrightarrow \txid'$, then it cannot be $\txid \toEDGE{\WR \cup \WW \cup \RW} \txid'$, 
because the relation $\twoheadrightarrow$ only relates transactions accessing different keys, and the structure of 
the multiple counter library ensures that transactions always access exactly one of the two keys $\key_1, \key_2$). 
Finally, note that whenever $\txid \toEDGE{\SO_{\mkvs}} \txid'$, then either $\txid, \txid'$ access the same 
key, and therefore $\txid \dashrightarrow \txid'$, or $\txid, \txid'$ access different keys, and therefore 
$\txid \twoheadrightarrow \txid'$. It follows that $(\SO_{\mkvs} \cup \WR_{\mkvs} \cup \WW_{\mkvs} \cup \RW_{\mkvs})^{+}$ 
is contained in $(\dashrightarrow \cup \twoheadrightarrow)^{+} = \rightarrow$; therefore, 
to prove that $\mkvs \in \CMs(\ET_{\SER}  \Counter(\{\key_1, \key_2\}))$, it suffices to prove that 
the relation$\rightarrow$ is irreflexive.
%
%Note that the definition of $\dashrightarrow$ coincides with partial order over transaction 
%identifiers from the proof of \cref{cor:psi_counter_acyclic}, and therefore it is irreflexive.

\begin{proposition}
Let $\mkvs \in \mathsf{KVStores}(\ET_{\SI}, \mathsf{Counter})$: the relation $\rightarrow$ 
defined by \cref{def:si_counter_order} is irreflexive.
\end{proposition}

\begin{proof}
By contradiction. Suppose that there exists a transaction identifier $\txid \in \mkvs$ such that 
$\txid \rightarrow \txid$. Then there exists a cyclic sequence of transaction identifiers 
$\txid^{0}, \cdots, \txid^{n}$ such that $\txid^{n} =  \txid^{0} = \txid$, and
\[ 
\txid^{0} \rightarrow \txid^{1} \rightarrow \cdots \rightarrow \txid^{n}.
\]
First note that, because $\rightarrow = (\dashrightarrow \cup \twoheadrightarrow)^{+}$, 
and because $\dashrightarrow$ is transitive and irreflexive, then it must be the 
case that the cycle above contains at least one edge of the form $\txid^{i} \twoheadrightarrow \txid^{i+1}$. 
Because the relation $\twoheadrightarrow$ only relates transactions accessing different object, 
then it must be the case that the cycle above also contains a second edge $\txid^{j} \twoheadrightarrow \txid^{j+1}$, 
where $j \neq i$: this is because if the cycle above contained exactly one edge labelled as $\twoheadrightarrow$, 
then $\txid^{0} = \txid^{n}$ would need to access both keys $\key_1$ and $\key_2$, contradicting the 
fact that the operations from $\Counter(\{\key_1, \key_2\})$ only access a single object. 
Thus, the cycle above can be rewritten as 
\[ 
\txid \twoheadrightarrow \txid^{a} (\dashrightarrow \cup \twoheadrightarrow)^{+} \txid^{b} \twoheadrightarrow  \txid^{c} (\dashrightarrow \cup \twoheadrightarrow)^{+} \txid, 
\]
where $\txid = \txid^{i}$ for some $i=0,\cdots, n-1$. Note that it cannot be $\txid^{a} = \txid^{b}$, because 
otherwise we would have $\txid \twoheadrightarrow \twoheadrightarrow \txid$, or equivalently 
$\txid \toEDGE{\SO_{\mkvs}} \txid$, contradicting the acycicity of the relation $\SO_{\mkvs}$. 
Also note that the relation $(\dashrightarrow \cup \twoheadrightarrow)^{+} ; \twoheadrightarrow$ can be rewritten as 
$(\dashrightarrow^{*} ; \twoheadrightarrow)^{+}$, and because $\dashrightarrow$ is transitive, 
this is equivalent to $(\dashrightarrow^{?} ; \twoheadrightarrow)^{+}$, where $\dashrightarrow^{?}$ is 
the reflexive closure of $\dashrightarrow^{?}$. 
We have determined that the presence of a cycle in the relation $(\SO_{\mkvs} \cup \WR_{\mkvs} \cup \WW_{\mkvs} \cup \RW_{\mkvs})^{+}$ 
implies the existence of a cycle of the form 
\[
\txid \twoheadrightarrow \_ \dashrightarrow^{?} \ \cdots \twoheadrightarrow \_ \dashrightarrow^{?} \txid.
\]
However, because any edge labelled as $\twoheadrightarrow$ cannot correspond to a $\RW_{\mkvs}$ edge, 
it follows that the orignal cycle cannot have two adjacent $\RW_{\mkvs}$-edges. 
%
%Without loss of generality, we may assume that such a cycle is minimal: i.e., 
%there exists no shorter cycle induced by the relation $\rightarrow$.
%Because $\txid^{0}$ appears only in $\mkvs(\key_1)$ or $\mkvs(\key_2)$ 
%(Property \ref{eq:si_counter_disjoint}), and because transitions of the form 
%$\txid \twoheadrightarrow \txid'$ are defined between transaction identifiers 
%appearing in the list of versions of different keys in $\mkvs$, then it 
%must be the case that the sequence above contains an even number of 
%$\twoheadrightarrow$ transitions. If such a number is zero, then it is immediate to observe that 
%$\txid^{0} \neq \txid^{n}$, leading to a contradiction. 
%Suppose then that that there exist two different indexes $i, j$ such that 
%$\txid^{i} \twoheadrightarrow \txid^{i+1}$ and $\txid^{j} \twoheadrightarrow \txid^{j+1}$. Without loss of 
%generality, suppose that $i < j$, and for no index $h: h < i \vee h > j$ we have $\txid^{h} \twoheadrightarrow \txid^{h+1}$. 
%%Let $\dashrightarrow$ be the reflexive, transitive closure of $\rightarrow$, and 
%Observe that in this case we have $\txid^{i} \twoheadrightarrow \txid^{i+1} \dashrightarrow^{?} \txid{j} \twoheadrightarrow \txid^{j+1} 
%(\dashrightarrow)^{?} \txid^{i}$, where $\dashrightarrow^{?}$ is the reflexive closure of $\dashrightarrow$.
%In fact, by definition, $\txid^{i+1} \in \{\wtOf(\mkvs(\key_{h}, p)\} \cup \rsOf(\mkvs(\key_{h}, p))$ 
%for $h=1,2$ and $p = 0,\cdots, \lvert \mkvs(\key_{h}) \rvert - 1$, 
%$\txid_{j} \in \{ \wtOf(\mkvs(\key_{h}, q)\} \cup \rsOf(\mkvs(\key_{h}, q))$ for some $q = 0,\cdots, \lvert \mkvs(\key_{h}) \rvert - 1$. 
%Observe that for any two transaction identifier $\txid, \txid' \in \mkvs(\key_h)$ we have that either 
%$\txid \dashrightarrow \txid'$, $\txid = \txid'$ or $\txid' \dashrightarrow \txid$. In particular, 
%either $\txid^{i+1} \dashrightarrow \txid^{j}, \txid^{i+1} = \txid^{j}$ or $\txid^{j} \dashrightarrow \txid^{i+1}$. 
%If we have that $\txid^{j+1} \dashrightarrow \txid^{j}$, then we can easily find a cycle of the form
%$\txid^{j} \rightarrow \txid^{i+1} \rightarrow{\txid^{j}}$, contradicting the minimality of the cycle that we have considered. 
%Therefore, it must be $\txid^{i+1} \dashrightarrow^{?} \txid^{j}$. The fact that $\txid^{j+1} \dashrightarrow^{?} \txid^{i}$ 
%follows from the fact that we chose the indexes $i, j$ so that for no index $h: h < i \vee h > j$ we have $\txid^{h} \twoheadrightarrow \txid^{h+1}$. 
%
%Finally, note that the cyclic path $\txid^{i} \twoheadrightarrow \txid^{i+1} \dashrightarrow^{?} \txid{j} \twoheadrightarrow \txid^{j+1} 
%(\dashrightarrow)^{?} \txid^{i}$ correspond to a cycle in $\graphOf(\mkvs)$ of the form: 
%\[
%\txid^{i} \toEDGE{\SO_{\mkvs}} \txid^{i+1} \toEDGE{(\SO_{\mkvs} \cup \WR_{\mkvs} \cup \WW_{\mkvs} \cup \RW_{\mkvs})^{\ast}} 
%\txid^{j} \toEDGE{\SO_{\mkvs}} \txid^{j+1} \toEDGE{(\SO_{\mkvs} \cup \WR_{\mkvs} \cup \WW_{\mkvs} \cup \RW_{\mkvs})^{\ast}} 
%\txid^{i}
%\]
This contradicts Proposition \ref{prop:si_cycles}.
%Finally, let us consider the order in which transactions $\txid^{i}, \txid^{i+1}, \txid^{j}, \txid^{j+1}$ must have been 
%executed to give rise to the kv-store $\mkvs$. Because $\txid^{i} \twoheadrightarrow \txid^{i+1}$, it must 
%be the case that $\txid^{i}$ has been executed before $\txid^{i+1}$; similarly we can prove that $\txid^{i}$ 
%has been executed before $\txid^{j+1}$. WIthout loss of generality, assume that $\txid^{i}$ has also 
%been executed before $\txid^{j}$. For simplicity, we only consider the case where we assume that $\txid^{i+1} \neq \txid^{j}$ 
%and $\txid^{j+1} \neq \txid^{i}$, although the proof in the remaning cases is similar.
%We have that $\txid^{j} \in \{\wtOf(\mkvs(\key_{h}), p_{h})\} \cup \rsOf(\mkvs(\key_{h}, \p_{h})$ for some $h=1,2$ and $p_{h} = 0,\cdots, 
%\lvert \mkvs(\key_{h}) \rvert$. 

\end{proof}

%Furthermore, when clients employ the execution test $\ET_{\SI}$ to commit transactions, 
%then we have the following: 
%\begin{proposition}
%Let $\mkvs \in \mathsf{KVStores}(\ET_{\PSI}, \mathsf{Counter})$, and let 
%$n_1 = \lvert \mkvs(\key_1) \rvert$, $n_2 = \lvert \mkvs(\key_2) \rvert$. 
%and $\{\txid_{i}^{\key_1}\}_{i=1}^{n_1 - 1}$, $\{\txid_{i}^{\key_2}\}_{i=0}^{n_2 - 1}$, 
%$\{\txidset_{i}^{\key_1}\}_{i=0}^{n_1-1}$, $\{\txidset_{i}^{\key_2}\}_{i=0}^{n_2 - 1}$ the indexes 
%and sets such that $(\mkvs, \{\txid_{i}^{\key_{1}}\}_{i=1}^{n_1 - 1}, \{\txid^{\key_2}_{i}\}_{i=1}^{n_2 - 1}, 
%\{\txidset_{i}^{\key_1}\}_{i=0}^{n_1 - 1}, \{\txidset_{i}^{\key_2}\}_{i=0}^{n_2-1})$ satisfies the property from 
%Proposition \ref{prop:si_counter_hhshape1}. Let $h, l \in \{1,2\}$ with $h \neq l$; then 
%\begin{align} 
%\forall i, j = 0,\cdots, \key_{h} - 1, p, q = 0,\cdots, \key_{l} - 1, \txid, \txid', \txid'', \txid'''. \txid \in \txidset_{i}^{\key_h} \land 
%\txid' \in \txidset_{j}^{\key_{h}} \land \txid'' \in \txidset_{p}^{\key_{l}} \land \txid''' \in \txidset_{q}^{\key_{k}} \land 
%\txid'' \toEDGE{PO} \txid' \land i < j \implies p \leq q \label{eq:si_counter_crossRD}
%\end{align}
%\end{proposition}
